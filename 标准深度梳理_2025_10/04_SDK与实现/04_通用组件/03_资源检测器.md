# 资源检测器

## 📋 目录

- [资源检测器](#资源检测器)
  - [📋 目录](#-目录)
  - [概述](#概述)
  - [内置检测器](#内置检测器)
  - [组合检测器](#组合检测器)
  - [Go 1.25.1 实现](#go-1251-实现)
    - [1. 自定义检测器](#1-自定义检测器)
    - [2. 条件检测](#2-条件检测)
  - [最佳实践](#最佳实践)
  - [参考资源](#参考资源)

---

## 概述

**Resource Detector** 自动检测运行环境并生成 Resource 属性。

---

## 内置检测器

```go
import (
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.21.0"
)

func newResource() *resource.Resource {
    return resource.NewWithAttributes(
        semconv.SchemaURL,
        semconv.ServiceName("myapp"),
        semconv.ServiceVersion("1.0.0"),
    )
}
```

**环境变量检测**:

```go
// 自动从 OTEL_RESOURCE_ATTRIBUTES 读取
// export OTEL_RESOURCE_ATTRIBUTES="service.name=myapp,deployment.environment=prod"

r, _ := resource.New(context.Background(),
    resource.WithFromEnv(), // 读取环境变量
)
```

---

## 组合检测器

```go
r, _ := resource.New(
    context.Background(),
    resource.WithFromEnv(),      // 环境变量
    resource.WithHost(),         // 主机信息
    resource.WithProcess(),      // 进程信息
    resource.WithContainer(),    // 容器信息
    resource.WithOS(),           // 操作系统
    resource.WithAttributes(     // 自定义属性
        semconv.ServiceName("myapp"),
    ),
)
```

---

## Go 1.25.1 实现

### 1. 自定义检测器

```go
type CustomDetector struct{}

func (d CustomDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    return resource.NewWithAttributes(
        semconv.SchemaURL,
        attribute.String("custom.key", "value"),
    ), nil
}

// 使用
r, _ := resource.New(
    context.Background(),
    resource.WithDetectors(CustomDetector{}),
)
```

### 2. 条件检测

```go
func newResource() *resource.Resource {
    detectors := []resource.Detector{
        resource.FromEnv(),
    }
    
    // 仅在 Kubernetes 中添加 K8s 检测器
    if isKubernetes() {
        detectors = append(detectors, kubernetesDetector{})
    }
    
    r, _ := resource.New(
        context.Background(),
        resource.WithDetectors(detectors...),
    )
    return r
}
```

---

## 最佳实践

```go
// ✅ 推荐配置
r, _ := resource.New(
    context.Background(),
    resource.WithFromEnv(),
    resource.WithHost(),
    resource.WithProcess(),
    resource.WithAttributes(
        semconv.ServiceName("myapp"),
        semconv.ServiceVersion("1.0.0"),
    ),
)
```

---

## 参考资源

- [OpenTelemetry Resource SDK](https://opentelemetry.io/docs/specs/otel/resource/sdk/)

---

**🎉 完成！资源检测器知识掌握！**
