# ID 生成器

## 📋 目录

- [ID 生成器](#id-生成器)
  - [📋 目录](#-目录)
  - [概述](#概述)
  - [默认生成器](#默认生成器)
  - [自定义 ID 生成器](#自定义-id-生成器)
  - [Go 1.25.1 实现](#go-1251-实现)
  - [最佳实践](#最佳实践)
  - [参考资源](#参考资源)

---

## 概述

**ID Generator** 负责生成 Trace ID 和 Span ID。

```text
Trace ID: 128-bit (32 hex)
Span ID:  64-bit (16 hex)
```

---

## 默认生成器

```go
// 默认使用 crypto/rand
tp := trace.NewTracerProvider()
```

---

## 自定义 ID 生成器

```go
import "go.opentelemetry.io/otel/sdk/trace"

type CustomIDGenerator struct{}

func (g CustomIDGenerator) NewIDs(ctx context.Context) (trace.TraceID, trace.SpanID) {
    var traceID trace.TraceID
    var spanID trace.SpanID
    
    // 自定义生成逻辑
    rand.Read(traceID[:])
    rand.Read(spanID[:])
    
    return traceID, spanID
}

func (g CustomIDGenerator) NewSpanID(ctx context.Context, traceID trace.TraceID) trace.SpanID {
    var spanID trace.SpanID
    rand.Read(spanID[:])
    return spanID
}

// 使用
tp := trace.NewTracerProvider(
    trace.WithIDGenerator(CustomIDGenerator{}),
)
```

---

## Go 1.25.1 实现

```go
import "math/rand/v2"

type ModernIDGenerator struct {
    rng *rand.Rand
}

func NewModernIDGenerator() *ModernIDGenerator {
    return &ModernIDGenerator{
        rng: rand.New(rand.NewPCG(uint64(time.Now().UnixNano()), 0)),
    }
}

func (g *ModernIDGenerator) NewIDs(ctx context.Context) (trace.TraceID, trace.SpanID) {
    var traceID trace.TraceID
    var spanID trace.SpanID
    
    g.rng.Read(traceID[:])
    g.rng.Read(spanID[:])
    
    return traceID, spanID
}

func (g *ModernIDGenerator) NewSpanID(ctx context.Context, traceID trace.TraceID) trace.SpanID {
    var spanID trace.SpanID
    g.rng.Read(spanID[:])
    return spanID
}
```

---

## 最佳实践

```go
// ✅ 使用默认生成器（推荐）
tp := trace.NewTracerProvider()

// ✅ 自定义生成器（特殊需求）
// 例如: 有序 ID、分布式 ID 等
tp := trace.NewTracerProvider(
    trace.WithIDGenerator(CustomIDGenerator{}),
)
```

---

## 参考资源

- [OpenTelemetry Trace SDK](https://opentelemetry.io/docs/specs/otel/trace/sdk/)

---

**🎉 完成！ID 生成器知识掌握！**-
