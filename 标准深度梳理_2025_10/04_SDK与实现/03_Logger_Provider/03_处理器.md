# LogRecordProcessor å¤„ç†å™¨

## ğŸ“‹ ç›®å½•

- [LogRecordProcessor å¤„ç†å™¨](#logrecordprocessor-å¤„ç†å™¨)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [å†…ç½®å¤„ç†å™¨](#å†…ç½®å¤„ç†å™¨)
    - [1. SimpleLogRecordProcessor](#1-simplelogrecordprocessor)
    - [2. BatchLogRecordProcessor](#2-batchlogrecordprocessor)
    - [3. å¤šå¤„ç†å™¨](#3-å¤šå¤„ç†å™¨)
  - [å¤„ç†å™¨é…ç½®](#å¤„ç†å™¨é…ç½®)
  - [Go 1.25.1 å®ç°](#go-1251-å®ç°)
    - [1. è‡ªå®šä¹‰å¤„ç†å™¨](#1-è‡ªå®šä¹‰å¤„ç†å™¨)
    - [2. è¿‡æ»¤å¤„ç†å™¨](#2-è¿‡æ»¤å¤„ç†å™¨)
    - [3. é“¾å¼å¤„ç†å™¨](#3-é“¾å¼å¤„ç†å™¨)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

**LogRecordProcessor** è´Ÿè´£å¤„ç† LogRecord çš„ç”Ÿå‘½å‘¨æœŸå¹¶å°†å…¶å¯¼å‡ºåˆ°åç«¯ã€‚ä¸ SpanProcessor ç±»ä¼¼ï¼Œä½†ä¸“é—¨ç”¨äºæ—¥å¿—ã€‚

```text
LogRecord
    â†“
Processor.OnEmit()
    â†“ (æ‰¹å¤„ç†/ç«‹å³)
Exporter.Export()
    â†“
Backend
```

---

## å†…ç½®å¤„ç†å™¨

### 1. SimpleLogRecordProcessor

åŒæ­¥å¯¼å‡ºï¼ˆæ¯æ¡æ—¥å¿—ç«‹å³å¯¼å‡ºï¼‰ï¼š

```go
import (
    "go.opentelemetry.io/otel/sdk/log"
    "go.opentelemetry.io/otel/exporters/stdout/stdoutlog"
)

func main() {
    exporter, _ := stdoutlog.New()
    
    // åˆ›å»º SimpleProcessor
    processor := log.NewSimpleProcessor(exporter)
    
    lp := log.NewLoggerProvider(
        log.WithProcessor(processor),
    )
    defer lp.Shutdown(context.Background())
}
```

**ç‰¹ç‚¹**:

```text
âœ… ä¼˜ç‚¹:
  - ç®€å•ç›´æ¥
  - ç«‹å³å¯è§
  - é€‚åˆè°ƒè¯•

âŒ ç¼ºç‚¹:
  - åŒæ­¥é˜»å¡
  - æ€§èƒ½å¼€é”€å¤§
  - ä¸é€‚åˆé«˜é¢‘æ—¥å¿—

ä½¿ç”¨åœºæ™¯:
âœ… å¼€å‘ç¯å¢ƒ
âœ… è°ƒè¯•
âœ… ä½é¢‘æ—¥å¿— (< 10/s)
âŒ ç”Ÿäº§ç¯å¢ƒï¼ˆé«˜é¢‘ï¼‰
```

### 2. BatchLogRecordProcessor

æ‰¹é‡å¼‚æ­¥å¯¼å‡ºï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

```go
import (
    "time"
    "go.opentelemetry.io/otel/sdk/log"
)

func main() {
    exporter, _ := stdoutlog.New()
    
    // åˆ›å»º BatchProcessor
    processor := log.NewBatchProcessor(
        exporter,
        log.WithBatchTimeout(5*time.Second),
        log.WithMaxQueueSize(2048),
        log.WithExportMaxBatchSize(512),
        log.WithExportTimeout(30*time.Second),
    )
    
    lp := log.NewLoggerProvider(
        log.WithProcessor(processor),
    )
    defer lp.Shutdown(context.Background())
}
```

**é…ç½®å‚æ•°**:

```text
BatchTimeout: 5ç§’
MaxQueueSize: 2048
ExportMaxBatchSize: 512
ExportTimeout: 30ç§’
```

### 3. å¤šå¤„ç†å™¨

```go
// åŒæ—¶é…ç½®å¤šä¸ªå¤„ç†å™¨
func main() {
    // å¤„ç†å™¨ 1: å¯¼å‡ºåˆ° OTLP
    otlpExporter, _ := otlploggrpc.New(context.Background())
    otlpProcessor := log.NewBatchProcessor(otlpExporter)
    
    // å¤„ç†å™¨ 2: å¯¼å‡ºåˆ°æ–‡ä»¶ï¼ˆè°ƒè¯•ï¼‰
    fileExporter, _ := filelogexporter.New("app.log")
    fileProcessor := log.NewSimpleProcessor(fileExporter)
    
    lp := log.NewLoggerProvider(
        log.WithProcessor(otlpProcessor),
        log.WithProcessor(fileProcessor),
    )
}
```

---

## å¤„ç†å™¨é…ç½®

```go
// å¼€å‘ç¯å¢ƒ: å¿«é€Ÿå¯¼å‡º
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(1*time.Second),
    log.WithMaxQueueSize(100),
)

// ç”Ÿäº§ç¯å¢ƒ: å¹³è¡¡æ€§èƒ½
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(5*time.Second),
    log.WithMaxQueueSize(2048),
    log.WithExportMaxBatchSize(512),
)

// é«˜é¢‘æ—¥å¿—: å¤§æ‰¹æ¬¡
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(10*time.Second),
    log.WithMaxQueueSize(4096),
    log.WithExportMaxBatchSize(1024),
)
```

---

## Go 1.25.1 å®ç°

### 1. è‡ªå®šä¹‰å¤„ç†å™¨

```go
package processor

import (
    "context"
    "go.opentelemetry.io/otel/sdk/log"
)

// CustomProcessor è‡ªå®šä¹‰å¤„ç†å™¨
type CustomProcessor struct {
    exporter log.Exporter
}

func NewCustomProcessor(exporter log.Exporter) log.Processor {
    return &CustomProcessor{
        exporter: exporter,
    }
}

// OnEmit å¤„ç†æ—¥å¿—è®°å½•
func (p *CustomProcessor) OnEmit(ctx context.Context, record log.Record) error {
    // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
    // ä¾‹å¦‚: æ·»åŠ é¢å¤–å±æ€§ã€è¿‡æ»¤ç­‰
    
    // å¯¼å‡º
    return p.exporter.Export(ctx, []log.Record{record})
}

// Shutdown å…³é—­å¤„ç†å™¨
func (p *CustomProcessor) Shutdown(ctx context.Context) error {
    return p.exporter.Shutdown(ctx)
}

// ForceFlush å¼ºåˆ¶åˆ·æ–°
func (p *CustomProcessor) ForceFlush(ctx context.Context) error {
    return nil
}
```

### 2. è¿‡æ»¤å¤„ç†å™¨

```go
package processor

// FilterProcessor è¿‡æ»¤å¤„ç†å™¨
type FilterProcessor struct {
    next   log.Processor
    filter func(log.Record) bool
}

func NewFilterProcessor(next log.Processor, filter func(log.Record) bool) log.Processor {
    return &FilterProcessor{
        next:   next,
        filter: filter,
    }
}

func (p *FilterProcessor) OnEmit(ctx context.Context, record log.Record) error {
    // åº”ç”¨è¿‡æ»¤å™¨
    if p.filter(record) {
        return p.next.OnEmit(ctx, record)
    }
    return nil
}

func (p *FilterProcessor) Shutdown(ctx context.Context) error {
    return p.next.Shutdown(ctx)
}

func (p *FilterProcessor) ForceFlush(ctx context.Context) error {
    return p.next.ForceFlush(ctx)
}

// ä½¿ç”¨ç¤ºä¾‹: åªå¯¼å‡º ERROR çº§åˆ«æ—¥å¿—
func main() {
    exporter, _ := stdoutlog.New()
    batchProcessor := log.NewBatchProcessor(exporter)
    
    filterProcessor := NewFilterProcessor(
        batchProcessor,
        func(r log.Record) bool {
            return r.SeverityNumber >= log.SeverityError
        },
    )
    
    lp := log.NewLoggerProvider(
        log.WithProcessor(filterProcessor),
    )
}
```

### 3. é“¾å¼å¤„ç†å™¨

```go
package processor

// ChainProcessor é“¾å¼å¤„ç†å™¨
type ChainProcessor struct {
    processors []log.Processor
}

func NewChainProcessor(processors ...log.Processor) log.Processor {
    return &ChainProcessor{
        processors: processors,
    }
}

func (p *ChainProcessor) OnEmit(ctx context.Context, record log.Record) error {
    for _, processor := range p.processors {
        if err := processor.OnEmit(ctx, record); err != nil {
            return err
        }
    }
    return nil
}

func (p *ChainProcessor) Shutdown(ctx context.Context) error {
    for _, processor := range p.processors {
        if err := processor.Shutdown(ctx); err != nil {
            return err
        }
    }
    return nil
}

func (p *ChainProcessor) ForceFlush(ctx context.Context) error {
    for _, processor := range p.processors {
        if err := processor.ForceFlush(ctx); err != nil {
            return err
        }
    }
    return nil
}
```

---

## æ€§èƒ½ä¼˜åŒ–

```go
// 1. ä½¿ç”¨ BatchProcessorï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(5*time.Second),
)

// 2. è°ƒæ•´æ‰¹æ¬¡å¤§å°
// é«˜é¢‘æ—¥å¿—: å¤§æ‰¹æ¬¡
log.WithExportMaxBatchSize(1024)

// 3. è°ƒæ•´é˜Ÿåˆ—å¤§å°
log.WithMaxQueueSize(4096) // ~8MB (å‡è®¾ 2KB/log)

// 4. é¿å…é˜»å¡æ“ä½œ
func (p *CustomProcessor) OnEmit(ctx context.Context, r log.Record) error {
    // âŒ é”™è¯¯: é˜»å¡æ“ä½œ
    time.Sleep(1*time.Second)
    
    // âœ… æ­£ç¡®: å¼‚æ­¥å¤„ç†
    go func() {
        p.next.OnEmit(ctx, r)
    }()
    return nil
}
```

---

## æœ€ä½³å®è·µ

```go
// âœ… æ­£ç¡®: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ BatchProcessor
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(5*time.Second),
    log.WithMaxQueueSize(2048),
)

// âœ… æ­£ç¡®: å¼€å‘ç¯å¢ƒä½¿ç”¨ SimpleProcessor
if os.Getenv("ENV") == "development" {
    processor = log.NewSimpleProcessor(exporter)
}

// âœ… æ­£ç¡®: æ­£ç¡®å…³é—­
defer func() {
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()
    if err := lp.Shutdown(ctx); err != nil {
        log.Printf("Error shutting down: %v", err)
    }
}()

// âŒ é”™è¯¯: å¿˜è®°å…³é—­
func main() {
    lp := log.NewLoggerProvider(...)
    // ç¼ºå°‘ defer lp.Shutdown()
}
```

---

## å¸¸è§é—®é¢˜

**Q1: SimpleProcessor vs BatchProcessorï¼Ÿ**

```text
SimpleProcessor:
âœ… å¼€å‘ç¯å¢ƒ
âœ… è°ƒè¯•
âœ… ä½é¢‘æ—¥å¿—
âŒ ç”Ÿäº§ç¯å¢ƒï¼ˆé«˜é¢‘ï¼‰

BatchProcessor (æ¨è):
âœ… ç”Ÿäº§ç¯å¢ƒ
âœ… é«˜é¢‘æ—¥å¿—
âœ… æ€§èƒ½æ•æ„Ÿ

é…ç½®æ¨è:
- å¼€å‘: SimpleProcessor
- ç”Ÿäº§: BatchProcessor (5s)
```

**Q2: å¦‚ä½•ç¡®ä¿æ—¥å¿—ä¸ä¸¢å¤±ï¼Ÿ**

```go
// 1. è®¾ç½®åˆç†é˜Ÿåˆ—å¤§å°
log.WithMaxQueueSize(4096)

// 2. æ­£ç¡®å…³é—­
defer lp.Shutdown(context.Background())

// 3. ç›‘æ§é˜Ÿåˆ—
// å¦‚æœé˜Ÿåˆ—æ»¡ï¼Œæ—¥å¿—ä¼šè¢«ä¸¢å¼ƒ
```

---

## å‚è€ƒèµ„æº

- [OpenTelemetry Logs SDK](https://opentelemetry.io/docs/specs/otel/logs/sdk/)
- [02_Loggeråˆ›å»º.md](./02_Loggeråˆ›å»º.md)
- [04_å¯¼å‡ºå™¨.md](./04_å¯¼å‡ºå™¨.md)

---

**ğŸ‰ å®Œæˆï¼LogRecordProcessor çŸ¥è¯†æŒæ¡ï¼**
