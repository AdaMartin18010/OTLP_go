# 日志批处理

## 📋 目录

- [日志批处理](#日志批处理)
  - [📋 目录](#-目录)
  - [概述](#概述)
  - [批处理配置](#批处理配置)
  - [性能优化](#性能优化)
  - [最佳实践](#最佳实践)
  - [参考资源](#参考资源)

---

## 概述

**批处理** 将多条日志聚合后批量导出，提高性能和效率。

```text
日志 1, 2, 3, 4, 5...
    ↓ (聚合)
批次 [1,2,3,4,5]
    ↓
批量导出
```

---

## 批处理配置

```go
processor := log.NewBatchProcessor(
    exporter,
    // 批处理超时: 5秒
    log.WithBatchTimeout(5*time.Second),
    
    // 最大批次大小: 512条
    log.WithExportMaxBatchSize(512),
    
    // 最大队列大小: 2048条
    log.WithMaxQueueSize(2048),
    
    // 导出超时: 30秒
    log.WithExportTimeout(30*time.Second),
)
```

**参数说明**:

```text
BatchTimeout:
- 默认: 5秒
- 推荐: 1-10秒
- 达到时间后导出

ExportMaxBatchSize:
- 默认: 512
- 推荐: 256-1024
- 达到大小后立即导出

MaxQueueSize:
- 默认: 2048
- 推荐: 1024-4096
- 队列满时丢弃新日志

ExportTimeout:
- 默认: 30秒
- 推荐: 10-30秒
- 单次导出最大时间
```

---

## 性能优化

```go
// 1. 根据日志频率调整
// 高频 (>100 logs/s)
log.WithBatchTimeout(1*time.Second)
log.WithExportMaxBatchSize(1024)

// 中频 (10-100 logs/s)
log.WithBatchTimeout(5*time.Second)
log.WithExportMaxBatchSize(512)

// 低频 (<10 logs/s)
log.WithBatchTimeout(10*time.Second)
log.WithExportMaxBatchSize(256)

// 2. 内存估算
// Memory ≈ MaxQueueSize × AvgLogSize
// 例如: 2048 × 2KB = ~4MB
```

---

## 最佳实践

```go
// ✅ 生产环境配置
processor := log.NewBatchProcessor(exporter,
    log.WithBatchTimeout(5*time.Second),
    log.WithMaxQueueSize(2048),
    log.WithExportMaxBatchSize(512),
)

// ✅ 监控队列
// 如果日志丢失，考虑增加队列大小
log.WithMaxQueueSize(4096)

// ✅ 根据场景调整
// 实时性要求高: 小 timeout
log.WithBatchTimeout(1*time.Second)

// 实时性要求低: 大 timeout
log.WithBatchTimeout(10*time.Second)
```

---

## 参考资源

- [03_处理器.md](./03_处理器.md)
- [04_导出器.md](./04_导出器.md)

---

**🎉 完成！日志批处理知识掌握！**

**🎊🎊🎊 Phase 4.3: Logger Provider 全部完成！🎊🎊🎊**-
