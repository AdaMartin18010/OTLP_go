# LogRecordExporter 导出器

## 📋 目录

- [LogRecordExporter 导出器](#logrecordexporter-导出器)
  - [📋 目录](#-目录)
  - [概述](#概述)
  - [内置导出器](#内置导出器)
    - [1. OTLP Exporter](#1-otlp-exporter)
    - [2. Stdout Exporter](#2-stdout-exporter)
    - [3. File Exporter](#3-file-exporter)
  - [OTLP 配置](#otlp-配置)
  - [Go 1.25.1 实现](#go-1251-实现)
    - [1. 自定义导出器](#1-自定义导出器)
    - [2. 多导出器](#2-多导出器)
  - [性能优化](#性能优化)
  - [最佳实践](#最佳实践)
  - [常见问题](#常见问题)
  - [参考资源](#参考资源)

---

## 概述

**LogRecordExporter** 负责将日志记录发送到后端系统。

```text
Processor
    ↓
Exporter.Export(logs)
    ↓ (gRPC/HTTP)
Backend
```

---

## 内置导出器

### 1. OTLP Exporter

```go
import (
    "go.opentelemetry.io/otel/exporters/otlp/otlplog/otlploggrpc"
    "go.opentelemetry.io/otel/sdk/log"
)

func main() {
    exporter, _ := otlploggrpc.New(
        context.Background(),
        otlploggrpc.WithEndpoint("localhost:4317"),
        otlploggrpc.WithInsecure(),
    )
    
    processor := log.NewBatchProcessor(exporter)
    lp := log.NewLoggerProvider(
        log.WithProcessor(processor),
    )
}
```

### 2. Stdout Exporter

```go
import "go.opentelemetry.io/otel/exporters/stdout/stdoutlog"

exporter, _ := stdoutlog.New(
    stdoutlog.WithPrettyPrint(),
)
```

### 3. File Exporter

```go
// 自定义文件导出器
type FileExporter struct {
    file *os.File
}

func (e *FileExporter) Export(ctx context.Context, records []log.Record) error {
    for _, r := range records {
        fmt.Fprintf(e.file, "%s\n", formatRecord(r))
    }
    return nil
}
```

---

## OTLP 配置

```go
// gRPC 导出器
exporter, _ := otlploggrpc.New(
    context.Background(),
    otlploggrpc.WithEndpoint("collector:4317"),
    otlploggrpc.WithTLSCredentials(...),
    otlploggrpc.WithTimeout(30*time.Second),
    otlploggrpc.WithCompressor("gzip"),
)

// HTTP 导出器
exporter, _ := otlploghttp.New(
    context.Background(),
    otlploghttp.WithEndpoint("collector:4318"),
    otlploghttp.WithURLPath("/v1/logs"),
)
```

---

## Go 1.25.1 实现

### 1. 自定义导出器

```go
type CustomExporter struct {
    endpoint string
}

func (e *CustomExporter) Export(ctx context.Context, records []log.Record) error {
    // 序列化并发送
    data, _ := json.Marshal(records)
    _, err := http.Post(e.endpoint, "application/json", bytes.NewReader(data))
    return err
}

func (e *CustomExporter) Shutdown(ctx context.Context) error {
    return nil
}

func (e *CustomExporter) ForceFlush(ctx context.Context) error {
    return nil
}
```

### 2. 多导出器

```go
type MultiExporter struct {
    exporters []log.Exporter
}

func (e *MultiExporter) Export(ctx context.Context, records []log.Record) error {
    for _, exporter := range e.exporters {
        exporter.Export(ctx, records)
    }
    return nil
}
```

---

## 性能优化

```go
// 1. 启用压缩
otlploggrpc.WithCompressor("gzip")

// 2. 批处理
processor := log.NewBatchProcessor(exporter,
    log.WithExportMaxBatchSize(512),
)

// 3. 配置超时
otlploggrpc.WithTimeout(30*time.Second)
```

---

## 最佳实践

```go
// ✅ 生产环境使用 OTLP
exporter, _ := otlploggrpc.New(
    context.Background(),
    otlploggrpc.WithEndpoint("collector:4317"),
    otlploggrpc.WithTLSCredentials(...),
)

// ✅ 正确关闭
defer exporter.Shutdown(context.Background())

// ✅ 使用环境变量
endpoint := os.Getenv("OTEL_EXPORTER_OTLP_ENDPOINT")
```

---

## 常见问题

**Q1: OTLP gRPC vs HTTP？**

参考 Tracer 的 SpanExporter 文档。

---

## 参考资源

- [OpenTelemetry Logs SDK](https://opentelemetry.io/docs/specs/otel/logs/sdk/)
- [03_处理器.md](./03_处理器.md)

---

**🎉 完成！LogRecordExporter 知识掌握！**
