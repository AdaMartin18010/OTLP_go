# ğŸ“‹ OpenTelemetry Go å¿«é€Ÿå‚è€ƒå¡ç‰‡

**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ9æ—¥

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (5è¡Œä»£ç )

```go
import "go.opentelemetry.io/otel"

// 1. åˆ›å»º Exporter
exporter, _ := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint("localhost:4317"), otlptracegrpc.WithInsecure())

// 2. åˆ›å»º TracerProvider
tp := sdktrace.NewTracerProvider(sdktrace.WithBatcher(exporter))
otel.SetTracerProvider(tp)

// 3. ä½¿ç”¨ Tracer
ctx, span := otel.Tracer("my-tracer").Start(ctx, "operation")
defer span.End()
```

---

## ğŸ“¦ æ ¸å¿ƒä¾èµ–

```go
require (
    go.opentelemetry.io/otel v1.32.0
    go.opentelemetry.io/otel/sdk v1.32.0
    go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc v1.32.0
    go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin v0.58.0
    go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres v0.58.0
)
```

---

## ğŸ¯ Provider é…ç½®é€ŸæŸ¥

### TracerProvider (Traces)

```go
tp := sdktrace.NewTracerProvider(
    // Resource
    sdktrace.WithResource(resource.NewWithAttributes(
        semconv.SchemaURL,
        semconv.ServiceName("my-service"),
        semconv.ServiceVersion("1.0.0"),
    )),
    
    // Sampler (é‡‡æ ·å™¨)
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.1), // 10% é‡‡æ ·
    )),
    
    // Processor (æ‰¹å¤„ç†)
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(5*time.Second),
        sdktrace.WithMaxExportBatchSize(512),
    ),
)
```

### MeterProvider (Metrics)

```go
mp := metric.NewMeterProvider(
    metric.WithResource(res),
    metric.WithReader(metric.NewPeriodicReader(exporter,
        metric.WithInterval(60*time.Second),
    )),
)
```

### LoggerProvider (Logs)

```go
lp := log.NewLoggerProvider(
    log.WithResource(res),
    log.WithProcessor(log.NewBatchProcessor(exporter)),
)

// slog é›†æˆ
handler := otelslog.NewHandler("myapp")
slog.SetDefault(slog.New(handler))
```

---

## ğŸ“Š Span æ“ä½œé€ŸæŸ¥

### åˆ›å»º Span

```go
ctx, span := tracer.Start(ctx, "operation")
defer span.End()
```

### æ·»åŠ å±æ€§

```go
span.SetAttributes(
    attribute.String("user.id", "12345"),
    attribute.Int("http.status_code", 200),
    attribute.Bool("cache.hit", true),
)
```

### è®°å½•äº‹ä»¶

```go
span.AddEvent("cache miss",
    trace.WithAttributes(
        attribute.String("cache.key", key),
    ),
)
```

### è®°å½•é”™è¯¯

```go
if err != nil {
    span.RecordError(err)
    span.SetStatus(codes.Error, err.Error())
}
```

### è®¾ç½®çŠ¶æ€

```go
span.SetStatus(codes.Ok, "success")
span.SetStatus(codes.Error, "failed")
```

---

## ğŸ“ˆ Metric ç±»å‹é€ŸæŸ¥

### Counter (ç´¯åŠ è®¡æ•°)

```go
counter, _ := meter.Int64Counter("http.requests",
    metric.WithDescription("Total HTTP requests"),
    metric.WithUnit("{request}"),
)
counter.Add(ctx, 1, metric.WithAttributes(
    attribute.String("method", "GET"),
))
```

### UpDownCounter (å¯å¢å¯å‡)

```go
upDownCounter, _ := meter.Int64UpDownCounter("queue.size")
upDownCounter.Add(ctx, 1)   // å…¥é˜Ÿ
upDownCounter.Add(ctx, -1)  // å‡ºé˜Ÿ
```

### Histogram (ç›´æ–¹å›¾)

```go
histogram, _ := meter.Float64Histogram("http.duration",
    metric.WithDescription("HTTP request duration"),
    metric.WithUnit("ms"),
)
histogram.Record(ctx, 123.45, metric.WithAttributes(
    attribute.String("method", "GET"),
))
```

### Gauge (å¼‚æ­¥è§‚å¯Ÿ)

```go
gauge, _ := meter.Int64ObservableGauge("memory.used")
_, _ = meter.RegisterCallback(func(ctx context.Context, o metric.Observer) error {
    o.ObserveInt64(gauge, getMemoryUsed())
    return nil
}, gauge)
```

---

## ğŸ” Context ä¼ æ’­é€ŸæŸ¥

### HTTP æœåŠ¡å™¨ (æå–)

```go
// è‡ªåŠ¨ (Gin)
router.Use(otelgin.Middleware("my-service"))

// æ‰‹åŠ¨
ctx := otel.GetTextMapPropagator().Extract(
    r.Context(),
    propagation.HeaderCarrier(r.Header),
)
```

### HTTP å®¢æˆ·ç«¯ (æ³¨å…¥)

```go
// è‡ªåŠ¨ (otelhttp)
client := &http.Client{
    Transport: otelhttp.NewTransport(http.DefaultTransport),
}

// æ‰‹åŠ¨
otel.GetTextMapPropagator().Inject(
    ctx,
    propagation.HeaderCarrier(req.Header),
)
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¿½è¸ªé€ŸæŸ¥

### database/sql

```go
import "go.opentelemetry.io/contrib/instrumentation/database/sql/otelsql"

db, _ := otelsql.Open("postgres", dsn,
    otelsql.WithAttributes(semconv.DBSystemPostgreSQL),
)
```

### GORM

```go
import "go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres"

db, _ := gorm.Open(postgres.Open(dsn), &gorm.Config{})
```

### Redis

```go
import "github.com/go-redis/redis/extra/redisotel/v9"

rdb := redis.NewClient(&redis.Options{...})
redisotel.InstrumentTracing(rdb)
```

---

## ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—è¿½è¸ªé€ŸæŸ¥

### Kafka Producer

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/segmentio/kafka-go/otellkafka"

writer := &kafka.Writer{...}
writer = otellkafka.NewWriter(writer)
```

### Kafka Consumer

```go
reader := &kafka.Reader{...}
reader = otellkafka.NewReader(reader)
```

---

## ğŸŒ Web æ¡†æ¶ä¸­é—´ä»¶é€ŸæŸ¥

### Gin

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"

router := gin.Default()
router.Use(otelgin.Middleware("my-service"))
```

### Echo

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/labstack/echo/otelecho"

e := echo.New()
e.Use(otelecho.Middleware("my-service"))
```

### Fiber

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/gofiber/fiber/v2/otelfiber"

app := fiber.New()
app.Use(otelfiber.Middleware())
```

### Chi

```go
import "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"

r := chi.NewRouter()
r.Use(func(next http.Handler) http.Handler {
    return otelhttp.NewHandler(next, "my-service")
})
```

---

## ğŸ”§ Exporter é…ç½®é€ŸæŸ¥

### OTLP gRPC

```go
exporter, _ := otlptracegrpc.New(
    ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
    otlptracegrpc.WithInsecure(),
    otlptracegrpc.WithCompressor("gzip"),
)
```

### OTLP HTTP

```go
exporter, _ := otlptracehttp.New(
    ctx,
    otlptracehttp.WithEndpoint("localhost:4318"),
    otlptracehttp.WithURLPath("/v1/traces"),
)
```

### Jaeger

```go
exporter, _ := jaeger.New(
    jaeger.WithCollectorEndpoint(jaeger.WithEndpoint("http://localhost:14268/api/traces")),
)
```

### Prometheus

```go
exporter, _ := prometheus.New()
http.Handle("/metrics", promhttp.Handler())
```

---

## âš™ï¸ é‡‡æ ·å™¨é€ŸæŸ¥

### AlwaysOn (100% é‡‡æ ·)

```go
sdktrace.AlwaysSample()
```

### AlwaysOff (ä¸é‡‡æ ·)

```go
sdktrace.NeverSample()
```

### TraceIDRatio (æ¯”ä¾‹é‡‡æ ·)

```go
sdktrace.TraceIDRatioBased(0.1) // 10% é‡‡æ ·
```

### ParentBased (çˆ¶çº§ç»§æ‰¿)

```go
sdktrace.ParentBased(
    sdktrace.TraceIDRatioBased(0.1),
)
```

---

## ğŸ“ Semantic Conventions é€ŸæŸ¥

### HTTP

```go
// è¯·æ±‚
semconv.HTTPMethod("GET")
semconv.HTTPRoute("/api/users/:id")
semconv.HTTPStatusCode(200)
semconv.HTTPURL("https://example.com/api/users/123")

// å“åº”
semconv.HTTPResponseContentLength(1024)
```

### Database

```go
semconv.DBSystem("postgresql")
semconv.DBName("mydb")
semconv.DBStatement("SELECT * FROM users WHERE id = ?")
semconv.DBOperation("SELECT")
```

### RPC

```go
semconv.RPCSystem("grpc")
semconv.RPCService("UserService")
semconv.RPCMethod("GetUser")
semconv.RPCGRPCStatusCode(0)
```

### Messaging

```go
semconv.MessagingSystem("kafka")
semconv.MessagingDestination("orders")
semconv.MessagingOperation("publish")
```

---

## ğŸ” Context å·¥å…·é€ŸæŸ¥ (Go 1.25.1)

### WithoutCancel

```go
// åˆ›å»ºä¸å—çˆ¶ Context å–æ¶ˆå½±å“çš„å­ Context
backgroundCtx := context.WithoutCancel(ctx)
```

### AfterFunc

```go
// Context å–æ¶ˆåæ‰§è¡Œæ¸…ç†
stop := context.AfterFunc(ctx, func() {
    log.Println("Context cancelled, cleaning up...")
})
defer stop()
```

### WithDeadlineCause

```go
// å¸¦åŸå› çš„è¶…æ—¶
ctx, cancel := context.WithDeadlineCause(
    ctx,
    time.Now().Add(5*time.Second),
    errors.New("operation timeout"),
)
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥

### æ‰¹å¤„ç†é…ç½®

```go
// ç”Ÿäº§ç¯å¢ƒæ¨è
sdktrace.WithBatchTimeout(5*time.Second)
sdktrace.WithMaxExportBatchSize(512)
sdktrace.WithMaxQueueSize(2048)
```

### é‡‡æ ·ç­–ç•¥

```go
// é«˜æµé‡: 10% é‡‡æ ·
sdktrace.TraceIDRatioBased(0.1)

// å…³é”®è·¯å¾„: 100% é‡‡æ ·
sdktrace.AlwaysSample()
```

### å‹ç¼©ä¼ è¾“

```go
otlptracegrpc.WithCompressor("gzip")
```

### å±æ€§é™åˆ¶

```go
// é™åˆ¶å±æ€§æ•°é‡
sdktrace.WithAttributeCountLimit(128)
```

---

## ğŸ› æ•…éšœæ’æŸ¥é€ŸæŸ¥

### æ£€æŸ¥ TracerProvider

```go
if tp := otel.GetTracerProvider(); tp != nil {
    log.Println("TracerProvider is set")
}
```

### æ£€æŸ¥ Propagator

```go
prop := otel.GetTextMapPropagator()
log.Printf("Propagator: %T", prop)
```

### è°ƒè¯• Span

```go
span := trace.SpanFromContext(ctx)
if span.SpanContext().IsValid() {
    log.Printf("TraceID: %s, SpanID: %s",
        span.SpanContext().TraceID(),
        span.SpanContext().SpanID(),
    )
}
```

### é”™è¯¯å¤„ç†

```go
otel.SetErrorHandler(otel.ErrorHandlerFunc(func(err error) {
    log.Printf("OTEL error: %v", err)
}))
```

---

## ğŸ“š å¸¸ç”¨å¯¼å…¥è·¯å¾„

```go
// æ ¸å¿ƒ
import "go.opentelemetry.io/otel"
import "go.opentelemetry.io/otel/trace"
import "go.opentelemetry.io/otel/metric"
import "go.opentelemetry.io/otel/propagation"

// SDK
import sdktrace "go.opentelemetry.io/otel/sdk/trace"
import sdkmetric "go.opentelemetry.io/otel/sdk/metric"
import "go.opentelemetry.io/otel/sdk/resource"

// Exporters
import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
import "go.opentelemetry.io/otel/exporters/jaeger"
import "go.opentelemetry.io/otel/exporters/prometheus"

// Semantic Conventions
import semconv "go.opentelemetry.io/otel/semconv/v1.21.0"

// Instrumentation
import "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"
import "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
import "go.opentelemetry.io/contrib/instrumentation/database/sql/otelsql"
import "go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres"
```

---

## ğŸ¯ æ¨èé…ç½®

### å¼€å‘ç¯å¢ƒ

```go
tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sdktrace.AlwaysSample()),
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(1*time.Second),
    ),
)
```

### ç”Ÿäº§ç¯å¢ƒ

```go
tp := sdktrace.NewTracerProvider(
    sdktrace.WithResource(resource.NewWithAttributes(
        semconv.ServiceName("my-service"),
        semconv.ServiceVersion("1.0.0"),
        semconv.DeploymentEnvironment("production"),
    )),
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.1),
    )),
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(5*time.Second),
        sdktrace.WithMaxExportBatchSize(512),
        sdktrace.WithMaxQueueSize(2048),
    ),
)
```

---

## ğŸ”— å¿«é€Ÿé“¾æ¥

- [å®Œæ•´å¯¼èˆª](./00_å¿«é€Ÿå¯¼èˆª.md)
- [å¾®æœåŠ¡ç¤ºä¾‹](./å®æˆ˜æ¡ˆä¾‹/01_å¾®æœåŠ¡å®Œæ•´ç¤ºä¾‹.md)
- [å¸¸è§é—®é¢˜FAQ](./00_å¸¸è§é—®é¢˜FAQ.md)
- [é¡¹ç›®å®ŒæˆæŠ¥å‘Š](./é¡¹ç›®æœ€ç»ˆå®ŒæˆæŠ¥å‘Š_2025_10_09.md)

---

**ğŸ’¡ æç¤º**: å°†æœ¬å¡ç‰‡æ‰“å°æˆ–ä¿å­˜ä¸ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼Œéšæ—¶æŸ¥é˜…ï¼

**ğŸ“… æœ€åæ›´æ–°**: 2025å¹´10æœˆ9æ—¥  
**ğŸ“– æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
