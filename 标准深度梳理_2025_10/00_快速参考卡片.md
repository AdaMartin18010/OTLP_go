# 📋 OpenTelemetry Go 快速参考卡片

**版本**: v1.0.0  
**最后更新**: 2025年10月9日

---

## 🚀 快速开始 (5行代码)

```go
import "go.opentelemetry.io/otel"

// 1. 创建 Exporter
exporter, _ := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint("localhost:4317"), otlptracegrpc.WithInsecure())

// 2. 创建 TracerProvider
tp := sdktrace.NewTracerProvider(sdktrace.WithBatcher(exporter))
otel.SetTracerProvider(tp)

// 3. 使用 Tracer
ctx, span := otel.Tracer("my-tracer").Start(ctx, "operation")
defer span.End()
```

---

## 📦 核心依赖

```go
require (
    go.opentelemetry.io/otel v1.32.0
    go.opentelemetry.io/otel/sdk v1.32.0
    go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc v1.32.0
    go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin v0.58.0
    go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres v0.58.0
)
```

---

## 🎯 Provider 配置速查

### TracerProvider (Traces)

```go
tp := sdktrace.NewTracerProvider(
    // Resource
    sdktrace.WithResource(resource.NewWithAttributes(
        semconv.SchemaURL,
        semconv.ServiceName("my-service"),
        semconv.ServiceVersion("1.0.0"),
    )),
    
    // Sampler (采样器)
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.1), // 10% 采样
    )),
    
    // Processor (批处理)
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(5*time.Second),
        sdktrace.WithMaxExportBatchSize(512),
    ),
)
```

### MeterProvider (Metrics)

```go
mp := metric.NewMeterProvider(
    metric.WithResource(res),
    metric.WithReader(metric.NewPeriodicReader(exporter,
        metric.WithInterval(60*time.Second),
    )),
)
```

### LoggerProvider (Logs)

```go
lp := log.NewLoggerProvider(
    log.WithResource(res),
    log.WithProcessor(log.NewBatchProcessor(exporter)),
)

// slog 集成
handler := otelslog.NewHandler("myapp")
slog.SetDefault(slog.New(handler))
```

---

## 📊 Span 操作速查

### 创建 Span

```go
ctx, span := tracer.Start(ctx, "operation")
defer span.End()
```

### 添加属性

```go
span.SetAttributes(
    attribute.String("user.id", "12345"),
    attribute.Int("http.status_code", 200),
    attribute.Bool("cache.hit", true),
)
```

### 记录事件

```go
span.AddEvent("cache miss",
    trace.WithAttributes(
        attribute.String("cache.key", key),
    ),
)
```

### 记录错误

```go
if err != nil {
    span.RecordError(err)
    span.SetStatus(codes.Error, err.Error())
}
```

### 设置状态

```go
span.SetStatus(codes.Ok, "success")
span.SetStatus(codes.Error, "failed")
```

---

## 📈 Metric 类型速查

### Counter (累加计数)

```go
counter, _ := meter.Int64Counter("http.requests",
    metric.WithDescription("Total HTTP requests"),
    metric.WithUnit("{request}"),
)
counter.Add(ctx, 1, metric.WithAttributes(
    attribute.String("method", "GET"),
))
```

### UpDownCounter (可增可减)

```go
upDownCounter, _ := meter.Int64UpDownCounter("queue.size")
upDownCounter.Add(ctx, 1)   // 入队
upDownCounter.Add(ctx, -1)  // 出队
```

### Histogram (直方图)

```go
histogram, _ := meter.Float64Histogram("http.duration",
    metric.WithDescription("HTTP request duration"),
    metric.WithUnit("ms"),
)
histogram.Record(ctx, 123.45, metric.WithAttributes(
    attribute.String("method", "GET"),
))
```

### Gauge (异步观察)

```go
gauge, _ := meter.Int64ObservableGauge("memory.used")
_, _ = meter.RegisterCallback(func(ctx context.Context, o metric.Observer) error {
    o.ObserveInt64(gauge, getMemoryUsed())
    return nil
}, gauge)
```

---

## 🔍 Context 传播速查

### HTTP 服务器 (提取)

```go
// 自动 (Gin)
router.Use(otelgin.Middleware("my-service"))

// 手动
ctx := otel.GetTextMapPropagator().Extract(
    r.Context(),
    propagation.HeaderCarrier(r.Header),
)
```

### HTTP 客户端 (注入)

```go
// 自动 (otelhttp)
client := &http.Client{
    Transport: otelhttp.NewTransport(http.DefaultTransport),
}

// 手动
otel.GetTextMapPropagator().Inject(
    ctx,
    propagation.HeaderCarrier(req.Header),
)
```

---

## 🗄️ 数据库追踪速查

### database/sql

```go
import "go.opentelemetry.io/contrib/instrumentation/database/sql/otelsql"

db, _ := otelsql.Open("postgres", dsn,
    otelsql.WithAttributes(semconv.DBSystemPostgreSQL),
)
```

### GORM

```go
import "go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres"

db, _ := gorm.Open(postgres.Open(dsn), &gorm.Config{})
```

### Redis

```go
import "github.com/go-redis/redis/extra/redisotel/v9"

rdb := redis.NewClient(&redis.Options{...})
redisotel.InstrumentTracing(rdb)
```

---

## 📨 消息队列追踪速查

### Kafka Producer

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/segmentio/kafka-go/otellkafka"

writer := &kafka.Writer{...}
writer = otellkafka.NewWriter(writer)
```

### Kafka Consumer

```go
reader := &kafka.Reader{...}
reader = otellkafka.NewReader(reader)
```

---

## 🌐 Web 框架中间件速查

### Gin

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"

router := gin.Default()
router.Use(otelgin.Middleware("my-service"))
```

### Echo

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/labstack/echo/otelecho"

e := echo.New()
e.Use(otelecho.Middleware("my-service"))
```

### Fiber

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/gofiber/fiber/v2/otelfiber"

app := fiber.New()
app.Use(otelfiber.Middleware())
```

### Chi

```go
import "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"

r := chi.NewRouter()
r.Use(func(next http.Handler) http.Handler {
    return otelhttp.NewHandler(next, "my-service")
})
```

---

## 🔧 Exporter 配置速查

### OTLP gRPC

```go
exporter, _ := otlptracegrpc.New(
    ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
    otlptracegrpc.WithInsecure(),
    otlptracegrpc.WithCompressor("gzip"),
)
```

### OTLP HTTP

```go
exporter, _ := otlptracehttp.New(
    ctx,
    otlptracehttp.WithEndpoint("localhost:4318"),
    otlptracehttp.WithURLPath("/v1/traces"),
)
```

### Jaeger

```go
exporter, _ := jaeger.New(
    jaeger.WithCollectorEndpoint(jaeger.WithEndpoint("http://localhost:14268/api/traces")),
)
```

### Prometheus

```go
exporter, _ := prometheus.New()
http.Handle("/metrics", promhttp.Handler())
```

---

## ⚙️ 采样器速查

### AlwaysOn (100% 采样)

```go
sdktrace.AlwaysSample()
```

### AlwaysOff (不采样)

```go
sdktrace.NeverSample()
```

### TraceIDRatio (比例采样)

```go
sdktrace.TraceIDRatioBased(0.1) // 10% 采样
```

### ParentBased (父级继承)

```go
sdktrace.ParentBased(
    sdktrace.TraceIDRatioBased(0.1),
)
```

---

## 📝 Semantic Conventions 速查

### HTTP

```go
// 请求
semconv.HTTPMethod("GET")
semconv.HTTPRoute("/api/users/:id")
semconv.HTTPStatusCode(200)
semconv.HTTPURL("https://example.com/api/users/123")

// 响应
semconv.HTTPResponseContentLength(1024)
```

### Database

```go
semconv.DBSystem("postgresql")
semconv.DBName("mydb")
semconv.DBStatement("SELECT * FROM users WHERE id = ?")
semconv.DBOperation("SELECT")
```

### RPC

```go
semconv.RPCSystem("grpc")
semconv.RPCService("UserService")
semconv.RPCMethod("GetUser")
semconv.RPCGRPCStatusCode(0)
```

### Messaging

```go
semconv.MessagingSystem("kafka")
semconv.MessagingDestination("orders")
semconv.MessagingOperation("publish")
```

---

## 🔍 Context 工具速查 (Go 1.25.1)

### WithoutCancel

```go
// 创建不受父 Context 取消影响的子 Context
backgroundCtx := context.WithoutCancel(ctx)
```

### AfterFunc

```go
// Context 取消后执行清理
stop := context.AfterFunc(ctx, func() {
    log.Println("Context cancelled, cleaning up...")
})
defer stop()
```

### WithDeadlineCause

```go
// 带原因的超时
ctx, cancel := context.WithDeadlineCause(
    ctx,
    time.Now().Add(5*time.Second),
    errors.New("operation timeout"),
)
```

---

## ⚡ 性能优化速查

### 批处理配置

```go
// 生产环境推荐
sdktrace.WithBatchTimeout(5*time.Second)
sdktrace.WithMaxExportBatchSize(512)
sdktrace.WithMaxQueueSize(2048)
```

### 采样策略

```go
// 高流量: 10% 采样
sdktrace.TraceIDRatioBased(0.1)

// 关键路径: 100% 采样
sdktrace.AlwaysSample()
```

### 压缩传输

```go
otlptracegrpc.WithCompressor("gzip")
```

### 属性限制

```go
// 限制属性数量
sdktrace.WithAttributeCountLimit(128)
```

---

## 🐛 故障排查速查

### 检查 TracerProvider

```go
if tp := otel.GetTracerProvider(); tp != nil {
    log.Println("TracerProvider is set")
}
```

### 检查 Propagator

```go
prop := otel.GetTextMapPropagator()
log.Printf("Propagator: %T", prop)
```

### 调试 Span

```go
span := trace.SpanFromContext(ctx)
if span.SpanContext().IsValid() {
    log.Printf("TraceID: %s, SpanID: %s",
        span.SpanContext().TraceID(),
        span.SpanContext().SpanID(),
    )
}
```

### 错误处理

```go
otel.SetErrorHandler(otel.ErrorHandlerFunc(func(err error) {
    log.Printf("OTEL error: %v", err)
}))
```

---

## 📚 常用导入路径

```go
// 核心
import "go.opentelemetry.io/otel"
import "go.opentelemetry.io/otel/trace"
import "go.opentelemetry.io/otel/metric"
import "go.opentelemetry.io/otel/propagation"

// SDK
import sdktrace "go.opentelemetry.io/otel/sdk/trace"
import sdkmetric "go.opentelemetry.io/otel/sdk/metric"
import "go.opentelemetry.io/otel/sdk/resource"

// Exporters
import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
import "go.opentelemetry.io/otel/exporters/jaeger"
import "go.opentelemetry.io/otel/exporters/prometheus"

// Semantic Conventions
import semconv "go.opentelemetry.io/otel/semconv/v1.21.0"

// Instrumentation
import "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"
import "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
import "go.opentelemetry.io/contrib/instrumentation/database/sql/otelsql"
import "go.opentelemetry.io/contrib/instrumentation/gorm.io/driver/postgres"
```

---

## 🎯 推荐配置

### 开发环境

```go
tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sdktrace.AlwaysSample()),
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(1*time.Second),
    ),
)
```

### 生产环境

```go
tp := sdktrace.NewTracerProvider(
    sdktrace.WithResource(resource.NewWithAttributes(
        semconv.ServiceName("my-service"),
        semconv.ServiceVersion("1.0.0"),
        semconv.DeploymentEnvironment("production"),
    )),
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.1),
    )),
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(5*time.Second),
        sdktrace.WithMaxExportBatchSize(512),
        sdktrace.WithMaxQueueSize(2048),
    ),
)
```

---

## 🔗 快速链接

- [完整导航](./00_快速导航.md)
- [微服务示例](./实战案例/01_微服务完整示例.md)
- [常见问题FAQ](./00_常见问题FAQ.md)
- [项目完成报告](./项目最终完成报告_2025_10_09.md)

---

**💡 提示**: 将本卡片打印或保存为桌面快捷方式，随时查阅！

**📅 最后更新**: 2025年10月9日  
**📖 文档版本**: v1.0.0
