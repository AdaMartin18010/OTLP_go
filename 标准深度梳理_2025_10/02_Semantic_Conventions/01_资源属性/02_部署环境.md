# 部署环境资源属性 (Deployment Environment Attributes)

> **文档版本**: v1.0.0  
> **OpenTelemetry 版本**: v1.32.0  
> **语义约定版本**: v1.28.0  
> **最后更新**: 2025年10月9日

---

## 📋 目录

- [部署环境资源属性 (Deployment Environment Attributes)](#部署环境资源属性-deployment-environment-attributes)
  - [📋 目录](#-目录)
  - [概述](#概述)
    - [部署环境的定义](#部署环境的定义)
    - [为什么需要部署环境属性?](#为什么需要部署环境属性)
  - [核心属性](#核心属性)
    - [完整属性列表](#完整属性列表)
  - [环境类型](#环境类型)
    - [1. 标准环境类型](#1-标准环境类型)
    - [2. 环境命名规范](#2-环境命名规范)
    - [3. 环境层级](#3-环境层级)
  - [区域与可用区](#区域与可用区)
    - [1. 地理区域](#1-地理区域)
    - [2. 可用区](#2-可用区)
  - [Go 实现](#go-实现)
    - [1. 基础实现](#1-基础实现)
    - [2. 环境配置管理](#2-环境配置管理)
    - [3. 环境特定配置](#3-环境特定配置)
    - [4. Kubernetes 环境检测](#4-kubernetes-环境检测)
  - [最佳实践](#最佳实践)
    - [1. 环境命名标准化](#1-环境命名标准化)
    - [2. 环境保护机制](#2-环境保护机制)
    - [3. 环境特定的遥测配置](#3-环境特定的遥测配置)
    - [4. 环境变量验证](#4-环境变量验证)
  - [参考资源](#参考资源)
    - [官方文档](#官方文档)
    - [相关工具](#相关工具)

---

## 概述

### 部署环境的定义

**形式化定义**:

```text
DeploymentEnvironment = (Environment, Region, AvailabilityZone)

其中:
- Environment: 部署环境类型 (推荐)
- Region: 地理区域 (可选)
- AvailabilityZone: 可用区 (可选)
```

### 为什么需要部署环境属性?

```text
1. 环境隔离
   - 区分生产、预发布、开发环境
   - 避免跨环境数据混淆

2. 问题定位
   - 快速识别问题环境
   - 环境特定的问题分析

3. 性能对比
   - 跨环境性能比较
   - 容量规划与优化

4. 合规与审计
   - 生产环境访问控制
   - 数据保护合规性

5. 灾难恢复
   - 区域故障隔离
   - 跨区域流量切换
```

---

## 核心属性

### 完整属性列表

| 属性名 | 类型 | 必需性 | 描述 | 示例 |
|-------|------|--------|------|------|
| `deployment.environment` | string | 推荐 | 部署环境名称 | `production` |
| `deployment.environment.name` | string | 可选 | 环境显示名称 | `Production US-East` |

**注意**: OpenTelemetry 语义约定中主要使用 `deployment.environment`,其他区域相关属性通常由云平台特定属性提供。

---

## 环境类型

### 1. 标准环境类型

```text
production (生产环境)
  - 对外提供服务的正式环境
  - 最高稳定性和可用性要求
  - 严格的变更控制

staging (预发布环境)
  - 生产前的最后测试环境
  - 配置接近生产环境
  - 用于最终验证

development (开发环境)
  - 开发人员日常开发环境
  - 配置灵活,可随时重启
  - 用于功能开发和调试

test (测试环境)
  - 自动化测试环境
  - 用于 CI/CD 流程
  - 可能有多个实例

qa (QA 环境)
  - 质量保证团队使用
  - 用于功能和回归测试
  - 相对稳定

demo (演示环境)
  - 产品演示和培训
  - 包含示例数据
  - 公开访问
```

### 2. 环境命名规范

```text
✅ 推荐命名:

1. 使用小写
   production, staging, development

2. 使用标准名称
   production (不是 prod, live)
   staging (不是 stage, pre-prod)
   development (不是 dev, devel)

3. 环境变体可使用后缀
   production-us
   production-eu
   staging-team-alpha

❌ 避免:

1. 大小写混合
   ✗ Production, STAGING

2. 缩写过度
   ✗ prod, stg, dev

3. 数字后缀 (除非必要)
   ✗ production1, production2
   ✓ 使用区域: production-us, production-eu
```

### 3. 环境层级

```text
完整的环境层级:

Local (本地)
  ↓
Development (开发)
  ↓
Test (测试)
  ↓
QA (质量保证)
  ↓
Staging (预发布)
  ↓
Production (生产)

简化的环境层级 (小型项目):

Development
  ↓
Staging
  ↓
Production
```

---

## 区域与可用区

### 1. 地理区域

虽然 `deployment.environment` 不直接包含区域信息,但可以通过云平台属性或自定义属性表示:

```text
区域命名示例:

美洲:
  us-east-1, us-west-2
  na-central-1
  sa-east-1

欧洲:
  eu-west-1, eu-central-1
  eu-north-1

亚太:
  ap-southeast-1, ap-northeast-1
  ap-south-1

混合:
  - 使用云厂商标准命名
  - 或自定义: region-country-datacenter
```

### 2. 可用区

```text
可用区命名:

单区域内的可用区:
  us-east-1a, us-east-1b, us-east-1c

数据中心:
  dc1, dc2, dc3
  datacenter-alpha, datacenter-beta
```

---

## Go 实现

### 1. 基础实现

```go
package main

import (
    "context"
    "fmt"
    "log"
    "os"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func initTracerWithEnvironment() (*sdktrace.TracerProvider, error) {
    ctx := context.Background()

    // 创建导出器
    exporter, err := otlptracegrpc.New(ctx,
        otlptracegrpc.WithInsecure(),
        otlptracegrpc.WithEndpoint("localhost:4317"),
    )
    if err != nil {
        return nil, err
    }

    // 创建资源,包含部署环境
    res, err := resource.New(ctx,
        resource.WithAttributes(
            // 服务属性
            semconv.ServiceName("order-service"),
            semconv.ServiceVersion("1.2.3"),
            
            // 部署环境
            semconv.DeploymentEnvironment(getEnvironment()),
        ),
    )
    if err != nil {
        return nil, err
    }

    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(res),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}

// getEnvironment 获取部署环境
func getEnvironment() string {
    env := os.Getenv("DEPLOYMENT_ENVIRONMENT")
    if env == "" {
        env = os.Getenv("ENV")
    }
    if env == "" {
        env = "development" // 默认开发环境
    }
    return env
}

func main() {
    tp, err := initTracerWithEnvironment()
    if err != nil {
        log.Fatalf("Failed to initialize tracer: %v", err)
    }
    defer tp.Shutdown(context.Background())

    fmt.Printf("Running in environment: %s\n", getEnvironment())
}
```

### 2. 环境配置管理

```go
package config

import (
    "fmt"
    "os"
    "strings"
)

// Environment 环境类型
type Environment string

const (
    EnvProduction  Environment = "production"
    EnvStaging     Environment = "staging"
    EnvDevelopment Environment = "development"
    EnvTest        Environment = "test"
    EnvQA          Environment = "qa"
    EnvDemo        Environment = "demo"
)

// EnvironmentConfig 环境配置
type EnvironmentConfig struct {
    Name        Environment
    DisplayName string
    Region      string
    Zone        string
}

// NewEnvironmentConfig 创建环境配置
func NewEnvironmentConfig() *EnvironmentConfig {
    envName := getEnvironmentName()
    
    return &EnvironmentConfig{
        Name:        envName,
        DisplayName: getDisplayName(envName),
        Region:      os.Getenv("REGION"),
        Zone:        os.Getenv("AVAILABILITY_ZONE"),
    }
}

// getEnvironmentName 获取环境名称
func getEnvironmentName() Environment {
    // 优先级1: DEPLOYMENT_ENVIRONMENT
    if env := os.Getenv("DEPLOYMENT_ENVIRONMENT"); env != "" {
        return normalizeEnvironment(env)
    }

    // 优先级2: ENV
    if env := os.Getenv("ENV"); env != "" {
        return normalizeEnvironment(env)
    }

    // 优先级3: 从 Kubernetes 命名空间推断
    if ns := os.Getenv("K8S_NAMESPACE"); ns != "" {
        if strings.Contains(ns, "prod") {
            return EnvProduction
        }
        if strings.Contains(ns, "staging") {
            return EnvStaging
        }
    }

    // 默认: development
    return EnvDevelopment
}

// normalizeEnvironment 标准化环境名称
func normalizeEnvironment(env string) Environment {
    env = strings.ToLower(strings.TrimSpace(env))

    switch env {
    case "production", "prod", "live":
        return EnvProduction
    case "staging", "stage", "pre-prod", "preprod":
        return EnvStaging
    case "development", "dev", "devel":
        return EnvDevelopment
    case "test", "testing":
        return EnvTest
    case "qa", "quality":
        return EnvQA
    case "demo", "demonstration":
        return EnvDemo
    default:
        return Environment(env)
    }
}

// getDisplayName 获取显示名称
func getDisplayName(env Environment) string {
    region := os.Getenv("REGION")
    if region != "" {
        return fmt.Sprintf("%s (%s)", strings.Title(string(env)), region)
    }
    return strings.Title(string(env))
}

// IsProduction 是否生产环境
func (ec *EnvironmentConfig) IsProduction() bool {
    return ec.Name == EnvProduction
}

// IsStaging 是否预发布环境
func (ec *EnvironmentConfig) IsStaging() bool {
    return ec.Name == EnvStaging
}

// IsDevelopment 是否开发环境
func (ec *EnvironmentConfig) IsDevelopment() bool {
    return ec.Name == EnvDevelopment
}

// String 字符串表示
func (ec *EnvironmentConfig) String() string {
    if ec.Region != "" && ec.Zone != "" {
        return fmt.Sprintf("%s (%s, %s)", ec.Name, ec.Region, ec.Zone)
    }
    if ec.Region != "" {
        return fmt.Sprintf("%s (%s)", ec.Name, ec.Region)
    }
    return string(ec.Name)
}
```

### 3. 环境特定配置

```go
package config

import (
    "time"
)

// Config 应用配置
type Config struct {
    Environment *EnvironmentConfig
    
    // 环境特定配置
    LogLevel          string
    EnableDebug       bool
    TraceSampleRate   float64
    MetricInterval    time.Duration
    EnableProfiling   bool
}

// NewConfig 创建配置
func NewConfig() *Config {
    env := NewEnvironmentConfig()
    
    cfg := &Config{
        Environment: env,
    }

    // 根据环境设置默认值
    switch env.Name {
    case EnvProduction:
        cfg.LogLevel = "info"
        cfg.EnableDebug = false
        cfg.TraceSampleRate = 0.01 // 1% 采样
        cfg.MetricInterval = 60 * time.Second
        cfg.EnableProfiling = false

    case EnvStaging:
        cfg.LogLevel = "debug"
        cfg.EnableDebug = true
        cfg.TraceSampleRate = 0.1 // 10% 采样
        cfg.MetricInterval = 30 * time.Second
        cfg.EnableProfiling = true

    case EnvDevelopment:
        cfg.LogLevel = "debug"
        cfg.EnableDebug = true
        cfg.TraceSampleRate = 1.0 // 100% 采样
        cfg.MetricInterval = 10 * time.Second
        cfg.EnableProfiling = true

    default:
        cfg.LogLevel = "info"
        cfg.EnableDebug = false
        cfg.TraceSampleRate = 0.1
        cfg.MetricInterval = 30 * time.Second
        cfg.EnableProfiling = false
    }

    return cfg
}

// 使用示例
func Example() {
    cfg := NewConfig()
    
    fmt.Printf("Environment: %s\n", cfg.Environment)
    fmt.Printf("Log Level: %s\n", cfg.LogLevel)
    fmt.Printf("Trace Sample Rate: %.2f%%\n", cfg.TraceSampleRate*100)
    
    if cfg.Environment.IsProduction() {
        fmt.Println("⚠️  Running in PRODUCTION")
    }
}
```

### 4. Kubernetes 环境检测

```go
package k8s

import (
    "context"
    "os"
    "strings"

    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// NewK8sEnvironmentResource 创建 Kubernetes 环境资源
func NewK8sEnvironmentResource(ctx context.Context) (*resource.Resource, error) {
    attrs := []attribute.KeyValue{
        // 部署环境
        semconv.DeploymentEnvironment(detectK8sEnvironment()),
    }

    // 添加 Kubernetes 特定属性
    if namespace := os.Getenv("K8S_NAMESPACE"); namespace != "" {
        attrs = append(attrs, 
            attribute.String("k8s.namespace.name", namespace))
    }

    if cluster := os.Getenv("K8S_CLUSTER_NAME"); cluster != "" {
        attrs = append(attrs,
            attribute.String("k8s.cluster.name", cluster))
    }

    return resource.New(ctx,
        resource.WithAttributes(attrs...),
        resource.WithFromEnv(),
        resource.WithContainer(),
    )
}

// detectK8sEnvironment 从 Kubernetes 环境检测部署环境
func detectK8sEnvironment() string {
    // 从命名空间检测
    namespace := os.Getenv("K8S_NAMESPACE")
    namespace = strings.ToLower(namespace)

    if strings.Contains(namespace, "prod") {
        return "production"
    }
    if strings.Contains(namespace, "staging") || strings.Contains(namespace, "stage") {
        return "staging"
    }
    if strings.Contains(namespace, "dev") {
        return "development"
    }
    if strings.Contains(namespace, "test") {
        return "test"
    }

    // 从标签检测
    if env := os.Getenv("DEPLOYMENT_ENVIRONMENT"); env != "" {
        return env
    }

    return "unknown"
}

// Kubernetes Deployment 示例
/*
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: production
spec:
  template:
    metadata:
      labels:
        app: order-service
        environment: production
    spec:
      containers:
      - name: order-service
        image: order-service:1.2.3
        env:
        # 部署环境
        - name: DEPLOYMENT_ENVIRONMENT
          value: "production"
        
        # Kubernetes 信息
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        
        - name: K8S_CLUSTER_NAME
          value: "production-us-east"
        
        # 区域信息
        - name: REGION
          value: "us-east-1"
        
        - name: AVAILABILITY_ZONE
          value: "us-east-1a"
*/
```

---

## 最佳实践

### 1. 环境命名标准化

```go
package standards

// 标准环境常量
const (
    // 推荐使用完整名称
    Production  = "production"  // ✓
    Staging     = "staging"     // ✓
    Development = "development" // ✓
    
    // 避免使用缩写
    // Prod = "prod"  // ✗
    // Dev  = "dev"   // ✗
)

// ValidEnvironments 有效环境列表
var ValidEnvironments = map[string]bool{
    "production":  true,
    "staging":     true,
    "development": true,
    "test":        true,
    "qa":          true,
    "demo":        true,
}

// IsValidEnvironment 验证环境名称
func IsValidEnvironment(env string) bool {
    return ValidEnvironments[strings.ToLower(env)]
}

// NormalizeEnvironment 标准化环境名称
func NormalizeEnvironment(env string) (string, error) {
    env = strings.ToLower(strings.TrimSpace(env))
    
    // 映射常见变体
    variants := map[string]string{
        "prod":    "production",
        "live":    "production",
        "stage":   "staging",
        "preprod": "staging",
        "dev":     "development",
        "devel":   "development",
    }
    
    if normalized, ok := variants[env]; ok {
        return normalized, nil
    }
    
    if IsValidEnvironment(env) {
        return env, nil
    }
    
    return "", fmt.Errorf("invalid environment: %s", env)
}
```

### 2. 环境保护机制

```go
package protection

import (
    "fmt"
    "os"
)

// RequireEnvironment 要求特定环境
func RequireEnvironment(required string) error {
    current := os.Getenv("DEPLOYMENT_ENVIRONMENT")
    if current != required {
        return fmt.Errorf("operation requires %s environment, but running in %s", 
            required, current)
    }
    return nil
}

// PreventProduction 防止在生产环境执行
func PreventProduction() error {
    env := os.Getenv("DEPLOYMENT_ENVIRONMENT")
    if env == "production" {
        return fmt.Errorf("operation not allowed in production environment")
    }
    return nil
}

// ConfirmProduction 生产环境确认
func ConfirmProduction(action string) error {
    env := os.Getenv("DEPLOYMENT_ENVIRONMENT")
    if env != "production" {
        return nil // 非生产环境直接通过
    }

    fmt.Printf("⚠️  WARNING: About to perform '%s' in PRODUCTION\n", action)
    fmt.Print("Type 'yes' to confirm: ")
    
    var confirm string
    fmt.Scanln(&confirm)
    
    if confirm != "yes" {
        return fmt.Errorf("operation cancelled")
    }
    
    return nil
}

// 使用示例
func DangerousOperation() error {
    // 防止在生产环境执行
    if err := PreventProduction(); err != nil {
        return err
    }
    
    // 执行操作
    fmt.Println("Performing dangerous operation...")
    return nil
}

func ProductionDeployment() error {
    // 需要确认
    if err := ConfirmProduction("deployment"); err != nil {
        return err
    }
    
    // 执行部署
    fmt.Println("Deploying to production...")
    return nil
}
```

### 3. 环境特定的遥测配置

```go
package telemetry

import (
    "context"
    "time"

    "go.opentelemetry.io/otel/sdk/trace"
)

// NewEnvironmentAwareSampler 创建环境感知采样器
func NewEnvironmentAwareSampler(env string) trace.Sampler {
    switch env {
    case "production":
        // 生产环境: 低采样率
        return trace.TraceIDRatioBased(0.01) // 1%

    case "staging":
        // 预发布环境: 中等采样率
        return trace.TraceIDRatioBased(0.1) // 10%

    case "development", "test":
        // 开发/测试环境: 全采样
        return trace.AlwaysSample()

    default:
        // 默认: 中等采样率
        return trace.TraceIDRatioBased(0.1)
    }
}

// NewEnvironmentAwareExporter 创建环境感知导出器
func NewEnvironmentAwareExporter(ctx context.Context, env string) (trace.SpanExporter, error) {
    switch env {
    case "production":
        // 生产环境: 使用生产端点
        return otlptracegrpc.New(ctx,
            otlptracegrpc.WithEndpoint("otel-collector.prod.svc:4317"),
            otlptracegrpc.WithTLSCredentials(credentials.NewClientTLSFromCert(nil, "")),
        )

    case "staging":
        // 预发布环境: 使用预发布端点
        return otlptracegrpc.New(ctx,
            otlptracegrpc.WithEndpoint("otel-collector.staging.svc:4317"),
            otlptracegrpc.WithInsecure(),
        )

    default:
        // 开发环境: 使用本地端点或控制台
        return stdouttrace.New()
    }
}

// BatchConfig 批处理配置
type BatchConfig struct {
    MaxQueueSize       int
    MaxExportBatchSize int
    BatchTimeout       time.Duration
    ExportTimeout      time.Duration
}

// NewEnvironmentAwareBatchConfig 创建环境感知批处理配置
func NewEnvironmentAwareBatchConfig(env string) BatchConfig {
    switch env {
    case "production":
        return BatchConfig{
            MaxQueueSize:       2048,
            MaxExportBatchSize: 512,
            BatchTimeout:       5 * time.Second,
            ExportTimeout:      30 * time.Second,
        }

    case "staging":
        return BatchConfig{
            MaxQueueSize:       1024,
            MaxExportBatchSize: 256,
            BatchTimeout:       3 * time.Second,
            ExportTimeout:      10 * time.Second,
        }

    default: // development, test
        return BatchConfig{
            MaxQueueSize:       256,
            MaxExportBatchSize: 64,
            BatchTimeout:       1 * time.Second,
            ExportTimeout:      5 * time.Second,
        }
    }
}
```

### 4. 环境变量验证

```go
package validation

import (
    "fmt"
    "os"
)

// ValidateEnvironmentVars 验证环境变量
func ValidateEnvironmentVars() error {
    env := os.Getenv("DEPLOYMENT_ENVIRONMENT")
    
    if env == "" {
        return fmt.Errorf("DEPLOYMENT_ENVIRONMENT not set")
    }

    // 验证环境名称
    validEnvs := map[string]bool{
        "production": true, "staging": true, "development": true,
        "test": true, "qa": true,
    }
    
    if !validEnvs[env] {
        return fmt.Errorf("invalid DEPLOYMENT_ENVIRONMENT: %s", env)
    }

    // 生产环境额外验证
    if env == "production" {
        required := []string{
            "REGION",
            "K8S_CLUSTER_NAME",
            "SERVICE_VERSION",
        }
        
        for _, key := range required {
            if os.Getenv(key) == "" {
                return fmt.Errorf("required env var %s not set for production", key)
            }
        }
    }

    return nil
}

// MustValidateEnvironmentVars 验证环境变量,失败则panic
func MustValidateEnvironmentVars() {
    if err := ValidateEnvironmentVars(); err != nil {
        panic(fmt.Sprintf("Environment validation failed: %v", err))
    }
}
```

---

## 参考资源

### 官方文档

- [OpenTelemetry Semantic Conventions - Deployment](https://opentelemetry.io/docs/specs/semconv/resource/deployment-environment/)
- [Resource Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/resource/)

### 相关工具

- [Kubernetes Downward API](https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/)
- [12-Factor App - Config](https://12factor.net/config)

---

**文档版本**: v1.0.0  
**最后更新**: 2025年10月9日  
**维护者**: OTLP 标准化项目组
