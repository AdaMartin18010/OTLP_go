# 云平台资源属性 (Cloud Platform Resource Attributes)

> **文档版本**: v1.0.0  
> **OpenTelemetry 版本**: v1.32.0  
> **语义约定版本**: v1.28.0  
> **最后更新**: 2025年10月9日

---

## 📋 目录

- [云平台资源属性 (Cloud Platform Resource Attributes)](#云平台资源属性-cloud-platform-resource-attributes)
  - [📋 目录](#-目录)
  - [概述](#概述)
    - [云资源的定义](#云资源的定义)
    - [为什么需要云平台属性?](#为什么需要云平台属性)
  - [通用云属性](#通用云属性)
    - [核心属性](#核心属性)
    - [云服务提供商枚举](#云服务提供商枚举)
  - [AWS 属性](#aws-属性)
    - [1. AWS 核心属性](#1-aws-核心属性)
    - [2. AWS 平台类型](#2-aws-平台类型)
    - [3. AWS EC2 示例](#3-aws-ec2-示例)
    - [4. AWS ECS 示例](#4-aws-ecs-示例)
    - [5. AWS Lambda 示例](#5-aws-lambda-示例)
  - [Azure 属性](#azure-属性)
    - [1. Azure 核心属性](#1-azure-核心属性)
    - [2. Azure 平台类型](#2-azure-平台类型)
    - [3. Azure VM 示例](#3-azure-vm-示例)
    - [4. Azure AKS 示例](#4-azure-aks-示例)
    - [5. Azure Functions 示例](#5-azure-functions-示例)
  - [GCP 属性](#gcp-属性)
    - [1. GCP 核心属性](#1-gcp-核心属性)
    - [2. GCP 平台类型](#2-gcp-平台类型)
    - [3. GCP Compute Engine 示例](#3-gcp-compute-engine-示例)
    - [4. GCP GKE 示例](#4-gcp-gke-示例)
    - [5. GCP Cloud Run 示例](#5-gcp-cloud-run-示例)
  - [Go 实现](#go-实现)
    - [1. 云平台自动检测](#1-云平台自动检测)
    - [2. AWS 资源检测](#2-aws-资源检测)
    - [3. Azure 资源检测](#3-azure-资源检测)
    - [4. GCP 资源检测](#4-gcp-资源检测)
  - [最佳实践](#最佳实践)
    - [1. 云平台检测优先级](#1-云平台检测优先级)
    - [2. 超时设置](#2-超时设置)
    - [3. 缓存元数据](#3-缓存元数据)
  - [参考资源](#参考资源)
    - [官方文档](#官方文档)

---

## 概述

### 云资源的定义

**形式化定义**:

```text
CloudResource = (Provider, Platform, Region, Zone, AccountId, ResourceId)

其中:
- Provider: 云服务提供商 (aws, azure, gcp)
- Platform: 云平台服务 (ec2, ecs, lambda, aks, gke 等)
- Region: 云区域
- Zone: 可用区
- AccountId: 账户/订阅/项目 ID
- ResourceId: 资源唯一标识
```

### 为什么需要云平台属性?

```text
1. 多云管理
   - 统一的云资源标识
   - 跨云平台数据分析

2. 成本分析
   - 按账户/区域聚合成本
   - 资源使用优化

3. 故障定位
   - 快速定位特定云资源
   - 区域级别故障分析

4. 合规审计
   - 跟踪云资源访问
   - 数据主权合规性

5. 容量规划
   - 区域级别负载分析
   - 自动扩缩容决策
```

---

## 通用云属性

### 核心属性

| 属性名 | 类型 | 必需性 | 描述 | 示例 |
|-------|------|--------|------|------|
| `cloud.provider` | string | **必需** | 云服务提供商 | `aws`, `azure`, `gcp` |
| `cloud.platform` | string | 推荐 | 云平台服务 | `aws_ec2`, `azure_vm` |
| `cloud.region` | string | 推荐 | 云区域 | `us-east-1`, `eastus` |
| `cloud.availability_zone` | string | 可选 | 可用区 | `us-east-1a` |
| `cloud.account.id` | string | 推荐 | 账户 ID | `123456789012` |
| `cloud.resource_id` | string | 推荐 | 资源 ID | `i-1234567890abcdef0` |

### 云服务提供商枚举

```text
支持的云服务提供商:

aws        - Amazon Web Services
azure      - Microsoft Azure
gcp        - Google Cloud Platform
alibaba    - Alibaba Cloud
tencent    - Tencent Cloud
```

---

## AWS 属性

### 1. AWS 核心属性

| 属性名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| `cloud.provider` | string | 固定值 `aws` | `aws` |
| `cloud.platform` | string | AWS 服务类型 | `aws_ec2`, `aws_ecs` |
| `cloud.region` | string | AWS 区域 | `us-east-1` |
| `cloud.availability_zone` | string | AWS 可用区 | `us-east-1a` |
| `cloud.account.id` | string | AWS 账户 ID | `123456789012` |

### 2. AWS 平台类型

```text
计算服务:
  aws_ec2          - Amazon EC2
  aws_ecs          - Amazon ECS
  aws_eks          - Amazon EKS
  aws_lambda       - AWS Lambda
  aws_elastic_beanstalk - Elastic Beanstalk

容器服务:
  aws_ecs          - ECS (Elastic Container Service)
  aws_eks          - EKS (Elastic Kubernetes Service)
  aws_fargate      - AWS Fargate

无服务器:
  aws_lambda       - AWS Lambda
  aws_app_runner   - AWS App Runner
```

### 3. AWS EC2 示例

```go
// AWS EC2 实例资源属性
cloud.provider           = "aws"
cloud.platform           = "aws_ec2"
cloud.region             = "us-east-1"
cloud.availability_zone  = "us-east-1a"
cloud.account.id         = "123456789012"
cloud.resource_id        = "i-1234567890abcdef0"

// 补充属性 (自定义或从 host 获取)
host.id                  = "i-1234567890abcdef0"
host.type                = "t3.large"
host.image.id            = "ami-0abcdef1234567890"
```

### 4. AWS ECS 示例

```go
// AWS ECS 任务资源属性
cloud.provider           = "aws"
cloud.platform           = "aws_ecs"
cloud.region             = "us-east-1"
cloud.availability_zone  = "us-east-1a"
cloud.account.id         = "123456789012"

// ECS 特定属性 (需要自定义或使用 container.* 属性)
aws.ecs.container.arn    = "arn:aws:ecs:us-east-1:123456789012:container/..."
aws.ecs.task.arn         = "arn:aws:ecs:us-east-1:123456789012:task/..."
aws.ecs.task.family      = "my-task-family"
aws.ecs.cluster.arn      = "arn:aws:ecs:us-east-1:123456789012:cluster/my-cluster"
```

### 5. AWS Lambda 示例

```go
// AWS Lambda 函数资源属性
cloud.provider           = "aws"
cloud.platform           = "aws_lambda"
cloud.region             = "us-east-1"
cloud.account.id         = "123456789012"

// Lambda 特定属性
faas.name                = "my-function"
faas.version             = "$LATEST"
faas.instance            = "2021/06/28/[$LATEST]abcdef1234567890"
```

---

## Azure 属性

### 1. Azure 核心属性

| 属性名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| `cloud.provider` | string | 固定值 `azure` | `azure` |
| `cloud.platform` | string | Azure 服务类型 | `azure_vm`, `azure_aks` |
| `cloud.region` | string | Azure 区域 | `eastus`, `westeurope` |
| `cloud.account.id` | string | Azure 订阅 ID | `00000000-0000-0000-0000-000000000000` |
| `cloud.resource_id` | string | Azure 资源 ID | `/subscriptions/.../resourceGroups/.../providers/...` |

### 2. Azure 平台类型

```text
计算服务:
  azure_vm             - Azure Virtual Machines
  azure_container_instances - Azure Container Instances
  azure_aks            - Azure Kubernetes Service
  azure_functions      - Azure Functions
  azure_app_service    - Azure App Service

容器服务:
  azure_aks            - AKS (Azure Kubernetes Service)
  azure_container_instances - ACI
  azure_container_apps - Azure Container Apps
```

### 3. Azure VM 示例

```go
// Azure VM 资源属性
cloud.provider           = "azure"
cloud.platform           = "azure_vm"
cloud.region             = "eastus"
cloud.account.id         = "00000000-0000-0000-0000-000000000000"
cloud.resource_id        = "/subscriptions/00000000.../resourceGroups/my-rg/providers/Microsoft.Compute/virtualMachines/my-vm"

// 补充属性
host.id                  = "my-vm"
host.type                = "Standard_D2s_v3"
azure.resourcegroup.name = "my-rg"
```

### 4. Azure AKS 示例

```go
// Azure AKS 资源属性
cloud.provider           = "azure"
cloud.platform           = "azure_aks"
cloud.region             = "eastus"
cloud.account.id         = "00000000-0000-0000-0000-000000000000"

// AKS 特定属性
k8s.cluster.name         = "my-aks-cluster"
azure.resourcegroup.name = "my-rg"
```

### 5. Azure Functions 示例

```go
// Azure Functions 资源属性
cloud.provider           = "azure"
cloud.platform           = "azure_functions"
cloud.region             = "eastus"
cloud.account.id         = "00000000-0000-0000-0000-000000000000"

// Functions 特定属性
faas.name                = "my-function"
faas.version             = "1.0.0"
azure.resourcegroup.name = "my-rg"
```

---

## GCP 属性

### 1. GCP 核心属性

| 属性名 | 类型 | 描述 | 示例 |
|-------|------|------|------|
| `cloud.provider` | string | 固定值 `gcp` | `gcp` |
| `cloud.platform` | string | GCP 服务类型 | `gcp_compute_engine` |
| `cloud.region` | string | GCP 区域 | `us-central1` |
| `cloud.availability_zone` | string | GCP 可用区 | `us-central1-a` |
| `cloud.account.id` | string | GCP 项目 ID | `my-project-123456` |
| `cloud.resource_id` | string | GCP 资源 ID | `1234567890` |

### 2. GCP 平台类型

```text
计算服务:
  gcp_compute_engine   - Google Compute Engine (GCE)
  gcp_cloud_run        - Cloud Run
  gcp_cloud_functions  - Cloud Functions
  gcp_app_engine       - App Engine
  gcp_kubernetes_engine - Google Kubernetes Engine (GKE)

容器服务:
  gcp_kubernetes_engine - GKE
  gcp_cloud_run        - Cloud Run
```

### 3. GCP Compute Engine 示例

```go
// GCP Compute Engine 实例资源属性
cloud.provider           = "gcp"
cloud.platform           = "gcp_compute_engine"
cloud.region             = "us-central1"
cloud.availability_zone  = "us-central1-a"
cloud.account.id         = "my-project-123456"
cloud.resource_id        = "1234567890"

// 补充属性
host.id                  = "1234567890"
host.name                = "my-instance"
host.type                = "n1-standard-4"
```

### 4. GCP GKE 示例

```go
// GCP GKE 资源属性
cloud.provider           = "gcp"
cloud.platform           = "gcp_kubernetes_engine"
cloud.region             = "us-central1"
cloud.account.id         = "my-project-123456"

// GKE 特定属性
k8s.cluster.name         = "my-gke-cluster"
gcp.gke.cluster.location = "us-central1"
```

### 5. GCP Cloud Run 示例

```go
// GCP Cloud Run 资源属性
cloud.provider           = "gcp"
cloud.platform           = "gcp_cloud_run"
cloud.region             = "us-central1"
cloud.account.id         = "my-project-123456"

// Cloud Run 特定属性
faas.name                = "my-service"
faas.version             = "v1"
gcp.cloud_run.job.execution = "my-job-execution-abc123"
```

---

## Go 实现

### 1. 云平台自动检测

```go
package cloud

import (
    "context"
    "io"
    "net/http"
    "os"
    "strings"
    "time"

    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// CloudProvider 云服务提供商
type CloudProvider string

const (
    AWS   CloudProvider = "aws"
    Azure CloudProvider = "azure"
    GCP   CloudProvider = "gcp"
    Unknown CloudProvider = "unknown"
)

// DetectCloudProvider 自动检测云服务提供商
func DetectCloudProvider() CloudProvider {
    // 检测顺序: 环境变量 -> 元数据服务

    // 1. 检查环境变量
    if provider := os.Getenv("CLOUD_PROVIDER"); provider != "" {
        return CloudProvider(strings.ToLower(provider))
    }

    // 2. AWS 检测
    if isAWS() {
        return AWS
    }

    // 3. Azure 检测
    if isAzure() {
        return Azure
    }

    // 4. GCP 检测
    if isGCP() {
        return GCP
    }

    return Unknown
}

// isAWS 检测是否在 AWS 环境
func isAWS() bool {
    // AWS 环境变量
    if os.Getenv("AWS_REGION") != "" || os.Getenv("AWS_DEFAULT_REGION") != "" {
        return true
    }

    // AWS EC2 元数据服务
    return checkMetadataService("http://169.254.169.254/latest/meta-data/")
}

// isAzure 检测是否在 Azure 环境
func isAzure() bool {
    // Azure 环境变量
    if os.Getenv("AZURE_SUBSCRIPTION_ID") != "" {
        return true
    }

    // Azure Instance Metadata Service
    return checkMetadataService("http://169.254.169.254/metadata/instance?api-version=2021-02-01")
}

// isGCP 检测是否在 GCP 环境
func isGCP() bool {
    // GCP 环境变量
    if os.Getenv("GCP_PROJECT") != "" || os.Getenv("GOOGLE_CLOUD_PROJECT") != "" {
        return true
    }

    // GCP Metadata Service
    return checkMetadataService("http://metadata.google.internal/computeMetadata/v1/")
}

// checkMetadataService 检查元数据服务是否可访问
func checkMetadataService(url string) bool {
    client := &http.Client{
        Timeout: 100 * time.Millisecond, // 快速超时
    }

    req, err := http.NewRequest("GET", url, nil)
    if err != nil {
        return false
    }

    // GCP 需要特殊的 header
    if strings.Contains(url, "metadata.google.internal") {
        req.Header.Set("Metadata-Flavor", "Google")
    }

    resp, err := client.Do(req)
    if err != nil {
        return false
    }
    defer resp.Body.Close()

    return resp.StatusCode == 200
}

// NewCloudResource 创建云资源
func NewCloudResource(ctx context.Context) (*resource.Resource, error) {
    provider := DetectCloudProvider()

    switch provider {
    case AWS:
        return NewAWSResource(ctx)
    case Azure:
        return NewAzureResource(ctx)
    case GCP:
        return NewGCPResource(ctx)
    default:
        return resource.New(ctx)
    }
}
```

### 2. AWS 资源检测

```go
package aws

import (
    "context"
    "encoding/json"
    "io"
    "net/http"
    "os"
    "time"

    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
    "go.opentelemetry.io/otel/attribute"
)

const (
    ec2MetadataURL = "http://169.254.169.254/latest/meta-data/"
    ec2DynamicURL  = "http://169.254.169.254/latest/dynamic/"
)

// EC2Metadata EC2 元数据
type EC2Metadata struct {
    InstanceID       string
    InstanceType     string
    Region           string
    AvailabilityZone string
    AccountID        string
    ImageID          string
}

// NewAWSResource 创建 AWS 资源
func NewAWSResource(ctx context.Context) (*resource.Resource, error) {
    attrs := []attribute.KeyValue{
        semconv.CloudProviderAWS,
    }

    // 检测平台类型
    platform := detectAWSPlatform()
    if platform != "" {
        attrs = append(attrs, semconv.CloudPlatform(platform))
    }

    // 获取 EC2 元数据
    metadata, err := getEC2Metadata()
    if err == nil {
        if metadata.Region != "" {
            attrs = append(attrs, semconv.CloudRegion(metadata.Region))
        }
        if metadata.AvailabilityZone != "" {
            attrs = append(attrs, semconv.CloudAvailabilityZone(metadata.AvailabilityZone))
        }
        if metadata.AccountID != "" {
            attrs = append(attrs, semconv.CloudAccountID(metadata.AccountID))
        }
        if metadata.InstanceID != "" {
            attrs = append(attrs, semconv.CloudResourceID(metadata.InstanceID))
            attrs = append(attrs, semconv.HostID(metadata.InstanceID))
        }
        if metadata.InstanceType != "" {
            attrs = append(attrs, semconv.HostType(metadata.InstanceType))
        }
        if metadata.ImageID != "" {
            attrs = append(attrs, semconv.HostImageID(metadata.ImageID))
        }
    }

    // 环境变量优先级更高
    if region := os.Getenv("AWS_REGION"); region != "" {
        attrs = append(attrs, semconv.CloudRegion(region))
    }

    return resource.New(ctx, resource.WithAttributes(attrs...))
}

// detectAWSPlatform 检测 AWS 平台类型
func detectAWSPlatform() string {
    // ECS 检测
    if os.Getenv("ECS_CONTAINER_METADATA_URI") != "" ||
       os.Getenv("ECS_CONTAINER_METADATA_URI_V4") != "" {
        return "aws_ecs"
    }

    // Lambda 检测
    if os.Getenv("AWS_LAMBDA_FUNCTION_NAME") != "" {
        return "aws_lambda"
    }

    // EKS 检测 (通过 Kubernetes 环境判断)
    if os.Getenv("KUBERNETES_SERVICE_HOST") != "" {
        return "aws_eks"
    }

    // 默认 EC2
    return "aws_ec2"
}

// getEC2Metadata 获取 EC2 元数据
func getEC2Metadata() (*EC2Metadata, error) {
    client := &http.Client{
        Timeout: 1 * time.Second,
    }

    metadata := &EC2Metadata{}

    // 获取实例 ID
    if data, err := getMetadata(client, ec2MetadataURL+"instance-id"); err == nil {
        metadata.InstanceID = string(data)
    }

    // 获取实例类型
    if data, err := getMetadata(client, ec2MetadataURL+"instance-type"); err == nil {
        metadata.InstanceType = string(data)
    }

    // 获取区域和可用区
    if data, err := getMetadata(client, ec2MetadataURL+"placement/availability-zone"); err == nil {
        metadata.AvailabilityZone = string(data)
        // 区域是可用区去掉最后一个字符
        if len(metadata.AvailabilityZone) > 0 {
            metadata.Region = metadata.AvailabilityZone[:len(metadata.AvailabilityZone)-1]
        }
    }

    // 获取账户 ID (从 instance identity document)
    if data, err := getMetadata(client, ec2DynamicURL+"instance-identity/document"); err == nil {
        var doc struct {
            AccountID string `json:"accountId"`
            ImageID   string `json:"imageId"`
        }
        if json.Unmarshal(data, &doc) == nil {
            metadata.AccountID = doc.AccountID
            metadata.ImageID = doc.ImageID
        }
    }

    return metadata, nil
}

// getMetadata 获取元数据
func getMetadata(client *http.Client, url string) ([]byte, error) {
    resp, err := client.Get(url)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()

    return io.ReadAll(resp.Body)
}
```

### 3. Azure 资源检测

```go
package azure

import (
    "context"
    "encoding/json"
    "io"
    "net/http"
    "os"
    "time"

    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
    "go.opentelemetry.io/otel/attribute"
)

const (
    azureMetadataURL = "http://169.254.169.254/metadata/instance?api-version=2021-02-01"
)

// AzureMetadata Azure 元数据
type AzureMetadata struct {
    Compute struct {
        AzureEnvironment  string `json:"azEnvironment"`
        Location          string `json:"location"`
        Name              string `json:"name"`
        ResourceGroupName string `json:"resourceGroupName"`
        SubscriptionID    string `json:"subscriptionId"`
        VMID              string `json:"vmId"`
        VMSize            string `json:"vmSize"`
        ResourceID        string `json:"resourceId"`
    } `json:"compute"`
}

// NewAzureResource 创建 Azure 资源
func NewAzureResource(ctx context.Context) (*resource.Resource, error) {
    attrs := []attribute.KeyValue{
        semconv.CloudProviderAzure,
    }

    // 检测平台类型
    platform := detectAzurePlatform()
    if platform != "" {
        attrs = append(attrs, semconv.CloudPlatform(platform))
    }

    // 获取 Azure 元数据
    metadata, err := getAzureMetadata()
    if err == nil {
        if metadata.Compute.Location != "" {
            attrs = append(attrs, semconv.CloudRegion(metadata.Compute.Location))
        }
        if metadata.Compute.SubscriptionID != "" {
            attrs = append(attrs, semconv.CloudAccountID(metadata.Compute.SubscriptionID))
        }
        if metadata.Compute.ResourceID != "" {
            attrs = append(attrs, semconv.CloudResourceID(metadata.Compute.ResourceID))
        }
        if metadata.Compute.Name != "" {
            attrs = append(attrs, semconv.HostID(metadata.Compute.Name))
        }
        if metadata.Compute.VMSize != "" {
            attrs = append(attrs, semconv.HostType(metadata.Compute.VMSize))
        }
        if metadata.Compute.ResourceGroupName != "" {
            attrs = append(attrs, attribute.String("azure.resourcegroup.name", metadata.Compute.ResourceGroupName))
        }
    }

    // 环境变量优先
    if subID := os.Getenv("AZURE_SUBSCRIPTION_ID"); subID != "" {
        attrs = append(attrs, semconv.CloudAccountID(subID))
    }

    return resource.New(ctx, resource.WithAttributes(attrs...))
}

// detectAzurePlatform 检测 Azure 平台类型
func detectAzurePlatform() string {
    // AKS 检测
    if os.Getenv("KUBERNETES_SERVICE_HOST") != "" {
        return "azure_aks"
    }

    // Azure Functions 检测
    if os.Getenv("FUNCTIONS_WORKER_RUNTIME") != "" {
        return "azure_functions"
    }

    // Container Instances 检测
    if os.Getenv("CONTAINER_APP_NAME") != "" {
        return "azure_container_apps"
    }

    // 默认 VM
    return "azure_vm"
}

// getAzureMetadata 获取 Azure 元数据
func getAzureMetadata() (*AzureMetadata, error) {
    client := &http.Client{
        Timeout: 1 * time.Second,
    }

    req, err := http.NewRequest("GET", azureMetadataURL, nil)
    if err != nil {
        return nil, err
    }

    req.Header.Set("Metadata", "true")

    resp, err := client.Do(req)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()

    data, err := io.ReadAll(resp.Body)
    if err != nil {
        return nil, err
    }

    var metadata AzureMetadata
    if err := json.Unmarshal(data, &metadata); err != nil {
        return nil, err
    }

    return &metadata, nil
}
```

### 4. GCP 资源检测

```go
package gcp

import (
    "context"
    "io"
    "net/http"
    "os"
    "strings"
    "time"

    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
    "go.opentelemetry.io/otel/attribute"
)

const (
    gcpMetadataURL = "http://metadata.google.internal/computeMetadata/v1/"
)

// NewGCPResource 创建 GCP 资源
func NewGCPResource(ctx context.Context) (*resource.Resource, error) {
    attrs := []attribute.KeyValue{
        semconv.CloudProviderGCP,
    }

    // 检测平台类型
    platform := detectGCPPlatform()
    if platform != "" {
        attrs = append(attrs, semconv.CloudPlatform(platform))
    }

    // 获取 GCP 元数据
    client := &http.Client{Timeout: 1 * time.Second}

    // 项目 ID
    if projectID, err := getGCPMetadata(client, "project/project-id"); err == nil {
        attrs = append(attrs, semconv.CloudAccountID(projectID))
    }

    // 区域
    if zone, err := getGCPMetadata(client, "instance/zone"); err == nil {
        // zone 格式: projects/PROJECT_NUM/zones/ZONE
        parts := strings.Split(zone, "/")
        if len(parts) > 0 {
            zoneName := parts[len(parts)-1]
            attrs = append(attrs, semconv.CloudAvailabilityZone(zoneName))
            // 区域是 zone 去掉最后的字母
            if idx := strings.LastIndex(zoneName, "-"); idx > 0 {
                region := zoneName[:idx]
                attrs = append(attrs, semconv.CloudRegion(region))
            }
        }
    }

    // 实例 ID
    if instanceID, err := getGCPMetadata(client, "instance/id"); err == nil {
        attrs = append(attrs, semconv.CloudResourceID(instanceID))
        attrs = append(attrs, semconv.HostID(instanceID))
    }

    // 实例名称
    if instanceName, err := getGCPMetadata(client, "instance/name"); err == nil {
        attrs = append(attrs, semconv.HostName(instanceName))
    }

    // 机器类型
    if machineType, err := getGCPMetadata(client, "instance/machine-type"); err == nil {
        // machine-type 格式: projects/PROJECT_NUM/machineTypes/TYPE
        parts := strings.Split(machineType, "/")
        if len(parts) > 0 {
            attrs = append(attrs, semconv.HostType(parts[len(parts)-1]))
        }
    }

    // 环境变量优先
    if projectID := os.Getenv("GOOGLE_CLOUD_PROJECT"); projectID != "" {
        attrs = append(attrs, semconv.CloudAccountID(projectID))
    }

    return resource.New(ctx, resource.WithAttributes(attrs...))
}

// detectGCPPlatform 检测 GCP 平台类型
func detectGCPPlatform() string {
    // GKE 检测
    if os.Getenv("KUBERNETES_SERVICE_HOST") != "" {
        return "gcp_kubernetes_engine"
    }

    // Cloud Run 检测
    if os.Getenv("K_SERVICE") != "" {
        return "gcp_cloud_run"
    }

    // Cloud Functions 检测
    if os.Getenv("FUNCTION_TARGET") != "" {
        return "gcp_cloud_functions"
    }

    // App Engine 检测
    if os.Getenv("GAE_APPLICATION") != "" {
        return "gcp_app_engine"
    }

    // 默认 Compute Engine
    return "gcp_compute_engine"
}

// getGCPMetadata 获取 GCP 元数据
func getGCPMetadata(client *http.Client, path string) (string, error) {
    req, err := http.NewRequest("GET", gcpMetadataURL+path, nil)
    if err != nil {
        return "", err
    }

    req.Header.Set("Metadata-Flavor", "Google")

    resp, err := client.Do(req)
    if err != nil {
        return "", err
    }
    defer resp.Body.Close()

    data, err := io.ReadAll(resp.Body)
    if err != nil {
        return "", err
    }

    return string(data), nil
}
```

---

## 最佳实践

### 1. 云平台检测优先级

```text
推荐的检测优先级:

1. 显式配置 (环境变量)
   CLOUD_PROVIDER=aws

2. 元数据服务
   - AWS: http://169.254.169.254/
   - Azure: http://169.254.169.254/metadata/
   - GCP: http://metadata.google.internal/

3. 特定环境变量
   - AWS: AWS_REGION, AWS_DEFAULT_REGION
   - Azure: AZURE_SUBSCRIPTION_ID
   - GCP: GOOGLE_CLOUD_PROJECT

4. 默认值
   provider = "unknown"
```

### 2. 超时设置

```go
// 元数据服务请求应该快速超时
client := &http.Client{
    Timeout: 100 * time.Millisecond, // 检测时使用极短超时
}

// 获取元数据时可以稍长
client := &http.Client{
    Timeout: 1 * time.Second, // 实际获取时使用1秒超时
}
```

### 3. 缓存元数据

```go
var (
    cachedMetadata *CloudMetadata
    metadataOnce   sync.Once
)

func GetCloudMetadata() *CloudMetadata {
    metadataOnce.Do(func() {
        cachedMetadata = fetchCloudMetadata()
    })
    return cachedMetadata
}
```

---

## 参考资源

### 官方文档

- [OpenTelemetry Semantic Conventions - Cloud](https://opentelemetry.io/docs/specs/semconv/resource/cloud/)
- [AWS EC2 Instance Metadata](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)
- [Azure Instance Metadata Service](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/instance-metadata-service)
- [GCP Instance Metadata](https://cloud.google.com/compute/docs/metadata/overview)

---

**文档版本**: v1.0.0  
**最后更新**: 2025年10月9日  
**维护者**: OTLP 标准化项目组
