# InstrumentationScope å½¢å¼åŒ–å®šä¹‰

## ğŸ“‹ ç›®å½•

- [InstrumentationScope å½¢å¼åŒ–å®šä¹‰](#instrumentationscope-å½¢å¼åŒ–å®šä¹‰)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [åŸºæœ¬å®šä¹‰](#åŸºæœ¬å®šä¹‰)
    - [1. InstrumentationScope å®šä¹‰](#1-instrumentationscope-å®šä¹‰)
    - [2. Scope æ ‡è¯†å®šä¹‰](#2-scope-æ ‡è¯†å®šä¹‰)
    - [3. Attributes å®šä¹‰](#3-attributes-å®šä¹‰)
  - [InstrumentationScope çš„å½¢å¼åŒ–](#instrumentationscope-çš„å½¢å¼åŒ–)
    - [1. å®Œæ•´å®šä¹‰](#1-å®Œæ•´å®šä¹‰)
    - [2. æœ‰æ•ˆæ€§æ¡ä»¶](#2-æœ‰æ•ˆæ€§æ¡ä»¶)
  - [Scope æ“ä½œçš„å½¢å¼åŒ–](#scope-æ“ä½œçš„å½¢å¼åŒ–)
    - [1. ç›¸ç­‰æ“ä½œ](#1-ç›¸ç­‰æ“ä½œ)
    - [2. åŒ¹é…æ“ä½œ](#2-åŒ¹é…æ“ä½œ)
  - [ä¸å˜é‡](#ä¸å˜é‡)
    - [1. Scope ä¸å˜é‡](#1-scope-ä¸å˜é‡)
    - [2. å”¯ä¸€æ€§ä¸å˜é‡](#2-å”¯ä¸€æ€§ä¸å˜é‡)
  - [æ­£ç¡®æ€§è¯æ˜](#æ­£ç¡®æ€§è¯æ˜)
    - [1. ç›¸ç­‰å…³ç³»](#1-ç›¸ç­‰å…³ç³»)
    - [2. å”¯ä¸€æ€§](#2-å”¯ä¸€æ€§)
  - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
    - [1. æ—¶é—´å¤æ‚åº¦](#1-æ—¶é—´å¤æ‚åº¦)
    - [2. ç©ºé—´å¤æ‚åº¦](#2-ç©ºé—´å¤æ‚åº¦)
  - [TLA+ è§„èŒƒ](#tla-è§„èŒƒ)
  - [Go å®ç°éªŒè¯](#go-å®ç°éªŒè¯)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾› OpenTelemetry InstrumentationScope æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬æ•°å­¦æ¨¡å‹ã€æ­£ç¡®æ€§è¯æ˜å’Œæ€§èƒ½åˆ†æã€‚

---

## åŸºæœ¬å®šä¹‰

### 1. InstrumentationScope å®šä¹‰

**å®šä¹‰ 1.1 (InstrumentationScope)**:

InstrumentationScope æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š

\[
S = (N, V, A, D)
\]

å…¶ä¸­ï¼š

- \( N \in \text{String} \): Name (å¿…éœ€)
- \( V \in \text{String} \cup \{\emptyset\} \): Version (å¯é€‰)
- \( A \subseteq \mathbb{K} \times \mathbb{V} \): Attributes (å¯é€‰)
- \( D \in \mathbb{N} \): DroppedAttributesCount

### 2. Scope æ ‡è¯†å®šä¹‰

**å®šä¹‰ 1.2 (Scope Identity)**:

Scope çš„æ ‡è¯†å®šä¹‰ä¸ºï¼š

\[
\text{ID}(S) = \begin{cases}
N & \text{if } V = \emptyset \\
N \oplus V & \text{if } V \neq \emptyset
\end{cases}
\]

å…¶ä¸­ \( \oplus \) è¡¨ç¤ºå­—ç¬¦ä¸²è¿æ¥æ“ä½œï¼ˆé€šå¸¸ç”¨ "@" åˆ†éš”ï¼‰ã€‚

**ç¤ºä¾‹**:
\[
\begin{aligned}
\text{ID}(("myapp", \emptyset, \emptyset, 0)) &= "myapp" \\
\text{ID}(("myapp", "1.0.0", \emptyset, 0)) &= "myapp@1.0.0"
\end{aligned}
\]

### 3. Attributes å®šä¹‰

**å®šä¹‰ 1.3 (Attributes)**:

Attributes æ˜¯ä¸€ä¸ªæœ‰é™æ˜ å°„ï¼š

\[
A: \mathbb{K} \rightharpoonup \mathbb{V}
\]

å…¶ä¸­ï¼š

- \( \mathbb{K} = \text{String} \) (é”®ç©ºé—´)
- \( \mathbb{V} = \text{String} \mid \text{Int} \mid \text{Float} \mid \text{Bool} \) (å€¼ç©ºé—´)
- \( \rightharpoonup \) è¡¨ç¤ºéƒ¨åˆ†å‡½æ•°

---

## InstrumentationScope çš„å½¢å¼åŒ–

### 1. å®Œæ•´å®šä¹‰

**å®šä¹‰ 2.1 (InstrumentationScope é›†åˆ)**:

InstrumentationScope çš„é›†åˆå®šä¹‰ä¸ºï¼š

\[
\mathcal{S} = \{(N, V, A, D) \mid \text{Valid}(N, V, A, D)\}
\]

### 2. æœ‰æ•ˆæ€§æ¡ä»¶

**å®šä¹‰ 2.2 (Valid)**:

InstrumentationScope æœ‰æ•ˆå½“ä¸”ä»…å½“ï¼š

\[
\begin{aligned}
\text{Valid}(S) \iff & \ N \neq \emptyset \\
& \land \text{ValidName}(N) \\
& \land (V = \emptyset \lor \text{ValidVersion}(V)) \\
& \land |A| \leq \text{MaxAttributes} \\
& \land \forall (k, v) \in A: k \neq \emptyset \\
& \land D = \max(0, \text{OriginalCount}(A) - |A|)
\end{aligned}
\]

**æ¡ä»¶è¯´æ˜**:

1. Name éç©º
2. Name ç¬¦åˆå‘½åè§„èŒƒ
3. Version ä¸ºç©ºæˆ–ç¬¦åˆç‰ˆæœ¬è§„èŒƒ
4. Attributes æ•°é‡ä¸è¶…è¿‡é™åˆ¶
5. æ‰€æœ‰å±æ€§é”®éç©º
6. DroppedAttributesCount æ­£ç¡®

**å®šä¹‰ 2.3 (ValidName)**:

æœ‰æ•ˆçš„ Name æ»¡è¶³ï¼š

\[
\text{ValidName}(N) \iff N \in [\text{a-z}][\text{a-z0-9}\_./]^*
\]

å³ï¼šå°å†™å­—æ¯å¼€å¤´ï¼Œåè·Ÿå°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹å·æˆ–æ–œæ ã€‚

**å®šä¹‰ 2.4 (ValidVersion)**:

æœ‰æ•ˆçš„ Version æ»¡è¶³è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼š

\[
\text{ValidVersion}(V) \iff V \in \text{SemVer}
\]

å…¶ä¸­ \( \text{SemVer} = \text{MAJOR}.\text{MINOR}.\text{PATCH}[-\text{PRERELEASE}] \)

---

## Scope æ“ä½œçš„å½¢å¼åŒ–

### 1. ç›¸ç­‰æ“ä½œ

**å®šä¹‰ 3.1 (Scope Equality)**:

ä¸¤ä¸ª Scope ç›¸ç­‰å½“ä¸”ä»…å½“åç§°å’Œç‰ˆæœ¬ç›¸åŒï¼š

\[
S_1 = S_2 \iff N_1 = N_2 \land V_1 = V_2
\]

**æ³¨æ„**: Attributes ä¸å½±å“ Scope çš„ç›¸ç­‰æ€§ã€‚

### 2. åŒ¹é…æ“ä½œ

**å®šä¹‰ 3.2 (Scope Matching)**:

Scope åŒ¹é…ç»™å®šåç§°ï¼š

\[
\text{Matches}(S, n) \iff N = n
\]

**å®šä¹‰ 3.3 (Prefix Matching)**:

Scope åç§°ä»¥ç»™å®šå‰ç¼€å¼€å¤´ï¼š

\[
\text{MatchesPrefix}(S, p) \iff \exists s \in \Sigma^*: N = p \oplus s
\]

---

## ä¸å˜é‡

### 1. Scope ä¸å˜é‡

**ä¸å˜é‡ 4.1 (Name éç©º)**:

\[
\forall S \in \mathcal{S}: N \neq \emptyset
\]

**ä¸å˜é‡ 4.2 (Name æœ‰æ•ˆæ€§)**:

\[
\forall S \in \mathcal{S}: \text{ValidName}(N)
\]

**ä¸å˜é‡ 4.3 (Version æœ‰æ•ˆæ€§)**:

\[
\forall S \in \mathcal{S}: V = \emptyset \lor \text{ValidVersion}(V)
\]

**ä¸å˜é‡ 4.4 (Attributes æ•°é‡)**:

\[
\forall S \in \mathcal{S}: |A| \leq \text{MaxAttributes}
\]

**ä¸å˜é‡ 4.5 (DroppedAttributesCount ä¸€è‡´æ€§)**:

\[
\forall S \in \mathcal{S}: D = \text{OriginalCount}(A) - |A|
\]

### 2. å”¯ä¸€æ€§ä¸å˜é‡

**ä¸å˜é‡ 4.6 (ID å”¯ä¸€æ€§)**:

åœ¨åŒä¸€ Provider ä¸­ï¼Œæ¯ä¸ª \( \text{ID}(S) \) å”¯ä¸€å¯¹åº”ä¸€ä¸ª Scopeï¼š

\[
\forall S_1, S_2 \in \mathcal{S}: \text{ID}(S_1) = \text{ID}(S_2) \Rightarrow S_1 = S_2
\]

---

## æ­£ç¡®æ€§è¯æ˜

### 1. ç›¸ç­‰å…³ç³»

**å®šç† 5.1 (ç›¸ç­‰å…³ç³»çš„æ€§è´¨)**:

Scope çš„ç›¸ç­‰å…³ç³»æ˜¯ç­‰ä»·å…³ç³»ï¼š

**è‡ªåæ€§**:
\[
\forall S: S = S
\]

**è¯æ˜**: æ˜¾ç„¶ \( N = N \land V = V \)ã€‚âˆ

**å¯¹ç§°æ€§**:
\[
S_1 = S_2 \Rightarrow S_2 = S_1
\]

**è¯æ˜**: å¦‚æœ \( N_1 = N_2 \land V_1 = V_2 \)ï¼Œåˆ™ \( N_2 = N_1 \land V_2 = V_1 \)ã€‚âˆ

**ä¼ é€’æ€§**:
\[
S_1 = S_2 \land S_2 = S_3 \Rightarrow S_1 = S_3
\]

**è¯æ˜**:
\[
\begin{aligned}
& N_1 = N_2 \land V_1 = V_2 \\
& N_2 = N_3 \land V_2 = V_3 \\
\Rightarrow & N_1 = N_3 \land V_1 = V_3
\end{aligned}
\]
âˆ

### 2. å”¯ä¸€æ€§

**å®šç† 5.2 (ID å”¯ä¸€æ€§)**:

å¦‚æœä¸¤ä¸ª Scope çš„ ID ç›¸åŒï¼Œåˆ™å®ƒä»¬ç›¸ç­‰ï¼š

\[
\text{ID}(S_1) = \text{ID}(S_2) \Rightarrow S_1 = S_2
\]

**è¯æ˜**:

**æƒ…å†µ 1**: \( V_1 = V_2 = \emptyset \)

\[
\text{ID}(S_1) = N_1, \text{ID}(S_2) = N_2
\]

å¦‚æœ \( N_1 = N_2 \)ï¼Œåˆ™ \( S_1 = S_2 \)ã€‚

**æƒ…å†µ 2**: \( V_1 \neq \emptyset \land V_2 \neq \emptyset \)

\[
\text{ID}(S_1) = N_1 \oplus V_1, \text{ID}(S_2) = N_2 \oplus V_2
\]

å¦‚æœ \( N_1 \oplus V_1 = N_2 \oplus V_2 \)ï¼Œç”±äº \( \oplus \) æ˜¯å•å°„ï¼Œåˆ™ \( N_1 = N_2 \land V_1 = V_2 \)ï¼Œå› æ­¤ \( S_1 = S_2 \)ã€‚

**æƒ…å†µ 3**: \( V_1 = \emptyset \land V_2 \neq \emptyset \) (æˆ–åä¹‹)

\[
\text{ID}(S_1) = N_1, \text{ID}(S_2) = N_2 \oplus V_2
\]

ç”±äºæ ¼å¼ä¸åŒï¼Œ\( N_1 \neq N_2 \oplus V_2 \)ï¼ˆå‡è®¾æ²¡æœ‰ "@" ç¬¦å·å†²çªï¼‰ã€‚

å› æ­¤ï¼ŒID å”¯ä¸€æ€§æˆç«‹ã€‚âˆ

---

## æ€§èƒ½åˆ†æ

### 1. æ—¶é—´å¤æ‚åº¦

**å®šç† 6.1 (Scope åˆ›å»ºå¤æ‚åº¦)**:

åˆ›å»º InstrumentationScope çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{create}}(n) = O(n)
\]

å…¶ä¸­ \( n = |A| \) æ˜¯å±æ€§æ•°é‡ã€‚

**è¯æ˜**:

```text
åˆ›å»º Scope:
  è®¾ç½® Name, Version:  O(1)
  å¤åˆ¶ Attributes:     O(n)
  
æ€»å¤æ‚åº¦: O(n)  âœ“
```

**å®šç† 6.2 (Scope ç›¸ç­‰æ¯”è¾ƒå¤æ‚åº¦)**:

æ¯”è¾ƒä¸¤ä¸ª Scope æ˜¯å¦ç›¸ç­‰çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{equal}}(m_1, m_2) = O(m_1 + m_2)
\]

å…¶ä¸­ \( m_1 = |N_1| + |V_1| \), \( m_2 = |N_2| + |V_2| \)ã€‚

**è¯æ˜**:

```text
ç›¸ç­‰æ¯”è¾ƒ:
  æ¯”è¾ƒ Name:    O(mâ‚)
  æ¯”è¾ƒ Version: O(mâ‚‚)
  
æ€»å¤æ‚åº¦: O(mâ‚ + mâ‚‚)  âœ“
```

**å®šç† 6.3 (ID ç”Ÿæˆå¤æ‚åº¦)**:

ç”Ÿæˆ Scope ID çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{id}}(m) = O(m)
\]

å…¶ä¸­ \( m = |N| + |V| \)ã€‚

### 2. ç©ºé—´å¤æ‚åº¦

**å®šç† 6.4 (Scope ç©ºé—´å¤æ‚åº¦)**:

InstrumentationScope çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š

\[
S_{\text{Scope}}(m, n) = O(m + n)
\]

å…¶ä¸­ï¼š

- \( m = |N| + |V| \): Name å’Œ Version çš„æ€»é•¿åº¦
- \( n = |A| \): Attributes æ•°é‡

**è¯æ˜**:

```text
Scope å­˜å‚¨:
  Name, Version:  O(m)
  Attributes:     O(n)
  DroppedCount:   O(1)
  
æ€»ç©ºé—´: O(m + n)  âœ“
```

---

## TLA+ è§„èŒƒ

```tla
------------------------ MODULE InstrumentationScope ------------------------
EXTENDS Naturals, Sequences, Strings, TLC

CONSTANTS MaxAttributes

VARIABLES 
    scopes,         \* Scope é›†åˆ
    nextID          \* ä¸‹ä¸€ä¸ª ID

TypeInvariant ==
    /\ scopes \in Seq([
        name: STRING,
        version: STRING,
        attributes: [STRING -> STRING],
        droppedAttributesCount: Nat
    ])
    /\ nextID \in Nat

Init ==
    /\ scopes = <<>>
    /\ nextID = 0

\* åˆ›å»º Scope
CreateScope(name, version, attrs) ==
    /\ name /= ""
    /\ Cardinality(DOMAIN attrs) <= MaxAttributes
    /\ nextID' = nextID + 1
    /\ scopes' = Append(scopes, [
        name |-> name,
        version |-> version,
        attributes |-> attrs,
        droppedAttributesCount |-> 0
    ])

\* ç”Ÿæˆ Scope ID
ScopeID(scope) ==
    IF scope.version = ""
    THEN scope.name
    ELSE scope.name \o "@" \o scope.version

\* ä¸å˜é‡ï¼šName éç©º
NameNonEmpty ==
    \A i \in DOMAIN scopes:
        scopes[i].name /= ""

\* ä¸å˜é‡ï¼šAttributes æ•°é‡é™åˆ¶
AttributesLimit ==
    \A i \in DOMAIN scopes:
        Cardinality(DOMAIN scopes[i].attributes) <= MaxAttributes

\* ä¸å˜é‡ï¼šID å”¯ä¸€æ€§
IDUniqueness ==
    \A i, j \in DOMAIN scopes:
        i /= j => ScopeID(scopes[i]) /= ScopeID(scopes[j])

Spec == Init /\ [][CreateScope]_<<scopes, nextID>>

THEOREM Spec => []TypeInvariant
THEOREM Spec => []NameNonEmpty
THEOREM Spec => []AttributesLimit
THEOREM Spec => []IDUniqueness
============================================================================
```

---

## Go å®ç°éªŒè¯

```go
package instrumentation

import (
    "testing"
    "go.opentelemetry.io/otel/attribute"
)

// TestScopeEquality éªŒè¯ç›¸ç­‰å…³ç³»
func TestScopeEquality(t *testing.T) {
    s1 := NewScope("myapp", "1.0.0")
    s2 := NewScope("myapp", "1.0.0")
    s3 := NewScope("myapp", "2.0.0")
    
    // è‡ªåæ€§
    if !s1.Equal(s1) {
        t.Error("è‡ªåæ€§å¤±è´¥")
    }
    
    // å¯¹ç§°æ€§
    if s1.Equal(s2) != s2.Equal(s1) {
        t.Error("å¯¹ç§°æ€§å¤±è´¥")
    }
    
    // ä¼ é€’æ€§
    if s1.Equal(s2) && s2.Equal(s1) && !s1.Equal(s2) {
        t.Error("ä¼ é€’æ€§å¤±è´¥")
    }
    
    // ä¸åŒç‰ˆæœ¬ä¸ç›¸ç­‰
    if s1.Equal(s3) {
        t.Error("ä¸åŒç‰ˆæœ¬åº”è¯¥ä¸ç›¸ç­‰")
    }
}

// TestScopeIDUniqueness éªŒè¯ ID å”¯ä¸€æ€§
func TestScopeIDUniqueness(t *testing.T) {
    s1 := NewScope("myapp", "1.0.0")
    s2 := NewScope("myapp", "1.0.0")
    s3 := NewScope("myapp", "2.0.0")
    
    // ç›¸åŒ Scopeï¼Œç›¸åŒ ID
    if s1.UniqueID() != s2.UniqueID() {
        t.Error("ç›¸åŒ Scope åº”è¯¥æœ‰ç›¸åŒ ID")
    }
    
    // ä¸åŒ Scopeï¼Œä¸åŒ ID
    if s1.UniqueID() == s3.UniqueID() {
        t.Error("ä¸åŒ Scope åº”è¯¥æœ‰ä¸åŒ ID")
    }
}

// TestScopeImmutability éªŒè¯ä¸å¯å˜æ€§
func TestScopeImmutability(t *testing.T) {
    attrs := []attribute.KeyValue{
        attribute.String("key", "value"),
    }
    
    scope := NewScope("myapp", "1.0.0", attrs...)
    originalID := scope.UniqueID()
    
    // ä¿®æ”¹åŸå§‹å±æ€§ä¸åº”å½±å“ Scope
    attrs[0] = attribute.String("key", "newvalue")
    
    if scope.UniqueID() != originalID {
        t.Error("Scope åº”è¯¥æ˜¯ä¸å¯å˜çš„")
    }
}
```

---

## å‚è€ƒèµ„æº

- [OpenTelemetry InstrumentationScope Spec](https://opentelemetry.io/docs/specs/otel/glossary/#instrumentation-scope)
- [TLA+ Specification](https://lamport.azurewebsites.net/tla/tla.html)
- [01_Scopeå®šä¹‰.md](./01_Scopeå®šä¹‰.md)
- [02_Scopeç®¡ç†.md](./02_Scopeç®¡ç†.md)

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»å®Œæˆäº† InstrumentationScope æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼**

æœ¬æ–‡æ¡£æä¾›äº†ï¼š

- âœ… å®Œæ•´çš„æ•°å­¦å®šä¹‰
- âœ… ä¸¥æ ¼çš„ä¸å˜é‡åˆ†æ
- âœ… æ­£ç¡®æ€§è¯æ˜
- âœ… æ€§èƒ½å¤æ‚åº¦åˆ†æ
- âœ… TLA+ å½¢å¼åŒ–è§„èŒƒ
- âœ… Go å®ç°éªŒè¯

**Phase 3.5: InstrumentationScope æ•°æ®æ¨¡å‹ å…¨éƒ¨å®Œæˆï¼** ğŸŠ
