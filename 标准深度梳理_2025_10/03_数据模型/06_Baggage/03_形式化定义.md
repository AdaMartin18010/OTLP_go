# Baggage å½¢å¼åŒ–å®šä¹‰

## ğŸ“‹ ç›®å½•

- [Baggage å½¢å¼åŒ–å®šä¹‰](#baggage-å½¢å¼åŒ–å®šä¹‰)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [åŸºæœ¬å®šä¹‰](#åŸºæœ¬å®šä¹‰)
    - [1. Baggage å®šä¹‰](#1-baggage-å®šä¹‰)
    - [2. Member å®šä¹‰](#2-member-å®šä¹‰)
    - [3. Metadata å®šä¹‰](#3-metadata-å®šä¹‰)
  - [Baggage çš„å½¢å¼åŒ–](#baggage-çš„å½¢å¼åŒ–)
    - [1. å®Œæ•´å®šä¹‰](#1-å®Œæ•´å®šä¹‰)
    - [2. æœ‰æ•ˆæ€§æ¡ä»¶](#2-æœ‰æ•ˆæ€§æ¡ä»¶)
  - [Baggage æ“ä½œçš„å½¢å¼åŒ–](#baggage-æ“ä½œçš„å½¢å¼åŒ–)
    - [1. è®¾ç½®æ“ä½œ](#1-è®¾ç½®æ“ä½œ)
    - [2. åˆ é™¤æ“ä½œ](#2-åˆ é™¤æ“ä½œ)
    - [3. åˆå¹¶æ“ä½œ](#3-åˆå¹¶æ“ä½œ)
  - [ä¸å˜é‡](#ä¸å˜é‡)
    - [1. Baggage ä¸å˜é‡](#1-baggage-ä¸å˜é‡)
    - [2. ä¼ æ’­ä¸å˜é‡](#2-ä¼ æ’­ä¸å˜é‡)
  - [æ­£ç¡®æ€§è¯æ˜](#æ­£ç¡®æ€§è¯æ˜)
    - [1. è®¾ç½®æ“ä½œæ­£ç¡®æ€§](#1-è®¾ç½®æ“ä½œæ­£ç¡®æ€§)
    - [2. åˆå¹¶æ“ä½œäº¤æ¢å¾‹](#2-åˆå¹¶æ“ä½œäº¤æ¢å¾‹)
    - [3. ä¸å¯å˜æ€§](#3-ä¸å¯å˜æ€§)
  - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
    - [1. æ—¶é—´å¤æ‚åº¦](#1-æ—¶é—´å¤æ‚åº¦)
    - [2. ç©ºé—´å¤æ‚åº¦](#2-ç©ºé—´å¤æ‚åº¦)
  - [TLA+ è§„èŒƒ](#tla-è§„èŒƒ)
  - [Go å®ç°éªŒè¯](#go-å®ç°éªŒè¯)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾› OpenTelemetry Baggage æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬æ•°å­¦æ¨¡å‹ã€æ­£ç¡®æ€§è¯æ˜å’Œæ€§èƒ½åˆ†æã€‚

---

## åŸºæœ¬å®šä¹‰

### 1. Baggage å®šä¹‰

**å®šä¹‰ 1.1 (Baggage)**:

Baggage æ˜¯ä¸€ä¸ªæœ‰é™æ˜ å°„ï¼š

\[
B: \mathbb{K} \rightharpoonup M
\]

å…¶ä¸­ï¼š

- \( \mathbb{K} = \text{String} \): é”®ç©ºé—´
- \( M \): Member é›†åˆ
- \( \rightharpoonup \): éƒ¨åˆ†å‡½æ•°ï¼ˆé”®å”¯ä¸€ï¼‰

### 2. Member å®šä¹‰

**å®šä¹‰ 1.2 (Member)**:

Member æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š

\[
m = (k, v, d)
\]

å…¶ä¸­ï¼š

- \( k \in \mathbb{K} \): Key
- \( v \in \mathbb{V} = \text{String} \): Value
- \( d \in \mathbb{D} = \text{String} \cup \{\emptyset\} \): Metadata (å¯é€‰)

### 3. Metadata å®šä¹‰

**å®šä¹‰ 1.3 (Metadata)**:

Metadata æ˜¯ä¸€ä¸ªå±æ€§åˆ—è¡¨ï¼š

\[
d = [p_1, p_2, ..., p_n]
\]

å…¶ä¸­æ¯ä¸ªå±æ€§ \( p_i \) æ˜¯ä¸€ä¸ªé”®å€¼å¯¹æˆ–å•ä¸ªé”®ã€‚

---

## Baggage çš„å½¢å¼åŒ–

### 1. å®Œæ•´å®šä¹‰

**å®šä¹‰ 2.1 (Baggage é›†åˆ)**:

Baggage çš„é›†åˆå®šä¹‰ä¸ºï¼š

\[
\mathcal{B} = \{B: \mathbb{K} \rightharpoonup M \mid \text{Valid}(B)\}
\]

### 2. æœ‰æ•ˆæ€§æ¡ä»¶

**å®šä¹‰ 2.2 (Valid)**:

Baggage æœ‰æ•ˆå½“ä¸”ä»…å½“ï¼š

\[
\begin{aligned}
\text{Valid}(B) \iff & \ |B| \leq \text{MaxMembers} \\
& \land \sum_{(k, m) \in B} (|k| + |m.v|) \leq \text{MaxTotalSize} \\
& \land \forall (k, m) \in B: \text{ValidKey}(k) \\
& \land \forall (k, m) \in B: \text{ValidValue}(m.v) \\
& \land \forall (k, m) \in B: |k| + |m.v| \leq \text{MaxMemberSize}
\end{aligned}
\]

**æ¡ä»¶è¯´æ˜**:

1. æˆå‘˜æ•°é‡ä¸è¶…è¿‡é™åˆ¶ï¼ˆé€šå¸¸ 180ï¼‰
2. æ€»å¤§å°ä¸è¶…è¿‡é™åˆ¶ï¼ˆé€šå¸¸ 8192 å­—èŠ‚ï¼‰
3. æ‰€æœ‰é”®æœ‰æ•ˆï¼ˆç¬¦åˆå‘½åè§„èŒƒï¼‰
4. æ‰€æœ‰å€¼æœ‰æ•ˆï¼ˆURL å®‰å…¨å­—ç¬¦ï¼‰
5. å•ä¸ªæˆå‘˜å¤§å°ä¸è¶…è¿‡é™åˆ¶ï¼ˆé€šå¸¸ 4096 å­—èŠ‚ï¼‰

**å®šä¹‰ 2.3 (ValidKey)**:

æœ‰æ•ˆçš„é”®æ»¡è¶³ï¼š

\[
\text{ValidKey}(k) \iff k \in [\text{a-z0-9}][\text{a-z0-9}\_\text{-}]^* \land k \neq \emptyset
\]

**å®šä¹‰ 2.4 (ValidValue)**:

æœ‰æ•ˆçš„å€¼æ»¡è¶³ URL ç¼–ç è§„èŒƒã€‚

---

## Baggage æ“ä½œçš„å½¢å¼åŒ–

### 1. è®¾ç½®æ“ä½œ

**å®šä¹‰ 3.1 (SetMember)**:

è®¾ç½®æˆå‘˜æ“ä½œ \( \text{set}: \mathcal{B} \times M \rightarrow \mathcal{B} \)ï¼š

\[
\text{set}(B, m) = B' \text{ where } B'(k) = \begin{cases}
m & \text{if } k = m.k \\
B(k) & \text{otherwise}
\end{cases}
\]

**è¯­ä¹‰**: å¦‚æœé”®å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°ï¼›å¦åˆ™æ·»åŠ æ–°æˆå‘˜ã€‚

### 2. åˆ é™¤æ“ä½œ

**å®šä¹‰ 3.2 (DeleteMember)**:

åˆ é™¤æˆå‘˜æ“ä½œ \( \text{del}: \mathcal{B} \times \mathbb{K} \rightarrow \mathcal{B} \)ï¼š

\[
\text{del}(B, k) = \{(k', m) \in B \mid k' \neq k\}
\]

### 3. åˆå¹¶æ“ä½œ

**å®šä¹‰ 3.3 (Merge)**:

åˆå¹¶æ“ä½œ \( \oplus: \mathcal{B} \times \mathcal{B} \rightarrow \mathcal{B} \)ï¼š

\[
B_1 \oplus B_2 = \{(k, m) \mid (k, m) \in B_1 \lor ((k, m) \in B_2 \land k \notin \text{keys}(B_1))\}
\]

**è¯­ä¹‰**: å·¦ä¼˜å…ˆåˆå¹¶ï¼Œ\( B_1 \) çš„æˆå‘˜è¦†ç›– \( B_2 \) çš„åŒåæˆå‘˜ã€‚

---

## ä¸å˜é‡

### 1. Baggage ä¸å˜é‡

**ä¸å˜é‡ 4.1 (é”®å”¯ä¸€æ€§)**:

\[
\forall (k_1, m_1), (k_2, m_2) \in B: k_1 = k_2 \Rightarrow m_1 = m_2
\]

**ä¸å˜é‡ 4.2 (æˆå‘˜æ•°é‡)**:

\[
\forall B \in \mathcal{B}: |B| \leq \text{MaxMembers}
\]

**ä¸å˜é‡ 4.3 (æ€»å¤§å°)**:

\[
\forall B \in \mathcal{B}: \sum_{(k, m) \in B} (|k| + |m.v|) \leq \text{MaxTotalSize}
\]

**ä¸å˜é‡ 4.4 (æˆå‘˜å¤§å°)**:

\[
\forall (k, m) \in B: |k| + |m.v| \leq \text{MaxMemberSize}
\]

### 2. ä¼ æ’­ä¸å˜é‡

**ä¸å˜é‡ 4.5 (ä¼ æ’­ä¿æŒæ€§)**:

åœ¨è·¨æœåŠ¡ä¼ æ’­è¿‡ç¨‹ä¸­ï¼ŒBaggage çš„é”®å€¼å¯¹ä¿æŒä¸å˜ï¼ˆé™¤éæ˜¾å¼ä¿®æ”¹ï¼‰ï¼š

\[
\text{Propagate}(B) = B
\]

**ä¸å˜é‡ 4.6 (ä¼ æ’­æœ‰ç•Œæ€§)**:

ä¼ æ’­åçš„ Baggage å¤§å°ä¸è¶…è¿‡åŸå¤§å°ï¼š

\[
|\text{Propagate}(B)| \leq |B|
\]

---

## æ­£ç¡®æ€§è¯æ˜

### 1. è®¾ç½®æ“ä½œæ­£ç¡®æ€§

**å®šç† 5.1 (è®¾ç½®æ“ä½œå¹‚ç­‰æ€§)**:

å¯¹äºåŒä¸€æˆå‘˜ï¼Œè¿ç»­è®¾ç½®ä¸¤æ¬¡ç­‰ä»·äºè®¾ç½®ä¸€æ¬¡ï¼š

\[
\text{set}(\text{set}(B, m), m) = \text{set}(B, m)
\]

**è¯æ˜**:

è®¾ \( B' = \text{set}(B, m) \)ï¼Œåˆ™ \( B'(m.k) = m \)ã€‚

å†æ¬¡è®¾ç½®ï¼š
\[
\text{set}(B', m) = B'' \text{ where } B''(m.k) = m
\]

å› ä¸º \( B'(m.k) = m \) ä¸” \( B''(m.k) = m \)ï¼Œæ‰€ä»¥ \( B' = B'' \)ã€‚âˆ

### 2. åˆå¹¶æ“ä½œäº¤æ¢å¾‹

**å®šç† 5.2 (åˆå¹¶ä¸æ»¡è¶³äº¤æ¢å¾‹)**:

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ\( B_1 \oplus B_2 \neq B_2 \oplus B_1 \)ã€‚

**è¯æ˜**:

åä¾‹ï¼šè®¾ \( B_1 = \{(k, m_1)\} \)ï¼Œ\( B_2 = \{(k, m_2)\} \)ï¼Œå…¶ä¸­ \( m_1 \neq m_2 \)ã€‚

\[
\begin{aligned}
B_1 \oplus B_2 &= \{(k, m_1)\} & \text{(} m_1 \text{ æ¥è‡ª } B_1\text{)} \\
B_2 \oplus B_1 &= \{(k, m_2)\} & \text{(} m_2 \text{ æ¥è‡ª } B_2\text{)}
\end{aligned}
\]

å› æ­¤ï¼Œ\( B_1 \oplus B_2 \neq B_2 \oplus B_1 \)ã€‚âˆ

**æ¨è®º**: åˆå¹¶æ“ä½œä¾èµ–äºé¡ºåºï¼Œå¿…é¡»æ˜ç¡®ä¼˜å…ˆçº§ã€‚

**å®šç† 5.3 (åˆå¹¶ç»“åˆå¾‹)**:

\[
(B_1 \oplus B_2) \oplus B_3 = B_1 \oplus (B_2 \oplus B_3)
\]

**è¯æ˜**: å¯¹äºä»»æ„é”® \( k \)ï¼š

- å¦‚æœ \( k \in \text{keys}(B_1) \)ï¼Œä¸¤ä¾§éƒ½ä½¿ç”¨ \( B_1 \) çš„æˆå‘˜
- å¦‚æœ \( k \notin \text{keys}(B_1) \land k \in \text{keys}(B_2) \)ï¼Œä¸¤ä¾§éƒ½ä½¿ç”¨ \( B_2 \) çš„æˆå‘˜
- å¦‚æœ \( k \notin \text{keys}(B_1) \land k \notin \text{keys}(B_2) \)ï¼Œä¸¤ä¾§éƒ½ä½¿ç”¨ \( B_3 \) çš„æˆå‘˜

ç»“åˆå¾‹æˆç«‹ã€‚âˆ

### 3. ä¸å¯å˜æ€§

**å®šç† 5.4 (æ“ä½œä¸å¯å˜æ€§)**:

æ‰€æœ‰ Baggage æ“ä½œéƒ½è¿”å›æ–°çš„ Baggageï¼Œä¸ä¿®æ”¹åŸæœ‰ï¼š

\[
\forall B \in \mathcal{B}, m \in M: \text{set}(B, m) \neq B \Rightarrow B \text{ æœªè¢«ä¿®æ”¹}
\]

**è¯æ˜**: ç”± Go çš„ä¸å¯å˜å®ç°ä¿è¯ã€‚âˆ

---

## æ€§èƒ½åˆ†æ

### 1. æ—¶é—´å¤æ‚åº¦

**å®šç† 6.1 (Member æŸ¥æ‰¾å¤æ‚åº¦)**:

æŸ¥æ‰¾æˆå‘˜çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{lookup}}(n) = O(1) \text{ (å¹³å‡)} \text{ æˆ– } O(n) \text{ (æœ€å)}
\]

å…¶ä¸­ \( n = |B| \)ã€‚

**å®šç† 6.2 (è®¾ç½®æ“ä½œå¤æ‚åº¦)**:

è®¾ç½®æˆå‘˜çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{set}}(n) = O(n)
\]

**è¯æ˜**: éœ€è¦å¤åˆ¶æ•´ä¸ª Baggageï¼ˆä¸å¯å˜è®¾è®¡ï¼‰ã€‚

**å®šç† 6.3 (åˆå¹¶æ“ä½œå¤æ‚åº¦)**:

åˆå¹¶ä¸¤ä¸ª Baggage çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{merge}}(n_1, n_2) = O(n_1 + n_2)
\]

**è¯æ˜**:

```text
åˆå¹¶æ“ä½œ:
  éå† Bâ‚:  O(nâ‚)
  éå† Bâ‚‚:  O(nâ‚‚)
  
æ€»å¤æ‚åº¦: O(nâ‚ + nâ‚‚)  âœ“
```

### 2. ç©ºé—´å¤æ‚åº¦

**å®šç† 6.4 (Baggage ç©ºé—´å¤æ‚åº¦)**:

Baggage çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š

\[
S_{\text{Baggage}}(n, m) = O(n \cdot m)
\]

å…¶ä¸­ï¼š

- \( n = |B| \): æˆå‘˜æ•°é‡
- \( m \): å¹³å‡æˆå‘˜å¤§å°

**çº¦æŸ**:
\[
S_{\text{Baggage}} \leq \text{MaxTotalSize} = 8192 \text{ bytes}
\]

---

## TLA+ è§„èŒƒ

```tla
--------------------------- MODULE Baggage ---------------------------
EXTENDS Naturals, Sequences, Strings, TLC

CONSTANTS MaxMembers, MaxTotalSize, MaxMemberSize

VARIABLES 
    baggages,       \* Baggage é›†åˆ
    nextID          \* ä¸‹ä¸€ä¸ª ID

TypeInvariant ==
    /\ baggages \in Seq([
        members: [STRING -> [value: STRING, metadata: STRING]]
    ])
    /\ nextID \in Nat

Init ==
    /\ baggages = <<>>
    /\ nextID = 0

\* è®¡ç®— Baggage å¤§å°
BaggageSize(bag) ==
    LET keys == DOMAIN bag.members
        sizes == {Len(k) + Len(bag.members[k].value) : k \in keys}
    IN  IF sizes = {} THEN 0 ELSE CHOOSE n \in Nat : 
            n = (CHOOSE s \in sizes : TRUE) \* ç®€åŒ–

\* åˆ›å»º Baggage
CreateBaggage(members) ==
    /\ Cardinality(DOMAIN members) <= MaxMembers
    /\ nextID' = nextID + 1
    /\ baggages' = Append(baggages, [members |-> members])

\* è®¾ç½®æˆå‘˜
SetMember(bagID, key, value, metadata) ==
    /\ bagID \in DOMAIN baggages
    /\ LET bag == baggages[bagID]
           newMembers == [k \in (DOMAIN bag.members \cup {key}) |->
               IF k = key 
               THEN [value |-> value, metadata |-> metadata]
               ELSE bag.members[k]
           ]
       IN /\ Cardinality(DOMAIN newMembers) <= MaxMembers
          /\ nextID' = nextID + 1
          /\ baggages' = Append(baggages, [members |-> newMembers])

\* ä¸å˜é‡ï¼šæˆå‘˜æ•°é‡é™åˆ¶
MemberCountLimit ==
    \A i \in DOMAIN baggages:
        Cardinality(DOMAIN baggages[i].members) <= MaxMembers

\* ä¸å˜é‡ï¼šé”®å”¯ä¸€æ€§
KeyUniqueness ==
    \A i \in DOMAIN baggages:
        \A k1, k2 \in DOMAIN baggages[i].members:
            k1 = k2 => baggages[i].members[k1] = baggages[i].members[k2]

Spec == Init /\ [][CreateBaggage \/ SetMember]_<<baggages, nextID>>

THEOREM Spec => []TypeInvariant
THEOREM Spec => []MemberCountLimit
THEOREM Spec => []KeyUniqueness
=======================================================================
```

---

## Go å®ç°éªŒè¯

```go
package baggage

import (
    "testing"
    "go.opentelemetry.io/otel/baggage"
)

// TestBaggageImmutability éªŒè¯ä¸å¯å˜æ€§
func TestBaggageImmutability(t *testing.T) {
    m1, _ := baggage.NewMember("key1", "value1")
    bag1, _ := baggage.New(m1)
    
    // æ·»åŠ æ–°æˆå‘˜
    m2, _ := baggage.NewMember("key2", "value2")
    bag2, _ := bag1.SetMember(m2)
    
    // éªŒè¯ bag1 æœªè¢«ä¿®æ”¹
    if bag1.Member("key2").Value() != "" {
        t.Error("bag1 should not be modified")
    }
    
    // éªŒè¯ bag2 åŒ…å«ä¸¤ä¸ªæˆå‘˜
    if len(bag2.Members()) != 2 {
        t.Error("bag2 should have 2 members")
    }
}

// TestBaggageMerge éªŒè¯åˆå¹¶æ“ä½œ
func TestBaggageMerge(t *testing.T) {
    m1, _ := baggage.NewMember("key1", "value1")
    bag1, _ := baggage.New(m1)
    
    m2, _ := baggage.NewMember("key2", "value2")
    bag2, _ := baggage.New(m2)
    
    // åˆå¹¶
    members := append(bag1.Members(), bag2.Members()...)
    merged, _ := baggage.New(members...)
    
    // éªŒè¯åˆå¹¶ç»“æœ
    if merged.Member("key1").Value() != "value1" {
        t.Error("key1 should be present")
    }
    if merged.Member("key2").Value() != "value2" {
        t.Error("key2 should be present")
    }
}

// TestBaggageSizeLimit éªŒè¯å¤§å°é™åˆ¶
func TestBaggageSizeLimit(t *testing.T) {
    members := make([]baggage.Member, 0)
    
    // å°è¯•åˆ›å»ºè¶…è¿‡é™åˆ¶çš„ Baggage
    for i := 0; i < 200; i++ {
        m, _ := baggage.NewMember(fmt.Sprintf("key%d", i), "value")
        members = append(members, m)
    }
    
    _, err := baggage.New(members...)
    if err == nil {
        t.Error("should fail when exceeding member limit")
    }
}

// TestSetMemberIdempotency éªŒè¯è®¾ç½®æ“ä½œå¹‚ç­‰æ€§
func TestSetMemberIdempotency(t *testing.T) {
    m, _ := baggage.NewMember("key", "value")
    bag, _ := baggage.New()
    
    // è®¾ç½®ä¸¤æ¬¡
    bag1, _ := bag.SetMember(m)
    bag2, _ := bag1.SetMember(m)
    
    // åº”è¯¥ç›¸ç­‰
    if len(bag1.Members()) != len(bag2.Members()) {
        t.Error("setting same member twice should be idempotent")
    }
}
```

---

## å‚è€ƒèµ„æº

- [W3C Baggage Specification](https://www.w3.org/TR/baggage/)
- [OpenTelemetry Baggage API](https://opentelemetry.io/docs/specs/otel/baggage/api/)
- [TLA+ Specification](https://lamport.azurewebsites.net/tla/tla.html)
- [01_Baggageå®šä¹‰.md](./01_Baggageå®šä¹‰.md)
- [02_ä¼ æ’­æœºåˆ¶.md](./02_ä¼ æ’­æœºåˆ¶.md)

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»å®Œæˆäº† Baggage æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼**

æœ¬æ–‡æ¡£æä¾›äº†ï¼š

- âœ… å®Œæ•´çš„æ•°å­¦å®šä¹‰
- âœ… ä¸¥æ ¼çš„ä¸å˜é‡åˆ†æ
- âœ… æ­£ç¡®æ€§è¯æ˜
- âœ… æ€§èƒ½å¤æ‚åº¦åˆ†æ
- âœ… TLA+ å½¢å¼åŒ–è§„èŒƒ
- âœ… Go å®ç°éªŒè¯

**Phase 3.6: Baggage æ•°æ®æ¨¡å‹ å…¨éƒ¨å®Œæˆï¼** ğŸŠ

**ğŸŠğŸŠğŸŠ Milestone 3: æ•°æ®æ¨¡å‹ å…¨éƒ¨å®Œæˆï¼ğŸŠğŸŠğŸŠ**-
