# èµ„æºåˆå¹¶

## ğŸ“‹ ç›®å½•

- [èµ„æºåˆå¹¶](#èµ„æºåˆå¹¶)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [åˆå¹¶è§„åˆ™](#åˆå¹¶è§„åˆ™)
  - [åˆå¹¶ç­–ç•¥](#åˆå¹¶ç­–ç•¥)
    - [1. å·¦ä¼˜å…ˆåˆå¹¶](#1-å·¦ä¼˜å…ˆåˆå¹¶)
    - [2. å³ä¼˜å…ˆåˆå¹¶](#2-å³ä¼˜å…ˆåˆå¹¶)
    - [3. æ¡ä»¶åˆå¹¶](#3-æ¡ä»¶åˆå¹¶)
  - [å†²çªè§£å†³](#å†²çªè§£å†³)
  - [Go 1.25.1 å®ç°](#go-1251-å®ç°)
    - [1. åŸºæœ¬åˆå¹¶](#1-åŸºæœ¬åˆå¹¶)
    - [2. å¤šèµ„æºåˆå¹¶](#2-å¤šèµ„æºåˆå¹¶)
    - [3. æ¡ä»¶åˆå¹¶](#3-æ¡ä»¶åˆå¹¶-1)
    - [4. è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥](#4-è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥)
  - [åˆå¹¶ä¼˜å…ˆçº§](#åˆå¹¶ä¼˜å…ˆçº§)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [å¸¸è§åœºæ™¯](#å¸¸è§åœºæ™¯)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

**èµ„æºåˆå¹¶** æ˜¯å°†å¤šä¸ª Resource çš„å±æ€§ç»„åˆæˆå•ä¸ª Resource çš„è¿‡ç¨‹ã€‚

```text
Resource1 + Resource2 -> MergedResource

ç”¨é€”:
âœ… ç»„åˆå¤šä¸ªæ£€æµ‹å™¨çš„ç»“æœ
âœ… è¦†ç›–é»˜è®¤é…ç½®
âœ… æ·»åŠ è‡ªå®šä¹‰å±æ€§
âœ… åˆ†å±‚é…ç½®ç®¡ç†
```

---

## åˆå¹¶è§„åˆ™

OpenTelemetry Resource åˆå¹¶çš„åŸºæœ¬è§„åˆ™ï¼š

```text
1. ä¸å¯å˜æ€§: Resource æœ¬èº«ä¸å¯å˜
2. éç ´åæ€§: åˆå¹¶åˆ›å»ºæ–°çš„ Resource
3. å±æ€§å”¯ä¸€: åŒä¸€é”®åªä¿ç•™ä¸€ä¸ªå€¼
4. é»˜è®¤ç­–ç•¥: åè€…è¦†ç›–å‰è€… (å³ä¼˜å…ˆ)
```

---

## åˆå¹¶ç­–ç•¥

### 1. å·¦ä¼˜å…ˆåˆå¹¶

ç¬¬ä¸€ä¸ª Resource çš„å±æ€§ä¼˜å…ˆï¼š

```go
// resource.Merge(r1, r2) - r1 ä¼˜å…ˆ
merged, err := resource.Merge(r1, r2)

// å¦‚æœ r1 å’Œ r2 éƒ½æœ‰ "service.name":
// ç»“æœä½¿ç”¨ r1 çš„å€¼
```

### 2. å³ä¼˜å…ˆåˆå¹¶

ç¬¬äºŒä¸ª Resource çš„å±æ€§ä¼˜å…ˆï¼š

```go
// é€šè¿‡äº¤æ¢å‚æ•°å®ç°å³ä¼˜å…ˆ
merged, err := resource.Merge(r2, r1)

// ç°åœ¨ r2 çš„å€¼ä¼šè¦†ç›– r1
```

### 3. æ¡ä»¶åˆå¹¶

åŸºäºæ¡ä»¶é€‰æ‹©æ€§åˆå¹¶ï¼š

```go
// åªæœ‰å½“ r1 ä¸å­˜åœ¨æŸä¸ªé”®æ—¶ï¼Œæ‰ä½¿ç”¨ r2 çš„å€¼
if !r1.HasAttribute("service.version") {
    merged, _ = resource.Merge(r1, r2)
}
```

---

## å†²çªè§£å†³

å¤„ç†å±æ€§å†²çªçš„ç­–ç•¥ï¼š

```text
å†²çªç±»å‹:
1. é”®å†²çª: ç›¸åŒçš„é”®ï¼Œä¸åŒçš„å€¼
2. ç±»å‹å†²çª: ç›¸åŒçš„é”®ï¼Œä¸åŒçš„ç±»å‹

è§£å†³æ–¹æ¡ˆ:
âœ… é»˜è®¤: ä½¿ç”¨ç¬¬ä¸€ä¸ª Resource çš„å€¼ (å·¦ä¼˜å…ˆ)
âœ… æ˜¾å¼é…ç½®ä¼˜å…ˆ: æ‰‹åŠ¨è®¾ç½® > è‡ªåŠ¨æ£€æµ‹
âœ… ç¯å¢ƒç‰¹å®š: ç”Ÿäº§ç¯å¢ƒ > é»˜è®¤é…ç½®
```

---

## Go 1.25.1 å®ç°

### 1. åŸºæœ¬åˆå¹¶

```go
package main

import (
    "context"
    "log"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func BasicMerge() {
    ctx := context.Background()
    
    // Resource 1: æœåŠ¡ä¿¡æ¯
    r1, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceName("api-gateway"),
            semconv.ServiceVersion("1.0.0"),
        ),
    )
    
    // Resource 2: éƒ¨ç½²ä¿¡æ¯
    r2, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.DeploymentEnvironment("production"),
            semconv.ServiceVersion("2.0.0"), // å†²çªï¼
        ),
    )
    
    // åˆå¹¶ (r1 ä¼˜å…ˆ)
    merged, err := resource.Merge(r1, r2)
    if err != nil {
        log.Fatal(err)
    }
    
    // ç»“æœ:
    // service.name = "api-gateway" (from r1)
    // service.version = "1.0.0"    (from r1, å†²çªä¼˜å…ˆ)
    // deployment.environment = "production" (from r2)
    
    for _, attr := range merged.Attributes() {
        log.Printf("%s = %v", attr.Key, attr.Value)
    }
}
```

### 2. å¤šèµ„æºåˆå¹¶

```go
package main

import (
    "context"
    
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// MergeMultiple åˆå¹¶å¤šä¸ª Resource
func MergeMultiple(resources ...*resource.Resource) (*resource.Resource, error) {
    if len(resources) == 0 {
        return resource.Empty(), nil
    }
    
    result := resources[0]
    for i := 1; i < len(resources); i++ {
        merged, err := resource.Merge(result, resources[i])
        if err != nil {
            return nil, err
        }
        result = merged
    }
    
    return result, nil
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    // åˆ›å»ºå¤šä¸ª Resource
    r1, _ := resource.New(ctx,
        resource.WithAttributes(semconv.ServiceName("api-gateway")),
    )
    
    r2, _ := resource.New(ctx,
        resource.WithHost(),
    )
    
    r3, _ := resource.New(ctx,
        resource.WithProcess(),
    )
    
    r4, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.DeploymentEnvironment("production"),
        ),
    )
    
    // åˆå¹¶æ‰€æœ‰ Resource
    merged, err := MergeMultiple(r1, r2, r3, r4)
    if err != nil {
        log.Fatal(err)
    }
    
    log.Printf("Merged resource: %v", merged.Attributes())
}
```

### 3. æ¡ä»¶åˆå¹¶

```go
package main

import (
    "context"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
)

// ConditionalMerge æ¡ä»¶åˆå¹¶
func ConditionalMerge(base, override *resource.Resource, condition func(attribute.KeyValue) bool) (*resource.Resource, error) {
    ctx := context.Background()
    
    // ä» override ä¸­ç­›é€‰æ»¡è¶³æ¡ä»¶çš„å±æ€§
    var attrs []attribute.KeyValue
    for _, attr := range override.Attributes() {
        if condition(attr) {
            attrs = append(attrs, attr)
        }
    }
    
    // åˆ›å»ºè¿‡æ»¤åçš„ Resource
    filtered, err := resource.New(ctx,
        resource.WithAttributes(attrs...),
    )
    if err != nil {
        return nil, err
    }
    
    // åˆå¹¶
    return resource.Merge(base, filtered)
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    base, _ := resource.New(ctx,
        resource.WithAttributes(
            attribute.String("service.name", "api-gateway"),
            attribute.String("service.version", "1.0.0"),
        ),
    )
    
    override, _ := resource.New(ctx,
        resource.WithAttributes(
            attribute.String("service.version", "2.0.0"),
            attribute.String("deployment.environment", "production"),
        ),
    )
    
    // åªåˆå¹¶ä»¥ "deployment." å¼€å¤´çš„å±æ€§
    merged, _ := ConditionalMerge(base, override, func(kv attribute.KeyValue) bool {
        return strings.HasPrefix(string(kv.Key), "deployment.")
    })
    
    // ç»“æœ:
    // service.name = "api-gateway"
    // service.version = "1.0.0"  (æœªè¢«è¦†ç›–)
    // deployment.environment = "production"
    
    log.Printf("Merged: %v", merged.Attributes())
}
```

### 4. è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥

```go
package main

import (
    "context"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
)

// MergeStrategy åˆå¹¶ç­–ç•¥
type MergeStrategy int

const (
    LeftPriority  MergeStrategy = iota // å·¦ä¼˜å…ˆ (é»˜è®¤)
    RightPriority                       // å³ä¼˜å…ˆ
    VersionAware                        // ç‰ˆæœ¬æ„ŸçŸ¥
)

// MergeWithStrategy ä½¿ç”¨æŒ‡å®šç­–ç•¥åˆå¹¶
func MergeWithStrategy(r1, r2 *resource.Resource, strategy MergeStrategy) (*resource.Resource, error) {
    switch strategy {
    case LeftPriority:
        return resource.Merge(r1, r2)
        
    case RightPriority:
        return resource.Merge(r2, r1)
        
    case VersionAware:
        return versionAwareMerge(r1, r2)
        
    default:
        return resource.Merge(r1, r2)
    }
}

// versionAwareMerge ç‰ˆæœ¬æ„ŸçŸ¥åˆå¹¶
func versionAwareMerge(r1, r2 *resource.Resource) (*resource.Resource, error) {
    ctx := context.Background()
    
    // ä»ä¸¤ä¸ª Resource ä¸­é€‰æ‹©å±æ€§
    attrs := make([]attribute.KeyValue, 0)
    
    // å¯¹äº service.versionï¼Œé€‰æ‹©è¾ƒæ–°çš„ç‰ˆæœ¬
    v1 := getVersion(r1)
    v2 := getVersion(r2)
    
    if compareVersion(v1, v2) >= 0 {
        attrs = append(attrs, attribute.String("service.version", v1))
    } else {
        attrs = append(attrs, attribute.String("service.version", v2))
    }
    
    // åˆå¹¶å…¶ä»–å±æ€§
    for _, attr := range r1.Attributes() {
        if attr.Key != "service.version" {
            attrs = append(attrs, attr)
        }
    }
    
    for _, attr := range r2.Attributes() {
        if attr.Key != "service.version" && !hasKey(attrs, attr.Key) {
            attrs = append(attrs, attr)
        }
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

func getVersion(r *resource.Resource) string {
    for _, attr := range r.Attributes() {
        if attr.Key == "service.version" {
            return attr.Value.AsString()
        }
    }
    return "0.0.0"
}

func compareVersion(v1, v2 string) int {
    // ç®€åŒ–çš„ç‰ˆæœ¬æ¯”è¾ƒ
    if v1 == v2 {
        return 0
    }
    if v1 > v2 {
        return 1
    }
    return -1
}

func hasKey(attrs []attribute.KeyValue, key attribute.Key) bool {
    for _, attr := range attrs {
        if attr.Key == key {
            return true
        }
    }
    return false
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    r1, _ := resource.New(ctx,
        resource.WithAttributes(
            attribute.String("service.name", "api-gateway"),
            attribute.String("service.version", "1.0.0"),
        ),
    )
    
    r2, _ := resource.New(ctx,
        resource.WithAttributes(
            attribute.String("service.version", "2.0.0"),
            attribute.String("deployment.environment", "production"),
        ),
    )
    
    // å·¦ä¼˜å…ˆ (é»˜è®¤)
    m1, _ := MergeWithStrategy(r1, r2, LeftPriority)
    // service.version = "1.0.0"
    
    // å³ä¼˜å…ˆ
    m2, _ := MergeWithStrategy(r1, r2, RightPriority)
    // service.version = "2.0.0"
    
    // ç‰ˆæœ¬æ„ŸçŸ¥ (é€‰æ‹©è¾ƒæ–°ç‰ˆæœ¬)
    m3, _ := MergeWithStrategy(r1, r2, VersionAware)
    // service.version = "2.0.0" (è‡ªåŠ¨é€‰æ‹©è¾ƒæ–°)
    
    log.Printf("Left: %v", m1.Attributes())
    log.Printf("Right: %v", m2.Attributes())
    log.Printf("Version-aware: %v", m3.Attributes())
}
```

---

## åˆå¹¶ä¼˜å…ˆçº§

å®é™…åº”ç”¨ä¸­çš„åˆå¹¶ä¼˜å…ˆçº§ï¼š

```go
package main

import (
    "context"
    
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func CreateResourceWithPriority(ctx context.Context, serviceName string) (*resource.Resource, error) {
    // ä¼˜å…ˆçº§ 1: é»˜è®¤é…ç½® (æœ€ä½)
    defaults, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceName(serviceName),
            semconv.ServiceVersion("0.0.0"),
            semconv.DeploymentEnvironment("development"),
        ),
    )
    
    // ä¼˜å…ˆçº§ 2: è‡ªåŠ¨æ£€æµ‹
    detected, _ := resource.New(ctx,
        resource.WithHost(),
        resource.WithProcess(),
        resource.WithContainer(),
    )
    
    // ä¼˜å…ˆçº§ 3: ç¯å¢ƒå˜é‡
    envConfig, _ := resource.New(ctx,
        resource.WithFromEnv(),
    )
    
    // ä¼˜å…ˆçº§ 4: æ˜¾å¼é…ç½® (æœ€é«˜)
    explicit, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceVersion("1.0.0"), // è¦†ç›–é»˜è®¤
        ),
    )
    
    // æŒ‰ä¼˜å…ˆçº§åˆå¹¶ (ä»ä½åˆ°é«˜)
    step1, _ := resource.Merge(defaults, detected)
    step2, _ := resource.Merge(step1, envConfig)
    final, _ := resource.Merge(step2, explicit)
    
    return final, nil
}
```

---

## æœ€ä½³å®è·µ

### âœ… æ­£ç¡®çš„åˆå¹¶æ–¹å¼

```go
// 1. æ¸…æ™°çš„ä¼˜å…ˆçº§
res, _ := resource.New(ctx,
    resource.WithAttributes(semconv.ServiceName("api-gateway")), // é«˜ä¼˜å…ˆçº§
    resource.WithFromEnv(),    // ä¸­ä¼˜å…ˆçº§
    resource.WithHost(),       // ä½ä¼˜å…ˆçº§
)

// 2. æ˜¾å¼è¦†ç›–
defaults, _ := resource.New(ctx, resource.WithHost())
overrides, _ := resource.New(ctx, 
    resource.WithAttributes(semconv.ServiceName("custom")))
final, _ := resource.Merge(defaults, overrides)

// 3. åˆ†å±‚é…ç½®
baseConfig := loadBaseConfig()
envConfig := loadEnvConfig()
merged, _ := resource.Merge(baseConfig, envConfig)
```

### âŒ é”™è¯¯çš„åˆå¹¶æ–¹å¼

```go
// 1. æœªè€ƒè™‘ä¼˜å…ˆçº§
res, _ := resource.Merge(explicit, defaults) // é”™è¯¯: ä½ä¼˜å…ˆçº§è¦†ç›–é«˜ä¼˜å…ˆçº§

// 2. è¿‡åº¦åˆå¹¶
for _, r := range manyResources {
    merged, _ = resource.Merge(merged, r) // æ€§èƒ½é—®é¢˜
}

// 3. å¿½ç•¥é”™è¯¯
merged, _ := resource.Merge(r1, r2) // åº”è¯¥æ£€æŸ¥é”™è¯¯
```

---

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: å¤šç¯å¢ƒé…ç½®

```go
func CreateResourceForEnvironment(env string) (*resource.Resource, error) {
    ctx := context.Background()
    
    // åŸºç¡€é…ç½®
    base, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceName("api-gateway"),
        ),
        resource.WithHost(),
        resource.WithProcess(),
    )
    
    // ç¯å¢ƒç‰¹å®šé…ç½®
    var envConfig *resource.Resource
    switch env {
    case "production":
        envConfig, _ = resource.New(ctx,
            resource.WithAttributes(
                semconv.DeploymentEnvironment("production"),
                semconv.ServiceVersion("1.0.0"),
            ),
        )
    case "staging":
        envConfig, _ = resource.New(ctx,
            resource.WithAttributes(
                semconv.DeploymentEnvironment("staging"),
                semconv.ServiceVersion("0.9.0"),
            ),
        )
    default:
        envConfig, _ = resource.New(ctx,
            resource.WithAttributes(
                semconv.DeploymentEnvironment("development"),
            ),
        )
    }
    
    return resource.Merge(base, envConfig)
}
```

### åœºæ™¯ 2: å›¢é˜Ÿçº§é…ç½®

```go
func CreateResourceWithTeamConfig(serviceName, team string) (*resource.Resource, error) {
    ctx := context.Background()
    
    // æœåŠ¡é…ç½®
    serviceConfig, _ := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceName(serviceName),
        ),
    )
    
    // å›¢é˜Ÿé…ç½®
    teamConfig, _ := resource.New(ctx,
        resource.WithAttributes(
            attribute.String("team.name", team),
            attribute.String("team.owner", getTeamOwner(team)),
        ),
    )
    
    // ç¯å¢ƒæ£€æµ‹
    envDetected, _ := resource.New(ctx,
        resource.WithHost(),
        resource.WithProcess(),
    )
    
    // åˆå¹¶: æœåŠ¡ + å›¢é˜Ÿ + ç¯å¢ƒ
    step1, _ := resource.Merge(serviceConfig, teamConfig)
    return resource.Merge(step1, envDetected)
}
```

### åœºæ™¯ 3: åŠ¨æ€è¦†ç›–

```go
func CreateResourceWithDynamicOverride(base *resource.Resource) (*resource.Resource, error) {
    ctx := context.Background()
    
    // ä»è¿œç¨‹é…ç½®æœåŠ¡è¯»å–è¦†ç›–
    overrideAttrs := fetchRemoteConfig()
    
    override, _ := resource.New(ctx,
        resource.WithAttributes(overrideAttrs...),
    )
    
    return resource.Merge(base, override)
}

func fetchRemoteConfig() []attribute.KeyValue {
    // ä» Config Server/Consul/etcd è¯»å–
    return []attribute.KeyValue{
        attribute.String("feature.flag.new_ui", "enabled"),
        attribute.String("log.level", "debug"),
    }
}
```

---

## å‚è€ƒèµ„æº

- [OpenTelemetry Resource Spec](https://opentelemetry.io/docs/specs/otel/resource/sdk/)
- [Go SDK Resource Package](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource)
- [01_Resourceå®šä¹‰.md](./01_Resourceå®šä¹‰.md)
- [02_èµ„æºæ£€æµ‹.md](./02_èµ„æºæ£€æµ‹.md)

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº†èµ„æºåˆå¹¶ï¼**

ç°åœ¨ä½ å¯ä»¥ï¼š
- âœ… ç†è§£åˆå¹¶è§„åˆ™å’Œç­–ç•¥
- âœ… å¤„ç†å±æ€§å†²çª
- âœ… å®ç°è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥
- âœ… åº”ç”¨äºå¤šç¯å¢ƒé…ç½®

