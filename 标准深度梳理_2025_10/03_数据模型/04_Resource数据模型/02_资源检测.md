# èµ„æºæ£€æµ‹

## ğŸ“‹ ç›®å½•

- [èµ„æºæ£€æµ‹](#èµ„æºæ£€æµ‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [æ£€æµ‹å™¨ç±»å‹](#æ£€æµ‹å™¨ç±»å‹)
    - [1. ç¯å¢ƒå˜é‡æ£€æµ‹å™¨](#1-ç¯å¢ƒå˜é‡æ£€æµ‹å™¨)
    - [2. ä¸»æœºæ£€æµ‹å™¨](#2-ä¸»æœºæ£€æµ‹å™¨)
    - [3. è¿›ç¨‹æ£€æµ‹å™¨](#3-è¿›ç¨‹æ£€æµ‹å™¨)
    - [4. å®¹å™¨æ£€æµ‹å™¨](#4-å®¹å™¨æ£€æµ‹å™¨)
    - [5. Kubernetes æ£€æµ‹å™¨](#5-kubernetes-æ£€æµ‹å™¨)
    - [6. äº‘å¹³å°æ£€æµ‹å™¨](#6-äº‘å¹³å°æ£€æµ‹å™¨)
  - [æ£€æµ‹å™¨æ¥å£](#æ£€æµ‹å™¨æ¥å£)
  - [æ£€æµ‹å™¨ä¼˜å…ˆçº§](#æ£€æµ‹å™¨ä¼˜å…ˆçº§)
  - [Go 1.25.1 å®ç°](#go-1251-å®ç°)
    - [1. ç¯å¢ƒå˜é‡æ£€æµ‹](#1-ç¯å¢ƒå˜é‡æ£€æµ‹)
    - [2. ä¸»æœºä¿¡æ¯æ£€æµ‹](#2-ä¸»æœºä¿¡æ¯æ£€æµ‹)
    - [3. è¿›ç¨‹ä¿¡æ¯æ£€æµ‹](#3-è¿›ç¨‹ä¿¡æ¯æ£€æµ‹)
    - [4. å®¹å™¨ç¯å¢ƒæ£€æµ‹](#4-å®¹å™¨ç¯å¢ƒæ£€æµ‹)
    - [5. Kubernetes æ£€æµ‹](#5-kubernetes-æ£€æµ‹)
    - [6. AWS æ£€æµ‹](#6-aws-æ£€æµ‹)
    - [7. GCP æ£€æµ‹](#7-gcp-æ£€æµ‹)
    - [8. Azure æ£€æµ‹](#8-azure-æ£€æµ‹)
  - [è‡ªå®šä¹‰æ£€æµ‹å™¨](#è‡ªå®šä¹‰æ£€æµ‹å™¨)
  - [ç»„åˆæ£€æµ‹å™¨](#ç»„åˆæ£€æµ‹å™¨)
  - [æ£€æµ‹å™¨ç¼“å­˜](#æ£€æµ‹å™¨ç¼“å­˜)
  - [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

**èµ„æºæ£€æµ‹** æ˜¯è‡ªåŠ¨å‘ç°å’Œè¯†åˆ«è¿è¡Œç¯å¢ƒä¿¡æ¯çš„è¿‡ç¨‹ï¼Œç”¨äºè‡ªåŠ¨å¡«å…… Resource å±æ€§ã€‚

```text
è‡ªåŠ¨æ£€æµ‹çš„å¥½å¤„:
âœ… å‡å°‘æ‰‹åŠ¨é…ç½®
âœ… ä¿è¯ä¸€è‡´æ€§
âœ… é€‚åº”ä¸åŒç¯å¢ƒ
âœ… ç®€åŒ–éƒ¨ç½²
```

---

## æ£€æµ‹å™¨ç±»å‹

### 1. ç¯å¢ƒå˜é‡æ£€æµ‹å™¨

ä»ç¯å¢ƒå˜é‡è¯»å– Resource å±æ€§ï¼š

```bash
# OpenTelemetry æ ‡å‡†ç¯å¢ƒå˜é‡
export OTEL_RESOURCE_ATTRIBUTES="service.name=api-gateway,service.version=1.0.0"
export OTEL_SERVICE_NAME="api-gateway"
```

### 2. ä¸»æœºæ£€æµ‹å™¨

æ£€æµ‹ä¸»æœºä¿¡æ¯ï¼ˆæ“ä½œç³»ç»Ÿã€æ¶æ„ã€ä¸»æœºåï¼‰ï¼š

```go
resource.WithHost()       // ä¸»æœºåã€ID
resource.WithOS()         // æ“ä½œç³»ç»Ÿç±»å‹ã€ç‰ˆæœ¬
resource.WithOSDescription() // è¯¦ç»†æè¿°
```

### 3. è¿›ç¨‹æ£€æµ‹å™¨

æ£€æµ‹è¿›ç¨‹ä¿¡æ¯ï¼ˆPIDã€å¯æ‰§è¡Œæ–‡ä»¶ã€è¿è¡Œæ—¶ï¼‰ï¼š

```go
resource.WithProcessPID()              // è¿›ç¨‹ ID
resource.WithProcessExecutableName()   // å¯æ‰§è¡Œæ–‡ä»¶å
resource.WithProcessRuntimeName()      // è¿è¡Œæ—¶åç§° (go)
resource.WithProcessRuntimeVersion()   // è¿è¡Œæ—¶ç‰ˆæœ¬
```

### 4. å®¹å™¨æ£€æµ‹å™¨

æ£€æµ‹å®¹å™¨ç¯å¢ƒï¼ˆDockerã€Podmanï¼‰ï¼š

```go
resource.WithContainer()  // container.id, container.image.name
```

### 5. Kubernetes æ£€æµ‹å™¨

æ£€æµ‹ Kubernetes èµ„æºä¿¡æ¯ï¼š

```go
// ä» Downward API è¯»å–
// /var/run/secrets/kubernetes.io/serviceaccount/
```

### 6. äº‘å¹³å°æ£€æµ‹å™¨

æ£€æµ‹äº‘å¹³å°å…ƒæ•°æ®ï¼ˆAWSã€GCPã€Azureï¼‰ï¼š

```go
// AWS: ä» EC2 Metadata Service
// GCP: ä» Metadata Server
// Azure: ä» Instance Metadata Service
```

---

## æ£€æµ‹å™¨æ¥å£

OpenTelemetry Go SDK å®šä¹‰çš„æ£€æµ‹å™¨æ¥å£ï¼š

```go
// Detector æ£€æµ‹å™¨æ¥å£
type Detector interface {
    // Detect æ£€æµ‹å¹¶è¿”å› Resource
    Detect(ctx context.Context) (*Resource, error)
}
```

---

## æ£€æµ‹å™¨ä¼˜å…ˆçº§

æ£€æµ‹å™¨çš„ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

```text
1. æ˜¾å¼é…ç½® (WithAttributes)
2. ç¯å¢ƒå˜é‡ (WithFromEnv)
3. äº‘å¹³å°æ£€æµ‹å™¨
4. Kubernetes æ£€æµ‹å™¨
5. å®¹å™¨æ£€æµ‹å™¨
6. ä¸»æœº/è¿›ç¨‹æ£€æµ‹å™¨
```

---

## Go 1.25.1 å®ç°

### 1. ç¯å¢ƒå˜é‡æ£€æµ‹

```go
package main

import (
    "context"
    "log"
    "os"
    
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func EnvResourceDetector() {
    // è®¾ç½®ç¯å¢ƒå˜é‡
    os.Setenv("OTEL_SERVICE_NAME", "api-gateway")
    os.Setenv("OTEL_RESOURCE_ATTRIBUTES", "deployment.environment=production,service.version=1.0.0")
    
    // ä»ç¯å¢ƒå˜é‡åˆ›å»º Resource
    res, err := resource.New(context.Background(),
        resource.WithFromEnv(),  // è‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡
    )
    if err != nil {
        log.Fatal(err)
    }
    
    // è¾“å‡ºå±æ€§
    for _, attr := range res.Attributes() {
        log.Printf("%s = %s", attr.Key, attr.Value.AsString())
    }
}

// æ”¯æŒçš„ç¯å¢ƒå˜é‡:
// OTEL_SERVICE_NAME                - service.name
// OTEL_RESOURCE_ATTRIBUTES         - key1=val1,key2=val2
```

### 2. ä¸»æœºä¿¡æ¯æ£€æµ‹

```go
package main

import (
    "context"
    "log"
    "os"
    "runtime"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// HostDetector ä¸»æœºä¿¡æ¯æ£€æµ‹å™¨
type HostDetector struct{}

func (d HostDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    hostname, err := os.Hostname()
    if err != nil {
        hostname = "unknown"
    }
    
    attrs := []attribute.KeyValue{
        semconv.HostName(hostname),
        semconv.HostArch(runtime.GOARCH),
        semconv.OSType(runtime.GOOS),
    }
    
    // åœ¨ Linux ä¸Šï¼Œå°è¯•è¯»å– machine-id
    if runtime.GOOS == "linux" {
        if id, err := os.ReadFile("/etc/machine-id"); err == nil {
            attrs = append(attrs, semconv.HostID(string(id)))
        }
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    // æ–¹å¼ 1: ä½¿ç”¨å†…ç½®æ£€æµ‹å™¨
    res1, _ := resource.New(ctx,
        resource.WithHost(),
        resource.WithOS(),
    )
    
    // æ–¹å¼ 2: ä½¿ç”¨è‡ªå®šä¹‰æ£€æµ‹å™¨
    detector := HostDetector{}
    res2, _ := detector.Detect(ctx)
    
    log.Printf("Host: %v", res1.Attributes())
    log.Printf("Custom: %v", res2.Attributes())
}
```

### 3. è¿›ç¨‹ä¿¡æ¯æ£€æµ‹

```go
package main

import (
    "context"
    "os"
    "path/filepath"
    "runtime"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// ProcessDetector è¿›ç¨‹ä¿¡æ¯æ£€æµ‹å™¨
type ProcessDetector struct{}

func (d ProcessDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    pid := os.Getpid()
    executable, _ := os.Executable()
    execName := filepath.Base(executable)
    
    attrs := []attribute.KeyValue{
        semconv.ProcessPID(pid),
        semconv.ProcessExecutableName(execName),
        semconv.ProcessExecutablePath(executable),
        semconv.ProcessRuntimeName("go"),
        semconv.ProcessRuntimeVersion(runtime.Version()),
        semconv.ProcessRuntimeDescription(runtime.Version()),
    }
    
    // è·å–å‘½ä»¤è¡Œå‚æ•°
    if len(os.Args) > 0 {
        cmdline := ""
        for i, arg := range os.Args {
            if i > 0 {
                cmdline += " "
            }
            cmdline += arg
        }
        attrs = append(attrs, semconv.ProcessCommandLine(cmdline))
    }
    
    // è·å–è¿›ç¨‹æ‰€æœ‰è€…
    if uid := os.Getuid(); uid != 0 {
        attrs = append(attrs, semconv.ProcessOwner(fmt.Sprintf("uid-%d", uid)))
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    // ä½¿ç”¨å†…ç½®æ£€æµ‹å™¨
    res, _ := resource.New(ctx,
        resource.WithProcess(),
    )
    
    for _, attr := range res.Attributes() {
        log.Printf("%s = %v", attr.Key, attr.Value)
    }
}
```

### 4. å®¹å™¨ç¯å¢ƒæ£€æµ‹

```go
package main

import (
    "context"
    "os"
    "strings"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// ContainerDetector å®¹å™¨æ£€æµ‹å™¨
type ContainerDetector struct{}

func (d ContainerDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    var attrs []attribute.KeyValue
    
    // æ–¹æ³• 1: æ£€æŸ¥ /.dockerenv æ–‡ä»¶
    if _, err := os.Stat("/.dockerenv"); err == nil {
        // ä» cgroup è¯»å– container ID
        if data, err := os.ReadFile("/proc/self/cgroup"); err == nil {
            for _, line := range strings.Split(string(data), "\n") {
                if strings.Contains(line, "docker") {
                    parts := strings.Split(line, "/")
                    if len(parts) > 0 {
                        containerID := parts[len(parts)-1]
                        attrs = append(attrs, semconv.ContainerID(containerID))
                        break
                    }
                }
            }
        }
    }
    
    // æ–¹æ³• 2: ä»ç¯å¢ƒå˜é‡è¯»å–
    if hostname, err := os.Hostname(); err == nil {
        attrs = append(attrs, semconv.ContainerName(hostname))
    }
    
    // æ£€æµ‹å®¹å™¨é•œåƒ
    if imageName := os.Getenv("CONTAINER_IMAGE"); imageName != "" {
        attrs = append(attrs, semconv.ContainerImageName(imageName))
    }
    
    if len(attrs) == 0 {
        return resource.Empty(), nil
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    // ä½¿ç”¨å†…ç½®å®¹å™¨æ£€æµ‹å™¨
    res, _ := resource.New(ctx,
        resource.WithContainer(),
    )
    
    log.Printf("Container: %v", res.Attributes())
}
```

### 5. Kubernetes æ£€æµ‹

```go
package main

import (
    "context"
    "os"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// K8sDetector Kubernetes æ£€æµ‹å™¨
type K8sDetector struct{}

func (d K8sDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    var attrs []attribute.KeyValue
    
    // ä» Downward API ç¯å¢ƒå˜é‡è¯»å–
    if podName := os.Getenv("POD_NAME"); podName != "" {
        attrs = append(attrs, semconv.K8SPodName(podName))
    }
    
    if podUID := os.Getenv("POD_UID"); podUID != "" {
        attrs = append(attrs, semconv.K8SPodUID(podUID))
    }
    
    if namespace := os.Getenv("POD_NAMESPACE"); namespace != "" {
        attrs = append(attrs, semconv.K8SNamespaceName(namespace))
    }
    
    if nodeName := os.Getenv("NODE_NAME"); nodeName != "" {
        attrs = append(attrs, semconv.K8SNodeName(nodeName))
    }
    
    if containerName := os.Getenv("CONTAINER_NAME"); containerName != "" {
        attrs = append(attrs, semconv.K8SContainerName(containerName))
    }
    
    // ä» Pod æ ‡ç­¾è¯»å–
    if deploymentName := os.Getenv("DEPLOYMENT_NAME"); deploymentName != "" {
        attrs = append(attrs, semconv.K8SDeploymentName(deploymentName))
    }
    
    if clusterName := os.Getenv("CLUSTER_NAME"); clusterName != "" {
        attrs = append(attrs, semconv.K8SClusterName(clusterName))
    }
    
    if len(attrs) == 0 {
        return resource.Empty(), nil
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

// Kubernetes Deployment YAML ç¤ºä¾‹
/*
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  template:
    spec:
      containers:
      - name: api-gateway
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: CONTAINER_NAME
          value: "api-gateway"
        - name: DEPLOYMENT_NAME
          value: "api-gateway"
        - name: CLUSTER_NAME
          value: "prod-cluster"
*/
```

### 6. AWS æ£€æµ‹

```go
package main

import (
    "context"
    "encoding/json"
    "io"
    "net/http"
    "time"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// AWSDetector AWS æ£€æµ‹å™¨
type AWSDetector struct {
    client *http.Client
}

func NewAWSDetector() *AWSDetector {
    return &AWSDetector{
        client: &http.Client{
            Timeout: 1 * time.Second,
        },
    }
}

type ec2Metadata struct {
    InstanceID       string `json:"instanceId"`
    InstanceType     string `json:"instanceType"`
    Region           string `json:"region"`
    AvailabilityZone string `json:"availabilityZone"`
    AccountID        string `json:"accountId"`
}

func (d *AWSDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    const metadataURL = "http://169.254.169.254/latest/dynamic/instance-identity/document"
    
    req, err := http.NewRequestWithContext(ctx, "GET", metadataURL, nil)
    if err != nil {
        return resource.Empty(), err
    }
    
    resp, err := d.client.Do(req)
    if err != nil {
        return resource.Empty(), nil // ä¸åœ¨ AWS ç¯å¢ƒ
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != http.StatusOK {
        return resource.Empty(), nil
    }
    
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return resource.Empty(), err
    }
    
    var metadata ec2Metadata
    if err := json.Unmarshal(body, &metadata); err != nil {
        return resource.Empty(), err
    }
    
    attrs := []attribute.KeyValue{
        semconv.CloudProvider("aws"),
        semconv.CloudPlatform("aws_ec2"),
        semconv.CloudAccountID(metadata.AccountID),
        semconv.CloudRegion(metadata.Region),
        semconv.CloudAvailabilityZone(metadata.AvailabilityZone),
        semconv.HostID(metadata.InstanceID),
        semconv.HostType(metadata.InstanceType),
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}
```

### 7. GCP æ£€æµ‹

```go
package main

import (
    "context"
    "io"
    "net/http"
    "time"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// GCPDetector GCP æ£€æµ‹å™¨
type GCPDetector struct {
    client *http.Client
}

func NewGCPDetector() *GCPDetector {
    return &GCPDetector{
        client: &http.Client{
            Timeout: 1 * time.Second,
        },
    }
}

func (d *GCPDetector) getMetadata(ctx context.Context, path string) (string, error) {
    url := "http://metadata.google.internal/computeMetadata/v1/" + path
    
    req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
    if err != nil {
        return "", err
    }
    req.Header.Set("Metadata-Flavor", "Google")
    
    resp, err := d.client.Do(req)
    if err != nil {
        return "", err
    }
    defer resp.Body.Close()
    
    body, err := io.ReadAll(resp.Body)
    return string(body), err
}

func (d *GCPDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    // æ£€æµ‹æ˜¯å¦åœ¨ GCP ç¯å¢ƒ
    projectID, err := d.getMetadata(ctx, "project/project-id")
    if err != nil {
        return resource.Empty(), nil // ä¸åœ¨ GCP ç¯å¢ƒ
    }
    
    zone, _ := d.getMetadata(ctx, "instance/zone")
    instanceID, _ := d.getMetadata(ctx, "instance/id")
    instanceType, _ := d.getMetadata(ctx, "instance/machine-type")
    
    // ä» zone æå– region (us-central1-a -> us-central1)
    region := zone
    if len(zone) > 2 {
        region = zone[:len(zone)-2]
    }
    
    attrs := []attribute.KeyValue{
        semconv.CloudProvider("gcp"),
        semconv.CloudPlatform("gcp_compute_engine"),
        semconv.CloudAccountID(projectID),
        semconv.CloudRegion(region),
        semconv.CloudAvailabilityZone(zone),
        semconv.HostID(instanceID),
        semconv.HostType(instanceType),
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}
```

### 8. Azure æ£€æµ‹

```go
package main

import (
    "context"
    "encoding/json"
    "io"
    "net/http"
    "time"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// AzureDetector Azure æ£€æµ‹å™¨
type AzureDetector struct {
    client *http.Client
}

func NewAzureDetector() *AzureDetector {
    return &AzureDetector{
        client: &http.Client{
            Timeout: 1 * time.Second,
        },
    }
}

type azureMetadata struct {
    Compute struct {
        VMId             string `json:"vmId"`
        VMSize           string `json:"vmSize"`
        Location         string `json:"location"`
        ResourceGroupName string `json:"resourceGroupName"`
        SubscriptionID   string `json:"subscriptionId"`
    } `json:"compute"`
}

func (d *AzureDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    const metadataURL = "http://169.254.169.254/metadata/instance?api-version=2021-02-01"
    
    req, err := http.NewRequestWithContext(ctx, "GET", metadataURL, nil)
    if err != nil {
        return resource.Empty(), err
    }
    req.Header.Set("Metadata", "true")
    
    resp, err := d.client.Do(req)
    if err != nil {
        return resource.Empty(), nil // ä¸åœ¨ Azure ç¯å¢ƒ
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != http.StatusOK {
        return resource.Empty(), nil
    }
    
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return resource.Empty(), err
    }
    
    var metadata azureMetadata
    if err := json.Unmarshal(body, &metadata); err != nil {
        return resource.Empty(), err
    }
    
    attrs := []attribute.KeyValue{
        semconv.CloudProvider("azure"),
        semconv.CloudPlatform("azure_vm"),
        semconv.CloudAccountID(metadata.Compute.SubscriptionID),
        semconv.CloudRegion(metadata.Compute.Location),
        semconv.HostID(metadata.Compute.VMId),
        semconv.HostType(metadata.Compute.VMSize),
        attribute.String("azure.resource_group", metadata.Compute.ResourceGroupName),
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}
```

---

## è‡ªå®šä¹‰æ£€æµ‹å™¨

åˆ›å»ºè‡ªå®šä¹‰æ£€æµ‹å™¨ï¼š

```go
package main

import (
    "context"
    "os"
    
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

// CustomDetector è‡ªå®šä¹‰æ£€æµ‹å™¨ç¤ºä¾‹
type CustomDetector struct {
    teamName string
}

func NewCustomDetector(teamName string) *CustomDetector {
    return &CustomDetector{
        teamName: teamName,
    }
}

func (d *CustomDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    attrs := []attribute.KeyValue{
        attribute.String("team.name", d.teamName),
    }
    
    // ä»é…ç½®æ–‡ä»¶è¯»å–
    if gitCommit := os.Getenv("GIT_COMMIT"); gitCommit != "" {
        attrs = append(attrs, attribute.String("git.commit", gitCommit))
    }
    
    // ä»æ„å»ºæ—¶é—´è¯»å–
    if buildTime := os.Getenv("BUILD_TIME"); buildTime != "" {
        attrs = append(attrs, attribute.String("build.time", buildTime))
    }
    
    return resource.NewWithAttributes(semconv.SchemaURL, attrs...), nil
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    customDetector := NewCustomDetector("platform-team")
    
    res, _ := resource.New(ctx,
        resource.WithDetectors(customDetector),
        resource.WithHost(),
    )
    
    log.Printf("Resource: %v", res.Attributes())
}
```

---

## ç»„åˆæ£€æµ‹å™¨

ç»„åˆå¤šä¸ªæ£€æµ‹å™¨ï¼š

```go
package main

import (
    "context"
    
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func CreateResourceWithAllDetectors(ctx context.Context, serviceName string) (*resource.Resource, error) {
    return resource.New(ctx,
        // 1. æ˜¾å¼é…ç½® (æœ€é«˜ä¼˜å…ˆçº§)
        resource.WithAttributes(
            semconv.ServiceName(serviceName),
        ),
        
        // 2. ç¯å¢ƒå˜é‡
        resource.WithFromEnv(),
        
        // 3. äº‘å¹³å°æ£€æµ‹
        resource.WithDetectors(
            NewAWSDetector(),
            NewGCPDetector(),
            NewAzureDetector(),
        ),
        
        // 4. Kubernetes
        resource.WithDetectors(
            &K8sDetector{},
        ),
        
        // 5. å®¹å™¨
        resource.WithContainer(),
        
        // 6. ä¸»æœºå’Œè¿›ç¨‹
        resource.WithHost(),
        resource.WithOS(),
        resource.WithProcess(),
        
        // 7. è‡ªå®šä¹‰æ£€æµ‹å™¨
        resource.WithDetectors(
            NewCustomDetector("my-team"),
        ),
    )
}
```

---

## æ£€æµ‹å™¨ç¼“å­˜

ç¼“å­˜æ£€æµ‹ç»“æœä»¥æå‡æ€§èƒ½ï¼š

```go
package main

import (
    "context"
    "sync"
    
    "go.opentelemetry.io/otel/sdk/resource"
)

// CachedDetector å¸¦ç¼“å­˜çš„æ£€æµ‹å™¨
type CachedDetector struct {
    detector resource.Detector
    once     sync.Once
    result   *resource.Resource
    err      error
}

func NewCachedDetector(detector resource.Detector) *CachedDetector {
    return &CachedDetector{
        detector: detector,
    }
}

func (d *CachedDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    d.once.Do(func() {
        d.result, d.err = d.detector.Detect(ctx)
    })
    return d.result, d.err
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    ctx := context.Background()
    
    // åŒ…è£… AWS æ£€æµ‹å™¨ä¸ºç¼“å­˜æ£€æµ‹å™¨
    awsDetector := NewCachedDetector(NewAWSDetector())
    
    // å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œä¸€æ¬¡æ£€æµ‹
    res1, _ := awsDetector.Detect(ctx)
    res2, _ := awsDetector.Detect(ctx) // ä½¿ç”¨ç¼“å­˜ç»“æœ
    
    log.Printf("Same: %v", res1 == res2)
}
```

---

## é”™è¯¯å¤„ç†

æ£€æµ‹å™¨é”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼š

```go
package main

import (
    "context"
    "log"
    
    "go.opentelemetry.io/otel/sdk/resource"
)

// SafeDetector å®‰å…¨çš„æ£€æµ‹å™¨åŒ…è£…
type SafeDetector struct {
    detector resource.Detector
    logger   *log.Logger
}

func NewSafeDetector(detector resource.Detector, logger *log.Logger) *SafeDetector {
    return &SafeDetector{
        detector: detector,
        logger:   logger,
    }
}

func (d *SafeDetector) Detect(ctx context.Context) (*resource.Resource, error) {
    res, err := d.detector.Detect(ctx)
    if err != nil {
        d.logger.Printf("Detector failed: %v", err)
        // è¿”å›ç©º Resourceï¼Œä¸ä¸­æ–­æ£€æµ‹æµç¨‹
        return resource.Empty(), nil
    }
    return res, nil
}
```

---

## æœ€ä½³å®è·µ

```go
// âœ… æ­£ç¡®ï¼šç»„åˆå¤šä¸ªæ£€æµ‹å™¨
res, _ := resource.New(ctx,
    resource.WithAttributes(semconv.ServiceName("api-gateway")),
    resource.WithFromEnv(),
    resource.WithHost(),
    resource.WithProcess(),
)

// âœ… æ­£ç¡®ï¼šè®¾ç½®è¶…æ—¶
ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
defer cancel()
res, _ := resource.New(ctx, resource.WithDetectors(detector))

// âŒ é”™è¯¯ï¼šé˜»å¡è¿‡é•¿æ—¶é—´
res, _ := resource.New(context.Background(),
    resource.WithDetectors(slowDetector), // æ— è¶…æ—¶æ§åˆ¶
)

// âœ… æ­£ç¡®ï¼šç¼“å­˜æ£€æµ‹ç»“æœ
cachedDetector := NewCachedDetector(NewAWSDetector())
res, _ := resource.New(ctx, resource.WithDetectors(cachedDetector))
```

---

## å‚è€ƒèµ„æº

- [OpenTelemetry Resource Detectors](https://opentelemetry.io/docs/specs/otel/resource/sdk/)
- [Go SDK Resource Detectors](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource)
- [01_Resourceå®šä¹‰.md](./01_Resourceå®šä¹‰.md)
- [03_èµ„æºåˆå¹¶.md](./03_èµ„æºåˆå¹¶.md)

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº†èµ„æºè‡ªåŠ¨æ£€æµ‹ï¼**

ç°åœ¨ä½ å¯ä»¥ï¼š
- âœ… ç†è§£ä¸åŒç±»å‹çš„æ£€æµ‹å™¨
- âœ… å®ç°è‡ªå®šä¹‰æ£€æµ‹å™¨
- âœ… ç»„åˆå¤šä¸ªæ£€æµ‹å™¨
- âœ… å¤„ç†æ£€æµ‹é”™è¯¯

