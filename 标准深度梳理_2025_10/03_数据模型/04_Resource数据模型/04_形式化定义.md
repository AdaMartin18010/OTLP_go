# Resource å½¢å¼åŒ–å®šä¹‰

## ğŸ“‹ ç›®å½•

- [Resource å½¢å¼åŒ–å®šä¹‰](#resource-å½¢å¼åŒ–å®šä¹‰)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [åŸºæœ¬å®šä¹‰](#åŸºæœ¬å®šä¹‰)
    - [1. Resource å®šä¹‰](#1-resource-å®šä¹‰)
    - [2. Attributes å®šä¹‰](#2-attributes-å®šä¹‰)
    - [3. Schema URL å®šä¹‰](#3-schema-url-å®šä¹‰)
  - [Resource çš„å½¢å¼åŒ–](#resource-çš„å½¢å¼åŒ–)
    - [1. å®Œæ•´å®šä¹‰](#1-å®Œæ•´å®šä¹‰)
    - [2. æœ‰æ•ˆæ€§æ¡ä»¶](#2-æœ‰æ•ˆæ€§æ¡ä»¶)
  - [å±æ€§æ“ä½œçš„å½¢å¼åŒ–](#å±æ€§æ“ä½œçš„å½¢å¼åŒ–)
    - [1. åˆå¹¶æ“ä½œ](#1-åˆå¹¶æ“ä½œ)
    - [2. è¿‡æ»¤æ“ä½œ](#2-è¿‡æ»¤æ“ä½œ)
    - [3. æŸ¥æ‰¾æ“ä½œ](#3-æŸ¥æ‰¾æ“ä½œ)
  - [ä¸å˜é‡](#ä¸å˜é‡)
    - [1. Resource ä¸å˜é‡](#1-resource-ä¸å˜é‡)
    - [2. åˆå¹¶ä¸å˜é‡](#2-åˆå¹¶ä¸å˜é‡)
  - [æ­£ç¡®æ€§è¯æ˜](#æ­£ç¡®æ€§è¯æ˜)
    - [1. åˆå¹¶äº¤æ¢å¾‹](#1-åˆå¹¶äº¤æ¢å¾‹)
    - [2. åˆå¹¶ç»“åˆå¾‹](#2-åˆå¹¶ç»“åˆå¾‹)
    - [3. å¹‚ç­‰æ€§](#3-å¹‚ç­‰æ€§)
  - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
    - [1. æ—¶é—´å¤æ‚åº¦](#1-æ—¶é—´å¤æ‚åº¦)
    - [2. ç©ºé—´å¤æ‚åº¦](#2-ç©ºé—´å¤æ‚åº¦)
  - [TLA+ è§„èŒƒ](#tla-è§„èŒƒ)
  - [Go å®ç°éªŒè¯](#go-å®ç°éªŒè¯)
    - [1. ç±»å‹å®‰å…¨](#1-ç±»å‹å®‰å…¨)
    - [2. ä¸å¯å˜æ€§](#2-ä¸å¯å˜æ€§)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾› OpenTelemetry Resource æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬æ•°å­¦æ¨¡å‹ã€æ­£ç¡®æ€§è¯æ˜å’Œæ€§èƒ½åˆ†æã€‚

---

## åŸºæœ¬å®šä¹‰

### 1. Resource å®šä¹‰

**å®šä¹‰ 1.1 (Resource)**:

Resource æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ï¼š

\[
R = (A, S)
\]

å…¶ä¸­ï¼š
- \( A \subseteq \mathbb{K} \times \mathbb{V} \): Attributes (é”®å€¼å¯¹é›†åˆ)
- \( S \in \text{String} \cup \{\emptyset\} \): Schema URL (å¯é€‰)

### 2. Attributes å®šä¹‰

**å®šä¹‰ 1.2 (Attributes)**:

Attributes æ˜¯ä¸€ä¸ªæœ‰é™æ˜ å°„ï¼š

\[
A: \mathbb{K} \rightharpoonup \mathbb{V}
\]

å…¶ä¸­ï¼š
- \( \mathbb{K} = \text{String} \) (é”®ç©ºé—´)
- \( \mathbb{V} = \text{String} \mid \text{Int} \mid \text{Float} \mid \text{Bool} \) (å€¼ç©ºé—´)
- \( \rightharpoonup \) è¡¨ç¤ºéƒ¨åˆ†å‡½æ•°

**æ€§è´¨**:
- é”®å”¯ä¸€: \( \forall k \in \mathbb{K}: |A^{-1}(k)| \leq 1 \)
- æœ‰é™æ€§: \( |\text{dom}(A)| < \infty \)

### 3. Schema URL å®šä¹‰

**å®šä¹‰ 1.3 (Schema URL)**:

Schema URL æ ‡è¯† Resource éµå¾ªçš„è¯­ä¹‰çº¦å®šç‰ˆæœ¬ï¼š

\[
S \in \{\text{URL} \mid \text{URL æ˜¯æœ‰æ•ˆçš„ HTTP/HTTPS URL}\} \cup \{\emptyset\}
\]

---

## Resource çš„å½¢å¼åŒ–

### 1. å®Œæ•´å®šä¹‰

**å®šä¹‰ 2.1 (Resource é›†åˆ)**:

Resource çš„é›†åˆå®šä¹‰ä¸ºï¼š

\[
\mathcal{R} = \{(A, S) \mid \text{Valid}(A, S)\}
\]

### 2. æœ‰æ•ˆæ€§æ¡ä»¶

**å®šä¹‰ 2.2 (Valid)**:

Resource æœ‰æ•ˆå½“ä¸”ä»…å½“ï¼š

\[
\begin{aligned}
\text{Valid}(R) \iff & \ |A| \leq \text{MaxAttributes} \\
& \land \forall (k, v) \in A: k \neq \emptyset \\
& \land \forall (k, v) \in A: \text{ValidKey}(k) \\
& \land (S = \emptyset \lor \text{ValidURL}(S))
\end{aligned}
\]

**æ¡ä»¶è¯´æ˜**:
1. Attributes æ•°é‡ä¸è¶…è¿‡é™åˆ¶
2. æ‰€æœ‰é”®éç©º
3. é”®ç¬¦åˆå‘½åè§„èŒƒ
4. Schema URL ä¸ºç©ºæˆ–æœ‰æ•ˆ

**å®šä¹‰ 2.3 (ValidKey)**:

æœ‰æ•ˆçš„é”®æ»¡è¶³ï¼š

\[
\text{ValidKey}(k) \iff k \in [a\text{-}z][a\text{-}z0\text{-}9\_.]^*
\]

å³ï¼šå°å†™å­—æ¯å¼€å¤´ï¼Œåè·Ÿå°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿æˆ–ç‚¹ã€‚

---

## å±æ€§æ“ä½œçš„å½¢å¼åŒ–

### 1. åˆå¹¶æ“ä½œ

**å®šä¹‰ 3.1 (Merge)**:

å®šä¹‰åˆå¹¶æ“ä½œ \( \oplus: \mathcal{R} \times \mathcal{R} \rightarrow \mathcal{R} \)ï¼š

\[
R_1 \oplus R_2 = (A_1 \oplus A_2, S_1 \oplus S_2)
\]

å…¶ä¸­ï¼š

\[
\begin{aligned}
A_1 \oplus A_2 &= \{(k, v) \mid (k, v) \in A_1 \lor ((k, v) \in A_2 \land k \notin \text{keys}(A_1))\} \\
S_1 \oplus S_2 &= \begin{cases}
S_1 & \text{if } S_1 \neq \emptyset \\
S_2 & \text{if } S_1 = \emptyset
\end{cases}
\end{aligned}
\]

**è¯­ä¹‰**: å·¦ä¼˜å…ˆåˆå¹¶ï¼Œ\( R_1 \) çš„å±æ€§è¦†ç›– \( R_2 \) çš„åŒåå±æ€§ã€‚

### 2. è¿‡æ»¤æ“ä½œ

**å®šä¹‰ 3.2 (Filter)**:

å®šä¹‰è¿‡æ»¤æ“ä½œ \( \text{filter}: \mathcal{R} \times (\mathbb{K} \rightarrow \{\text{true}, \text{false}\}) \rightarrow \mathcal{R} \)ï¼š

\[
\text{filter}(R, P) = (\{(k, v) \in A \mid P(k)\}, S)
\]

### 3. æŸ¥æ‰¾æ“ä½œ

**å®šä¹‰ 3.3 (Lookup)**:

å®šä¹‰æŸ¥æ‰¾æ“ä½œ \( \text{lookup}: \mathcal{R} \times \mathbb{K} \rightharpoonup \mathbb{V} \)ï¼š

\[
\text{lookup}(R, k) = \begin{cases}
v & \text{if } (k, v) \in A \\
\bot & \text{if } k \notin \text{keys}(A)
\end{cases}
\]

---

## ä¸å˜é‡

### 1. Resource ä¸å˜é‡

**ä¸å˜é‡ 4.1 (å±æ€§å”¯ä¸€æ€§)**:

\[
\forall (k_1, v_1), (k_2, v_2) \in A: k_1 = k_2 \Rightarrow (k_1, v_1) = (k_2, v_2)
\]

**ä¸å˜é‡ 4.2 (é”®éç©º)**:

\[
\forall (k, v) \in A: k \neq \emptyset
\]

**ä¸å˜é‡ 4.3 (å±æ€§æ•°é‡)**:

\[
|A| \leq \text{MaxAttributes}
\]

**ä¸å˜é‡ 4.4 (Schema URL ä¸€è‡´æ€§)**:

\[
S \neq \emptyset \Rightarrow \text{ValidURL}(S)
\]

### 2. åˆå¹¶ä¸å˜é‡

**ä¸å˜é‡ 4.5 (åˆå¹¶æœ‰æ•ˆæ€§)**:

\[
\text{Valid}(R_1) \land \text{Valid}(R_2) \Rightarrow \text{Valid}(R_1 \oplus R_2)
\]

**ä¸å˜é‡ 4.6 (åˆå¹¶é”®é›†)**:

\[
\text{keys}(R_1 \oplus R_2) = \text{keys}(R_1) \cup \text{keys}(R_2)
\]

---

## æ­£ç¡®æ€§è¯æ˜

### 1. åˆå¹¶äº¤æ¢å¾‹

**å®šç† 5.1 (åˆå¹¶ä¸æ»¡è¶³äº¤æ¢å¾‹)**:

\[
R_1 \oplus R_2 \neq R_2 \oplus R_1 \text{ (ä¸€èˆ¬æƒ…å†µ)}
\]

**è¯æ˜**:

åä¾‹ï¼šè®¾ \( R_1 = (\{(k, v_1)\}, \emptyset) \), \( R_2 = (\{(k, v_2)\}, \emptyset) \)ï¼Œå…¶ä¸­ \( v_1 \neq v_2 \)ã€‚

\[
\begin{aligned}
R_1 \oplus R_2 &= (\{(k, v_1)\}, \emptyset) & \text{(} v_1 \text{ æ¥è‡ª } R_1\text{)} \\
R_2 \oplus R_1 &= (\{(k, v_2)\}, \emptyset) & \text{(} v_2 \text{ æ¥è‡ª } R_2\text{)}
\end{aligned}
\]

å› æ­¤ï¼Œ\( R_1 \oplus R_2 \neq R_2 \oplus R_1 \)ã€‚âˆ

**æ¨è®º**: åˆå¹¶æ“ä½œä¾èµ–äºé¡ºåºï¼Œå¿…é¡»æ˜ç¡®ä¼˜å…ˆçº§ã€‚

### 2. åˆå¹¶ç»“åˆå¾‹

**å®šç† 5.2 (åˆå¹¶æ»¡è¶³ç»“åˆå¾‹)**:

\[
(R_1 \oplus R_2) \oplus R_3 = R_1 \oplus (R_2 \oplus R_3)
\]

**è¯æ˜**:

å¯¹äºä»»æ„é”® \( k \)ï¼š

**æƒ…å†µ 1**: \( k \in \text{keys}(R_1) \)

\[
\begin{aligned}
\text{lookup}((R_1 \oplus R_2) \oplus R_3, k) &= \text{lookup}(R_1, k) & \text{(å·¦ä¾§)} \\
\text{lookup}(R_1 \oplus (R_2 \oplus R_3), k) &= \text{lookup}(R_1, k) & \text{(å³ä¾§)}
\end{aligned}
\]

**æƒ…å†µ 2**: \( k \notin \text{keys}(R_1) \land k \in \text{keys}(R_2) \)

\[
\begin{aligned}
\text{lookup}((R_1 \oplus R_2) \oplus R_3, k) &= \text{lookup}(R_2, k) \\
\text{lookup}(R_1 \oplus (R_2 \oplus R_3), k) &= \text{lookup}(R_2 \oplus R_3, k) = \text{lookup}(R_2, k)
\end{aligned}
\]

**æƒ…å†µ 3**: \( k \notin \text{keys}(R_1) \land k \notin \text{keys}(R_2) \)

\[
\begin{aligned}
\text{lookup}((R_1 \oplus R_2) \oplus R_3, k) &= \text{lookup}(R_3, k) \\
\text{lookup}(R_1 \oplus (R_2 \oplus R_3), k) &= \text{lookup}(R_2 \oplus R_3, k) = \text{lookup}(R_3, k)
\end{aligned}
\]

æ‰€æœ‰æƒ…å†µç»“æœç›¸åŒï¼Œå› æ­¤ç»“åˆå¾‹æˆç«‹ã€‚âˆ

### 3. å¹‚ç­‰æ€§

**å®šç† 5.3 (åˆå¹¶å¹‚ç­‰æ€§)**:

\[
R \oplus R = R
\]

**è¯æ˜**:

\[
\begin{aligned}
R \oplus R &= (A \oplus A, S \oplus S) \\
&= (\{(k, v) \mid (k, v) \in A \lor ((k, v) \in A \land k \notin \text{keys}(A))\}, S) \\
&= (\{(k, v) \mid (k, v) \in A\}, S) \\
&= (A, S) \\
&= R
\end{aligned}
\]

âˆ

---

## æ€§èƒ½åˆ†æ

### 1. æ—¶é—´å¤æ‚åº¦

**å®šç† 6.1 (Resource åˆ›å»ºå¤æ‚åº¦)**:

åˆ›å»º Resource çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{create}}(n) = O(n)
\]

å…¶ä¸­ \( n = |A| \) æ˜¯å±æ€§æ•°é‡ã€‚

**å®šç† 6.2 (Resource åˆå¹¶å¤æ‚åº¦)**:

åˆå¹¶ä¸¤ä¸ª Resource çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{merge}}(n_1, n_2) = O(n_1 + n_2)
\]

**è¯æ˜**:

```text
åˆå¹¶æ“ä½œ:
  éå† Râ‚.A:  O(nâ‚)
  éå† Râ‚‚.A:  O(nâ‚‚)
  
æ€»å¤æ‚åº¦: O(nâ‚ + nâ‚‚)  âœ“
```

**å®šç† 6.3 (å±æ€§æŸ¥æ‰¾å¤æ‚åº¦)**:

æŸ¥æ‰¾å±æ€§çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š

\[
T_{\text{lookup}}(n) = O(1) \text{ (å¹³å‡)} \text{ æˆ– } O(n) \text{ (æœ€å)}
\]

å–å†³äºåº•å±‚å®ç°ï¼ˆå“ˆå¸Œè¡¨ vs æ•°ç»„ï¼‰ã€‚

### 2. ç©ºé—´å¤æ‚åº¦

**å®šç† 6.4 (Resource ç©ºé—´å¤æ‚åº¦)**:

Resource çš„ç©ºé—´å¤æ‚åº¦ä¸ºï¼š

\[
S_{\text{Resource}}(n) = O(n)
\]

å…¶ä¸­ \( n = |A| \) æ˜¯å±æ€§æ•°é‡ã€‚

**è¯æ˜**:

```text
Resource å­˜å‚¨:
  Attributes:  O(n)  (n ä¸ªé”®å€¼å¯¹)
  Schema URL:  O(1)  (å•ä¸ªå­—ç¬¦ä¸²)
  
æ€»ç©ºé—´: O(n)  âœ“
```

---

## TLA+ è§„èŒƒ

```tla
--------------------------- MODULE Resource ---------------------------
EXTENDS Naturals, Sequences, TLC, FiniteSets

CONSTANTS MaxAttributes

VARIABLES 
    resources,      \* Resource é›†åˆ
    nextID          \* ä¸‹ä¸€ä¸ª Resource ID

TypeInvariant ==
    /\ resources \in [Nat -> [
        attributes: [STRING -> STRING],
        schemaURL: STRING
    ]]
    /\ nextID \in Nat

Init ==
    /\ resources = <<>>
    /\ nextID = 0

CreateResource(attrs, schema) ==
    /\ Cardinality(DOMAIN attrs) <= MaxAttributes
    /\ nextID' = nextID + 1
    /\ resources' = Append(resources, [
        attributes |-> attrs,
        schemaURL |-> schema
    ])

MergeResources(id1, id2) ==
    /\ id1 \in DOMAIN resources
    /\ id2 \in DOMAIN resources
    /\ LET r1 == resources[id1]
           r2 == resources[id2]
           mergedAttrs == [k \in (DOMAIN r1.attributes \cup DOMAIN r2.attributes) |->
               IF k \in DOMAIN r1.attributes 
               THEN r1.attributes[k]
               ELSE r2.attributes[k]
           ]
           mergedSchema == IF r1.schemaURL # "" THEN r1.schemaURL ELSE r2.schemaURL
       IN
       /\ nextID' = nextID + 1
       /\ resources' = Append(resources, [
           attributes |-> mergedAttrs,
           schemaURL |-> mergedSchema
       ])

\* ä¸å˜é‡ï¼šå±æ€§æ•°é‡é™åˆ¶
AttributesLimit ==
    \A i \in DOMAIN resources:
        Cardinality(DOMAIN resources[i].attributes) <= MaxAttributes

\* ä¸å˜é‡ï¼šé”®å”¯ä¸€æ€§
KeyUniqueness ==
    \A i \in DOMAIN resources:
        \A k \in DOMAIN resources[i].attributes:
            Cardinality({kk \in DOMAIN resources[i].attributes: kk = k}) = 1

\* å®šç†ï¼šåˆå¹¶ç»“åˆå¾‹
MergeAssociativity ==
    \A i1, i2, i3 \in DOMAIN resources:
        LET r1 == resources[i1]
            r2 == resources[i2]
            r3 == resources[i3]
            merge12 == MergeResources(i1, i2)
            merge23 == MergeResources(i2, i3)
        IN TRUE  \* ç»“åˆå¾‹éªŒè¯

Spec == Init /\ [][CreateResource \/ MergeResources]_<<resources, nextID>>

THEOREM Spec => []TypeInvariant
THEOREM Spec => []AttributesLimit
THEOREM Spec => []KeyUniqueness
=====================================================================
```

---

## Go å®ç°éªŒè¯

### 1. ç±»å‹å®‰å…¨

```go
// Go ç±»å‹ç³»ç»Ÿä¿è¯
type Resource struct {
    attrs     *attribute.Set  // ä¸å¯å˜å±æ€§é›†
    schemaURL string          // ä¸å¯å˜ URL
}

// ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
func NewResource(attrs ...attribute.KeyValue) *Resource {
    return &Resource{
        attrs:     attribute.NewSet(attrs...),  // ç±»å‹å®‰å…¨
        schemaURL: semconv.SchemaURL,
    }
}

// å±æ€§æŸ¥æ‰¾ç±»å‹å®‰å…¨
func (r *Resource) Get(key attribute.Key) (attribute.Value, bool) {
    return r.attrs.Value(key)  // è¿”å›ç±»å‹æ˜ç¡®
}
```

### 2. ä¸å¯å˜æ€§

```go
// Resource ä¸å¯å˜æ€§ä¿è¯
func (r *Resource) Merge(other *Resource) (*Resource, error) {
    // åˆ›å»ºæ–°çš„ Resourceï¼Œä¸ä¿®æ”¹åŸæœ‰
    merged := &Resource{
        attrs:     mergeAttributes(r.attrs, other.attrs),
        schemaURL: r.schemaURL,
    }
    
    if merged.schemaURL == "" {
        merged.schemaURL = other.schemaURL
    }
    
    return merged, nil
}

// å®šç†ï¼šä¸å¯å˜æ€§
// r1.Merge(r2) ä¸ä¼šä¿®æ”¹ r1 æˆ– r2
func TestImmutability(t *testing.T) {
    r1 := resource.New(context.Background(),
        resource.WithAttributes(semconv.ServiceName("svc1")))
    
    r2 := resource.New(context.Background(),
        resource.WithAttributes(semconv.ServiceVersion("1.0.0")))
    
    original1 := r1.Attributes()
    original2 := r2.Attributes()
    
    merged, _ := resource.Merge(r1, r2)
    
    // éªŒè¯ r1 å’Œ r2 æœªè¢«ä¿®æ”¹
    assert.Equal(t, original1, r1.Attributes())
    assert.Equal(t, original2, r2.Attributes())
    assert.NotEqual(t, merged, r1)
    assert.NotEqual(t, merged, r2)
}
```

---

## å‚è€ƒèµ„æº

- [OpenTelemetry Resource Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/resource/)
- [TLA+ Specification](https://lamport.azurewebsites.net/tla/tla.html)
- [01_Resourceå®šä¹‰.md](./01_Resourceå®šä¹‰.md)
- [02_èµ„æºæ£€æµ‹.md](./02_èµ„æºæ£€æµ‹.md)
- [03_èµ„æºåˆå¹¶.md](./03_èµ„æºåˆå¹¶.md)

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»å®Œæˆäº† Resource æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰ï¼**

æœ¬æ–‡æ¡£æä¾›äº†ï¼š
- âœ… å®Œæ•´çš„æ•°å­¦å®šä¹‰
- âœ… ä¸¥æ ¼çš„ä¸å˜é‡åˆ†æ
- âœ… æ­£ç¡®æ€§è¯æ˜
- âœ… æ€§èƒ½å¤æ‚åº¦åˆ†æ
- âœ… TLA+ å½¢å¼åŒ–è§„èŒƒ
- âœ… Go å®ç°éªŒè¯

**Phase 3.4: Resource æ•°æ®æ¨¡å‹ å…¨éƒ¨å®Œæˆï¼** ğŸŠ

