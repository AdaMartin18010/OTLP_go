# OpenTelemetry 生产环境配置模板

> **目标**: 生产级高可用、高性能、低成本配置  
> **特点**: 1-10%采样、批处理优化、高可用部署、成本控制  
> **适用场景**: 生产环境、大规模部署、成本敏感场景  
> **难度**: ⭐⭐⭐⭐ (需要调优)

---

## 快速部署

```bash
# Kubernetes 部署
kubectl apply -f k8s-prod/

# 验证
kubectl get pods -n observability
kubectl logs -f deployment/otel-collector -n observability
```

---

## 生产级 Go 应用配置

```go:pkg/telemetry/production.go
package telemetry

import (
    "context"
    "time"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
)

func InitProduction(ctx context.Context, serviceName string) (*sdktrace.TracerProvider, error) {
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String(serviceName),
            semconv.DeploymentEnvironmentKey.String("production"),
        ),
    )
    if err != nil {
        return nil, err
    }

    exporter, err := otlptracegrpc.New(ctx,
        otlptracegrpc.WithEndpoint("otel-collector.observability.svc.cluster.local:4317"),
        otlptracegrpc.WithInsecure(),
        otlptracegrpc.WithTimeout(5*time.Second),
    )
    if err != nil {
        return nil, err
    }

    tp := sdktrace.NewTracerProvider(
        sdktrace.WithResource(res),
        // 生产环境：采样优化
        sdktrace.WithSampler(sdktrace.ParentBased(
            sdktrace.TraceIDRatioBased(0.05), // 5% 采样
        )),
        // 批处理优化
        sdktrace.WithBatcher(exporter,
            sdktrace.WithBatchTimeout(10*time.Second),
            sdktrace.WithMaxExportBatchSize(512),
            sdktrace.WithMaxQueueSize(2048),
        ),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}
```

---

## Kubernetes 部署

### DaemonSet 配置

```yaml:k8s-prod/otel-collector-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: observability
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.96.0
        ports:
        - containerPort: 4317
        resources:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: config
          mountPath: /etc/otel
      volumes:
      - name: config
        configMap:
          name: otel-collector-config
```

### Collector 配置

```yaml:k8s-prod/otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        max_recv_msg_size_mib: 32

processors:
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1024

  k8sattributes:
    auth_type: "serviceAccount"
    passthrough: false
    extract:
      metadata:
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.node.name

  # Tail Sampling（保留错误和慢请求）
  tail_sampling:
    decision_wait: 10s
    num_traces: 100
    policies:
      - name: errors
        type: status_code
        status_code:
          status_codes: [ERROR]
      - name: slow
        type: latency
        latency:
          threshold_ms: 1000
      - name: random
        type: probabilistic
        probabilistic:
          sampling_percentage: 1  # 1% 随机采样

  # 内存限制
  memory_limiter:
    check_interval: 1s
    limit_mib: 1536  # 1.5GB
    spike_limit_mib: 512

exporters:
  otlp/jaeger:
    endpoint: jaeger-collector:4317
    tls:
      insecure: true

  prometheusremotewrite:
    endpoint: http://prometheus:9090/api/v1/write

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, k8sattributes, tail_sampling, batch]
      exporters: [otlp/jaeger]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, k8sattributes, batch]
      exporters: [prometheusremotewrite]
```

---

## 监控告警

### Prometheus 告警规则

```yaml:alerts.yaml
groups:
  - name: otel_collector
    rules:
      - alert: OTELCollectorDown
        expr: up{job="otel-collector"} == 0
        for: 5m
        annotations:
          summary: "OTLP Collector is down"

      - alert: HighDropRate
        expr: rate(otelcol_processor_dropped_spans[5m]) > 100
        for: 5m
        annotations:
          summary: "High span drop rate"

      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes{pod=~"otel-collector.*"} > 1.8e9
        for: 5m
        annotations:
          summary: "OTLP Collector memory usage > 1.8GB"
```

---

## 成本优化

### 采样策略

- **Head Sampling**: 5% 采样率
- **Tail Sampling**: 保留100%错误 + 100%慢请求 + 1%随机

### 数据归档

```yaml
exporters:
  s3:
    region: us-east-1
    s3_bucket: traces-archive
    compression: gzip
service:
  pipelines:
    traces:
      exporters: [otlp/jaeger, s3]  # 同时归档到 S3
```

### 估算成本

```text
假设:
- 100万 RPM (requests per minute)
- 5% 采样率 = 50,000 traces/min
- 平均 Span 大小 = 2KB
- 数据量 = 50,000 * 2KB = 100MB/min = 144GB/day

成本:
- Jaeger 存储 (7天): 144GB * 7 = 1TB @ $0.023/GB = $23/day
- S3 归档 (90天): 144GB * 90 = 12.96TB @ $0.004/GB = $52/month
- 网络传输: ~$10/month

总计: ~$60-70/month
```

---

## 性能调优

### 1. 连接池

```go
exporter, err := otlptracegrpc.New(ctx,
    otlptracegrpc.WithDialOption(
        grpc.WithDefaultCallOptions(
            grpc.MaxCallRecvMsgSize(16*1024*1024), // 16MB
        ),
    ),
)
```

### 2. 批处理

```yaml
processors:
  batch:
    timeout: 10s
    send_batch_size: 512        # 批次大小
    send_batch_max_size: 1024   # 最大批次
```

### 3. 并发

```yaml
exporters:
  otlp:
    endpoint: jaeger:4317
    sending_queue:
      enabled: true
      num_consumers: 10  # 10个并发导出
      queue_size: 5000
```

---

## 故障恢复

### 重试策略

```yaml
exporters:
  otlp:
    endpoint: jaeger:4317
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
```

### 降级策略

```go
// 如果 Collector 不可用，降级为本地日志
exporter, err := otlptracegrpc.New(ctx)
if err != nil {
    log.Warn("OTLP exporter unavailable, fallback to logging")
    exporter = loggingExporter()
}
```

---

## 🎯 生产检查清单

- [ ] 采样率设置（1-10%）
- [ ] 批处理配置（10s, 512 spans）
- [ ] 内存限制（< 2GB）
- [ ] 资源限制（CPU/Memory requests & limits）
- [ ] 监控告警（Prometheus alerts）
- [ ] 成本监控（数据量追踪）
- [ ] 灾备方案（多 Collector 实例）
- [ ] 日志级别（warn 或 error）

---

**🎊 生产环境配置完成！**

- 📚 [中间件集成](./04_中间件集成_Gin.md)
- 📚 [实战案例](../实战案例/)
