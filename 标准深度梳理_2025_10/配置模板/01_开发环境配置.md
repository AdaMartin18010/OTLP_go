# OpenTelemetry å¼€å‘ç¯å¢ƒé…ç½®æ¨¡æ¿

> **ç›®æ ‡**: å¿«é€Ÿå¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ŒæŸ¥çœ‹å®Œæ•´ Trace  
> **ç‰¹ç‚¹**: 100%é‡‡æ ·ã€Consoleè¾“å‡ºã€æœ¬åœ°Jaegerã€å¿«é€Ÿè°ƒè¯•  
> **é€‚ç”¨åœºæ™¯**: æœ¬åœ°å¼€å‘ã€åŠŸèƒ½è°ƒè¯•ã€å­¦ä¹ OpenTelemetry  
> **éš¾åº¦**: â­ (å¼€ç®±å³ç”¨)

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1åˆ†é’Ÿå¯åŠ¨

```bash
# 1. å¯åŠ¨æœ¬åœ° Collector + Jaeger + Prometheus
cd é…ç½®æ¨¡æ¿/
docker-compose -f docker-compose.dev.yml up -d

# 2. è¿è¡Œæ‚¨çš„åº”ç”¨
export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4317"
export OTEL_SERVICE_NAME="my-dev-service"
export OTEL_TRACES_SAMPLER="always_on"
go run main.go

# 3. æŸ¥çœ‹ Traces
open http://localhost:16686  # Jaeger UI
```

---

## Go åº”ç”¨é…ç½®

### main.go

```go:main.go
package main

import (
    "context"
    "log"
    "os"
    "os/signal"
    "time"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/exporters/stdout/stdouttrace"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
)

func main() {
    ctx := context.Background()

    // åˆå§‹åŒ– Telemetry
    shutdown, err := initTelemetry(ctx)
    if err != nil {
        log.Fatal(err)
    }
    defer func() {
        if err := shutdown(ctx); err != nil {
            log.Printf("failed to shutdown: %v", err)
        }
    }()

    // è¿è¡Œåº”ç”¨
    runApp(ctx)

    // ä¼˜é›…å…³é—­
    waitForShutdown()
}

// initTelemetry åˆå§‹åŒ– OpenTelemetryï¼ˆå¼€å‘ç¯å¢ƒï¼‰
func initTelemetry(ctx context.Context) (func(context.Context) error, error) {
    // 1. Resource
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String(getEnv("OTEL_SERVICE_NAME", "dev-service")),
            semconv.ServiceVersionKey.String("dev"),
            semconv.DeploymentEnvironmentKey.String("development"),
        ),
    )
    if err != nil {
        return nil, err
    }

    // 2. åˆ›å»ºå¤šä¸ª Exporterï¼ˆå¼€å‘ç¯å¢ƒå¯ä»¥åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªåœ°æ–¹ï¼‰
    
    // 2.1 Console Exporterï¼ˆç»ˆç«¯è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
    consoleExporter, err := stdouttrace.New(
        stdouttrace.WithPrettyPrint(), // æ ¼å¼åŒ–è¾“å‡º
    )
    if err != nil {
        return nil, err
    }

    // 2.2 OTLP Exporterï¼ˆå‘é€åˆ° Collectorï¼‰
    conn, err := grpc.NewClient(
        getEnv("OTEL_EXPORTER_OTLP_ENDPOINT", "localhost:4317"),
        grpc.WithTransportCredentials(insecure.NewCredentials()),
    )
    if err != nil {
        return nil, err
    }

    otlpExporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithGRPCConn(conn))
    if err != nil {
        return nil, err
    }

    // 3. TracerProviderï¼ˆå¼€å‘ç¯å¢ƒé…ç½®ï¼‰
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithResource(res),
        
        // å¼€å‘ç¯å¢ƒï¼š100% é‡‡æ ·ï¼ˆæŸ¥çœ‹æ‰€æœ‰ Traceï¼‰
        sdktrace.WithSampler(sdktrace.AlwaysSample()),
        
        // Console Exporter - ç®€å•å¯¼å‡ºå™¨ï¼Œç«‹å³è¾“å‡º
        sdktrace.WithSyncer(consoleExporter),
        
        // OTLP Exporter - æ‰¹å¤„ç†å¯¼å‡ºå™¨ï¼ˆå‘é€åˆ° Jaegerï¼‰
        sdktrace.WithBatcher(otlpExporter,
            sdktrace.WithBatchTimeout(1*time.Second),     // å¿«é€Ÿå¯¼å‡º
            sdktrace.WithMaxExportBatchSize(128),          // å°æ‰¹æ¬¡
        ),
    )
    otel.SetTracerProvider(tp)

    // 4. Propagatorï¼ˆè·¨æœåŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­ï¼‰
    otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
        propagation.TraceContext{},
        propagation.Baggage{},
    ))

    // 5. è¿”å› Shutdown å‡½æ•°
    return func(ctx context.Context) error {
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()
        return tp.Shutdown(ctx)
    }, nil
}

// runApp è¿è¡Œç¤ºä¾‹åº”ç”¨
func runApp(ctx context.Context) {
    tracer := otel.Tracer("dev-service")

    ctx, span := tracer.Start(ctx, "main.runApp")
    defer span.End()

    // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
    doSomething(ctx)
}

func doSomething(ctx context.Context) {
    tracer := otel.Tracer("dev-service")
    
    ctx, span := tracer.Start(ctx, "doSomething")
    defer span.End()

    // æ¨¡æ‹Ÿå·¥ä½œ
    time.Sleep(100 * time.Millisecond)
    
    log.Println("Work done!")
}

// getEnv è·å–ç¯å¢ƒå˜é‡ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
func getEnv(key, defaultValue string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return defaultValue
}

// waitForShutdown ç­‰å¾…å…³é—­ä¿¡å·
func waitForShutdown() {
    c := make(chan os.Signal, 1)
    signal.Notify(c, os.Interrupt)
    <-c
    log.Println("Shutting down gracefully...")
}
```

---

## Docker Compose é…ç½®

### docker-compose.dev.yml

```yaml:docker-compose.dev.yml
version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: otel-collector-dev
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-dev.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics
      - "13133:13133" # Health check
    depends_on:
      - jaeger
      - prometheus

  # Jaeger (All-in-One)
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: jaeger-dev
    ports:
      - "16686:16686"  # UI
      - "14250:14250"  # gRPC
      - "14268:14268"  # HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  # Prometheus
  prometheus:
    image: prom/prometheus:v2.49.0
    container_name: prometheus-dev
    volumes:
      - ./prometheus-dev.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

  # Grafana (å¯é€‰)
  grafana:
    image: grafana/grafana:10.3.0
    container_name: grafana-dev
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - grafana-storage:/var/lib/grafana

volumes:
  grafana-storage:
```

### otel-collector-dev.yaml

```yaml:otel-collector-dev.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # æ‰¹å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼šå°æ‰¹æ¬¡ï¼Œå¿«é€Ÿå¯¼å‡ºï¼‰
  batch:
    timeout: 1s
    send_batch_size: 128

  # èµ„æºå±æ€§ï¼ˆæ·»åŠ ç¯å¢ƒä¿¡æ¯ï¼‰
  resource:
    attributes:
      - key: deployment.environment
        value: development
        action: insert

  # å±æ€§å¤„ç†ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
  attributes:
    actions:
      - key: dev.mode
        value: "true"
        action: insert

exporters:
  # Jaeger Exporter
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  # Prometheus Exporter
  prometheus:
    endpoint: "0.0.0.0:8888"

  # Console Exporterï¼ˆåœ¨ Collector æ—¥å¿—ä¸­è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
  logging:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resource, attributes, batch]
      exporters: [jaeger, logging]  # åŒæ—¶è¾“å‡ºåˆ° Jaeger å’Œ Console
      
    metrics:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [prometheus, logging]

  extensions:
    - health_check

  # å¼€å‘ç¯å¢ƒï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—
  telemetry:
    logs:
      level: debug
```

### prometheus-dev.yml

```yaml:prometheus-dev.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # OpenTelemetry Collector Metrics
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']

  # åº”ç”¨ Metricsï¼ˆå¦‚æœåº”ç”¨ä¹Ÿæš´éœ² Prometheus metricsï¼‰
  - job_name: 'app'
    static_configs:
      - targets: ['host.docker.internal:8080']  # Mac/Windows
      # - targets: ['172.17.0.1:8080']          # Linux
```

---

## ç¯å¢ƒå˜é‡é…ç½®

### .env.dev

```bash:.env.dev
# OpenTelemetry é…ç½®
OTEL_SERVICE_NAME=my-dev-service
OTEL_SERVICE_VERSION=dev
OTEL_DEPLOYMENT_ENVIRONMENT=development

# Exporter é…ç½®
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
OTEL_EXPORTER_OTLP_INSECURE=true

# é‡‡æ ·é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼š100%é‡‡æ ·ï¼‰
OTEL_TRACES_SAMPLER=always_on

# æ—¥å¿—çº§åˆ«
OTEL_LOG_LEVEL=debug

# èµ„æºå±æ€§
OTEL_RESOURCE_ATTRIBUTES=deployment.environment=development,service.name=my-dev-service
```

### åŠ è½½ç¯å¢ƒå˜é‡

```bash
# æ–¹æ³• 1: source
source .env.dev

# æ–¹æ³• 2: export
set -a
source .env.dev
set +a

# æ–¹æ³• 3: direnv (æ¨è)
# echo "source_env .env.dev" > .envrc
# direnv allow
```

---

## VS Code è°ƒè¯•é…ç½®

### .vscode/launch.json

```json:.vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug with OTLP",
      "type": "go",
      "request": "launch",
      "mode": "auto",
      "program": "${workspaceFolder}",
      "env": {
        "OTEL_SERVICE_NAME": "my-dev-service",
        "OTEL_EXPORTER_OTLP_ENDPOINT": "http://localhost:4317",
        "OTEL_TRACES_SAMPLER": "always_on",
        "OTEL_LOG_LEVEL": "debug"
      },
      "args": [],
      "showLog": true
    }
  ]
}
```

---

## éªŒè¯ä¸è°ƒè¯•

### 1. æ£€æŸ¥ Collector å¥åº·çŠ¶æ€

```bash
curl http://localhost:13133
# è¾“å‡º: {"status":"Server available"}
```

### 2. æŸ¥çœ‹ Collector Metrics

```bash
curl http://localhost:8888/metrics | grep otelcol
```

### 3. è®¿é—® Jaeger UI

```bash
open http://localhost:16686
```

**æ“ä½œ**:

1. é€‰æ‹© Service: `my-dev-service`
2. ç‚¹å‡» "Find Traces"
3. æŸ¥çœ‹ Trace è¯¦æƒ…

### 4. æŸ¥çœ‹ Console è¾“å‡º

ç»ˆç«¯ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```json
{
  "Name": "main.runApp",
  "SpanContext": {
    "TraceID": "4bf92f3577b34da6a3ce929d0e0e4736",
    "SpanID": "00f067aa0ba902b7",
    "TraceFlags": "01",
    "TraceState": "",
    "Remote": false
  },
  "Parent": {...},
  "SpanKind": "Internal",
  "StartTime": "2025-10-09T10:00:00.000000Z",
  "EndTime": "2025-10-09T10:00:00.150000Z",
  "Attributes": [...],
  "Events": null,
  "Links": null,
  "Status": {
    "Code": "Unset",
    "Description": ""
  },
  "DroppedAttributes": 0,
  "DroppedEvents": 0,
  "DroppedLinks": 0,
  "ChildSpanCount": 1,
  "Resource": [...],
  "InstrumentationScope": {
    "Name": "dev-service",
    "Version": "",
    "SchemaURL": ""
  }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆçœ‹ä¸åˆ° Tracesï¼Ÿ

**æ£€æŸ¥æ¸…å•**:

- [ ] Collector æ˜¯å¦å¯åŠ¨ï¼Ÿ`docker ps`
- [ ] åº”ç”¨æ˜¯å¦æ­£ç¡®è¿æ¥ï¼Ÿæ£€æŸ¥ `OTEL_EXPORTER_OTLP_ENDPOINT`
- [ ] é˜²ç«å¢™æ˜¯å¦é˜»æ­¢ï¼Ÿå°è¯• `telnet localhost 4317`
- [ ] é‡‡æ ·æ˜¯å¦é…ç½®ï¼Ÿåº”è¯¥æ˜¯ `always_on`

### Q2: Console è¾“å‡ºå¤ªå¤šæ€ä¹ˆåŠï¼Ÿ

**æ–¹æ¡ˆ 1**: ç§»é™¤ Console Exporter

```go
// æ³¨é‡Šæ‰è¿™ä¸€è¡Œ
// sdktrace.WithSyncer(consoleExporter),
```

**æ–¹æ¡ˆ 2**: åªåœ¨æœ‰é”™è¯¯æ—¶è¾“å‡º

```go
// ä½¿ç”¨æ¡ä»¶ Exporter
if span.Status().Code == codes.Error {
    // è¾“å‡ºåˆ° Console
}
```

### Q3: å¦‚ä½•è°ƒè¯• Span æœªç»“æŸï¼Ÿ

å¼€å¯ Span æ³„æ¼æ£€æµ‹ï¼š

```go
tp := sdktrace.NewTracerProvider(
    // ... å…¶ä»–é…ç½®
    sdktrace.WithSpanLimits(sdktrace.SpanLimits{
        AttributeValueLengthLimit: 4096,
        AttributeCountLimit:       128,
        EventCountLimit:           128,
        LinkCountLimit:            128,
    }),
)
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æœ‰æ„ä¹‰çš„ Span åç§°

```go
// âŒ Bad
ctx, span := tracer.Start(ctx, "function1")

// âœ… Good
ctx, span := tracer.Start(ctx, "user.create")
```

### 2. æ·»åŠ å…³é”®å±æ€§

```go
span.SetAttributes(
    attribute.String("user.id", userID),
    attribute.Int("order.amount", amount),
)
```

### 3. è®°å½•é”™è¯¯

```go
if err != nil {
    span.RecordError(err)
    span.SetStatus(codes.Error, err.Error())
    return err
}
```

### 4. ä½¿ç”¨ defer ç¡®ä¿ Span ç»“æŸ

```go
ctx, span := tracer.Start(ctx, "operation")
defer span.End()
```

---

## ä¸‹ä¸€æ­¥

- âœ… å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆ
- ğŸ“š [ç”Ÿäº§ç¯å¢ƒé…ç½®](./03_ç”Ÿäº§ç¯å¢ƒé…ç½®.md)
- ğŸ“š [ä¸­é—´ä»¶é›†æˆ](./04_ä¸­é—´ä»¶é›†æˆ_Gin.md)
- ğŸ“š [å®æˆ˜æ¡ˆä¾‹](../å®æˆ˜æ¡ˆä¾‹/)

---

**ğŸ‰ å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆï¼** ç°åœ¨æ‚¨å¯ä»¥å¼€å§‹æ„‰å¿«åœ°å¼€å‘å’Œè°ƒè¯•äº†ï¼
