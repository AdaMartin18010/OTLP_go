# OpenTelemetry 开发环境配置模板

> **目标**: 快速启动本地开发环境，查看完整 Trace  
> **特点**: 100%采样、Console输出、本地Jaeger、快速调试  
> **适用场景**: 本地开发、功能调试、学习OpenTelemetry  
> **难度**: ⭐ (开箱即用)

---

## 📋 快速开始

### 1分钟启动

```bash
# 1. 启动本地 Collector + Jaeger + Prometheus
cd 配置模板/
docker-compose -f docker-compose.dev.yml up -d

# 2. 运行您的应用
export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4317"
export OTEL_SERVICE_NAME="my-dev-service"
export OTEL_TRACES_SAMPLER="always_on"
go run main.go

# 3. 查看 Traces
open http://localhost:16686  # Jaeger UI
```

---

## Go 应用配置

### main.go

```go:main.go
package main

import (
    "context"
    "log"
    "os"
    "os/signal"
    "time"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/exporters/stdout/stdouttrace"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
)

func main() {
    ctx := context.Background()

    // 初始化 Telemetry
    shutdown, err := initTelemetry(ctx)
    if err != nil {
        log.Fatal(err)
    }
    defer func() {
        if err := shutdown(ctx); err != nil {
            log.Printf("failed to shutdown: %v", err)
        }
    }()

    // 运行应用
    runApp(ctx)

    // 优雅关闭
    waitForShutdown()
}

// initTelemetry 初始化 OpenTelemetry（开发环境）
func initTelemetry(ctx context.Context) (func(context.Context) error, error) {
    // 1. Resource
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String(getEnv("OTEL_SERVICE_NAME", "dev-service")),
            semconv.ServiceVersionKey.String("dev"),
            semconv.DeploymentEnvironmentKey.String("development"),
        ),
    )
    if err != nil {
        return nil, err
    }

    // 2. 创建多个 Exporter（开发环境可以同时输出到多个地方）
    
    // 2.1 Console Exporter（终端输出，方便调试）
    consoleExporter, err := stdouttrace.New(
        stdouttrace.WithPrettyPrint(), // 格式化输出
    )
    if err != nil {
        return nil, err
    }

    // 2.2 OTLP Exporter（发送到 Collector）
    conn, err := grpc.NewClient(
        getEnv("OTEL_EXPORTER_OTLP_ENDPOINT", "localhost:4317"),
        grpc.WithTransportCredentials(insecure.NewCredentials()),
    )
    if err != nil {
        return nil, err
    }

    otlpExporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithGRPCConn(conn))
    if err != nil {
        return nil, err
    }

    // 3. TracerProvider（开发环境配置）
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithResource(res),
        
        // 开发环境：100% 采样（查看所有 Trace）
        sdktrace.WithSampler(sdktrace.AlwaysSample()),
        
        // Console Exporter - 简单导出器，立即输出
        sdktrace.WithSyncer(consoleExporter),
        
        // OTLP Exporter - 批处理导出器（发送到 Jaeger）
        sdktrace.WithBatcher(otlpExporter,
            sdktrace.WithBatchTimeout(1*time.Second),     // 快速导出
            sdktrace.WithMaxExportBatchSize(128),          // 小批次
        ),
    )
    otel.SetTracerProvider(tp)

    // 4. Propagator（跨服务上下文传播）
    otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
        propagation.TraceContext{},
        propagation.Baggage{},
    ))

    // 5. 返回 Shutdown 函数
    return func(ctx context.Context) error {
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()
        return tp.Shutdown(ctx)
    }, nil
}

// runApp 运行示例应用
func runApp(ctx context.Context) {
    tracer := otel.Tracer("dev-service")

    ctx, span := tracer.Start(ctx, "main.runApp")
    defer span.End()

    // 模拟业务逻辑
    doSomething(ctx)
}

func doSomething(ctx context.Context) {
    tracer := otel.Tracer("dev-service")
    
    ctx, span := tracer.Start(ctx, "doSomething")
    defer span.End()

    // 模拟工作
    time.Sleep(100 * time.Millisecond)
    
    log.Println("Work done!")
}

// getEnv 获取环境变量（带默认值）
func getEnv(key, defaultValue string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return defaultValue
}

// waitForShutdown 等待关闭信号
func waitForShutdown() {
    c := make(chan os.Signal, 1)
    signal.Notify(c, os.Interrupt)
    <-c
    log.Println("Shutting down gracefully...")
}
```

---

## Docker Compose 配置

### docker-compose.dev.yml

```yaml:docker-compose.dev.yml
version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: otel-collector-dev
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-dev.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics
      - "13133:13133" # Health check
    depends_on:
      - jaeger
      - prometheus

  # Jaeger (All-in-One)
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: jaeger-dev
    ports:
      - "16686:16686"  # UI
      - "14250:14250"  # gRPC
      - "14268:14268"  # HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  # Prometheus
  prometheus:
    image: prom/prometheus:v2.49.0
    container_name: prometheus-dev
    volumes:
      - ./prometheus-dev.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

  # Grafana (可选)
  grafana:
    image: grafana/grafana:10.3.0
    container_name: grafana-dev
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - grafana-storage:/var/lib/grafana

volumes:
  grafana-storage:
```

### otel-collector-dev.yaml

```yaml:otel-collector-dev.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # 批处理（开发环境：小批次，快速导出）
  batch:
    timeout: 1s
    send_batch_size: 128

  # 资源属性（添加环境信息）
  resource:
    attributes:
      - key: deployment.environment
        value: development
        action: insert

  # 属性处理（方便调试）
  attributes:
    actions:
      - key: dev.mode
        value: "true"
        action: insert

exporters:
  # Jaeger Exporter
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  # Prometheus Exporter
  prometheus:
    endpoint: "0.0.0.0:8888"

  # Console Exporter（在 Collector 日志中输出，方便调试）
  logging:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resource, attributes, batch]
      exporters: [jaeger, logging]  # 同时输出到 Jaeger 和 Console
      
    metrics:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [prometheus, logging]

  extensions:
    - health_check

  # 开发环境：启用详细日志
  telemetry:
    logs:
      level: debug
```

### prometheus-dev.yml

```yaml:prometheus-dev.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # OpenTelemetry Collector Metrics
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']

  # 应用 Metrics（如果应用也暴露 Prometheus metrics）
  - job_name: 'app'
    static_configs:
      - targets: ['host.docker.internal:8080']  # Mac/Windows
      # - targets: ['172.17.0.1:8080']          # Linux
```

---

## 环境变量配置

### .env.dev

```bash:.env.dev
# OpenTelemetry 配置
OTEL_SERVICE_NAME=my-dev-service
OTEL_SERVICE_VERSION=dev
OTEL_DEPLOYMENT_ENVIRONMENT=development

# Exporter 配置
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
OTEL_EXPORTER_OTLP_INSECURE=true

# 采样配置（开发环境：100%采样）
OTEL_TRACES_SAMPLER=always_on

# 日志级别
OTEL_LOG_LEVEL=debug

# 资源属性
OTEL_RESOURCE_ATTRIBUTES=deployment.environment=development,service.name=my-dev-service
```

### 加载环境变量

```bash
# 方法 1: source
source .env.dev

# 方法 2: export
set -a
source .env.dev
set +a

# 方法 3: direnv (推荐)
# echo "source_env .env.dev" > .envrc
# direnv allow
```

---

## VS Code 调试配置

### .vscode/launch.json

```json:.vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug with OTLP",
      "type": "go",
      "request": "launch",
      "mode": "auto",
      "program": "${workspaceFolder}",
      "env": {
        "OTEL_SERVICE_NAME": "my-dev-service",
        "OTEL_EXPORTER_OTLP_ENDPOINT": "http://localhost:4317",
        "OTEL_TRACES_SAMPLER": "always_on",
        "OTEL_LOG_LEVEL": "debug"
      },
      "args": [],
      "showLog": true
    }
  ]
}
```

---

## 验证与调试

### 1. 检查 Collector 健康状态

```bash
curl http://localhost:13133
# 输出: {"status":"Server available"}
```

### 2. 查看 Collector Metrics

```bash
curl http://localhost:8888/metrics | grep otelcol
```

### 3. 访问 Jaeger UI

```bash
open http://localhost:16686
```

**操作**:

1. 选择 Service: `my-dev-service`
2. 点击 "Find Traces"
3. 查看 Trace 详情

### 4. 查看 Console 输出

终端会看到类似输出：

```json
{
  "Name": "main.runApp",
  "SpanContext": {
    "TraceID": "4bf92f3577b34da6a3ce929d0e0e4736",
    "SpanID": "00f067aa0ba902b7",
    "TraceFlags": "01",
    "TraceState": "",
    "Remote": false
  },
  "Parent": {...},
  "SpanKind": "Internal",
  "StartTime": "2025-10-09T10:00:00.000000Z",
  "EndTime": "2025-10-09T10:00:00.150000Z",
  "Attributes": [...],
  "Events": null,
  "Links": null,
  "Status": {
    "Code": "Unset",
    "Description": ""
  },
  "DroppedAttributes": 0,
  "DroppedEvents": 0,
  "DroppedLinks": 0,
  "ChildSpanCount": 1,
  "Resource": [...],
  "InstrumentationScope": {
    "Name": "dev-service",
    "Version": "",
    "SchemaURL": ""
  }
}
```

---

## 常见问题

### Q1: 为什么看不到 Traces？

**检查清单**:

- [ ] Collector 是否启动？`docker ps`
- [ ] 应用是否正确连接？检查 `OTEL_EXPORTER_OTLP_ENDPOINT`
- [ ] 防火墙是否阻止？尝试 `telnet localhost 4317`
- [ ] 采样是否配置？应该是 `always_on`

### Q2: Console 输出太多怎么办？

**方案 1**: 移除 Console Exporter

```go
// 注释掉这一行
// sdktrace.WithSyncer(consoleExporter),
```

**方案 2**: 只在有错误时输出

```go
// 使用条件 Exporter
if span.Status().Code == codes.Error {
    // 输出到 Console
}
```

### Q3: 如何调试 Span 未结束？

开启 Span 泄漏检测：

```go
tp := sdktrace.NewTracerProvider(
    // ... 其他配置
    sdktrace.WithSpanLimits(sdktrace.SpanLimits{
        AttributeValueLengthLimit: 4096,
        AttributeCountLimit:       128,
        EventCountLimit:           128,
        LinkCountLimit:            128,
    }),
)
```

---

## 最佳实践

### 1. 使用有意义的 Span 名称

```go
// ❌ Bad
ctx, span := tracer.Start(ctx, "function1")

// ✅ Good
ctx, span := tracer.Start(ctx, "user.create")
```

### 2. 添加关键属性

```go
span.SetAttributes(
    attribute.String("user.id", userID),
    attribute.Int("order.amount", amount),
)
```

### 3. 记录错误

```go
if err != nil {
    span.RecordError(err)
    span.SetStatus(codes.Error, err.Error())
    return err
}
```

### 4. 使用 defer 确保 Span 结束

```go
ctx, span := tracer.Start(ctx, "operation")
defer span.End()
```

---

## 下一步

- ✅ 开发环境配置完成
- 📚 [生产环境配置](./03_生产环境配置.md)
- 📚 [中间件集成](./04_中间件集成_Gin.md)
- 📚 [实战案例](../实战案例/)

---

**🎉 开发环境配置完成！** 现在您可以开始愉快地开发和调试了！
