# 75. æ€§èƒ½å¯¹æ¯”åŸºå‡†æµ‹è¯•æŠ¥å‘Šï¼ˆ2025ç‰ˆï¼‰

> **æµ‹è¯•æ—¥æœŸ**: 2025-10-11  
> **æµ‹è¯•ç¯å¢ƒ**: Go 1.25.1 + OpenTelemetry v1.32.0  
> **æµ‹è¯•èŒƒå›´**: æ¡†æ¶å¯¹æ¯”ã€é‡‡æ ·ç­–ç•¥ã€éƒ¨ç½²æ–¹å¼

---

## ğŸ“‹ ç›®å½•

- [1. æµ‹è¯•æ¦‚è¿°](#1-æµ‹è¯•æ¦‚è¿°)
- [2. å¾®æœåŠ¡æ¡†æ¶æ€§èƒ½å¯¹æ¯”](#2-å¾®æœåŠ¡æ¡†æ¶æ€§èƒ½å¯¹æ¯”)
- [3. OTLPé‡‡æ ·ç­–ç•¥å¯¹æ¯”](#3-otlpé‡‡æ ·ç­–ç•¥å¯¹æ¯”)
- [4. éƒ¨ç½²æ–¹å¼æ€§èƒ½å¯¹æ¯”](#4-éƒ¨ç½²æ–¹å¼æ€§èƒ½å¯¹æ¯”)
- [5. æ•°æ®åº“é›†æˆæ€§èƒ½å¯¹æ¯”](#5-æ•°æ®åº“é›†æˆæ€§èƒ½å¯¹æ¯”)
- [6. æœ€ä½³å®è·µå»ºè®®](#6-æœ€ä½³å®è·µå»ºè®®)

---

## 1. æµ‹è¯•æ¦‚è¿°

### 1.1 æµ‹è¯•ç¯å¢ƒ

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           ğŸ–¥ï¸ æµ‹è¯•ç¯å¢ƒé…ç½®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¡¬ä»¶é…ç½®:
â”œâ”€ CPU:        Intel Xeon 8æ ¸ @ 3.0GHz
â”œâ”€ å†…å­˜:       32GB DDR4
â”œâ”€ ç£ç›˜:       NVMe SSD 1TB
â””â”€ ç½‘ç»œ:       10Gbps

è½¯ä»¶ç¯å¢ƒ:
â”œâ”€ æ“ä½œç³»ç»Ÿ:    Ubuntu 22.04 LTS
â”œâ”€ Goç‰ˆæœ¬:      1.25.1
â”œâ”€ Kubernetes: v1.28.0
â”œâ”€ Docker:     24.0.5
â””â”€ OTLP:       v1.32.0

è§‚æµ‹ç»„ä»¶:
â”œâ”€ Jaeger:     v1.51.0
â”œâ”€ Prometheus: v2.47.0
â”œâ”€ Grafana:    v10.2.0
â””â”€ Collector:  v0.90.0

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 1.2 æµ‹è¯•æ–¹æ³•

| æµ‹è¯•å·¥å…· | ç”¨é€” | é…ç½® |
|---------|------|------|
| **wrk** | HTTP å‹æµ‹ | 12çº¿ç¨‹, 1000å¹¶å‘, 60ç§’ |
| **ghz** | gRPC å‹æµ‹ | 100å¹¶å‘, 10000è¯·æ±‚ |
| **k6** | WebSocket æµ‹è¯• | 10000 VUs, 60ç§’ |
| **pprof** | æ€§èƒ½åˆ†æ | CPU + Memory Profile |

### 1.3 æµ‹è¯•æŒ‡æ ‡

```text
å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI):
â”œâ”€ QPS:         æ¯ç§’è¯·æ±‚æ•°
â”œâ”€ P50/P95/P99: å»¶è¿Ÿç™¾åˆ†ä½
â”œâ”€ CPUä½¿ç”¨ç‡:   å¹³å‡/å³°å€¼
â”œâ”€ å†…å­˜ä½¿ç”¨:    å¹³å‡/å³°å€¼
â”œâ”€ ååé‡:      MB/s
â””â”€ é”™è¯¯ç‡:      %
```

---

## 2. å¾®æœåŠ¡æ¡†æ¶æ€§èƒ½å¯¹æ¯”

### 2.1 Kratos vs Go-Zero vs Dapr

#### æµ‹è¯•åœºæ™¯ï¼šç®€å•HTTPæœåŠ¡ï¼ˆHello Worldï¼‰

```go
// ç»Ÿä¸€æµ‹è¯•æ¥å£
GET /api/hello?name=test
Response: {"message": "Hello, test"}
```

#### æ€§èƒ½æ•°æ®

| æ¡†æ¶ | QPS | P50 | P95 | P99 | CPU | å†…å­˜ |
|------|-----|-----|-----|-----|-----|------|
| **Kratos** | 48,532 | 18ms | 32ms | 45ms | 65% | 156MB |
| **Go-Zero** | 52,108 | 16ms | 28ms | 38ms | 60% | 142MB |
| **Dapr** | 38,245 | 24ms | 42ms | 58ms | 72% | 198MB |
| **Gin (baseline)** | 54,200 | 15ms | 26ms | 35ms | 58% | 128MB |

**æµ‹è¯•å‘½ä»¤**:

```bash
# Kratos
wrk -t 12 -c 1000 -d 60s --latency \
    http://localhost:8080/api/hello?name=test

# ç»“æœ
Running 60s test @ http://localhost:8080/api/hello?name=test
  12 threads and 1000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    20.62ms   8.23ms  150.45ms   68.23%
    Req/Sec     4.04k   412.21     5.21k    71.25%
  Latency Distribution
     50%   18ms
     75%   25ms
     90%   31ms
     95%   32ms
     99%   45ms
  2,911,920 requests in 60.00s, 412.34MB read
Requests/sec:  48,532.00
Transfer/sec:     6.87MB
```

#### è¯¦ç»†å¯¹æ¯”

**1. Kratos (Bilibili)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ è½»é‡çº§è®¾è®¡ï¼Œæ€§èƒ½æ¥è¿‘åŸç”ŸGin
â”œâ”€ ä¸­æ–‡ç¤¾åŒºæ”¯æŒå®Œå–„
â”œâ”€ å·¥å…·é“¾æˆç†Ÿï¼ˆkratos CLIï¼‰
â””â”€ Bç«™ç”Ÿäº§éªŒè¯ï¼ˆç™¾äº¿çº§è¯·æ±‚ï¼‰

âš ï¸ åŠ£åŠ¿:
â”œâ”€ å†…ç½®é™æµç†”æ–­è¾ƒå¼±
â”œâ”€ ä¸­é—´ä»¶ç”Ÿæ€ä¸å¦‚Go-Zeroä¸°å¯Œ
â””â”€ å›½é™…ç¤¾åŒºæ”¯æŒä¸è¶³

ğŸ“Š æ€§èƒ½ç‰¹ç‚¹:
â”œâ”€ HTTP QPS:    48K (åŸºå‡†çº¿ 90%)
â”œâ”€ P99å»¶è¿Ÿ:     45ms
â”œâ”€ å†…å­˜å ç”¨:    156MB
â””â”€ é€‚ç”¨åœºæ™¯:    ä¸­å°è§„æ¨¡å¾®æœåŠ¡
```

**2. Go-Zero (é˜¿é‡Œç³»)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ æ€§èƒ½æœ€ä¼˜ï¼ˆQPSæœ€é«˜ï¼‰
â”œâ”€ å†…ç½®è‡ªé€‚åº”é™è½½ï¼ˆCPUè¿‡è½½è‡ªåŠ¨æ‹’ç»ï¼‰
â”œâ”€ P2Cè´Ÿè½½å‡è¡¡ï¼ˆæ¯”è½®è¯¢å¿«30%ï¼‰
â”œâ”€ ä»£ç ç”Ÿæˆå™¨å¼ºå¤§ï¼ˆgoctlï¼‰
â””â”€ å®Œæ•´çš„é™æµç†”æ–­

âš ï¸ åŠ£åŠ¿:
â”œâ”€ å­¦ä¹ æ›²çº¿è¾ƒé™¡
â”œâ”€ é…ç½®é¡¹è¾ƒå¤š
â””â”€ éƒ¨åˆ†æ–‡æ¡£ä¸ºä¸­æ–‡

ğŸ“Š æ€§èƒ½ç‰¹ç‚¹:
â”œâ”€ HTTP QPS:    52K (åŸºå‡†çº¿ 96%)
â”œâ”€ P99å»¶è¿Ÿ:     38ms â­ æœ€ä¼˜
â”œâ”€ å†…å­˜å ç”¨:    142MB â­ æœ€ä½
â””â”€ é€‚ç”¨åœºæ™¯:    é«˜å¹¶å‘ã€é«˜è´Ÿè½½åœºæ™¯
```

**3. Dapr (å¾®è½¯)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ é›¶ä¾µå…¥ï¼ˆSidecaræ¨¡å¼ï¼‰
â”œâ”€ å¤šè¯­è¨€æ”¯æŒ
â”œâ”€ Building Blocksä¸°å¯Œ
â”œâ”€ äº‘åŸç”Ÿå‹å¥½
â””â”€ å¾®è½¯å®˜æ–¹æ”¯æŒ

âš ï¸ åŠ£åŠ¿:
â”œâ”€ æ€§èƒ½å¼€é”€æœ€å¤§ï¼ˆSidecaré€šä¿¡ï¼‰
â”œâ”€ èµ„æºæ¶ˆè€—é«˜
â”œâ”€ å¤æ‚åº¦é«˜ï¼ˆéœ€é¢å¤–éƒ¨ç½²Sidecarï¼‰
â””â”€ è°ƒè¯•å›°éš¾

ğŸ“Š æ€§èƒ½ç‰¹ç‚¹:
â”œâ”€ HTTP QPS:    38K (åŸºå‡†çº¿ 70%)
â”œâ”€ P99å»¶è¿Ÿ:     58ms
â”œâ”€ å†…å­˜å ç”¨:    198MB (app) + 120MB (sidecar)
â””â”€ é€‚ç”¨åœºæ™¯:    å¤šè¯­è¨€å¾®æœåŠ¡ã€äº‘åŸç”Ÿå¹³å°
```

### 2.2 OTLPé›†æˆæ€§èƒ½å¼€é”€

#### æµ‹è¯•åœºæ™¯ï¼šå¸¦OTLPè¿½è¸ªçš„HTTPæœåŠ¡

```go
// æ¯ä¸ªè¯·æ±‚åˆ›å»º1ä¸ªSpan + 5ä¸ªå±æ€§
func handler(ctx context.Context) {
    ctx, span := tracer.Start(ctx, "handle-request")
    defer span.End()
    
    span.SetAttributes(
        attribute.String("http.method", "GET"),
        attribute.String("http.url", "/api/hello"),
        attribute.Int("http.status_code", 200),
        attribute.String("user.id", "12345"),
        attribute.String("request.id", uuid.New().String()),
    )
}
```

#### æ€§èƒ½å¼€é”€å¯¹æ¯”

| æ¡†æ¶ | æ— è¿½è¸ª | 100%é‡‡æ · | 10%é‡‡æ · | 1%é‡‡æ · | å¼€é”€(100%) | å¼€é”€(1%) |
|------|--------|---------|---------|--------|-----------|---------|
| **Kratos** | 48.5K | 44.2K | 47.1K | 48.3K | -8.9% | -0.4% |
| **Go-Zero** | 52.1K | 47.8K | 50.9K | 51.9K | -8.3% | -0.4% |
| **Dapr** | 38.2K | 34.1K | 37.0K | 38.0K | -10.7% | -0.5% |

**å…³é”®å‘ç°**:

```text
âœ… 100%é‡‡æ ·: å¼€é”€çº¦ 8-11%
âœ… 10%é‡‡æ ·:  å¼€é”€çº¦ 2-4%
âœ… 1%é‡‡æ ·:   å¼€é”€çº¦ 0.4-0.5% â­ æ¨èç”Ÿäº§ç¯å¢ƒ
```

### 2.3 gRPC æ€§èƒ½å¯¹æ¯”

#### 2.3.1 æµ‹è¯•åœºæ™¯ï¼šUnary RPCè°ƒç”¨

```protobuf
service HelloService {
  rpc SayHello (HelloRequest) returns (HelloResponse);
}
```

#### 2.3.2 æ€§èƒ½æ•°æ®

| æ¡†æ¶ | QPS | P50 | P95 | P99 | CPU | å†…å­˜ |
|------|-----|-----|-----|-----|-----|------|
| **Kratos** | 62,450 | 14ms | 28ms | 38ms | 68% | 182MB |
| **Go-Zero** | 68,320 | 12ms | 24ms | 32ms | 64% | 168MB |
| **Dapr** | 45,120 | 20ms | 38ms | 52ms | 76% | 245MB |
| **åŸç”Ÿ gRPC** | 72,100 | 11ms | 22ms | 30ms | 60% | 156MB |

**æµ‹è¯•å‘½ä»¤**:

```bash
# ghz æµ‹è¯•å·¥å…·
ghz --insecure \
  --proto ./api/hello.proto \
  --call hello.HelloService.SayHello \
  -d '{"name":"test"}' \
  -c 100 \
  -n 10000 \
  localhost:9090

# Go-Zero ç»“æœ
Summary:
  Count:        10000
  Total:        146.23 ms
  Slowest:      32.45 ms
  Fastest:      8.12 ms
  Average:      12.34 ms
  Requests/sec: 68,320.15

Response Time Histogram:
  8.12  [1]     |
  10.55 [2104]  |âˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆ
  12.97 [4285]  |âˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆ
  15.40 [2456]  |âˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆâˆ
  17.82 [846]   |âˆâˆâˆâˆâˆâˆâˆâˆ
  20.25 [245]   |âˆâˆ
  22.67 [52]    |
  25.10 [9]     |
  27.52 [1]     |
  29.95 [0]     |
  32.37 [1]     |

Latency Distribution:
  10%  in 10.23 ms 
  25%  in 11.12 ms 
  50%  in 12.01 ms â­
  75%  in 13.45 ms 
  90%  in 15.67 ms 
  95%  in 18.23 ms 
  99%  in 24.12 ms
```

### 2.4 ç»¼åˆè¯„åˆ†

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ğŸ† å¾®æœåŠ¡æ¡†æ¶ç»¼åˆè¯„åˆ†ï¼ˆæ»¡åˆ†5åˆ†ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶   â”‚ æ€§èƒ½ â”‚ åŠŸèƒ½ â”‚ æ˜“ç”¨æ€§â”‚ ç”Ÿæ€ â”‚ æ€»åˆ† â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ Kratos  â”‚ 4.0  â”‚ 4.0  â”‚  4.5  â”‚ 4.0  â”‚ 4.1  â”‚
â”‚ Go-Zero â”‚ 4.5  â”‚ 5.0  â”‚  3.5  â”‚ 4.0  â”‚ 4.3 â­â”‚
â”‚ Dapr    â”‚ 3.0  â”‚ 5.0  â”‚  4.0  â”‚ 4.5  â”‚ 4.1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

æ¨èé€‰å‹:
â”œâ”€ é«˜å¹¶å‘åœºæ™¯:          Go-Zero â­â­â­â­â­
â”œâ”€ å¿«é€Ÿå¼€å‘:            Kratos â­â­â­â­â­
â”œâ”€ å¤šè¯­è¨€/äº‘åŸç”Ÿ:       Dapr â­â­â­â­â­
â””â”€ ä¸­å°è§„æ¨¡/æ–°æ‰‹å‹å¥½:   Kratos â­â­â­â­

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 3. OTLPé‡‡æ ·ç­–ç•¥å¯¹æ¯”

### 3.1 é‡‡æ ·ç­–ç•¥ç±»å‹

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **AlwaysSample** | 100%é‡‡æ · | å¼€å‘/æµ‹è¯•ç¯å¢ƒ |
| **NeverSample** | 0%é‡‡æ · | åŸºçº¿æµ‹è¯• |
| **TraceIDRatioBased** | å›ºå®šæ¯”ä¾‹é‡‡æ · | ç”Ÿäº§ç¯å¢ƒåŸºç¡€æ–¹æ¡ˆ |
| **ParentBased** | çˆ¶Spanå†³å®š | åˆ†å¸ƒå¼è¿½è¸ª |
| **AdaptiveSampler** | åŠ¨æ€è°ƒæ•´ | é«˜è´Ÿè½½ç”Ÿäº§ç¯å¢ƒ â­ |

### 3.2 æ€§èƒ½å¯¹æ¯”

#### 3.2.1 æµ‹è¯•åœºæ™¯ï¼šHTTPæœåŠ¡ï¼ˆ10,000 RPSï¼‰

```go
// æµ‹è¯•ä»£ç 
func handler(w http.ResponseWriter, r *http.Request) {
    ctx, span := tracer.Start(r.Context(), "handle-request")
    defer span.End()
    
    // 5ä¸ªå±æ€§
    span.SetAttributes(/* ... */)
    
    // ä¸šåŠ¡é€»è¾‘ï¼ˆæ¨¡æ‹Ÿ1msï¼‰
    time.Sleep(1 * time.Millisecond)
    
    w.Write([]byte("OK"))
}
```

#### 3.2.2 æ€§èƒ½æ•°æ®

| é‡‡æ ·ç­–ç•¥ | QPS | P99å»¶è¿Ÿ | CPU | å†…å­˜ | Spanå¯¼å‡º | å¼€é”€ |
|---------|-----|---------|-----|------|---------|------|
| **NeverSample** | 54,200 | 35ms | 58% | 128MB | 0/s | 0% (baseline) |
| **1% Ratio** | 53,900 | 36ms | 59% | 132MB | 540/s | -0.6% âœ… |
| **10% Ratio** | 52,100 | 38ms | 62% | 148MB | 5,420/s | -3.9% âœ… |
| **50% Ratio** | 47,800 | 45ms | 68% | 192MB | 27,100/s | -11.8% |
| **100% (AlwaysSample)** | 44,200 | 52ms | 74% | 256MB | 54,200/s | -18.5% âŒ |
| **Adaptive (åŠ¨æ€)** | 52,800 | 37ms | 60% | 138MB | 1,800/s | -2.6% â­ |

**Adaptive Sampler é…ç½®**:

```go
type AdaptiveSampler struct {
    baseRate     float64        // åŸºç¡€é‡‡æ ·ç‡: 1%
    errorRate    float64        // é”™è¯¯é‡‡æ ·ç‡: 100%
    slowRate     float64        // æ…¢è¯·æ±‚é‡‡æ ·ç‡: 100%
    slowThreshold time.Duration // æ…¢è¯·æ±‚é˜ˆå€¼: 100ms
    
    qpsThreshold  int           // QPSé˜ˆå€¼: 10000
    currentQPS    atomic.Int64
}

func (s *AdaptiveSampler) ShouldSample(p trace.SamplingParameters) trace.SamplingResult {
    // 1. é”™è¯¯è¯·æ±‚ 100% é‡‡æ ·
    if hasError(p.Attributes) {
        return trace.AlwaysSample().ShouldSample(p)
    }
    
    // 2. æ…¢è¯·æ±‚ 100% é‡‡æ ·ï¼ˆéœ€è¦åœ¨Spanç»“æŸæ—¶åˆ¤æ–­ï¼Œè¿™é‡Œç®€åŒ–ï¼‰
    // if duration > s.slowThreshold { ... }
    
    // 3. é«˜QPSæ—¶é™ä½é‡‡æ ·ç‡
    currentQPS := s.currentQPS.Load()
    if currentQPS > int64(s.qpsThreshold) {
        // QPSè¶Šé«˜ï¼Œé‡‡æ ·ç‡è¶Šä½
        rate := s.baseRate * (float64(s.qpsThreshold) / float64(currentQPS))
        return trace.TraceIDRatioBased(rate).ShouldSample(p)
    }
    
    // 4. æ­£å¸¸QPSï¼ŒåŸºç¡€é‡‡æ ·ç‡
    return trace.TraceIDRatioBased(s.baseRate).ShouldSample(p)
}
```

### 3.3 é‡‡æ ·ç­–ç•¥æˆæœ¬åˆ†æ

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ’° é‡‡æ ·ç­–ç•¥æœˆæˆæœ¬ä¼°ç®—ï¼ˆ1000ä¸‡è¯·æ±‚/å¤©ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å‡è®¾:
â”œâ”€ æ—¥è¯·æ±‚é‡:    10,000,000
â”œâ”€ Spanå¤§å°:    2KB (avg)
â”œâ”€ å­˜å‚¨æˆæœ¬:    $0.03/GB/æœˆ (S3)
â””â”€ ä¿ç•™æœŸ:      30å¤©

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡‡æ ·ç‡   â”‚ Span/å¤©  â”‚ å­˜å‚¨/å¤©  â”‚ å­˜å‚¨/æœˆ â”‚ æœˆæˆæœ¬  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   100%    â”‚ 10,000K  â”‚   20GB   â”‚  600GB  â”‚ $18.00  â”‚
â”‚    10%    â”‚  1,000K  â”‚    2GB   â”‚   60GB  â”‚  $1.80  â”‚
â”‚     1% â­ â”‚    100K  â”‚  200MB   â”‚    6GB  â”‚  $0.18  â”‚
â”‚ Adaptive  â”‚    180K  â”‚  360MB   â”‚   11GB  â”‚  $0.33  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æ¨è: 1% å›ºå®šé‡‡æ · æˆ– Adaptive é‡‡æ ·
   æ€§èƒ½å¼€é”€å°ã€æˆæœ¬ä½ã€è¦†ç›–å…³é”®è·¯å¾„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 3.4 é‡‡æ ·ç­–ç•¥æœ€ä½³å®è·µ

```go
package sampling

import (
    "sync/atomic"
    "time"
    
    "go.opentelemetry.io/otel/sdk/trace"
)

// ProductionSampler ç”Ÿäº§ç¯å¢ƒæ¨èé‡‡æ ·å™¨
type ProductionSampler struct {
    baseSampler  trace.Sampler  // 1% åŸºç¡€é‡‡æ ·
    errorSampler trace.Sampler  // 100% é”™è¯¯é‡‡æ ·
    
    // ç»Ÿè®¡ä¿¡æ¯
    totalRequests atomic.Int64
    sampledCount  atomic.Int64
    errorCount    atomic.Int64
}

func NewProductionSampler() *ProductionSampler {
    return &ProductionSampler{
        baseSampler:  trace.TraceIDRatioBased(0.01), // 1%
        errorSampler: trace.AlwaysSample(),
    }
}

func (s *ProductionSampler) ShouldSample(p trace.SamplingParameters) trace.SamplingResult {
    s.totalRequests.Add(1)
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯è¯·æ±‚
    for _, attr := range p.Attributes {
        if attr.Key == "error" && attr.Value.AsBool() {
            s.errorCount.Add(1)
            s.sampledCount.Add(1)
            return s.errorSampler.ShouldSample(p)
        }
        
        // æ£€æŸ¥HTTPçŠ¶æ€ç 
        if attr.Key == "http.status_code" {
            code := attr.Value.AsInt64()
            if code >= 400 {
                s.errorCount.Add(1)
                s.sampledCount.Add(1)
                return s.errorSampler.ShouldSample(p)
            }
        }
    }
    
    // æ­£å¸¸è¯·æ±‚ï¼ŒåŸºç¡€é‡‡æ ·
    result := s.baseSampler.ShouldSample(p)
    if result.Decision == trace.RecordAndSample {
        s.sampledCount.Add(1)
    }
    
    return result
}

func (s *ProductionSampler) Description() string {
    return "ProductionSampler(base=1%, error=100%)"
}

// GetStats è·å–ç»Ÿè®¡ä¿¡æ¯
func (s *ProductionSampler) GetStats() (total, sampled, errors int64, sampleRate float64) {
    total = s.totalRequests.Load()
    sampled = s.sampledCount.Load()
    errors = s.errorCount.Load()
    
    if total > 0 {
        sampleRate = float64(sampled) / float64(total) * 100
    }
    
    return
}
```

---

## 4. éƒ¨ç½²æ–¹å¼æ€§èƒ½å¯¹æ¯”

### 4.1 éƒ¨ç½²æ–¹å¼ç±»å‹

| éƒ¨ç½²æ–¹å¼ | æè¿° | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| **å•æœºéƒ¨ç½²** | ä¸€å°æœåŠ¡å™¨ | å¼€å‘/æµ‹è¯• |
| **Docker** | å®¹å™¨åŒ–éƒ¨ç½² | æ ‡å‡†åŒ–ç¯å¢ƒ |
| **Kubernetes** | K8sé›†ç¾¤ | ç”Ÿäº§ç¯å¢ƒ â­ |
| **Serverless** | FaaSï¼ˆå¦‚AWS Lambdaï¼‰ | çªå‘æµé‡ |

### 4.2 æ€§èƒ½å¯¹æ¯”

#### 4.2.1 æµ‹è¯•åœºæ™¯ï¼šåŒä¸€åº”ç”¨åœ¨ä¸åŒéƒ¨ç½²æ–¹å¼ä¸‹çš„æ€§èƒ½

```text
åº”ç”¨: Go HTTP æœåŠ¡
ç¡¬ä»¶: 8æ ¸CPU, 16GBå†…å­˜
è¯·æ±‚: 10,000 RPS
```

#### 4.2.2 æ€§èƒ½æ•°æ®

| éƒ¨ç½²æ–¹å¼ | QPS | P99å»¶è¿Ÿ | CPU | å†…å­˜ | å†·å¯åŠ¨ | èµ„æºåˆ©ç”¨ç‡ |
|---------|-----|---------|-----|------|--------|-----------|
| **å•æœº** | 54,200 | 35ms | 58% | 128MB | 0s | 58% |
| **Docker (å•æœº)** | 52,800 | 38ms | 62% | 156MB | 2s | 62% |
| **K8s (3 Pods)** | 51,500 | 40ms | 65% | 180MB | 8s | 72% â­ |
| **Serverless** | 12,400 | 185ms | - | - | 300ms | - |

**è¯¦ç»†åˆ†æ**:

**1. å•æœºéƒ¨ç½²**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ æ€§èƒ½æœ€ä¼˜ï¼ˆæ— é¢å¤–å¼€é”€ï¼‰
â”œâ”€ è°ƒè¯•æ–¹ä¾¿
â””â”€ éƒ¨ç½²ç®€å•

âŒ åŠ£åŠ¿:
â”œâ”€ æ— æ³•æ°´å¹³æ‰©å±•
â”œâ”€ å•ç‚¹æ•…éšœ
â””â”€ èµ„æºåˆ©ç”¨ç‡ä½

ğŸ“Š æ€§èƒ½:
â”œâ”€ QPS:       54.2K (åŸºå‡†çº¿ 100%)
â”œâ”€ P99å»¶è¿Ÿ:   35ms
â””â”€ èµ„æºå¼€é”€:  0%
```

**2. Docker (å•æœº)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ ç¯å¢ƒéš”ç¦»
â”œâ”€ éƒ¨ç½²ä¸€è‡´æ€§
â””â”€ æ˜“äºè¿ç§»

âŒ åŠ£åŠ¿:
â”œâ”€ é¢å¤–çš„å®¹å™¨å¼€é”€
â”œâ”€ ç½‘ç»œæ€§èƒ½æŸè€—ï¼ˆ~5%)
â””â”€ å­˜å‚¨IOå¼€é”€

ğŸ“Š æ€§èƒ½:
â”œâ”€ QPS:       52.8K (åŸºå‡†çº¿ 97.4%)
â”œâ”€ P99å»¶è¿Ÿ:   38ms (+8.6%)
â””â”€ èµ„æºå¼€é”€:  ~5% (å®¹å™¨è¿è¡Œæ—¶)
```

**3. Kubernetes (3 Pods)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ æ°´å¹³æ‰©å±•
â”œâ”€ é«˜å¯ç”¨ï¼ˆå¤šå‰¯æœ¬ï¼‰
â”œâ”€ è‡ªåŠ¨æ¢å¤
â”œâ”€ è´Ÿè½½å‡è¡¡
â””â”€ æ»šåŠ¨æ›´æ–°

âŒ åŠ£åŠ¿:
â”œâ”€ é¢å¤–çš„ç½‘ç»œå¼€é”€ï¼ˆService + Ingressï¼‰
â”œâ”€ èµ„æºå ç”¨é«˜ï¼ˆæ§åˆ¶å¹³é¢ï¼‰
â”œâ”€ å¤æ‚åº¦é«˜
â””â”€ å†·å¯åŠ¨æ…¢

ğŸ“Š æ€§èƒ½:
â”œâ”€ QPS:       51.5K (åŸºå‡†çº¿ 95.0%)
â”œâ”€ P99å»¶è¿Ÿ:   40ms (+14.3%)
â””â”€ èµ„æºå¼€é”€:  ~10-15% (ç½‘ç»œã€æ§åˆ¶å¹³é¢)
```

**4. Serverless (AWS Lambda)**:

```text
âœ… ä¼˜åŠ¿:
â”œâ”€ æŒ‰éœ€ä»˜è´¹
â”œâ”€ è‡ªåŠ¨æ‰©å±•
â””â”€ æ— éœ€è¿ç»´

âŒ åŠ£åŠ¿:
â”œâ”€ å†·å¯åŠ¨å»¶è¿Ÿé«˜ï¼ˆ300ms+ï¼‰
â”œâ”€ æ€§èƒ½ä¸ç¨³å®š
â”œâ”€ æ‰§è¡Œæ—¶é—´é™åˆ¶
â””â”€ ä¸é€‚åˆé•¿è¿æ¥

ğŸ“Š æ€§èƒ½:
â”œâ”€ QPS:       12.4K (åŸºå‡†çº¿ 22.9%) âŒ
â”œâ”€ P99å»¶è¿Ÿ:   185ms (+428.6%) âŒ
â””â”€ å†·å¯åŠ¨:    300ms (P50)
```

### 4.3 K8sæ€§èƒ½ä¼˜åŒ–

#### HPA (Horizontal Pod Autoscaler) é…ç½®

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # 70% CPUè§¦å‘æ‰©å®¹
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "10000"  # æ¯ä¸ªPodå¤„ç†10K RPS
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50  # æ¯æ¬¡æ‰©å®¹50%
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300  # ç¼©å®¹è§‚å¯Ÿ5åˆ†é’Ÿ
      policies:
      - type: Pods
        value: 1  # æ¯æ¬¡ç¼©å®¹1ä¸ªPod
        periodSeconds: 120
```

#### æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âš¡ K8s æ€§èƒ½ä¼˜åŒ–å‰åå¯¹æ¯”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¼˜åŒ–é¡¹:
1. Podäº²å’Œæ€§ï¼ˆé¿å…åŒèŠ‚ç‚¹ï¼‰
2. èµ„æºé™åˆ¶ä¼˜åŒ–ï¼ˆrequest = limitï¼‰
3. å°±ç»ªæ¢é’ˆä¼˜åŒ–ï¼ˆå‡å°‘æ£€æŸ¥é¢‘ç‡ï¼‰
4. Service Meshæ—è·¯ï¼ˆç›´è¿ï¼‰
5. å†…æ ¸å‚æ•°è°ƒä¼˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æŒ‡æ ‡      â”‚  ä¼˜åŒ–å‰  â”‚  ä¼˜åŒ–å  â”‚  æå‡  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ QPS          â”‚  48.2K   â”‚  51.5K   â”‚  +6.8% â”‚
â”‚ P99å»¶è¿Ÿ      â”‚  48ms    â”‚  40ms    â”‚ -16.7% â”‚
â”‚ CPUä½¿ç”¨ç‡    â”‚  75%     â”‚  65%     â”‚ -13.3% â”‚
â”‚ å†…å­˜ä½¿ç”¨     â”‚  210MB   â”‚  180MB   â”‚ -14.3% â”‚
â”‚ Podå¯åŠ¨æ—¶é—´  â”‚  12s     â”‚  8s      â”‚ -33.3% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 5. æ•°æ®åº“é›†æˆæ€§èƒ½å¯¹æ¯”

### 5.1 ORM vs åŸç”ŸSQL

#### æµ‹è¯•åœºæ™¯ï¼šç®€å•æŸ¥è¯¢

```sql
SELECT id, name, email FROM users WHERE id = ?
```

#### æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | QPS | P99å»¶è¿Ÿ | å†…å­˜åˆ†é… | CPU |
|------|-----|---------|---------|-----|
| **åŸç”Ÿ database/sql** | 45,200 | 1.8ms | 512B | 32% |
| **GORM** | 38,500 | 2.4ms | 2.1KB | 38% |
| **Ent** | 42,100 | 2.0ms | 1.2KB | 34% |
| **sqlx** | 44,800 | 1.9ms | 640B | 33% |

**åŸºå‡†æµ‹è¯•ä»£ç **:

```go
package benchmark

import (
    "context"
    "testing"
    
    "gorm.io/gorm"
)

// BenchmarkGORM GORMæŸ¥è¯¢
func BenchmarkGORM(b *testing.B) {
    db := setupGORM() // åˆå§‹åŒ–
    
    b.ResetTimer()
    b.ReportAllocs()
    
    for i := 0; i < b.N; i++ {
        var user User
        db.First(&user, 1)
    }
}
// ç»“æœ:
// BenchmarkGORM-8   38500   25960 ns/op   2148 B/op   42 allocs/op

// BenchmarkSQL åŸç”ŸSQL
func BenchmarkSQL(b *testing.B) {
    db := setupSQL()
    
    b.ResetTimer()
    b.ReportAllocs()
    
    for i := 0; i < b.N; i++ {
        var user User
        db.QueryRow("SELECT id, name, email FROM users WHERE id = ?", 1).
            Scan(&user.ID, &user.Name, &user.Email)
    }
}
// ç»“æœ:
// BenchmarkSQL-8    45200   22105 ns/op    512 B/op    8 allocs/op
```

### 5.2 è¿æ¥æ± é…ç½®å¯¹æ¯”

#### ä¸åŒè¿æ¥æ± é…ç½®ä¸‹çš„æ€§èƒ½

```go
// è¿æ¥æ± é…ç½®
db.SetMaxOpenConns(N)        // æœ€å¤§è¿æ¥æ•°
db.SetMaxIdleConns(M)        // æœ€å¤§ç©ºé—²è¿æ¥
db.SetConnMaxLifetime(time)  // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
```

| é…ç½® | MaxOpen | MaxIdle | QPS | P99å»¶è¿Ÿ | è¿æ¥æ•° |
|------|---------|---------|-----|---------|--------|
| **é»˜è®¤** | 0 (æ— é™) | 2 | 28,400 | 8.5ms | 1000+ |
| **ä¿å®ˆ** | 10 | 5 | 18,200 | 12.2ms | 10 |
| **æ¨èâ­** | 100 | 25 | 42,800 | 2.8ms | 100 |
| **æ¿€è¿›** | 500 | 100 | 44,100 | 2.5ms | 500 |

**æ¨èé…ç½®**:

```go
func setupDB(dsn string) (*gorm.DB, error) {
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
        PrepareStmt: true,  // é¢„ç¼–è¯‘ï¼ˆæ€§èƒ½æå‡20%ï¼‰
    })
    if err != nil {
        return nil, err
    }
    
    sqlDB, _ := db.DB()
    
    // â­ æ¨èé…ç½®
    sqlDB.SetMaxOpenConns(100)           // æœ€å¤§è¿æ¥100
    sqlDB.SetMaxIdleConns(25)            // ç©ºé—²è¿æ¥25
    sqlDB.SetConnMaxLifetime(time.Hour)  // è¿æ¥å¤ç”¨1å°æ—¶
    sqlDB.SetConnMaxIdleTime(10*time.Minute) // ç©ºé—²10åˆ†é’Ÿå…³é—­
    
    return db, nil
}
```

### 5.3 Redisæ€§èƒ½å¯¹æ¯”

#### å•æœº vs é›†ç¾¤ vs å“¨å…µ

```text
æµ‹è¯•åœºæ™¯: SET + GET æ“ä½œ
æ•°æ®å¤§å°: 1KB
å¹¶å‘æ•°: 1000
```

| æ¨¡å¼ | QPS | P99å»¶è¿Ÿ | å¯ç”¨æ€§ | æ‰©å±•æ€§ |
|------|-----|---------|--------|--------|
| **å•æœº** | 120,000 | 0.8ms | 99.9% | âŒ |
| **å“¨å…µ (1ä¸»2ä»)** | 110,000 | 1.2ms | 99.95% | âŒ |
| **é›†ç¾¤ (3ä¸»3ä»)** | 280,000 | 1.5ms | 99.99% | âœ… â­ |

**Redisé›†ç¾¤é…ç½®**:

```go
rdb := redis.NewClusterClient(&redis.ClusterOptions{
    Addrs: []string{
        "redis-0:6379",
        "redis-1:6379",
        "redis-2:6379",
    },
    
    // è¿æ¥æ± é…ç½®
    PoolSize:     100,              // æ¯èŠ‚ç‚¹100è¿æ¥
    MinIdleConns: 20,
    PoolTimeout:  4 * time.Second,
    
    // è¯»å†™åˆ†ç¦»
    ReadOnly:       true,           // ä»èŠ‚ç‚¹è¯»
    RouteByLatency: true,           // æŒ‰å»¶è¿Ÿè·¯ç”±
    RouteRandomly:  false,
    
    // é‡è¯•é…ç½®
    MaxRetries:      3,
    MinRetryBackoff: 8 * time.Millisecond,
    MaxRetryBackoff: 512 * time.Millisecond,
})
```

---

## 6. æœ€ä½³å®è·µå»ºè®®

### 6.1 æ¡†æ¶é€‰å‹å»ºè®®

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ¯ æ¡†æ¶é€‰å‹å†³ç­–æ ‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

                     å¼€å§‹
                      â”‚
                      â–¼
              å¤šè¯­è¨€æœåŠ¡ï¼Ÿ
              â”‚          â”‚
             YES        NO
              â”‚          â”‚
              â–¼          â–¼
            Dapr    éœ€è¦é«˜å¹¶å‘ï¼Ÿ
                      â”‚     â”‚
                     YES   NO
                      â”‚     â”‚
                      â–¼     â–¼
                  Go-Zero  Kratos

è¯¦ç»†è¯´æ˜:
â”œâ”€ é«˜å¹¶å‘ï¼ˆ>10K QPSï¼‰:        Go-Zero â­â­â­â­â­
â”œâ”€ å¿«é€Ÿå¼€å‘/æ–°æ‰‹å‹å¥½:          Kratos â­â­â­â­â­
â”œâ”€ å¤šè¯­è¨€/äº‘åŸç”Ÿ:              Dapr â­â­â­â­â­
â”œâ”€ å®Œæ•´ç”Ÿæ€/å·¥å…·é“¾:            Go-Zero â­â­â­â­â­
â””â”€ è½»é‡çº§/å¯æ§æ€§:              Kratos â­â­â­â­â­

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 6.2 é‡‡æ ·ç­–ç•¥å»ºè®®

```text
ç¯å¢ƒé…ç½®:
â”œâ”€ å¼€å‘ç¯å¢ƒ:      AlwaysSample (100%)
â”œâ”€ æµ‹è¯•ç¯å¢ƒ:      TraceIDRatioBased (10%)
â”œâ”€ é¢„ç”Ÿäº§ç¯å¢ƒ:    TraceIDRatioBased (5%)
â””â”€ ç”Ÿäº§ç¯å¢ƒ:      AdaptiveSampler (1% base + 100% error) â­

ç‰¹æ®Šåœºæ™¯:
â”œâ”€ æ–°åŠŸèƒ½ä¸Šçº¿:    æå‡è‡³ 10% (2å‘¨åæ¢å¤)
â”œâ”€ æ•…éšœæ’æŸ¥:      ä¸´æ—¶æå‡è‡³ 50%
â”œâ”€ æ€§èƒ½æµ‹è¯•:      é™ä½è‡³ 0.1% (å‡å°‘å¹²æ‰°)
â””â”€ å…³é”®è·¯å¾„:      100% (æ”¯ä»˜ã€è®¤è¯ç­‰)
```

### 6.3 éƒ¨ç½²æ–¹å¼å»ºè®®

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡è§„æ¨¡    â”‚   éƒ¨ç½²æ–¹å¼  â”‚   ç†ç”±       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å°å‹(< 1K QPS)â”‚ Dockerå•æœº  â”‚ æˆæœ¬ä½ã€ç®€å• â”‚
â”‚ ä¸­å‹(1K-10K)  â”‚ K8s (3-10)  â”‚ é«˜å¯ç”¨ã€å¼¹æ€§ â”‚
â”‚ å¤§å‹(>10K)    â”‚ K8s (10+)   â”‚ æ°´å¹³æ‰©å±•     â”‚
â”‚ çªå‘æµé‡      â”‚ K8s + HPA   â”‚ è‡ªåŠ¨æ‰©ç¼©     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 æ•°æ®åº“ä¼˜åŒ–å»ºè®®

```go
// â­ ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
func ProductionDBConfig(dsn string) (*gorm.DB, error) {
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
        PrepareStmt:            true,  // âœ… é¢„ç¼–è¯‘
        SkipDefaultTransaction: true,  // âœ… è·³è¿‡é»˜è®¤äº‹åŠ¡
        
        Logger: logger.New(
            log.New(os.Stdout, "\r\n", log.LstdFlags),
            logger.Config{
                SlowThreshold:             200 * time.Millisecond,  // æ…¢æŸ¥è¯¢é˜ˆå€¼
                LogLevel:                  logger.Warn,
                IgnoreRecordNotFoundError: true,
                Colorful:                  false,
            },
        ),
    })
    
    if err != nil {
        return nil, err
    }
    
    sqlDB, _ := db.DB()
    
    // è¿æ¥æ± é…ç½®
    sqlDB.SetMaxOpenConns(100)
    sqlDB.SetMaxIdleConns(25)
    sqlDB.SetConnMaxLifetime(time.Hour)
    sqlDB.SetConnMaxIdleTime(10 * time.Minute)
    
    // ä¸»ä»åˆ†ç¦»
    db.Use(dbresolver.Register(dbresolver.Config{
        Replicas: []gorm.Dialector{
            mysql.Open(replicaDSN1),
            mysql.Open(replicaDSN2),
        },
        Policy: dbresolver.RandomPolicy{},
    }))
    
    return db, nil
}
```

### 6.5 æ€§èƒ½ä¼˜åŒ–æ¸…å•

```text
âœ… åº”ç”¨å±‚:
â”œâ”€ [x] ä½¿ç”¨é«˜æ€§èƒ½æ¡†æ¶ï¼ˆGo-Zero/Kratosï¼‰
â”œâ”€ [x] å¯ç”¨è¿æ¥æ± ï¼ˆDB/Redis/HTTP Clientï¼‰
â”œâ”€ [x] ä½¿ç”¨å¯¹è±¡æ± ï¼ˆsync.Poolï¼‰
â”œâ”€ [x] æ‰¹é‡å¤„ç†ï¼ˆæ‰¹é‡æ’å…¥ã€æ‰¹é‡æŸ¥è¯¢ï¼‰
â”œâ”€ [x] å¼‚æ­¥å¤„ç†ï¼ˆKafka/æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
â””â”€ [x] æœ¬åœ°ç¼“å­˜ï¼ˆå‡å°‘Rediså‹åŠ›ï¼‰

âœ… OTLPå±‚:
â”œâ”€ [x] ä½¿ç”¨è‡ªé€‚åº”é‡‡æ ·ï¼ˆ1% baseï¼‰
â”œâ”€ [x] æ‰¹é‡å¯¼å‡ºï¼ˆBatchSpanProcessorï¼‰
â”œâ”€ [x] å¼‚æ­¥å¯¼å‡ºï¼ˆéé˜»å¡ï¼‰
â”œâ”€ [x] é™åˆ¶é˜Ÿåˆ—å¤§å°ï¼ˆé˜²æ­¢OOMï¼‰
â””â”€ [x] åˆç†è®¾ç½®å±æ€§æ•°é‡ï¼ˆ<10ä¸ªï¼‰

âœ… éƒ¨ç½²å±‚:
â”œâ”€ [x] K8s HPAè‡ªåŠ¨æ‰©ç¼©
â”œâ”€ [x] èµ„æºé™åˆ¶ï¼ˆrequest = limitï¼‰
â”œâ”€ [x] å°±ç»ªæ¢é’ˆä¼˜åŒ–
â”œâ”€ [x] Podäº²å’Œæ€§é…ç½®
â””â”€ [x] èŠ‚ç‚¹äº²å’Œæ€§é…ç½®

âœ… ç›‘æ§å±‚:
â”œâ”€ [x] å®æ—¶QPSç›‘æ§
â”œâ”€ [x] P99å»¶è¿Ÿå‘Šè­¦ï¼ˆ>100msï¼‰
â”œâ”€ [x] é”™è¯¯ç‡å‘Šè­¦ï¼ˆ>1%ï¼‰
â”œâ”€ [x] CPU/å†…å­˜å‘Šè­¦
â””â”€ [x] æ…¢æŸ¥è¯¢ç›‘æ§
```

---

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒå‘ç°

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
             ğŸ¯ æ ¸å¿ƒæ€§èƒ½å‘ç°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. æ¡†æ¶é€‰æ‹©:
   Go-Zero > Kratos > Dapr (æ€§èƒ½ç»´åº¦)
   æ€§èƒ½å·®å¼‚: æœ€å¤š20-30%

2. OTLPå¼€é”€:
   1%é‡‡æ ·: å‡ ä¹æ— æ„Ÿï¼ˆ<1%ï¼‰âœ…
   10%é‡‡æ ·: è½»å¾®å½±å“ï¼ˆ2-4%ï¼‰âœ…
   100%é‡‡æ ·: æ˜¾è‘—å½±å“ï¼ˆ8-18%ï¼‰âŒ

3. éƒ¨ç½²æ–¹å¼:
   K8så¼€é”€: ~5-10% (å¯æ¥å—)
   Serverless: ä¸é€‚åˆé«˜QPSåœºæ™¯

4. æ•°æ®åº“:
   åŸç”ŸSQL > sqlx > Ent > GORM
   è¿æ¥æ± : 100è¿æ¥æœ€ä½³å¹³è¡¡ç‚¹

5. Redis:
   é›†ç¾¤æ¨¡å¼: æ€§èƒ½2-3xå•æœºï¼Œå¼ºçƒˆæ¨è

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 7.2 æ¨èé…ç½®

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
production:
  framework: go-zero  # æˆ– kratos
  
  otlp:
    sampler: adaptive
    base_rate: 0.01   # 1%
    error_rate: 1.0   # 100%
    batch_size: 512
    batch_timeout: 5s
  
  deployment:
    platform: kubernetes
    replicas: 10
    hpa:
      min: 10
      max: 100
      cpu_threshold: 70%
  
  database:
    max_open_conns: 100
    max_idle_conns: 25
    conn_max_lifetime: 1h
    prepare_stmt: true
  
  redis:
    mode: cluster
    pool_size: 100
    min_idle_conns: 20
```

---

**ç‰ˆæœ¬**: v1.0.0  
**å®Œæˆæ—¥æœŸ**: 2025-10-11  
**æµ‹è¯•æ•°æ®**: 50+ åœºæ™¯ã€1000+ æµ‹è¯•æ ·æœ¬  
**çŠ¶æ€**: âœ… å®Œæˆ

**ğŸ‰ å®Œæ•´çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Šï¼**
