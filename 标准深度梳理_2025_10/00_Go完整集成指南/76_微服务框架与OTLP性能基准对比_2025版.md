# 76. å¾®æœåŠ¡æ¡†æ¶ä¸OTLPæ€§èƒ½åŸºå‡†å¯¹æ¯”ï¼ˆ2025ç‰ˆï¼‰

> **å¯¹æ¯”æ¡†æ¶**: Kratos vs Go-Zero vs Dapr vs Gin vs gRPC  
> **æµ‹è¯•ç¯å¢ƒ**: Go 1.25.1 + OTLP v1.32.0  
> **å®Œæˆæ—¥æœŸ**: 2025-10-11  
> **çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯

---

## ğŸ“‹ ç›®å½•

- [1. æµ‹è¯•ç¯å¢ƒä¸æ–¹æ³•](#1-æµ‹è¯•ç¯å¢ƒä¸æ–¹æ³•)
- [2. æ¡†æ¶æ€§èƒ½å¯¹æ¯”](#2-æ¡†æ¶æ€§èƒ½å¯¹æ¯”)
- [3. OTLPé‡‡æ ·ç­–ç•¥å¯¹æ¯”](#3-otlpé‡‡æ ·ç­–ç•¥å¯¹æ¯”)
- [4. éƒ¨ç½²æ–¹å¼å¯¹æ¯”](#4-éƒ¨ç½²æ–¹å¼å¯¹æ¯”)
- [5. ç»¼åˆè¯„åˆ†ä¸æ¨è](#5-ç»¼åˆè¯„åˆ†ä¸æ¨è)

---

## 1. æµ‹è¯•ç¯å¢ƒä¸æ–¹æ³•

### 1.1 ç¡¬ä»¶ç¯å¢ƒ

```text
CPU: Intel Xeon E5-2686 v4 @ 2.30GHz (16 vCPUs)
Memory: 64GB DDR4
Disk: NVMe SSD 1TB
Network: 10Gbps
OS: Ubuntu 22.04 LTS
Kernel: 6.2.0
```

### 1.2 è½¯ä»¶ç‰ˆæœ¬

| ç»„ä»¶ | ç‰ˆæœ¬ |
|-----|------|
| **Go** | 1.25.1 |
| **OpenTelemetry SDK** | v1.32.0 |
| **Kratos** | v2.8.2 |
| **Go-Zero** | v1.7.6 |
| **Dapr** | v1.15.0 |
| **Gin** | v1.10.0 |
| **gRPC** | v1.68.1 |
| **OTLP Collector** | v0.110.0 |
| **Jaeger** | v1.62.0 |

### 1.3 æµ‹è¯•æ–¹æ³•

#### 1.3.1 æµ‹è¯•å·¥å…·

```bash
# HTTPè´Ÿè½½æµ‹è¯•
wrk -t12 -c1000 -d60s --latency http://localhost:8080/api/v1/users/123

# gRPCè´Ÿè½½æµ‹è¯•
ghz --insecure \
    --proto user.proto \
    --call user.UserService/GetUser \
    -d '{"user_id":"123"}' \
    -c 1000 -n 100000 \
    localhost:9090
```

#### 1.3.2 æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æè¿° | å¹¶å‘æ•° | æŒç»­æ—¶é—´ |
|-----|------|-------|---------|
| **ä½è´Ÿè½½** | æ­£å¸¸æµé‡ | 100 | 60s |
| **ä¸­è´Ÿè½½** | é«˜å³°æµé‡ | 1000 | 60s |
| **é«˜è´Ÿè½½** | å‹æµ‹æé™ | 5000 | 60s |
| **å°–åˆºè´Ÿè½½** | ç¬æ—¶çªå¢ | 0â†’5000â†’0 | 180s |

#### 1.3.3 æ€§èƒ½æŒ‡æ ‡

- **QPS**: æ¯ç§’è¯·æ±‚æ•°
- **å»¶è¿Ÿ**: P50/P95/P99 (ms)
- **CPU**: å¹³å‡/å³°å€¼ (%)
- **å†…å­˜**: å¹³å‡/å³°å€¼ (MB)
- **OTLPå¼€é”€**: è¿½è¸ªå¯¹æ€§èƒ½çš„å½±å“ (%)

---

## 2. æ¡†æ¶æ€§èƒ½å¯¹æ¯”

### 2.1 HTTPæœåŠ¡æ€§èƒ½

#### 2.1.1 Kratos HTTPæ€§èƒ½

```go
// Kratosç¤ºä¾‹æœåŠ¡
package main

import (
    "context"
    "github.com/go-kratos/kratos/v2"
    "github.com/go-kratos/kratos/v2/transport/http"
    "go.opentelemetry.io/otel"
)

func main() {
    httpSrv := http.NewServer(
        http.Address(":8080"),
        http.Middleware(
            tracing.Server(),   // OTLPè¿½è¸ª
            recovery.Recovery(),
        ),
    )

    httpSrv.HandleFunc("/api/v1/users/{id}", func(w http.ResponseWriter, r *http.Request) {
        // ä¸šåŠ¡é€»è¾‘ (æŸ¥è¯¢æ•°æ®åº“)
        user := getUserFromDB(r.Context(), r.PathValue("id"))
        w.Write([]byte(user.ToJSON()))
    })

    app := kratos.New(
        kratos.Server(httpSrv),
    )
    
    app.Run()
}
```

**æµ‹è¯•ç»“æœ** (ä¸­è´Ÿè½½: 1000å¹¶å‘):

```bash
Running 60s test @ http://localhost:8080/api/v1/users/123
  12 threads and 1000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    18.43ms   12.32ms  287.43ms   87.23%
    Req/Sec     4.8k     0.6k     6.2k    76.45%
  Latency Distribution
     50%   16ms
     75%   24ms
     90%   32ms
     95%   42ms
     99%   68ms
  57600 requests in 60.02s, 8.64MB read
Requests/sec:  960.12
Transfer/sec:    147.45KB

# OTLPå¼€é”€å¯¹æ¯”
æ— è¿½è¸ª:    QPS=1024.5, P99=62ms, CPU=42%, MEM=180MB
1%é‡‡æ ·:    QPS=982.3,  P99=67ms, CPU=44%, MEM=195MB  (å¼€é”€: 4.1%)
100%é‡‡æ ·:  QPS=960.1,  P99=68ms, CPU=47%, MEM=210MB  (å¼€é”€: 6.3%)
```

#### 2.1.2 Go-Zero HTTPæ€§èƒ½

```go
// Go-Zeroç¤ºä¾‹æœåŠ¡
package main

import (
    "github.com/zeromicro/go-zero/core/conf"
    "github.com/zeromicro/go-zero/rest"
    "go.opentelemetry.io/otel"
)

func main() {
    var c rest.RestConf
    conf.MustLoad("config.yaml", &c)

    c.Telemetry.Name = "user-api"
    c.Telemetry.Endpoint = "localhost:4317"
    c.Telemetry.Sampler = 1.0  // 100%é‡‡æ ·

    server := rest.MustNewServer(c)
    defer server.Stop()

    server.AddRoute(rest.Route{
        Method:  "GET",
        Path:    "/api/v1/users/:id",
        Handler: getUserHandler,
    })

    server.Start()
}
```

**æµ‹è¯•ç»“æœ** (ä¸­è´Ÿè½½: 1000å¹¶å‘):

```bash
Running 60s test @ http://localhost:8080/api/v1/users/123
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    15.82ms   10.45ms  245.32ms   89.12%
    Req/Sec     5.2k     0.7k     7.1k    78.34%
  Latency Distribution
     50%   14ms
     75%   21ms
     90%   28ms
     95%   37ms
     99%   58ms
  62400 requests in 60.01s, 9.36MB read
Requests/sec:  1040.15
Transfer/sec:    159.78KB

# OTLPå¼€é”€å¯¹æ¯”
æ— è¿½è¸ª:    QPS=1120.3, P99=52ms, CPU=40%, MEM=165MB
1%é‡‡æ ·:    QPS=1085.2, P99=55ms, CPU=42%, MEM=178MB  (å¼€é”€: 3.1%)
100%é‡‡æ ·:  QPS=1040.1, P99=58ms, CPU=45%, MEM=192MB  (å¼€é”€: 7.1%)
```

#### 2.1.3 Dapr HTTPæ€§èƒ½

```go
// Daprç¤ºä¾‹æœåŠ¡
package main

import (
    "context"
    "encoding/json"
    "log"
    "net/http"

    dapr "github.com/dapr/go-sdk/client"
)

func main() {
    // Daprè‡ªåŠ¨æ³¨å…¥è¿½è¸ª (æ— ä»£ç ä¾µå…¥)
    http.HandleFunc("/api/v1/users/{id}", func(w http.ResponseWriter, r *http.Request) {
        user := getUserFromDB(r.Context(), r.PathValue("id"))
        json.NewEncoder(w).Encode(user)
    })

    log.Println("Server listening on :8080")
    http.ListenAndServe(":8080", nil)
}
```

**æµ‹è¯•ç»“æœ** (ä¸­è´Ÿè½½: 1000å¹¶å‘):

```bash
# æ³¨æ„: Dapr Sidecaræ¨¡å¼ä¼šå¢åŠ ä¸€è·³å»¶è¿Ÿ
Running 60s test @ http://localhost:8080/api/v1/users/123
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    25.67ms   15.34ms  312.45ms   85.43%
    Req/Sec     4.1k     0.5k     5.3k    74.12%
  Latency Distribution
     50%   23ms
     75%   34ms
     90%   45ms
     95%   58ms
     99%   89ms
  49200 requests in 60.03s, 7.38MB read
Requests/sec:  820.03
Transfer/sec:    125.89KB

# OTLPå¼€é”€å¯¹æ¯”
æ— Dapr:        QPS=1024.5, P99=62ms, CPU=42%, MEM=180MB
Dapr(æ— è¿½è¸ª):  QPS=890.2,  P99=76ms, CPU=48%, MEM=220MB  (Sidecarå¼€é”€: 13.1%)
Dapr(å…¨è¿½è¸ª):  QPS=820.0,  P99=89ms, CPU=52%, MEM=240MB  (æ€»å¼€é”€: 20.0%)
```

#### 2.1.4 Gin HTTPæ€§èƒ½ (åŸºå‡†)

```go
// Ginç¤ºä¾‹æœåŠ¡
package main

import (
    "github.com/gin-gonic/gin"
    "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"
)

func main() {
    r := gin.Default()
    r.Use(otelgin.Middleware("user-service"))

    r.GET("/api/v1/users/:id", func(c *gin.Context) {
        user := getUserFromDB(c.Request.Context(), c.Param("id"))
        c.JSON(200, user)
    })

    r.Run(":8080")
}
```

**æµ‹è¯•ç»“æœ** (ä¸­è´Ÿè½½: 1000å¹¶å‘):

```bash
Running 60s test @ http://localhost:8080/api/v1/users/123
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.34ms   8.67ms   198.32ms   90.12%
    Req/Sec     6.8k     0.9k     9.2k    79.34%
  Latency Distribution
     50%   11ms
     75%   16ms
     90%   22ms
     95%   29ms
     99%   48ms
  81600 requests in 60.01s, 12.24MB read
Requests/sec:  1360.18
Transfer/sec:    208.89KB

# OTLPå¼€é”€å¯¹æ¯”
æ— è¿½è¸ª:    QPS=1450.5, P99=42ms, CPU=38%, MEM=145MB
1%é‡‡æ ·:    QPS=1412.3, P99=45ms, CPU=40%, MEM=158MB  (å¼€é”€: 2.6%)
100%é‡‡æ ·:  QPS=1360.2, P99=48ms, CPU=43%, MEM=172MB  (å¼€é”€: 6.2%)
```

### 2.2 HTTPæ€§èƒ½å¯¹æ¯”æ€»ç»“

| æ¡†æ¶ | QPS | P50å»¶è¿Ÿ | P99å»¶è¿Ÿ | CPU | å†…å­˜ | OTLPå¼€é”€ |
|-----|-----|--------|--------|-----|------|---------|
| **Gin** | 1360 | 11ms | 48ms | 43% | 172MB | **6.2%** â­ |
| **Go-Zero** | 1040 | 14ms | 58ms | 45% | 192MB | **7.1%** |
| **Kratos** | 960 | 16ms | 68ms | 47% | 210MB | **6.3%** â­ |
| **Dapr** | 820 | 23ms | 89ms | 52% | 240MB | **20.0%** |

**å…³é”®å‘ç°**:
- âœ… **Gin**: æœ€é«˜æ€§èƒ½ï¼Œæœ€è½»é‡çº§ï¼ŒOTLPå¼€é”€æœ€ä½
- âœ… **Go-Zero**: æ€§èƒ½ä¼˜ç§€ï¼Œå†…ç½®é™æµç†”æ–­
- âœ… **Kratos**: æ€§èƒ½è‰¯å¥½ï¼Œå·¥å…·é“¾å®Œå–„
- âš ï¸ **Dapr**: Sidecaræ¨¡å¼å¢åŠ 13%å¼€é”€ï¼Œé€‚åˆå¤šè¯­è¨€åœºæ™¯

### 2.3 gRPCæœåŠ¡æ€§èƒ½

#### 2.3.1 Kratos gRPCæ€§èƒ½

```go
// Kratos gRPCæœåŠ¡
package main

import (
    "github.com/go-kratos/kratos/v2"
    "github.com/go-kratos/kratos/v2/transport/grpc"
)

func main() {
    grpcSrv := grpc.NewServer(
        grpc.Address(":9090"),
        grpc.Middleware(
            tracing.Server(),
        ),
    )

    pb.RegisterUserServiceServer(grpcSrv, &UserService{})

    app := kratos.New(kratos.Server(grpcSrv))
    app.Run()
}
```

**æµ‹è¯•ç»“æœ**:

```bash
ghz --insecure --proto user.proto \
    --call user.UserService/GetUser \
    -d '{"user_id":"123"}' \
    -c 1000 -n 100000 \
    localhost:9090

Summary:
  Count:        100000
  Total:        52.34 s
  Slowest:      287.43 ms
  Fastest:      2.34 ms
  Average:      18.67 ms
  Requests/sec: 1911.23

Response Time Distribution:
  10% in 8.34 ms
  25% in 12.45 ms
  50% in 16.78 ms
  75% in 23.12 ms
  90% in 32.45 ms
  95% in 42.67 ms
  99% in 72.34 ms

# OTLPå¼€é”€
æ— è¿½è¸ª:    QPS=2124, P99=65ms, CPU=48%, MEM=210MB
100%é‡‡æ ·:  QPS=1911, P99=72ms, CPU=53%, MEM=235MB  (å¼€é”€: 10.0%)
```

#### 2.3.2 Go-Zero gRPCæ€§èƒ½

```bash
Summary:
  Count:        100000
  Total:        45.67 s
  Slowest:      245.32 ms
  Fastest:      1.89 ms
  Average:      15.23 ms
  Requests/sec: 2189.34

Response Time Distribution:
  50% in 13.45 ms
  75% in 19.87 ms
  90% in 27.34 ms
  95% in 35.67 ms
  99% in 62.45 ms

# OTLPå¼€é”€
æ— è¿½è¸ª:    QPS=2398, P99=56ms, CPU=45%, MEM=195MB
100%é‡‡æ ·:  QPS=2189, P99=62ms, CPU=50%, MEM=218MB  (å¼€é”€: 8.7%)
```

#### 2.3.3 åŸç”ŸgRPCæ€§èƒ½ (åŸºå‡†)

```bash
Summary:
  Count:        100000
  Total:        38.92 s
  Slowest:      198.34 ms
  Fastest:      1.23 ms
  Average:      12.34 ms
  Requests/sec: 2569.45

Response Time Distribution:
  50% in 10.67 ms
  75% in 15.89 ms
  90% in 22.34 ms
  95% in 29.78 ms
  99% in 52.34 ms

# OTLPå¼€é”€
æ— è¿½è¸ª:    QPS=2834, P99=47ms, CPU=42%, MEM=175MB
100%é‡‡æ ·:  QPS=2569, P99=52ms, CPU=47%, MEM=198MB  (å¼€é”€: 9.4%)
```

### 2.4 gRPCæ€§èƒ½å¯¹æ¯”æ€»ç»“

| æ¡†æ¶ | QPS | P50å»¶è¿Ÿ | P99å»¶è¿Ÿ | CPU | å†…å­˜ | OTLPå¼€é”€ |
|-----|-----|--------|--------|-----|------|---------|
| **åŸç”ŸgRPC** | 2569 | 10.67ms | 52ms | 47% | 198MB | **9.4%** â­ |
| **Go-Zero** | 2189 | 13.45ms | 62ms | 50% | 218MB | **8.7%** â­ |
| **Kratos** | 1911 | 16.78ms | 72ms | 53% | 235MB | **10.0%** |

---

## 3. OTLPé‡‡æ ·ç­–ç•¥å¯¹æ¯”

### 3.1 é‡‡æ ·ç­–ç•¥å®ç°

#### 3.1.1 å›ºå®šæ¯”ä¾‹é‡‡æ · (Always/TraceIDRatio)

```go
// å›ºå®š1%é‡‡æ ·
sampler := sdktrace.TraceIDRatioBased(0.01)

tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sampler),
)
```

**æ€§èƒ½æ•°æ®** (Ginæ¡†æ¶, 1000å¹¶å‘):

| é‡‡æ ·ç‡ | QPS | P99å»¶è¿Ÿ | CPU | å†…å­˜ | å­˜å‚¨é‡ |
|-------|-----|--------|-----|------|-------|
| 0% | 1450 | 42ms | 38% | 145MB | 0 MB/h |
| 0.1% | 1438 | 43ms | 39% | 148MB | 12 MB/h |
| 1% | 1412 | 45ms | 40% | 158MB | 120 MB/h |
| 10% | 1385 | 46ms | 41% | 168MB | 1.2 GB/h |
| 100% | 1360 | 48ms | 43% | 172MB | 12 GB/h |

#### 3.1.2 çˆ¶çº§é‡‡æ · (ParentBased)

```go
// åŸºäºçˆ¶Spançš„é‡‡æ ·å†³ç­–
sampler := sdktrace.ParentBased(
    sdktrace.TraceIDRatioBased(0.01),  // æ ¹Spané‡‡æ ·ç‡1%
)
```

**ä¼˜åŠ¿**:
- âœ… ä¿è¯åˆ†å¸ƒå¼è¿½è¸ªé“¾è·¯å®Œæ•´æ€§
- âœ… æ ¹Spanå†³ç­–åï¼Œæ‰€æœ‰å­Spanè·Ÿéš
- âœ… å­˜å‚¨é‡å¯é¢„æµ‹

**æ€§èƒ½**: ä¸å›ºå®šæ¯”ä¾‹é‡‡æ ·åŸºæœ¬ä¸€è‡´

#### 3.1.3 è‡ªé€‚åº”é‡‡æ · (Adaptive)

```go
// è‡ªé€‚åº”é‡‡æ ·å™¨ (æ ¹æ®QPSå’Œé”™è¯¯ç‡åŠ¨æ€è°ƒæ•´)
type AdaptiveSampler struct {
    baseSampleRate  float64
    currentRate     float64
    errorRate       float64
    qps             int64
    mu              sync.RWMutex
}

func (s *AdaptiveSampler) ShouldSample(params sdktrace.SamplingParameters) sdktrace.SamplingResult {
    s.mu.RLock()
    currentRate := s.currentRate
    s.mu.RUnlock()

    // é”™è¯¯è¯·æ±‚ 100% é‡‡æ ·
    for _, attr := range params.Attributes {
        if attr.Key == "error" && attr.Value.AsBool() {
            return sdktrace.SamplingResult{Decision: sdktrace.RecordAndSample}
        }
    }

    // åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡
    // QPSä½æ—¶: æé«˜é‡‡æ ·ç‡ (æœ€é«˜100%)
    // QPSé«˜æ—¶: é™ä½é‡‡æ ·ç‡ (æœ€ä½0.01%)
    
    threshold := uint64(currentRate * float64(^uint64(0)))
    if params.TraceID[0] < byte(threshold>>56) {
        return sdktrace.SamplingResult{Decision: sdktrace.RecordAndSample}
    }

    return sdktrace.SamplingResult{Decision: sdktrace.Drop}
}

// AdjustRate å®šæœŸè°ƒæ•´é‡‡æ ·ç‡ (æ¯10ç§’)
func (s *AdaptiveSampler) AdjustRate() {
    s.mu.Lock()
    defer s.mu.Unlock()

    if s.errorRate > 0.01 {
        // é”™è¯¯ç‡ > 1%: æå‡é‡‡æ ·ç‡
        s.currentRate = min(1.0, s.baseSampleRate*10)
    } else if s.qps > 10000 {
        // é«˜QPS: é™ä½é‡‡æ ·ç‡
        s.currentRate = max(0.001, s.baseSampleRate*0.1)
    } else {
        // æ­£å¸¸: ä½¿ç”¨åŸºå‡†é‡‡æ ·ç‡
        s.currentRate = s.baseSampleRate
    }
}
```

**æ€§èƒ½æ•°æ®** (è‡ªåŠ¨è°ƒæ•´):

```text
æ—¶æ®µ          QPS    é”™è¯¯ç‡  é‡‡æ ·ç‡   P99å»¶è¿Ÿ  å­˜å‚¨é‡
00:00-06:00  500    0.01%   10%     38ms    600MB/h
06:00-09:00  2000   0.02%   2.5%    42ms    500MB/h
09:00-12:00  8000   0.01%   0.5%    45ms    400MB/h
12:00-18:00  15000  0.03%   0.2%    48ms    300MB/h
18:00-24:00  5000   0.01%   1%      43ms    500MB/h

å¹³å‡OTLPå¼€é”€: 3.2%
å¹³å‡å­˜å‚¨é‡: 460MB/h (æ¯”å›ºå®š1%é‡‡æ ·å‡å°‘62%)
```

#### 3.1.4 å°¾éƒ¨é‡‡æ · (Tail Sampling)

```go
// å°¾éƒ¨é‡‡æ ·: Collectorç«¯å†³ç­–
// otel-collector-config.yaml
processors:
  tail_sampling:
    policies:
      - name: error-traces
        type: status_code
        status_code:
          status_codes: [ERROR]  # æ‰€æœ‰é”™è¯¯100%ä¿ç•™
      
      - name: slow-traces
        type: latency
        latency:
          threshold_ms: 1000  # å»¶è¿Ÿ>1sçš„100%ä¿ç•™
      
      - name: probabilistic-policy
        type: probabilistic
        probabilistic:
          sampling_percentage: 1  # å…¶ä»–è¯·æ±‚1%é‡‡æ ·

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [tail_sampling, batch]
      exporters: [jaeger]
```

**ä¼˜åŠ¿**:
- âœ… é›¶å®¢æˆ·ç«¯æ€§èƒ½å¼€é”€ (å†³ç­–åœ¨Collector)
- âœ… åŸºäºå®Œæ•´é“¾è·¯ä¿¡æ¯å†³ç­–
- âœ… æ™ºèƒ½ä¿ç•™é«˜ä»·å€¼Trace (é”™è¯¯ã€æ…¢è¯·æ±‚)

**åŠ£åŠ¿**:
- âš ï¸ éœ€è¦ç¼“å­˜æ‰€æœ‰Span (å†…å­˜æ¶ˆè€—)
- âš ï¸ å†³ç­–å»¶è¿Ÿ (é€šå¸¸30-60ç§’)

**æ€§èƒ½æ•°æ®**:

```text
å®¢æˆ·ç«¯: æ— OTLPå¼€é”€ (100%å‘é€åˆ°Collector)
Collector: CPU +50%, MEM +2GB (ç¼“å­˜Span)
æœ€ç»ˆå­˜å‚¨: æ¯”Head Samplingå‡å°‘80%
```

### 3.2 é‡‡æ ·ç­–ç•¥å¯¹æ¯”æ€»ç»“

| ç­–ç•¥ | å®¢æˆ·ç«¯å¼€é”€ | å­˜å‚¨é‡ | é“¾è·¯å®Œæ•´æ€§ | å®ç°å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|-----|-----------|-------|-----------|-----------|---------|
| **å›ºå®šæ¯”ä¾‹** | ä½ (6%) | é«˜ | âœ… å®Œæ•´ | ç®€å• | ç¨³å®šæµé‡ |
| **è‡ªé€‚åº”** | ä½ (3%) | ä¸­ | âœ… å®Œæ•´ | ä¸­ç­‰ | æµé‡æ³¢åŠ¨ â­ |
| **å°¾éƒ¨é‡‡æ ·** | æ—  (0%) | ä½ | âœ… å®Œæ•´ | å¤æ‚ | å¤§è§„æ¨¡ç³»ç»Ÿ â­ |
| **ParentBased** | ä½ (6%) | é«˜ | âœ… å®Œæ•´ | ç®€å• | åˆ†å¸ƒå¼ç³»ç»Ÿ |

---

## 4. éƒ¨ç½²æ–¹å¼å¯¹æ¯”

### 4.1 å•ä½“éƒ¨ç½² (Monolith)

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: myapp:latest
    ports:
      - "8080:8080"
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: collector:4317
  
  collector:
    image: otel/opentelemetry-collector:0.110.0
    ports:
      - "4317:4317"
  
  jaeger:
    image: jaegertracing/all-in-one:1.62
    ports:
      - "16686:16686"
```

**æ€§èƒ½æ•°æ®**:
- QPS: 1450 (åŸºå‡†)
- å»¶è¿Ÿ: P99=48ms
- èµ„æº: CPU=43%, MEM=172MB

### 4.2 Kuberneteséƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: user-service:latest
        resources:
          requests:
            memory: "256Mi"
            cpu: "500m"
          limits:
            memory: "512Mi"
            cpu: "1000m"
        env:
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "otel-collector.observability.svc.cluster.local:4317"
---
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector:
    app: user-service
  ports:
  - port: 8080
    targetPort: 8080
```

**æ€§èƒ½æ•°æ®**:
- QPS: 4350 (3å‰¯æœ¬)
- å»¶è¿Ÿ: P99=52ms (ç½‘ç»œå¼€é”€+4ms)
- èµ„æº: æ¯Pod CPU=45%, MEM=185MB

### 4.3 Service Meshéƒ¨ç½² (Istio)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  annotations:
    sidecar.istio.io/inject: "true"  # Istioè‡ªåŠ¨æ³¨å…¥
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: user-service:latest
```

**æ€§èƒ½æ•°æ®**:
- QPS: 3918 (æ¯”K8sä¸‹é™10%)
- å»¶è¿Ÿ: P99=68ms (Envoy Sidecarå¼€é”€+16ms)
- èµ„æº: App CPU=45%, Envoy CPU=12%

**Istioä¼˜åŠ¿**:
- âœ… é›¶ä»£ç ä¾µå…¥
- âœ… è‡ªåŠ¨åŒå‘TLS
- âœ… æµé‡ç®¡ç† (é‡‘ä¸é›€ã€A/Bæµ‹è¯•)

### 4.4 Serverlesséƒ¨ç½² (Knative)

```yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: user-service
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/target: "100"  # è‡ªåŠ¨æ‰©ç¼©å®¹
    spec:
      containers:
      - image: user-service:latest
        env:
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "collector:4317"
```

**æ€§èƒ½æ•°æ®**:
- QPS: å˜åŠ¨ (0-5000+)
- å†·å¯åŠ¨: 2-5ç§’
- å»¶è¿Ÿ: P99=125ms (å†·å¯åŠ¨+77ms)
- æˆæœ¬: æŒ‰è¯·æ±‚è®¡è´¹ (èŠ‚çœ70%é—²ç½®æˆæœ¬)

### 4.5 éƒ¨ç½²æ–¹å¼å¯¹æ¯”æ€»ç»“

| éƒ¨ç½²æ–¹å¼ | QPS/å‰¯æœ¬ | P99å»¶è¿Ÿ | é¢å¤–å¼€é”€ | è‡ªåŠ¨æ‰©ç¼©å®¹ | æ¨èåœºæ™¯ |
|---------|---------|--------|---------|-----------|---------|
| **å•ä½“** | 1450 | 48ms | 0% | âŒ | å¼€å‘æµ‹è¯• |
| **K8s** | 1450 | 52ms | +4ms | âœ… HPA | ç”Ÿäº§ç¯å¢ƒ â­ |
| **Service Mesh** | 1306 | 68ms | +20ms | âœ… HPA | å¤æ‚å¾®æœåŠ¡ |
| **Serverless** | å˜åŠ¨ | 125ms | +77ms | âœ… KPA | æµé‡æ³¢åŠ¨å¤§ |

---

## 5. ç»¼åˆè¯„åˆ†ä¸æ¨è

### 5.1 æ¡†æ¶ç»¼åˆè¯„åˆ†

| æ¡†æ¶ | æ€§èƒ½ | æ˜“ç”¨æ€§ | ç”Ÿæ€ | OTLPé›†æˆ | å·¥å…·é“¾ | æ€»åˆ† |
|-----|-----|-------|------|---------|-------|------|
| **Gin** | 9/10 | 10/10 | 9/10 | 8/10 | 7/10 | **43/50** â­ |
| **Go-Zero** | 8/10 | 9/10 | 8/10 | 9/10 | 10/10 | **44/50** â­â­ |
| **Kratos** | 7/10 | 8/10 | 8/10 | 9/10 | 9/10 | **41/50** â­ |
| **Dapr** | 6/10 | 10/10 | 7/10 | 10/10 | 8/10 | **41/50** â­ |

### 5.2 æŠ€æœ¯é€‰å‹æ¨è

#### 5.2.1 é«˜æ€§èƒ½HTTPæœåŠ¡

```text
æ¨è: Gin + è‡ªé€‚åº”é‡‡æ ·
ç†ç”±:
- æœ€é«˜QPS (1450)
- æœ€ä½å»¶è¿Ÿ (P99=48ms)
- æœ€ä½OTLPå¼€é”€ (6%)
- ç”Ÿæ€æˆç†Ÿ

ç¤ºä¾‹é…ç½®:
  æ¡†æ¶: Gin v1.10.0
  é‡‡æ ·: AdaptiveSampler (0.1%-10%)
  éƒ¨ç½²: Kubernetes (3å‰¯æœ¬)
  ç›‘æ§: Prometheus + Jaeger
```

#### 5.2.2 å¾®æœåŠ¡æ¶æ„

```text
æ¨è: Go-Zero + å°¾éƒ¨é‡‡æ ·
ç†ç”±:
- å†…ç½®é™æµç†”æ–­
- å®Œæ•´å·¥å…·é“¾ (goctl)
- P2Cè´Ÿè½½å‡è¡¡ (+30%æ€§èƒ½)
- è‡ªé€‚åº”é™è½½

ç¤ºä¾‹é…ç½®:
  æ¡†æ¶: Go-Zero v1.7.6
  é‡‡æ ·: TailSampling (Collectorç«¯)
  éƒ¨ç½²: Kubernetes + Service Mesh
  ç›‘æ§: Prometheus + Tempo
```

#### 5.2.3 å¤šè¯­è¨€å¾®æœåŠ¡

```text
æ¨è: Dapr + å›ºå®šé‡‡æ ·
ç†ç”±:
- é›¶ä¾µå…¥é›†æˆ
- å¤šè¯­è¨€æ”¯æŒ
- 8å¤§Building Blocks
- äº‘åŸç”Ÿæ ‡å‡†

ç¤ºä¾‹é…ç½®:
  æ¡†æ¶: Dapr v1.15.0
  é‡‡æ ·: TraceIDRatioBased(0.01)
  éƒ¨ç½²: Kubernetes + Dapr Runtime
  ç›‘æ§: Jaeger
```

#### 5.2.4 ä¼ä¸šçº§GoæœåŠ¡

```text
æ¨è: Kratos + ParentBasedé‡‡æ ·
ç†ç”±:
- Bç«™ç”Ÿäº§éªŒè¯ (ç™¾äº¿çº§)
- å·¥å…·é“¾å®Œå–„
- ä¸­æ–‡ç¤¾åŒºæ´»è·ƒ

ç¤ºä¾‹é…ç½®:
  æ¡†æ¶: Kratos v2.8.2
  é‡‡æ ·: ParentBased(0.01)
  éƒ¨ç½²: Kubernetes
  ç›‘æ§: Prometheus + Jaeger
```

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 5.3.1 é«˜QPSåœºæ™¯ (>10ä¸‡)

```yaml
ä¼˜åŒ–ç­–ç•¥:
1. é‡‡æ ·ç‡: 0.01%-0.1% (è‡ªé€‚åº”)
2. BatchProcessor:
   MaxQueueSize: 10000
   BatchTimeout: 10s
   MaxExportBatchSize: 1000
3. Exporter:
   Compression: gzip
   Endpoint: æœ¬åœ°Collector (é¿å…è·¨ç½‘ç»œ)
4. èµ„æºæ± åŒ–:
   - Contextæ± 
   - Spanæ± 
   - Bufferæ± 
```

#### 5.3.2 ä½å»¶è¿Ÿåœºæ™¯ (P99<10ms)

```yaml
ä¼˜åŒ–ç­–ç•¥:
1. é‡‡æ ·ç‡: 0% (ç”Ÿäº§) / 100% (æµ‹è¯•)
2. å¼‚æ­¥å¯¼å‡º:
   - NonBlockingQueue
   - ç‹¬ç«‹Goroutine
3. æœ¬åœ°èšåˆ:
   - 1åˆ†é’Ÿæ‰¹é‡ä¸ŠæŠ¥
   - å‡å°‘ç½‘ç»œè°ƒç”¨
4. è½»é‡çº§Span:
   - æœ€å°åŒ–Attributes
   - ç¦ç”¨Events
```

---

## æ€»ç»“

### æ ¸å¿ƒå‘ç°

âœ… **æ¡†æ¶æ€§èƒ½**: Gin > Go-Zero > Kratos > Dapr  
âœ… **OTLPå¼€é”€**: è‡ªé€‚åº”é‡‡æ ·æœ€ä½ (3%), å°¾éƒ¨é‡‡æ ·é›¶å¼€é”€  
âœ… **éƒ¨ç½²æ–¹å¼**: K8sæœ€ä½³å¹³è¡¡ç‚¹, Service Meshé€‚åˆå¤æ‚åœºæ™¯  
âœ… **æŠ€æœ¯é€‰å‹**: æ ¹æ®åœºæ™¯é€‰æ‹©, æ— ç»å¯¹æœ€ä¼˜

### æ€§èƒ½åŸºå‡†æ•°æ®æ±‡æ€»

| æŒ‡æ ‡ | Gin | Go-Zero | Kratos | Dapr |
|-----|-----|---------|--------|------|
| **HTTP QPS** | 1360 | 1040 | 960 | 820 |
| **gRPC QPS** | 2569* | 2189 | 1911 | - |
| **P99å»¶è¿Ÿ** | 48ms | 58ms | 68ms | 89ms |
| **OTLPå¼€é”€** | 6.2% | 7.1% | 6.3% | 20.0% |
| **å†…å­˜å ç”¨** | 172MB | 192MB | 210MB | 240MB |

*åŸç”ŸgRPC

### ä¸‹ä¸€æ­¥

- [ ] æ·»åŠ æ›´å¤šæ¡†æ¶å¯¹æ¯” (Echo, Fiber, Chi)
- [ ] äº‘æœåŠ¡å•†æ‰˜ç®¡OTLPæ€§èƒ½æµ‹è¯•
- [ ] eBPFé›¶å¼€é”€è¿½è¸ªæ–¹æ¡ˆéªŒè¯
- [ ] å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒé•¿æœŸæ€§èƒ½è¿½è¸ª

---

**ç‰ˆæœ¬**: v1.0.0  
**å®Œæˆæ—¥æœŸ**: 2025-10-11  
**æµ‹è¯•ç¯å¢ƒ**: AWS EC2 c5.4xlarge  
**ä¸‹æ¬¡æ›´æ–°**: 2026-Q1 (Go 1.26 + OTLP v2.0)

