# Go 主流框架深度集成指南

> **Go 版本**: 1.25.1  
> **OpenTelemetry SDK**: v1.32.0+  
> **最后更新**: 2025年10月8日

---

## 📋 目录

- [Go 主流框架深度集成指南](#go-主流框架深度集成指南)
  - [📋 目录](#-目录)
  - [概述](#概述)
  - [Gin Framework](#gin-framework)
    - [1. Gin 完整集成](#1-gin-完整集成)
  - [Echo Framework](#echo-framework)
    - [2. Echo 完整集成](#2-echo-完整集成)
  - [Fiber Framework](#fiber-framework)
    - [3. Fiber 完整集成](#3-fiber-完整集成)
  - [Chi Router](#chi-router)
    - [4. Chi Router 集成](#4-chi-router-集成)
  - [总结](#总结)
    - [相关文档](#相关文档)

---

## 概述

本文档提供 Go 主流 Web 框架与 OpenTelemetry OTLP 的深度集成方案，涵盖 HTTP、gRPC、GraphQL 和 WebSocket。

---

## Gin Framework

### 1. Gin 完整集成

```go
package gin

import (
    "context"
    "time"

    "github.com/gin-gonic/gin"
    "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/codes"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/trace"
)

// GinApp Gin应用
type GinApp struct {
    engine *gin.Engine
    tracer trace.Tracer
}

// NewGinApp 创建Gin应用
func NewGinApp(serviceName string) *GinApp {
    // 设置Gin模式
    gin.SetMode(gin.ReleaseMode)
    
    engine := gin.New()
    
    app := &GinApp{
        engine: engine,
        tracer: otel.Tracer(serviceName),
    }
    
    // 注册中间件
    app.setupMiddlewares(serviceName)
    
    // 注册路由
    app.setupRoutes()
    
    return app
}

// setupMiddlewares 设置中间件
func (app *GinApp) setupMiddlewares(serviceName string) {
    // 1. Recovery中间件（必须最先）
    app.engine.Use(app.recoveryMiddleware())
    
    // 2. OpenTelemetry追踪中间件
    app.engine.Use(otelgin.Middleware(serviceName))
    
    // 3. 自定义追踪增强
    app.engine.Use(app.enhancedTracingMiddleware())
    
    // 4. 请求日志中间件
    app.engine.Use(app.loggingMiddleware())
    
    // 5. CORS中间件
    app.engine.Use(app.corsMiddleware())
    
    // 6. 速率限制
    app.engine.Use(app.rateLimitMiddleware())
}

// enhancedTracingMiddleware 增强追踪中间件
func (app *GinApp) enhancedTracingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        span := trace.SpanFromContext(c.Request.Context())
        
        // 添加额外属性
        span.SetAttributes(
            attribute.String("http.client_ip", c.ClientIP()),
            attribute.String("http.user_agent", c.Request.UserAgent()),
            attribute.StringSlice("http.accept", c.Request.Header.Values("Accept")),
        )
        
        // 记录请求体大小
        if c.Request.ContentLength > 0 {
            span.SetAttributes(
                attribute.Int64("http.request.body.size", c.Request.ContentLength),
            )
        }
        
        c.Next()
        
        // 记录响应信息
        span.SetAttributes(
            attribute.Int("http.status_code", c.Writer.Status()),
            attribute.Int("http.response.body.size", c.Writer.Size()),
        )
        
        // 记录错误
        if len(c.Errors) > 0 {
            for _, err := range c.Errors {
                span.RecordError(err.Err)
            }
            span.SetStatus(codes.Error, c.Errors.String())
        } else if c.Writer.Status() >= 400 {
            span.SetStatus(codes.Error, http.StatusText(c.Writer.Status()))
        } else {
            span.SetStatus(codes.Ok, "")
        }
    }
}

// loggingMiddleware 日志中间件
func (app *GinApp) loggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        path := c.Request.URL.Path
        query := c.Request.URL.RawQuery
        
        c.Next()
        
        latency := time.Since(start)
        
        // 从context获取trace信息
        span := trace.SpanFromContext(c.Request.Context())
        spanContext := span.SpanContext()
        
        // 结构化日志
        log.WithFields(log.Fields{
            "status":     c.Writer.Status(),
            "method":     c.Request.Method,
            "path":       path,
            "query":      query,
            "ip":         c.ClientIP(),
            "user_agent": c.Request.UserAgent(),
            "latency_ms": latency.Milliseconds(),
            "trace_id":   spanContext.TraceID().String(),
            "span_id":    spanContext.SpanID().String(),
        }).Info("HTTP Request")
    }
}

// recoveryMiddleware Panic恢复中间件
func (app *GinApp) recoveryMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        defer func() {
            if err := recover(); err != nil {
                ctx := c.Request.Context()
                _, span := app.tracer.Start(ctx, "panic-recovery")
                defer span.End()
                
                // 记录panic
                panicErr := fmt.Errorf("panic: %v", err)
                span.RecordError(panicErr)
                span.SetStatus(codes.Error, panicErr.Error())
                
                // 记录堆栈
                stack := string(debug.Stack())
                span.SetAttributes(
                    attribute.String("panic.stack", stack),
                )
                
                // 返回错误响应
                c.JSON(500, gin.H{
                    "error":    "Internal Server Error",
                    "trace_id": span.SpanContext().TraceID().String(),
                })
                c.Abort()
            }
        }()
        
        c.Next()
    }
}

// corsMiddleware CORS中间件
func (app *GinApp) corsMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Writer.Header().Set("Access-Control-Allow-Origin", "*")
        c.Writer.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
        c.Writer.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization, traceparent, tracestate")
        c.Writer.Header().Set("Access-Control-Max-Age", "86400")
        
        if c.Request.Method == "OPTIONS" {
            c.AbortWithStatus(204)
            return
        }
        
        c.Next()
    }
}

// rateLimitMiddleware 速率限制中间件
func (app *GinApp) rateLimitMiddleware() gin.HandlerFunc {
    limiter := rate.NewLimiter(100, 200) // 100 req/s, burst 200
    
    return func(c *gin.Context) {
        if !limiter.Allow() {
            span := trace.SpanFromContext(c.Request.Context())
            span.AddEvent("Rate limit exceeded")
            span.SetAttributes(
                attribute.String("rate_limit.client_ip", c.ClientIP()),
            )
            
            c.JSON(429, gin.H{
                "error": "Too Many Requests",
            })
            c.Abort()
            return
        }
        
        c.Next()
    }
}

// setupRoutes 设置路由
func (app *GinApp) setupRoutes() {
    // 健康检查
    app.engine.GET("/healthz", app.handleHealth)
    app.engine.GET("/readyz", app.handleReadiness)
    
    // API v1
    v1 := app.engine.Group("/api/v1")
    {
        // 用户相关
        users := v1.Group("/users")
        {
            users.GET("", app.listUsers)
            users.GET("/:id", app.getUser)
            users.POST("", app.createUser)
            users.PUT("/:id", app.updateUser)
            users.DELETE("/:id", app.deleteUser)
        }
        
        // 订单相关
        orders := v1.Group("/orders")
        {
            orders.GET("", app.listOrders)
            orders.GET("/:id", app.getOrder)
            orders.POST("", app.createOrder)
        }
    }
}

// Handler示例

// listUsers 列出用户
func (app *GinApp) listUsers(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 创建子span
    ctx, span := app.tracer.Start(ctx, "list-users")
    defer span.End()
    
    // 获取查询参数
    page := c.DefaultQuery("page", "1")
    limit := c.DefaultQuery("limit", "10")
    
    span.SetAttributes(
        attribute.String("query.page", page),
        attribute.String("query.limit", limit),
    )
    
    // 调用服务层
    users, err := app.userService.List(ctx, page, limit)
    if err != nil {
        span.RecordError(err)
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    span.SetAttributes(
        attribute.Int("users.count", len(users)),
    )
    
    c.JSON(200, gin.H{
        "data": users,
    })
}

// createUser 创建用户
func (app *GinApp) createUser(c *gin.Context) {
    ctx := c.Request.Context()
    
    ctx, span := app.tracer.Start(ctx, "create-user")
    defer span.End()
    
    var req CreateUserRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        span.RecordError(err)
        c.JSON(400, gin.H{"error": "Invalid request"})
        return
    }
    
    span.SetAttributes(
        attribute.String("user.email", req.Email),
    )
    
    // 验证
    if err := req.Validate(); err != nil {
        span.RecordError(err)
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }
    
    // 创建用户
    user, err := app.userService.Create(ctx, &req)
    if err != nil {
        span.RecordError(err)
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    span.SetAttributes(
        attribute.String("user.id", user.ID),
    )
    
    c.JSON(201, gin.H{
        "data": user,
    })
}

// Run 运行应用
func (app *GinApp) Run(addr string) error {
    return app.engine.Run(addr)
}
```

---

## Echo Framework

### 2. Echo 完整集成

```go
package echo

import (
    "github.com/labstack/echo/v4"
    "github.com/labstack/echo/v4/middleware"
    "go.opentelemetry.io/contrib/instrumentation/github.com/labstack/echo/otelecho"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/codes"
    "go.opentelemetry.io/otel/trace"
)

// EchoApp Echo应用
type EchoApp struct {
    echo   *echo.Echo
    tracer trace.Tracer
}

// NewEchoApp 创建Echo应用
func NewEchoApp(serviceName string) *EchoApp {
    e := echo.New()
    
    app := &EchoApp{
        echo:   e,
        tracer: otel.Tracer(serviceName),
    }
    
    // 隐藏banner
    e.HideBanner = true
    e.HidePort = true
    
    // 设置中间件
    app.setupMiddlewares(serviceName)
    
    // 设置路由
    app.setupRoutes()
    
    return app
}

// setupMiddlewares 设置中间件
func (app *EchoApp) setupMiddlewares(serviceName string) {
    // 1. Recovery
    app.echo.Use(middleware.RecoverWithConfig(middleware.RecoverConfig{
        DisableStackAll: false,
        DisablePrintStack: false,
    }))
    
    // 2. OpenTelemetry
    app.echo.Use(otelecho.Middleware(serviceName))
    
    // 3. 自定义追踪
    app.echo.Use(app.tracingMiddleware())
    
    // 4. Logger
    app.echo.Use(middleware.LoggerWithConfig(middleware.LoggerConfig{
        Format: `{"time":"${time_rfc3339}","method":"${method}","uri":"${uri}",` +
            `"status":${status},"latency_ms":${latency_ms},"trace_id":"${header:traceparent}"}` + "\n",
    }))
    
    // 5. CORS
    app.echo.Use(middleware.CORSWithConfig(middleware.CORSConfig{
        AllowOrigins: []string{"*"},
        AllowMethods: []string{echo.GET, echo.POST, echo.PUT, echo.DELETE},
        AllowHeaders: []string{"Content-Type", "Authorization", "traceparent", "tracestate"},
    }))
    
    // 6. Rate Limit
    app.echo.Use(middleware.RateLimiterWithConfig(middleware.RateLimiterConfig{
        Store: middleware.NewRateLimiterMemoryStore(100),
    }))
}

// tracingMiddleware 追踪中间件
func (app *EchoApp) tracingMiddleware() echo.MiddlewareFunc {
    return func(next echo.HandlerFunc) echo.HandlerFunc {
        return func(c echo.Context) error {
            req := c.Request()
            span := trace.SpanFromContext(req.Context())
            
            // 添加自定义属性
            span.SetAttributes(
                attribute.String("echo.route", c.Path()),
                attribute.String("echo.real_ip", c.RealIP()),
            )
            
            // 处理请求
            err := next(c)
            
            // 记录响应状态
            if err != nil {
                span.RecordError(err)
                span.SetStatus(codes.Error, err.Error())
                
                // Echo错误处理
                if he, ok := err.(*echo.HTTPError); ok {
                    span.SetAttributes(
                        attribute.Int("http.status_code", he.Code),
                    )
                }
                
                return err
            }
            
            span.SetStatus(codes.Ok, "")
            return nil
        }
    }
}

// setupRoutes 设置路由
func (app *EchoApp) setupRoutes() {
    // 健康检查
    app.echo.GET("/healthz", app.handleHealth)
    
    // API组
    api := app.echo.Group("/api/v1")
    
    // 用户路由
    api.GET("/users", app.listUsers)
    api.GET("/users/:id", app.getUser)
    api.POST("/users", app.createUser)
    api.PUT("/users/:id", app.updateUser)
    api.DELETE("/users/:id", app.deleteUser)
}

// Handler示例
func (app *EchoApp) listUsers(c echo.Context) error {
    ctx := c.Request().Context()
    
    ctx, span := app.tracer.Start(ctx, "list-users")
    defer span.End()
    
    // 业务逻辑
    users := []User{} // 从数据库获取
    
    span.SetAttributes(
        attribute.Int("users.count", len(users)),
    )
    
    return c.JSON(200, users)
}

// Start 启动服务
func (app *EchoApp) Start(addr string) error {
    return app.echo.Start(addr)
}
```

---

## Fiber Framework

### 3. Fiber 完整集成

```go
package fiber

import (
    "github.com/gofiber/fiber/v2"
    "github.com/gofiber/fiber/v2/middleware/cors"
    "github.com/gofiber/fiber/v2/middleware/logger"
    "github.com/gofiber/fiber/v2/middleware/recover"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/trace"
)

// FiberApp Fiber应用
type FiberApp struct {
    app    *fiber.App
    tracer trace.Tracer
}

// NewFiberApp 创建Fiber应用
func NewFiberApp(serviceName string) *FiberApp {
    app := fiber.New(fiber.Config{
        AppName:      serviceName,
        ServerHeader: serviceName,
        ErrorHandler: customErrorHandler,
    })
    
    fiberApp := &FiberApp{
        app:    app,
        tracer: otel.Tracer(serviceName),
    }
    
    // 设置中间件
    fiberApp.setupMiddlewares()
    
    // 设置路由
    fiberApp.setupRoutes()
    
    return fiberApp
}

// setupMiddlewares 设置中间件
func (app *FiberApp) setupMiddlewares() {
    // 1. Recovery
    app.app.Use(recover.New())
    
    // 2. Logger
    app.app.Use(logger.New(logger.Config{
        Format: "[${time}] ${status} - ${latency} ${method} ${path}\n",
    }))
    
    // 3. CORS
    app.app.Use(cors.New(cors.Config{
        AllowOrigins: "*",
        AllowHeaders: "Content-Type, Authorization, traceparent, tracestate",
    }))
    
    // 4. OpenTelemetry追踪
    app.app.Use(app.tracingMiddleware())
}

// tracingMiddleware OpenTelemetry追踪中间件
func (app *FiberApp) tracingMiddleware() fiber.Handler {
    propagator := otel.GetTextMapPropagator()
    
    return func(c *fiber.Ctx) error {
        // 提取trace context
        ctx := propagator.Extract(c.Context(), &fiberCarrier{c: c})
        
        // 创建span
        spanName := c.Method() + " " + c.Route().Path
        ctx, span := app.tracer.Start(ctx, spanName,
            trace.WithSpanKind(trace.SpanKindServer),
            trace.WithAttributes(
                attribute.String("http.method", c.Method()),
                attribute.String("http.url", c.OriginalURL()),
                attribute.String("http.route", c.Route().Path),
                attribute.String("http.client_ip", c.IP()),
                attribute.String("http.user_agent", c.Get("User-Agent")),
            ),
        )
        defer span.End()
        
        // 将context存储到fiber.Ctx
        c.SetUserContext(ctx)
        
        // 注入trace context到响应头
        propagator.Inject(ctx, &fiberCarrier{c: c})
        
        // 处理请求
        err := c.Next()
        
        // 记录响应信息
        span.SetAttributes(
            attribute.Int("http.status_code", c.Response().StatusCode()),
        )
        
        if err != nil {
            span.RecordError(err)
            span.SetStatus(codes.Error, err.Error())
            return err
        }
        
        span.SetStatus(codes.Ok, "")
        return nil
    }
}

// fiberCarrier Fiber trace context carrier
type fiberCarrier struct {
    c *fiber.Ctx
}

func (fc *fiberCarrier) Get(key string) string {
    return fc.c.Get(key)
}

func (fc *fiberCarrier) Set(key, value string) {
    fc.c.Set(key, value)
}

func (fc *fiberCarrier) Keys() []string {
    keys := make([]string, 0)
    fc.c.Request().Header.VisitAll(func(key, value []byte) {
        keys = append(keys, string(key))
    })
    return keys
}

// setupRoutes 设置路由
func (app *FiberApp) setupRoutes() {
    // 健康检查
    app.app.Get("/healthz", app.handleHealth)
    
    // API路由
    api := app.app.Group("/api/v1")
    
    // 用户路由
    users := api.Group("/users")
    users.Get("/", app.listUsers)
    users.Get("/:id", app.getUser)
    users.Post("/", app.createUser)
    users.Put("/:id", app.updateUser)
    users.Delete("/:id", app.deleteUser)
}

// Handler示例
func (app *FiberApp) listUsers(c *fiber.Ctx) error {
    ctx := c.UserContext()
    
    ctx, span := app.tracer.Start(ctx, "list-users")
    defer span.End()
    
    // 业务逻辑
    users := []User{} // 从数据库获取
    
    span.SetAttributes(
        attribute.Int("users.count", len(users)),
    )
    
    return c.JSON(users)
}

// Listen 启动服务
func (app *FiberApp) Listen(addr string) error {
    return app.app.Listen(addr)
}

// 自定义错误处理
func customErrorHandler(c *fiber.Ctx, err error) error {
    code := fiber.StatusInternalServerError
    
    if e, ok := err.(*fiber.Error); ok {
        code = e.Code
    }
    
    return c.Status(code).JSON(fiber.Map{
        "error": err.Error(),
    })
}
```

---

## Chi Router

### 4. Chi Router 集成

```go
package chi

import (
    "net/http"
    
    "github.com/go-chi/chi/v5"
    "github.com/go-chi/chi/v5/middleware"
    "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/trace"
)

// ChiApp Chi应用
type ChiApp struct {
    router *chi.Mux
    tracer trace.Tracer
}

// NewChiApp 创建Chi应用
func NewChiApp(serviceName string) *ChiApp {
    r := chi.NewRouter()
    
    app := &ChiApp{
        router: r,
        tracer: otel.Tracer(serviceName),
    }
    
    // 设置中间件
    app.setupMiddlewares(serviceName)
    
    // 设置路由
    app.setupRoutes()
    
    return app
}

// setupMiddlewares 设置中间件
func (app *ChiApp) setupMiddlewares(serviceName string) {
    // 1. Recovery
    app.router.Use(middleware.Recoverer)
    
    // 2. Logger
    app.router.Use(middleware.Logger)
    
    // 3. Request ID
    app.router.Use(middleware.RequestID)
    
    // 4. Real IP
    app.router.Use(middleware.RealIP)
    
    // 5. OpenTelemetry
    app.router.Use(func(next http.Handler) http.Handler {
        return otelhttp.NewHandler(next, serviceName)
    })
}

// setupRoutes 设置路由
func (app *ChiApp) setupRoutes() {
    app.router.Get("/healthz", app.handleHealth)
    
    app.router.Route("/api/v1", func(r chi.Router) {
        r.Route("/users", func(r chi.Router) {
            r.Get("/", app.listUsers)
            r.Post("/", app.createUser)
            
            r.Route("/{id}", func(r chi.Router) {
                r.Get("/", app.getUser)
                r.Put("/", app.updateUser)
                r.Delete("/", app.deleteUser)
            })
        })
    })
}

// ServeHTTP 实现http.Handler接口
func (app *ChiApp) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    app.router.ServeHTTP(w, r)
}
```

---

## 总结

本文档提供了 Go 主流 Web 框架与 OpenTelemetry OTLP 的完整集成方案，包括：

1. ✅ **Gin** - 最流行的Go Web框架
2. ✅ **Echo** - 高性能极简框架
3. ✅ **Fiber** - Express风格的快速框架
4. ✅ **Chi** - 轻量级路由器
5. ✅ **中间件** - 完整的中间件栈
6. ✅ **错误处理** - 统一的错误处理模式

### 相关文档

- [Go_SDK深度实践](./05_Go_SDK深度实践与中间件集成.md)
- [生产级部署](./07_Go生产级部署与运维最佳实践.md)
