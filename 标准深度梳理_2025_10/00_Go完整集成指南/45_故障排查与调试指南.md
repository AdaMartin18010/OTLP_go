# 45. æ•…éšœæ’æŸ¥ä¸è°ƒè¯•æŒ‡å—

## ğŸ“š ç›®å½•

- [1. å¸¸è§é—®é¢˜æ’æŸ¥](#1-å¸¸è§é—®é¢˜æ’æŸ¥)
- [2. Trace é—®é¢˜è¯Šæ–­](#2-trace-é—®é¢˜è¯Šæ–­)
- [3. Metrics é—®é¢˜è¯Šæ–­](#3-metrics-é—®é¢˜è¯Šæ–­)
- [4. æ€§èƒ½é—®é¢˜å®šä½](#4-æ€§èƒ½é—®é¢˜å®šä½)
- [5. æ•°æ®åº“é—®é¢˜](#5-æ•°æ®åº“é—®é¢˜)
- [6. åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜](#6-åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜)
- [7. è°ƒè¯•å·¥å…·](#7-è°ƒè¯•å·¥å…·)
- [8. æ€»ç»“](#8-æ€»ç»“)

---

## 1. å¸¸è§é—®é¢˜æ’æŸ¥

### 1.1 Trace æ•°æ®ä¸¢å¤±

**ç—‡çŠ¶**: Jaeger ä¸­çœ‹ä¸åˆ°æŸäº›æœåŠ¡çš„ Trace æ•°æ®

**å¯èƒ½åŸå› **:
1. OTLP Collector æœªæ­£ç¡®é…ç½®
2. é‡‡æ ·ç‡è®¾ç½®è¿‡ä½
3. ç½‘ç»œè¿æ¥é—®é¢˜
4. å¯¼å‡ºå™¨é…ç½®é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æ£€æŸ¥ OTLP Collector çŠ¶æ€
curl http://localhost:13133/

# 2. æ£€æŸ¥åº”ç”¨æ—¥å¿—
docker logs api-gateway | grep -i "otel\|trace"

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
telnet localhost 4317

# 4. éªŒè¯é‡‡æ ·é…ç½®
```

**è§£å†³æ–¹æ¡ˆ**:

```go
// ç¡®ä¿é‡‡æ ·ç‡é…ç½®æ­£ç¡®
tp := sdktrace.NewTracerProvider(
    sdktrace.WithBatcher(exporter),
    sdktrace.WithSampler(sdktrace.AlwaysSample()), // å¼€å‘ç¯å¢ƒä½¿ç”¨
    // sdktrace.WithSampler(sdktrace.TraceIDRatioBased(0.1)), // ç”Ÿäº§ç¯å¢ƒ
)
```

### 1.2 Context æœªä¼ æ’­

**ç—‡çŠ¶**: Span ä¹‹é—´æ²¡æœ‰çˆ¶å­å…³ç³»

**åŸå› **: Context æœªæ­£ç¡®ä¼ é€’

**é”™è¯¯ç¤ºä¾‹**:

```go
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ä¼ é€’ Context
func processRequest(req Request) error {
    ctx := context.Background() // åˆ›å»ºæ–°çš„ Context
    span := tracer.Start(ctx, "process") // ä¸¢å¤±äº†çˆ¶ Span
    defer span.End()
    
    return doWork(ctx)
}
```

**æ­£ç¡®ç¤ºä¾‹**:

```go
// âœ… æ­£ç¡®ï¼šä¼ é€’ Context
func processRequest(ctx context.Context, req Request) error {
    ctx, span := tracer.Start(ctx, "process") // ç»§æ‰¿çˆ¶ Span
    defer span.End()
    
    return doWork(ctx)
}
```

### 1.3 Goroutine æ³„æ¼

**ç—‡çŠ¶**: å†…å­˜æŒç»­å¢é•¿ï¼Œgoroutine æ•°é‡ä¸æ–­ä¸Šå‡

**æ’æŸ¥å·¥å…·**:

```go
package main

import (
    "net/http"
    _ "net/http/pprof"
    "runtime"
)

func monitorGoroutines() {
    go func() {
        ticker := time.NewTicker(10 * time.Second)
        for range ticker.C {
            count := runtime.NumGoroutine()
            log.Printf("Current goroutines: %d", count)
            
            if count > 10000 {
                log.Printf("WARNING: High goroutine count detected!")
            }
        }
    }()
    
    // å¯åŠ¨ pprof
    go http.ListenAndServe("localhost:6060", nil)
}
```

**æ’æŸ¥å‘½ä»¤**:

```bash
# æŸ¥çœ‹ goroutine æ ˆ
curl http://localhost:6060/debug/pprof/goroutine?debug=2

# ç”Ÿæˆ goroutine profile
go tool pprof http://localhost:6060/debug/pprof/goroutine

# åˆ†æ goroutine
top 20
list <function_name>
```

**å¸¸è§åŸå› **:

```go
// âŒ æ²¡æœ‰æ­£ç¡®å…³é—­ Channel
func leakyFunction() {
    ch := make(chan int)
    go func() {
        for v := range ch { // å¦‚æœ ch æ°¸è¿œä¸å…³é—­ï¼Œgoroutine ä¼šä¸€ç›´ç­‰å¾…
            process(v)
        }
    }()
}

// âœ… æ­£ç¡®å…³é—­ Channel
func correctFunction(ctx context.Context) {
    ch := make(chan int)
    go func() {
        defer close(ch)
        for {
            select {
            case <-ctx.Done():
                return
            case v := <-source:
                ch <- v
            }
        }
    }()
}
```

---

## 2. Trace é—®é¢˜è¯Šæ–­

### 2.1 Span å±æ€§ç¼ºå¤±

**é—®é¢˜**: Span ä¸­ç¼ºå°‘å…³é”®å±æ€§

**æ£€æŸ¥æ¸…å•**:

```go
// ç¡®ä¿è®¾ç½®å…³é”®å±æ€§
span.SetAttributes(
    attribute.String("service.name", "my-service"),
    attribute.String("service.version", "1.0.0"),
    attribute.String("deployment.environment", "production"),
    
    // ä¸šåŠ¡å±æ€§
    attribute.String("user.id", userID),
    attribute.String("order.id", orderID),
    attribute.Int64("order.amount", amount),
)
```

### 2.2 Trace é“¾è·¯æ–­è£‚

**ç—‡çŠ¶**: è·¨æœåŠ¡è°ƒç”¨æ—¶ Trace é“¾è·¯ä¸­æ–­

**åŸå› **: HTTP/gRPC è°ƒç”¨æ—¶æœªä¼ æ’­ Context

**HTTP Client æ­£ç¡®ç¤ºä¾‹**:

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ otelhttp.Transport
client := &http.Client{
    Transport: otelhttp.NewTransport(http.DefaultTransport),
}

req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
resp, err := client.Do(req)
```

**gRPC Client æ­£ç¡®ç¤ºä¾‹**:

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ otelgrpc
conn, err := grpc.Dial(target,
    grpc.WithStatsHandler(otelgrpc.NewClientHandler()),
)
```

### 2.3 Span æ—¶é—´å¼‚å¸¸

**é—®é¢˜**: Span æŒç»­æ—¶é—´å¼‚å¸¸é•¿æˆ–å¼‚å¸¸çŸ­

**æ’æŸ¥**:

```go
// æ·»åŠ  Event æ ‡è®°å…³é”®æ—¶é—´ç‚¹
span.AddEvent("validation_start")
// ... validation logic
span.AddEvent("validation_end")

span.AddEvent("db_query_start")
// ... database query
span.AddEvent("db_query_end")

// åœ¨ Jaeger UI ä¸­æŸ¥çœ‹ Events æ—¶é—´çº¿
```

---

## 3. Metrics é—®é¢˜è¯Šæ–­

### 3.1 Metrics æœªä¸ŠæŠ¥

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æ£€æŸ¥ Prometheus targets
curl http://localhost:9090/api/v1/targets

# 2. æ£€æŸ¥åº”ç”¨ metrics ç«¯ç‚¹
curl http://localhost:9090/metrics

# 3. æŸ¥è¯¢ç‰¹å®š metric
curl 'http://localhost:9090/api/v1/query?query=http_server_requests_total'
```

### 3.2 Metric å€¼å¼‚å¸¸

**é—®é¢˜**: Counter å‡å°‘æˆ– Gauge å€¼ä¸åˆç†

**æ£€æŸ¥**:

```go
// âŒ é”™è¯¯ï¼šCounter ä½¿ç”¨äº† Add(-1)
counter.Add(ctx, -1) // Counter ä¸åº”è¯¥å‡å°‘

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸¤ä¸ª Counter
activeRequests.Add(ctx, 1)  // è¯·æ±‚å¼€å§‹
completedRequests.Add(ctx, 1) // è¯·æ±‚å®Œæˆ

// æˆ–ä½¿ç”¨ UpDownCounter
activeConnections := meter.Int64UpDownCounter("active_connections")
activeConnections.Add(ctx, 1)  // è¿æ¥å»ºç«‹
activeConnections.Add(ctx, -1) // è¿æ¥å…³é—­
```

### 3.3 Histogram åˆ†å¸ƒå¼‚å¸¸

**é—®é¢˜**: P95/P99 å»¶è¿Ÿå¼‚å¸¸é«˜

**åˆ†æ**:

```promql
# æŸ¥çœ‹å»¶è¿Ÿåˆ†å¸ƒ
histogram_quantile(0.50, rate(http_server_duration_bucket[5m]))
histogram_quantile(0.95, rate(http_server_duration_bucket[5m]))
histogram_quantile(0.99, rate(http_server_duration_bucket[5m]))

# æŒ‰ç«¯ç‚¹åˆ†ç»„
histogram_quantile(0.95, 
    sum(rate(http_server_duration_bucket[5m])) by (le, endpoint)
)
```

---

## 4. æ€§èƒ½é—®é¢˜å®šä½

### 4.1 CPU ä½¿ç”¨ç‡é«˜

**æ’æŸ¥**:

```bash
# 1. ç”Ÿæˆ CPU profile
curl http://localhost:6060/debug/pprof/profile?seconds=30 > cpu.prof

# 2. åˆ†æ profile
go tool pprof cpu.prof
(pprof) top 20
(pprof) list <function_name>
(pprof) web  # ç”Ÿæˆå¯è§†åŒ–å›¾

# 3. æŸ¥çœ‹ç«ç„°å›¾
go tool pprof -http=:8080 cpu.prof
```

**å¸¸è§åŸå› **:

```go
// âŒ é¢‘ç¹çš„å­—ç¬¦ä¸²æ‹¼æ¥
func buildMessage(items []string) string {
    result := ""
    for _, item := range items {
        result += item + ", " // æ¯æ¬¡åˆ›å»ºæ–°å­—ç¬¦ä¸²
    }
    return result
}

// âœ… ä½¿ç”¨ strings.Builder
func buildMessage(items []string) string {
    var builder strings.Builder
    builder.Grow(len(items) * 10) // é¢„åˆ†é…
    for i, item := range items {
        if i > 0 {
            builder.WriteString(", ")
        }
        builder.WriteString(item)
    }
    return builder.String()
}
```

### 4.2 å†…å­˜æ³„æ¼

**æ’æŸ¥**:

```bash
# 1. ç”Ÿæˆ heap profile
curl http://localhost:6060/debug/pprof/heap > heap.prof

# 2. åˆ†æå†…å­˜åˆ†é…
go tool pprof -alloc_space heap.prof
(pprof) top 20
(pprof) list <function_name>

# 3. æŸ¥çœ‹å†…å­˜ä½¿ç”¨
go tool pprof -inuse_space heap.prof
```

**å¸¸è§åŸå› **:

```go
// âŒ æœªå…³é—­èµ„æº
func processFile(filename string) error {
    file, _ := os.Open(filename)
    // å¿˜è®° defer file.Close()
    
    data, _ := ioutil.ReadAll(file)
    process(data)
    return nil
}

// âœ… æ­£ç¡®å…³é—­èµ„æº
func processFile(filename string) error {
    file, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer file.Close()
    
    data, err := ioutil.ReadAll(file)
    if err != nil {
        return err
    }
    
    return process(data)
}
```

### 4.3 GC æš‚åœæ—¶é—´é•¿

**æ’æŸ¥**:

```bash
# å¼€å¯ GC trace
GODEBUG=gctrace=1 ./your-app

# è¾“å‡ºç¤ºä¾‹ï¼š
# gc 1 @0.003s 0%: 0.018+1.2+0.003 ms clock, 0.037+0.27/1.1/2.3+0.006 ms cpu
```

**ä¼˜åŒ–**:

```go
// è°ƒæ•´ GC å‚æ•°
import "runtime/debug"

// é™ä½ GC é¢‘ç‡ï¼ˆå¢åŠ å†…å­˜ä½¿ç”¨ï¼‰
debug.SetGCPercent(200) // é»˜è®¤ 100

// è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆGo 1.19+ï¼‰
debug.SetMemoryLimit(8 * 1024 * 1024 * 1024) // 8GB
```

---

## 5. æ•°æ®åº“é—®é¢˜

### 5.1 æ…¢æŸ¥è¯¢

**æ’æŸ¥**:

```go
// æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—
db.Logger = logger.New(
    log.New(os.Stdout, "\r\n", log.LstdFlags),
    logger.Config{
        SlowThreshold: 200 * time.Millisecond,
        LogLevel:      logger.Warn,
        Colorful:      true,
    },
)

// ä½¿ç”¨ OTLP è¿½è¸ªæ…¢æŸ¥è¯¢
func (s *Service) QueryWithTracing(ctx context.Context, query string) error {
    ctx, span := s.tracer.Start(ctx, "db.query",
        trace.WithAttributes(
            attribute.String("db.statement", query),
        ),
    )
    defer span.End()
    
    start := time.Now()
    err := s.db.WithContext(ctx).Raw(query).Error
    duration := time.Since(start)
    
    if duration > 200*time.Millisecond {
        span.SetAttributes(attribute.Bool("db.slow_query", true))
    }
    
    return err
}
```

### 5.2 è¿æ¥æ± è€—å°½

**ç—‡çŠ¶**: `Error: too many connections` æˆ–è¿æ¥è¶…æ—¶

**æ’æŸ¥**:

```go
// ç›‘æ§è¿æ¥æ± 
stats := db.Stats()
log.Printf("OpenConnections: %d", stats.OpenConnections)
log.Printf("InUse: %d", stats.InUse)
log.Printf("Idle: %d", stats.Idle)
log.Printf("WaitCount: %d", stats.WaitCount)
log.Printf("WaitDuration: %v", stats.WaitDuration)

// é…ç½®è¿æ¥æ± 
db.SetMaxOpenConns(25)
db.SetMaxIdleConns(5)
db.SetConnMaxLifetime(5 * time.Minute)
db.SetConnMaxIdleTime(1 * time.Minute)
```

### 5.3 æ­»é”

**æ’æŸ¥**:

```sql
-- PostgreSQL æŸ¥çœ‹é”ç­‰å¾…
SELECT 
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks 
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

## 6. åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

### 6.1 Saga å›æ»šå¤±è´¥

**é—®é¢˜**: è¡¥å¿æ“ä½œå¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**æ’æŸ¥**:

```go
// æ·»åŠ è¯¦ç»†çš„å›æ»šæ—¥å¿—
func (s *OrderSaga) rollback(ctx context.Context) {
    ctx, span := s.tracer.Start(ctx, "saga.rollback")
    defer span.End()
    
    span.AddEvent("starting rollback")
    
    var rollbackErrors []error
    
    // è®°å½•æ¯ä¸€æ­¥å›æ»š
    if s.paymentProcessed {
        span.AddEvent("attempting payment refund")
        if err := s.refundPayment(ctx); err != nil {
            span.RecordError(err)
            rollbackErrors = append(rollbackErrors, fmt.Errorf("refund failed: %w", err))
            // å‘é€å‘Šè­¦
            alerting.SendAlert("saga_rollback_failed", map[string]string{
                "order_id": s.orderID.String(),
                "step": "payment_refund",
                "error": err.Error(),
            })
        }
    }
    
    // ... å…¶ä»–å›æ»šæ­¥éª¤
    
    if len(rollbackErrors) > 0 {
        span.SetStatus(codes.Error, "rollback partially failed")
        // è®°å½•åˆ°è¡¥å¿é˜Ÿåˆ—ï¼Œç¨åé‡è¯•
        s.enqueueCompensation(ctx, rollbackErrors)
    }
}
```

### 6.2 2PC è¶…æ—¶

**é—®é¢˜**: Prepare é˜¶æ®µè¶…æ—¶å¯¼è‡´äº‹åŠ¡å¤±è´¥

**æ’æŸ¥**:

```go
// æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œç›‘æ§
func (tpc *TwoPhaseCommit) prepare(ctx context.Context) error {
    // è®¾ç½® Prepare è¶…æ—¶
    ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
    defer cancel()
    
    ctx, span := tpc.tracer.Start(ctx, "twopc.prepare")
    defer span.End()
    
    start := time.Now()
    defer func() {
        duration := time.Since(start)
        tpc.prepareDuration.Record(ctx, float64(duration.Milliseconds()))
        
        if duration > 5*time.Second {
            span.SetAttributes(attribute.Bool("slow_prepare", true))
            log.Printf("WARN: Slow prepare detected: %v", duration)
        }
    }()
    
    // ... prepare logic
}
```

---

## 7. è°ƒè¯•å·¥å…·

### 7.1 Jaeger UI ä½¿ç”¨æŠ€å·§

```bash
# 1. æŒ‰æœåŠ¡æŸ¥æ‰¾
Service: api-gateway
Operation: POST /api/orders

# 2. æŒ‰ TraceID æŸ¥æ‰¾
TraceID: 1234567890abcdef

# 3. æŒ‰æ ‡ç­¾è¿‡æ»¤
Tags: error=true
Tags: http.status_code=500

# 4. æŒ‰æŒç»­æ—¶é—´è¿‡æ»¤
Duration: > 1s
```

### 7.2 Prometheus æŸ¥è¯¢ç¤ºä¾‹

```promql
# é”™è¯¯ç‡
rate(http_server_requests_total{status=~"5.."}[5m]) / 
rate(http_server_requests_total[5m])

# å»¶è¿Ÿ P95
histogram_quantile(0.95, 
    rate(http_server_duration_bucket[5m])
)

# QPS
sum(rate(http_server_requests_total[1m])) by (service)

# æ•°æ®åº“è¿æ¥æ•°
sum(db_connections_active) by (service)
```

### 7.3 æ—¥å¿—åˆ†æ

```bash
# æŸ¥æ‰¾é”™è¯¯æ—¥å¿—
docker logs api-gateway 2>&1 | grep -i "error\|fatal"

# æŒ‰ TraceID å…³è”æ—¥å¿—
docker logs api-gateway 2>&1 | grep "trace_id=1234567890abcdef"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
docker logs api-gateway 2>&1 | \
    grep -i "error" | \
    awk '{print $NF}' | \
    sort | uniq -c | sort -rn
```

---

## 8. æ€»ç»“

### æ’æŸ¥æµç¨‹

1. **ç¡®è®¤é—®é¢˜**: æ”¶é›†é”™è¯¯ä¿¡æ¯ã€æ—¥å¿—ã€ç›‘æ§æ•°æ®
2. **å®šä½æœåŠ¡**: é€šè¿‡ Trace æ‰¾åˆ°é—®é¢˜æœåŠ¡
3. **åˆ†æåŸå› **: æŸ¥çœ‹ Span å±æ€§ã€Eventsã€æ—¥å¿—
4. **éªŒè¯ä¿®å¤**: ä½¿ç”¨ Metrics ç¡®è®¤é—®é¢˜è§£å†³

### æœ€ä½³å®è·µ

âœ… **é¢„é˜²æ€§ç›‘æ§**
- è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
- å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢å’Œæ…¢ API
- ç›‘æ§èµ„æºä½¿ç”¨è¶‹åŠ¿

âœ… **å¯è§‚æµ‹æ€§**
- å®Œæ•´çš„ Traceã€Metricã€Log
- å…³é”®æ“ä½œæ·»åŠ  Span Event
- é”™è¯¯ä¿¡æ¯åŒ…å« TraceID

âœ… **è‡ªåŠ¨åŒ–**
- è‡ªåŠ¨åŒ–å¥åº·æ£€æŸ¥
- è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•
- è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤

### ç›¸å…³æ–‡æ¡£

- [35_Goç”Ÿäº§çº§éƒ¨ç½²æ¨¡å¼ä¸åæ¨¡å¼](./35_Goç”Ÿäº§çº§éƒ¨ç½²æ¨¡å¼ä¸åæ¨¡å¼.md)
- [34_Goå†…å­˜ç®¡ç†ä¸æ€§èƒ½è°ƒä¼˜å®æˆ˜](./34_Goå†…å­˜ç®¡ç†ä¸æ€§èƒ½è°ƒä¼˜å®æˆ˜.md)
- [41_å®æˆ˜æ¡ˆä¾‹_API Gatewayä¸æœåŠ¡é›†æˆ](./41_å®æˆ˜æ¡ˆä¾‹_API Gatewayä¸æœåŠ¡é›†æˆ.md)

