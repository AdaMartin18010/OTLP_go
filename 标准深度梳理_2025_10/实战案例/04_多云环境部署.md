# å®æˆ˜æ¡ˆä¾‹ï¼šå¤šäº‘ç¯å¢ƒ OpenTelemetry éƒ¨ç½²å®Œæ•´æŒ‡å—

> **åœºæ™¯**: AWS + GCP + Azure å¤šäº‘ç¯å¢ƒç»Ÿä¸€å¯è§‚æµ‹æ€§  
> **æŠ€æœ¯æ ˆ**: Go 1.25.1, Kubernetes, Terraform, OpenTelemetry Collector  
> **ç‰¹æ€§**: è·¨äº‘è¿½è¸ªã€ç»Ÿä¸€ç›‘æ§ã€æˆæœ¬ä¼˜åŒ–ã€ç¾å¤‡åˆ‡æ¢  
> **OpenTelemetry**: v1.32.0+  
> **éš¾åº¦**: â­â­â­â­â­ (ç”Ÿäº§çº§ + å¤šäº‘æ¶æ„)

---

## ğŸ“‹ ç›®å½•

- [å®æˆ˜æ¡ˆä¾‹ï¼šå¤šäº‘ç¯å¢ƒ OpenTelemetry éƒ¨ç½²å®Œæ•´æŒ‡å—](#å®æˆ˜æ¡ˆä¾‹å¤šäº‘ç¯å¢ƒ-opentelemetry-éƒ¨ç½²å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
    - [ä¸šåŠ¡åœºæ™¯](#ä¸šåŠ¡åœºæ™¯)
    - [ç³»ç»Ÿæ‹“æ‰‘](#ç³»ç»Ÿæ‹“æ‰‘)
    - [å…³é”®æŒ‘æˆ˜](#å…³é”®æŒ‘æˆ˜)
  - [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
    - [ä¸‰å±‚æ¶æ„](#ä¸‰å±‚æ¶æ„)
    - [æ•°æ®æµ](#æ•°æ®æµ)
  - [å„äº‘å¹³å°é›†æˆ](#å„äº‘å¹³å°é›†æˆ)
    - [1. AWS (EKS) é›†æˆ](#1-aws-eks-é›†æˆ)
      - [Kubernetes éƒ¨ç½²](#kubernetes-éƒ¨ç½²)
      - [Collector é…ç½® (AWS)](#collector-é…ç½®-aws)
    - [2. GCP (GKE) é›†æˆ](#2-gcp-gke-é›†æˆ)
      - [Collector é…ç½® (GCP)](#collector-é…ç½®-gcp)
    - [3. Azure (AKS) é›†æˆ](#3-azure-aks-é›†æˆ)
      - [Collector é…ç½® (Azure)](#collector-é…ç½®-azure)
  - [ç»Ÿä¸€é‡‡é›†é…ç½®](#ç»Ÿä¸€é‡‡é›†é…ç½®)
    - [ä¸­å¿ƒ Collector é…ç½®](#ä¸­å¿ƒ-collector-é…ç½®)
  - [è·¨äº‘è¿½è¸ªå®ç°](#è·¨äº‘è¿½è¸ªå®ç°)
    - [Go åº”ç”¨é…ç½®](#go-åº”ç”¨é…ç½®)
    - [è·¨äº‘æœåŠ¡è°ƒç”¨ç¤ºä¾‹](#è·¨äº‘æœåŠ¡è°ƒç”¨ç¤ºä¾‹)
    - [è·¨äº‘ HTTP å®¢æˆ·ç«¯](#è·¨äº‘-http-å®¢æˆ·ç«¯)
  - [æˆæœ¬ä¼˜åŒ–](#æˆæœ¬ä¼˜åŒ–)
    - [1. é‡‡æ ·ç­–ç•¥](#1-é‡‡æ ·ç­–ç•¥)
    - [2. æ•°æ®å½’æ¡£](#2-æ•°æ®å½’æ¡£)
    - [3. æˆæœ¬ç›‘æ§](#3-æˆæœ¬ç›‘æ§)
  - [ç¾å¤‡åˆ‡æ¢](#ç¾å¤‡åˆ‡æ¢)
    - [1. åŒä¸­å¿ƒé…ç½®](#1-åŒä¸­å¿ƒé…ç½®)
    - [2. å¥åº·æ£€æŸ¥](#2-å¥åº·æ£€æŸ¥)
  - [Terraform è‡ªåŠ¨åŒ–éƒ¨ç½²](#terraform-è‡ªåŠ¨åŒ–éƒ¨ç½²)
    - [AWS EKS](#aws-eks)
  - [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)
    - [1. åŒºåŸŸå°±è¿‘é‡‡é›†](#1-åŒºåŸŸå°±è¿‘é‡‡é›†)
    - [2. ç»Ÿä¸€èµ„æºå±æ€§](#2-ç»Ÿä¸€èµ„æºå±æ€§)
    - [3. æˆæœ¬ä¼˜åŒ–](#3-æˆæœ¬ä¼˜åŒ–)
    - [4. ç¾å¤‡](#4-ç¾å¤‡)
  - [ğŸ¯ å­¦åˆ°çš„å…³é”®çŸ¥è¯†ç‚¹](#-å­¦åˆ°çš„å…³é”®çŸ¥è¯†ç‚¹)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä¸šåŠ¡åœºæ™¯

å¤šäº‘éƒ¨ç½²çš„å…¸å‹åœºæ™¯ï¼š

- ğŸŒ **åœ°ç†åˆ†å¸ƒ**: ä¸åŒåŒºåŸŸä½¿ç”¨ä¸åŒäº‘æœåŠ¡å•†
- ğŸ’° **æˆæœ¬ä¼˜åŒ–**: åˆ©ç”¨ä¸åŒäº‘å•†çš„ä»·æ ¼ä¼˜åŠ¿
- ğŸ”’ **ä¾›åº”å•†é”å®šè§„é¿**: é¿å…å•ä¸€äº‘å•†ä¾èµ–
- ğŸš€ **ç¾å¤‡**: è·¨äº‘å†—ä½™éƒ¨ç½²

### ç³»ç»Ÿæ‹“æ‰‘

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AWS (US-East) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  - API Gateway (EKS)                       â”‚
â”‚  - Order Service                           â”‚
â”‚  - OTLP Collector (DaemonSet)              â”‚
â”‚  - CloudWatch Logs                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GCP (Europe-West) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  - Product Service (GKE)                   â”‚
â”‚  - Inventory Service                       â”‚
â”‚  - OTLP Collector (DaemonSet)              â”‚
â”‚  - Cloud Logging                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Azure (Asia-East) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  - Payment Service (AKS)                   â”‚
â”‚  - User Service                            â”‚
â”‚  - OTLP Collector (DaemonSet)              â”‚
â”‚  - Azure Monitor                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Central OTLP   â”‚  â”‚   Backup OTLP   â”‚
â”‚   Collector     â”‚  â”‚    Collector    â”‚
â”‚  (AWS EKS)      â”‚  â”‚   (GCP GKE)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Jaeger  â”‚   â”‚Prometheusâ”‚   â”‚  S3     â”‚
â”‚(Tracing)â”‚   â”‚(Metrics) â”‚   â”‚(Archive)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‘æˆ˜

| æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| è·¨äº‘ç½‘ç»œå»¶è¿Ÿ | åŒºåŸŸå°±è¿‘é‡‡é›† + å¼‚æ­¥æ‰¹é‡ä¼ è¾“ |
| æ•°æ®ä¸»æƒ | åŒºåŸŸå†…å¤„ç† + åˆè§„é‡‡é›† |
| ç»Ÿä¸€å¯è§‚æµ‹æ€§ | ä¸­å¿ƒåŒ– Collector + ç»Ÿä¸€åç«¯ |
| äº‘å¹³å°å·®å¼‚ | Resource Detection + æ ‡å‡†åŒ–å±æ€§ |
| æˆæœ¬æ§åˆ¶ | é‡‡æ ·ç­–ç•¥ + æ•°æ®å½’æ¡£ |

---

## æ¶æ„è®¾è®¡

### ä¸‰å±‚æ¶æ„

```text
Layer 1: åº”ç”¨å±‚ (æ¯ä¸ª Pod)
  â”œâ”€ Go Application (OTLP SDK)
  â””â”€ Export â†’ localhost:4317 (Sidecar/DaemonSet)

Layer 2: åŒºåŸŸé‡‡é›†å±‚ (æ¯ä¸ªäº‘/åŒºåŸŸ)
  â”œâ”€ OTLP Collector (DaemonSet/Sidecar)
  â”œâ”€ æœ¬åœ°é¢„å¤„ç† (è¿‡æ»¤ã€é‡‡æ ·ã€å¯ŒåŒ–)
  â”œâ”€ äº‘å¹³å°èµ„æºæ£€æµ‹ (AWS/GCP/Azure)
  â””â”€ Export â†’ Central Collector

Layer 3: ä¸­å¿ƒå±‚ (ç»Ÿä¸€åç«¯)
  â”œâ”€ Central OTLP Collector (è´Ÿè½½å‡è¡¡)
  â”œâ”€ å…¨å±€èšåˆä¸è·¯ç”±
  â”œâ”€ æ•°æ®æŒä¹…åŒ– (Jaeger, Prometheus, S3)
  â””â”€ æŸ¥è¯¢ä¸å¯è§†åŒ– (Grafana, Jaeger UI)
```

### æ•°æ®æµ

```text
1. åº”ç”¨ç”Ÿæˆé¥æµ‹æ•°æ®
   App â†’ OTLP SDK â†’ gRPC (localhost:4317)

2. åŒºåŸŸ Collector é‡‡é›†
   DaemonSet Collector â†’ å¯ŒåŒ–äº‘å¹³å°å…ƒæ•°æ®
     â”œâ”€ AWS: ec2, ecs, eks metadata
     â”œâ”€ GCP: gce, gke metadata
     â””â”€ Azure: vm, aks metadata

3. ä¼ è¾“åˆ°ä¸­å¿ƒ Collector
   Regional Collector â†’ Central Collector (OTLP/gRPC)
     â”œâ”€ å‹ç¼© (gzip)
     â”œâ”€ æ‰¹å¤„ç† (10s batch, 512 spans)
     â””â”€ é‡è¯• (exponential backoff)

4. ä¸­å¿ƒå¤„ç†ä¸å­˜å‚¨
   Central Collector â†’ 
     â”œâ”€ Jaeger (traces)
     â”œâ”€ Prometheus (metrics)
     â”œâ”€ S3 (long-term archive)
     â””â”€ Cloud-specific backends (optional)
```

---

## å„äº‘å¹³å°é›†æˆ

### 1. AWS (EKS) é›†æˆ

#### Kubernetes éƒ¨ç½²

```yaml:deployments/aws/otel-collector-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: observability
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.96.0
        ports:
        - containerPort: 4317  # OTLP gRPC
        - containerPort: 4318  # OTLP HTTP
        - containerPort: 8888  # Prometheus metrics
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        env:
        # AWS å…ƒæ•°æ®æ³¨å…¥
        - name: AWS_REGION
          value: "us-east-1"
        - name: EKS_CLUSTER_NAME
          value: "prod-cluster"
        # Kubernetes Downward API
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: otel-config
          mountPath: /etc/otel
      volumes:
      - name: otel-config
        configMap:
          name: otel-collector-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: observability
  annotations:
    # AWS IAM Role for Service Account (IRSA)
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/OTELCollectorRole
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
  namespace: observability
spec:
  selector:
    app: otel-collector
  ports:
  - name: otlp-grpc
    port: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    protocol: TCP
  type: ClusterIP
```

#### Collector é…ç½® (AWS)

```yaml:deployments/aws/otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # æ‰¹å¤„ç†ä¼˜åŒ–
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1024

  # AWS èµ„æºæ£€æµ‹
  resourcedetection/aws:
    detectors: [env, ec2, ecs, eks]
    timeout: 5s
    override: false

  # K8s å±æ€§å¤„ç†å™¨
  k8sattributes:
    auth_type: "serviceAccount"
    passthrough: false
    extract:
      metadata:
        - k8s.namespace.name
        - k8s.deployment.name
        - k8s.pod.name
        - k8s.pod.uid
        - k8s.node.name
      labels:
        - tag_name: app
          key: app
          from: pod
      annotations:
        - tag_name: version
          key: version
          from: pod

  # é‡‡æ ·ï¼ˆé™ä½æˆæœ¬ï¼‰
  probabilistic_sampler:
    sampling_percentage: 10  # 10% é‡‡æ ·

  # å±æ€§è¿‡æ»¤ï¼ˆç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰
  attributes:
    actions:
      - key: password
        action: delete
      - key: token
        action: delete
      - key: cloud.provider
        action: insert
        value: "aws"
      - key: cloud.region
        action: insert
        from_attribute: AWS_REGION

exporters:
  # å‘é€åˆ°ä¸­å¿ƒ Collector
  otlp/central:
    endpoint: central-collector.example.com:4317
    compression: gzip
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  # CloudWatch Logs (å¯é€‰ï¼Œæœ¬åœ°å¤‡ä»½)
  awscloudwatchlogs:
    log_group_name: /aws/otel/traces
    log_stream_name: ${K8S_POD_NAME}
    region: us-east-1

  # Prometheus Metrics (æœ¬åœ°æš´éœ²)
  prometheus:
    endpoint: 0.0.0.0:8888

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: 
        - resourcedetection/aws
        - k8sattributes
        - probabilistic_sampler
        - attributes
        - batch
      exporters: [otlp/central, awscloudwatchlogs]
      
    metrics:
      receivers: [otlp]
      processors:
        - resourcedetection/aws
        - k8sattributes
        - batch
      exporters: [otlp/central, prometheus]
```

### 2. GCP (GKE) é›†æˆ

#### Collector é…ç½® (GCP)

```yaml:deployments/gcp/otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  batch:
    timeout: 10s
    send_batch_size: 512

  # GCP èµ„æºæ£€æµ‹
  resourcedetection/gcp:
    detectors: [env, gcp]
    timeout: 5s

  k8sattributes:
    auth_type: "serviceAccount"
    extract:
      metadata:
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.node.name

  attributes:
    actions:
      - key: cloud.provider
        action: insert
        value: "gcp"
      - key: cloud.region
        action: insert
        from_attribute: GCP_REGION

exporters:
  # ä¸­å¿ƒ Collector
  otlp/central:
    endpoint: central-collector.example.com:4317
    compression: gzip

  # Google Cloud Logging (å¯é€‰)
  googlecloud:
    project: my-gcp-project
    log:
      default_log_name: opentelemetry.io/collector-exported-log

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors:
        - resourcedetection/gcp
        - k8sattributes
        - attributes
        - batch
      exporters: [otlp/central, googlecloud]
```

### 3. Azure (AKS) é›†æˆ

#### Collector é…ç½® (Azure)

```yaml:deployments/azure/otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  batch:
    timeout: 10s
    send_batch_size: 512

  # Azure èµ„æºæ£€æµ‹
  resourcedetection/azure:
    detectors: [env, azure]
    timeout: 5s

  k8sattributes:
    auth_type: "serviceAccount"

  attributes:
    actions:
      - key: cloud.provider
        action: insert
        value: "azure"
      - key: cloud.region
        action: insert
        from_attribute: AZURE_REGION

exporters:
  # ä¸­å¿ƒ Collector
  otlp/central:
    endpoint: central-collector.example.com:4317
    compression: gzip

  # Azure Monitor (å¯é€‰)
  azuremonitor:
    instrumentation_key: ${AZURE_INSTRUMENTATION_KEY}

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors:
        - resourcedetection/azure
        - k8sattributes
        - attributes
        - batch
      exporters: [otlp/central, azuremonitor]
```

---

## ç»Ÿä¸€é‡‡é›†é…ç½®

### ä¸­å¿ƒ Collector é…ç½®

```yaml:deployments/central/otel-collector-config.yaml
receivers:
  # æ¥æ”¶æ¥è‡ªå„åŒºåŸŸçš„æ•°æ®
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        max_recv_msg_size_mib: 16

processors:
  batch:
    timeout: 15s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # å…¨å±€å±æ€§æ·»åŠ 
  attributes:
    actions:
      - key: deployment.environment
        action: insert
        value: "production"
      - key: telemetry.sdk.name
        action: insert
        value: "opentelemetry"

  # Span è¿‡æ»¤ï¼ˆåªä¿ç•™é‡è¦ Spanï¼‰
  filter:
    error_mode: ignore
    traces:
      span:
        - 'attributes["http.status_code"] >= 500'
        - 'status.code == STATUS_CODE_ERROR'

  # Tail Samplingï¼ˆå°¾éƒ¨é‡‡æ ·ï¼Œä¿ç•™æ‰€æœ‰é”™è¯¯traceï¼‰
  tail_sampling:
    decision_wait: 10s
    num_traces: 100
    expected_new_traces_per_sec: 10
    policies:
      - name: errors
        type: status_code
        status_code:
          status_codes: [ERROR]
      - name: slow
        type: latency
        latency:
          threshold_ms: 1000
      - name: random
        type: probabilistic
        probabilistic:
          sampling_percentage: 5

exporters:
  # Jaeger (Traces)
  jaeger:
    endpoint: jaeger-collector:14250
    tls:
      insecure: true

  # Prometheus Remote Write (Metrics)
  prometheusremotewrite:
    endpoint: http://prometheus:9090/api/v1/write

  # S3 å½’æ¡£ï¼ˆé•¿æœŸå­˜å‚¨ï¼‰
  s3:
    region: us-east-1
    s3_bucket: otel-archive
    s3_prefix: traces
    s3_partition: minute
    compression: gzip

  # Kafka (å®æ—¶æµå¤„ç†ï¼Œå¯é€‰)
  kafka:
    brokers: [kafka:9092]
    topic: otel-traces
    encoding: otlp_proto

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch, attributes, tail_sampling]
      exporters: [jaeger, s3, kafka]
      
    metrics:
      receivers: [otlp]
      processors: [batch, attributes]
      exporters: [prometheusremotewrite]
```

---

## è·¨äº‘è¿½è¸ªå®ç°

### Go åº”ç”¨é…ç½®

```go:pkg/telemetry/init.go
package telemetry

import (
    "context"
    "os"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
)

func InitTracer(ctx context.Context, serviceName string) (*sdktrace.TracerProvider, error) {
    // è¯»å–ç¯å¢ƒå˜é‡ï¼ˆKubernetes Downward APIæ³¨å…¥ï¼‰
    cloudProvider := os.Getenv("CLOUD_PROVIDER")    // aws/gcp/azure
    cloudRegion := os.Getenv("CLOUD_REGION")
    k8sNamespace := os.Getenv("K8S_NAMESPACE")
    k8sPodName := os.Getenv("K8S_POD_NAME")
    k8sNodeName := os.Getenv("K8S_NODE_NAME")

    // åˆ›å»º Resource (åŒ…å«äº‘å¹³å°ä¿¡æ¯)
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String(serviceName),
            semconv.ServiceVersionKey.String("1.0.0"),
            semconv.CloudProviderKey.String(cloudProvider),
            semconv.CloudRegionKey.String(cloudRegion),
            semconv.K8SNamespaceNameKey.String(k8sNamespace),
            semconv.K8SPodNameKey.String(k8sPodName),
            semconv.K8SNodeNameKey.String(k8sNodeName),
        ),
    )
    if err != nil {
        return nil, err
    }

    // OTLP Exporterï¼ˆè¿æ¥åˆ°æœ¬åœ° DaemonSet Collectorï¼‰
    conn, err := grpc.NewClient(
        "localhost:4317",  // DaemonSet collector
        grpc.WithTransportCredentials(insecure.NewCredentials()),
    )
    if err != nil {
        return nil, err
    }

    exporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithGRPCConn(conn))
    if err != nil {
        return nil, err
    }

    // TracerProvider
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(res),
        // è®©åŒºåŸŸ Collector å¤„ç†é‡‡æ ·
        sdktrace.WithSampler(sdktrace.AlwaysSample()),
    )

    otel.SetTracerProvider(tp)

    // è·¨äº‘ä¼ æ’­å™¨ï¼ˆæ”¯æŒ W3C Trace Context + Baggageï¼‰
    otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
        propagation.TraceContext{},
        propagation.Baggage{},
    ))

    return tp, nil
}
```

### è·¨äº‘æœåŠ¡è°ƒç”¨ç¤ºä¾‹

```go:internal/order/service.go
package order

import (
    "context"
    "fmt"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/baggage"
    "go.opentelemetry.io/otel/trace"
)

var tracer = otel.Tracer("order-service")

type Service struct {
    productClient  *ProductClient  // GCP
    inventoryClient *InventoryClient // GCP
    paymentClient  *PaymentClient  // Azure
}

// CreateOrder åˆ›å»ºè®¢å•ï¼ˆè·¨äº‘è°ƒç”¨ï¼‰
func (s *Service) CreateOrder(ctx context.Context, req *CreateOrderRequest) (*Order, error) {
    ctx, span := tracer.Start(ctx, "order.create",
        trace.WithAttributes(
            attribute.String("order.id", req.OrderID),
            attribute.String("user.id", req.UserID),
        ),
    )
    defer span.End()

    // æ·»åŠ  Baggageï¼ˆè·¨äº‘ä¼ æ’­ç”¨æˆ·ä¿¡æ¯ï¼‰
    member, _ := baggage.NewMember("user.id", req.UserID)
    bag, _ := baggage.New(member)
    ctx = baggage.ContextWithBaggage(ctx, bag)

    // 1. è°ƒç”¨äº§å“æœåŠ¡ï¼ˆGCPï¼‰
    span.AddEvent("calling product service")
    product, err := s.productClient.GetProduct(ctx, req.ProductID)
    if err != nil {
        span.RecordError(err)
        return nil, fmt.Errorf("get product failed: %w", err)
    }
    span.SetAttributes(attribute.Float64("product.price", product.Price))

    // 2. è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆGCPï¼‰
    span.AddEvent("calling inventory service")
    if err := s.inventoryClient.Deduct(ctx, req.ProductID, req.Quantity); err != nil {
        span.RecordError(err)
        return nil, fmt.Errorf("deduct inventory failed: %w", err)
    }

    // 3. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆAzureï¼‰
    span.AddEvent("calling payment service")
    payment, err := s.paymentClient.Process(ctx, &PaymentRequest{
        UserID: req.UserID,
        Amount: product.Price * float64(req.Quantity),
    })
    if err != nil {
        // å›æ»šåº“å­˜
        s.inventoryClient.Refund(ctx, req.ProductID, req.Quantity)
        span.RecordError(err)
        return nil, fmt.Errorf("payment failed: %w", err)
    }

    span.SetAttributes(attribute.String("payment.id", payment.PaymentID))
    span.AddEvent("order created successfully")

    return &Order{
        OrderID:   req.OrderID,
        Status:    "confirmed",
        PaymentID: payment.PaymentID,
    }, nil
}
```

### è·¨äº‘ HTTP å®¢æˆ·ç«¯

```go:pkg/client/http.go
package client

import (
    "net/http"

    "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/propagation"
)

// NewHTTPClient åˆ›å»ºè·¨äº‘ HTTP å®¢æˆ·ç«¯ï¼ˆè‡ªåŠ¨ä¼ æ’­ä¸Šä¸‹æ–‡ï¼‰
func NewHTTPClient() *http.Client {
    return &http.Client{
        Transport: otelhttp.NewTransport(
            http.DefaultTransport,
            otelhttp.WithPropagators(otel.GetTextMapPropagator()),
        ),
    }
}
```

---

## æˆæœ¬ä¼˜åŒ–

### 1. é‡‡æ ·ç­–ç•¥

```yaml
processors:
  # Head Samplingï¼ˆå¤´éƒ¨é‡‡æ ·ï¼Œé™ä½ä¼ è¾“æˆæœ¬ï¼‰
  probabilistic_sampler:
    sampling_percentage: 10  # 10% é‡‡æ ·

  # Tail Samplingï¼ˆå°¾éƒ¨é‡‡æ ·ï¼Œä¿ç•™é‡è¦ traceï¼‰
  tail_sampling:
    policies:
      - name: errors
        type: status_code
        status_code:
          status_codes: [ERROR]
      - name: slow
        type: latency
        latency:
          threshold_ms: 1000
      - name: random
        type: probabilistic
        probabilistic:
          sampling_percentage: 1  # å‰©ä½™ 1% éšæœº
```

### 2. æ•°æ®å½’æ¡£

```yaml
exporters:
  # S3 å½’æ¡£ï¼ˆä½æˆæœ¬é•¿æœŸå­˜å‚¨ï¼‰
  s3:
    region: us-east-1
    s3_bucket: otel-archive
    s3_prefix: traces/${cloud.provider}/${cloud.region}
    s3_partition: hour
    compression: gzip
    
  # ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼ˆåœ¨ S3 ä¾§é…ç½®ï¼‰
  # - 30å¤©åè½¬ä¸º Glacier
  # - 90å¤©ååˆ é™¤
```

### 3. æˆæœ¬ç›‘æ§

```promql
# æ¯å°æ—¶æ•°æ®é‡
sum(rate(otelcol_exporter_sent_spans[1h])) * 3600

# æ¯æœˆé¢„ä¼°æˆæœ¬ï¼ˆå‡è®¾ $0.50/GBï¼‰
(sum(rate(otelcol_exporter_sent_spans[30d])) * 30 * 86400 * 0.001) * 0.50

# æŒ‰äº‘å¹³å°åˆ†ç»„
sum(rate(otelcol_exporter_sent_spans[1h])) by (cloud_provider)
```

---

## ç¾å¤‡åˆ‡æ¢

### 1. åŒä¸­å¿ƒé…ç½®

```yaml:deployments/central/otel-collector-config.yaml
exporters:
  # ä¸»ä¸­å¿ƒï¼ˆAWSï¼‰
  otlp/primary:
    endpoint: primary-collector.aws.example.com:4317
    retry_on_failure:
      enabled: true
      max_elapsed_time: 60s

  # å¤‡ä»½ä¸­å¿ƒï¼ˆGCPï¼‰
  otlp/backup:
    endpoint: backup-collector.gcp.example.com:4317

  # æ•…éšœè½¬ç§»å¯¼å‡ºå™¨
  loadbalancing:
    protocol:
      otlp:
        timeout: 1s
    resolver:
      static:
        hostnames:
          - primary-collector.aws.example.com:4317
          - backup-collector.gcp.example.com:4317

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [loadbalancing]  # è‡ªåŠ¨è´Ÿè½½å‡è¡¡ + æ•…éšœè½¬ç§»
```

### 2. å¥åº·æ£€æŸ¥

```go:internal/health/check.go
package health

import (
    "context"
    "time"

    "google.golang.org/grpc"
    "google.golang.org/grpc/health/grpc_health_v1"
)

// CheckCollectorHealth æ£€æŸ¥ Collector å¥åº·çŠ¶æ€
func CheckCollectorHealth(endpoint string) error {
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()

    conn, err := grpc.DialContext(ctx, endpoint, grpc.WithInsecure())
    if err != nil {
        return err
    }
    defer conn.Close()

    client := grpc_health_v1.NewHealthClient(conn)
    resp, err := client.Check(ctx, &grpc_health_v1.HealthCheckRequest{})
    if err != nil {
        return err
    }

    if resp.Status != grpc_health_v1.HealthCheckResponse_SERVING {
        return fmt.Errorf("collector not serving")
    }

    return nil
}
```

---

## Terraform è‡ªåŠ¨åŒ–éƒ¨ç½²

### AWS EKS

```hcl:terraform/aws/main.tf
provider "aws" {
  region = "us-east-1"
}

# EKS Cluster
module "eks" {
  source  = "terraform-aws-modules/eks/aws"
  version = "~> 19.0"

  cluster_name    = "prod-cluster"
  cluster_version = "1.28"

  vpc_id     = module.vpc.vpc_id
  subnet_ids = module.vpc.private_subnets

  eks_managed_node_groups = {
    main = {
      desired_size = 3
      min_size     = 2
      max_size     = 5
      instance_types = ["t3.large"]
    }
  }
}

# OTLP Collector Namespace
resource "kubernetes_namespace" "observability" {
  metadata {
    name = "observability"
  }
}

# OTLP Collector DaemonSet
resource "kubernetes_daemonset" "otel_collector" {
  metadata {
    name      = "otel-collector"
    namespace = kubernetes_namespace.observability.metadata[0].name
  }

  spec {
    selector {
      match_labels = {
        app = "otel-collector"
      }
    }

    template {
      metadata {
        labels = {
          app = "otel-collector"
        }
      }

      spec {
        service_account_name = kubernetes_service_account.otel_collector.metadata[0].name

        container {
          name  = "otel-collector"
          image = "otel/opentelemetry-collector-contrib:0.96.0"

          port {
            container_port = 4317
          }

          env {
            name  = "AWS_REGION"
            value = "us-east-1"
          }

          env {
            name = "K8S_NODE_NAME"
            value_from {
              field_ref {
                field_path = "spec.nodeName"
              }
            }
          }

          resources {
            requests = {
              memory = "512Mi"
              cpu    = "500m"
            }
            limits = {
              memory = "1Gi"
              cpu    = "1000m"
            }
          }
        }
      }
    }
  }
}
```

---

## æœ€ä½³å®è·µæ€»ç»“

### 1. åŒºåŸŸå°±è¿‘é‡‡é›†

âœ… **DO**:

- æ¯ä¸ªäº‘/åŒºåŸŸéƒ¨ç½² DaemonSet Collector
- æœ¬åœ°é¢„å¤„ç†ï¼ˆé‡‡æ ·ã€è¿‡æ»¤ã€å¯ŒåŒ–ï¼‰
- å¼‚æ­¥æ‰¹é‡ä¼ è¾“åˆ°ä¸­å¿ƒ

âŒ **DON'T**:

- ä¸è¦è®©åº”ç”¨ç›´æ¥è¿æ¥è·¨äº‘ Collectorï¼ˆå»¶è¿Ÿé«˜ï¼‰
- ä¸è¦åœ¨åŒºåŸŸ Collector åšé‡å¤„ç†ï¼ˆå½±å“æ€§èƒ½ï¼‰

### 2. ç»Ÿä¸€èµ„æºå±æ€§

âœ… **DO**:

- ä½¿ç”¨ Resource Detection Processor
- æ ‡å‡†åŒ–äº‘å¹³å°å±æ€§ï¼ˆ`cloud.provider`, `cloud.region`ï¼‰
- æ·»åŠ  Kubernetes å…ƒæ•°æ®

### 3. æˆæœ¬ä¼˜åŒ–

âœ… **DO**:

- é‡‡æ ·ç­–ç•¥ï¼ˆHead + Tail Samplingï¼‰
- æ•°æ®å½’æ¡£ï¼ˆS3 + Glacierï¼‰
- ç›‘æ§æ•°æ®é‡ä¸æˆæœ¬

### 4. ç¾å¤‡

âœ… **DO**:

- åŒä¸­å¿ƒéƒ¨ç½²
- è´Ÿè½½å‡è¡¡ + æ•…éšœè½¬ç§»
- å®šæœŸç¾å¤‡æ¼”ç»ƒ

---

## ğŸ¯ å­¦åˆ°çš„å…³é”®çŸ¥è¯†ç‚¹

1. âœ… **å¤šäº‘æ¶æ„**: ä¸‰å±‚æ¶æ„ï¼ˆåº”ç”¨å±‚ã€åŒºåŸŸå±‚ã€ä¸­å¿ƒå±‚ï¼‰
2. âœ… **è·¨äº‘è¿½è¸ª**: W3C Trace Context + Baggage è·¨äº‘ä¼ æ’­
3. âœ… **èµ„æºæ£€æµ‹**: AWS/GCP/Azure è‡ªåŠ¨æ£€æµ‹ä¸å¯ŒåŒ–
4. âœ… **æˆæœ¬ä¼˜åŒ–**: é‡‡æ ·ç­–ç•¥ + æ•°æ®å½’æ¡£
5. âœ… **ç¾å¤‡**: åŒä¸­å¿ƒ + è´Ÿè½½å‡è¡¡ + æ•…éšœè½¬ç§»
6. âœ… **è‡ªåŠ¨åŒ–**: Terraform ä¸€é”®éƒ¨ç½²

---

**ğŸŠ æ­å–œï¼** æ‚¨å·²ç»æŒæ¡äº†å¤šäº‘ç¯å¢ƒ OpenTelemetry çš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼

**ä¸‹ä¸€æ­¥**:

- ğŸ“š [é…ç½®æ¨¡æ¿åº“](../é…ç½®æ¨¡æ¿/)
