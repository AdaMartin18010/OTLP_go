# 分布式 CSP 机制与一致性论证（与 OTLP 语义对齐）

## 目录

- [分布式 CSP 机制与一致性论证（与 OTLP 语义对齐）](#分布式-csp-机制与一致性论证与-otlp-语义对齐)
  - [目录](#目录)
  - [1. 模型要素](#1-模型要素)
  - [2. 因果与隔离](#2-因果与隔离)
  - [3. 可证明的 SLO 约束（概要）](#3-可证明的-slo-约束概要)
  - [4. 观测到控制](#4-观测到控制)
  - [5. 与一致性/幂等性](#5-与一致性幂等性)
  - [6. 结语](#6-结语)

本文刻画以 CSP 为逻辑骨架的分布式编程机制，并以 OTLP 的 Trace/Resource 语义作为观测证据，给出可验证的系统性约束与推导。

## 1. 模型要素

- 进程：服务/实例视为顺序进程；
- 通道：进程间通过 RPC/消息队列通信，落地为 HTTP/gRPC/Kafka；
- 事件：发送/接收、超时、重试、丢弃、降级，均可映射为 OTLP 事件与指标。

## 2. 因果与隔离

- 因果链以 `TraceId/SpanId/ParentSpanId` 表示，形成偏序；
- 故障域以“通道边界”为界，将级联故障限制在局部；
- 背压通过“队列长度与延迟直方图”度量，阈值触发本地降级。

## 3. 可证明的 SLO 约束（概要）

- 有界队列：当输入到达率 ≤ 服务能力 × 并行度，稳态队列长度有上界；
- 超时链：父超时 ≤ 子超时之和，且设置“护栏系数”，避免过度并发引发同步风暴；
- 重试预算：每窗口重试次数 ≤ p95 延迟护栏与错误预算之函数，防止放大流量。

## 4. 观测到控制

- 以 OTLP 指标连续估计到达率、服务率、队列水位与抖动；
- 以 OTTL 将异常打分/标记；
- 以 OPAMP 下发限流/采样/路由策略；
- 形成闭环：观测→分析→决策→执行→再观测。

## 5. 与一致性/幂等性

- 幂等键：请求携带 `idempotency_key` 或 `trace_id` 变体，重试不产生副作用；
- 事务边界：以“阶段/消息投递确认”为单位；
- 侧线对账：事件日志聚合后进行差异校验，避免重放/丢失。

## 6. 结语

通过 CSP 的可组合性与 OTLP 的可观测语义，可将分布式系统的正确性约束显式化、可度量与可回放，为弹性与自愈提供基础。
