# 分布式设计（CSP × OTLP）

目标：以 CSP 抽象下的 goroutine/channel 为基本构件，构造端到端的分布式遥测与控制闭环。

## 📋 目录

- [分布式设计（CSP × OTLP）](#分布式设计csp--otlp)
  - [📋 目录](#-目录)
  - [端到端路径](#端到端路径)
    - [1. 感知层（数据采集）](#1-感知层数据采集)
    - [2. 分析层（数据处理）](#2-分析层数据处理)
    - [3. 决策层（控制逻辑）](#3-决策层控制逻辑)
    - [4. 执行层（动作实施）](#4-执行层动作实施)
  - [一致性与容错](#一致性与容错)
    - [数据一致性](#数据一致性)
    - [背压与流控](#背压与流控)
    - [故障处理](#故障处理)
  - [CSP 设计模式](#csp-设计模式)
    - [并发控制模式](#并发控制模式)
    - [观测与监控模式](#观测与监控模式)
    - [错误处理模式](#错误处理模式)
  - [多租户与隔离](#多租户与隔离)

## 端到端路径

### 1. 感知层（数据采集）

- **应用内采集**：Span/Metrics/Logs 带 Resource 语义上报至 Collector
- **CSP并发模型**：goroutine并发采集，channel缓冲传输
- **语义一致性**：统一Resource标签，确保数据关联性
- **性能优化**：批处理、压缩、重试机制

### 2. 分析层（数据处理）

- **Collector处理**：OTTL 清洗/降维/路由，边缘聚合降低带宽
- **实时分析**：异常检测、阈值监控、趋势分析
- **数据质量**：去重、补全、验证
- **存储优化**：时序数据压缩、索引优化

### 3. 决策层（控制逻辑）

- **中心决策**：依据指标/异常分数，OPAMP 下发新 OTTL/采样率/插件
- **规则引擎**：动态规则更新、A/B测试、灰度发布
- **智能运维**：自动扩缩容、故障转移、性能调优
- **反馈循环**：效果评估、规则优化、持续改进

### 4. 执行层（动作实施）

- **热更新**：Agent/Collector 热更新规则，无需重启
- **背压控制**：应用按 ctx/select 实施背压与限流
- **资源调度**：动态资源分配、负载均衡
- **故障恢复**：自动故障检测、快速恢复

## 一致性与容错

### 数据一致性

- **至少一次语义**：应用 SDK 与 Collector 都采用重试/批量；幂等由 TraceId/SpanId/Attributes 保证
- **因果一致性**：通过TraceId/SpanId/ParentId维护请求链路完整性
- **时序一致性**：使用高精度时间戳，支持跨时区数据关联
- **语义一致性**：统一Resource标签，确保数据关联性

### 背压与流控

- **背压传播**：从后端 → Collector → 应用，通过 gRPC 超时与 Exporter 队列回压体现
- **流控策略**：令牌桶、漏桶、滑动窗口算法
- **优先级队列**：重要数据优先处理，普通数据降级
- **动态调整**：根据系统负载自动调整处理速率

### 故障处理

- **降级策略**：超时/取消优先，记录 `drop` 原因与比率，维持控制面的稳定收敛
- **故障隔离**：服务熔断、限流、降级
- **自动恢复**：健康检查、自动重启、故障转移
- **监控告警**：实时监控、异常检测、及时告警

## CSP 设计模式

### 并发控制模式

- **有界缓冲队列**：限定 `chan` 缓冲 + select 超时，避免整体阻塞
- **工作池模式**：固定数量的goroutine处理任务，控制并发度
- **扇出扇入模式**：一个输入channel分发到多个worker，结果汇总
- **管道模式**：多个stage通过channel连接，形成处理流水线

### 观测与监控模式

- **旁路观测**：指标从 goroutine 安全更新，避免锁竞争
- **事件驱动**：重要分支点记录 SpanEvent 便于根因分析
- **健康检查**：定期检查系统状态，及时发现问题
- **性能监控**：实时监控系统性能，优化瓶颈

### 错误处理模式

- **优雅降级**：系统过载时自动降级，保证核心功能
- **重试机制**：失败操作自动重试，支持指数退避
- **熔断器**：连续失败时自动熔断，防止雪崩
- **超时控制**：设置合理超时，避免长时间阻塞

## 多租户与隔离

- 按 `resource.attributes["tenant"]` 路由到不同 Exporter 或 topic
- 应用层使用独立 Meter/Tracer 名称空间，避免冲突
