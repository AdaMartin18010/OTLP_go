# å¼¹æ€§æ¨¡å¼ç¤ºä¾‹

> **éš¾åº¦**: â­â­â­  
> **Go ç‰ˆæœ¬**: 1.25.1+  
> **OpenTelemetry SDK**: v1.32.0+

æœ¬ç›®å½•åŒ…å«å¼¹æ€§è®¾è®¡æ¨¡å¼çš„ç¤ºä¾‹ä»£ç ï¼Œå¸®åŠ©æ„å»ºå¥å£®çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

---

## ğŸ“š ç¤ºä¾‹åˆ—è¡¨

### 1. [circuit-breaker](./circuit-breaker/) - ç†”æ–­å™¨æ¨¡å¼

**éš¾åº¦**: â­â­â­  
**ç”¨é€”**: æ•…éšœéš”ç¦»ã€å¿«é€Ÿå¤±è´¥

**åŠŸèƒ½**:

- ä¸‰æ€ç†”æ–­å™¨ (å…³é—­/æ‰“å¼€/åŠå¼€)
- å¤±è´¥è®¡æ•°å’Œé˜ˆå€¼
- è‡ªåŠ¨æ¢å¤æœºåˆ¶
- ç›‘æ§å’Œå‘Šè­¦

**é€‚ç”¨åœºæ™¯**:

- ä¾èµ–æœåŠ¡ä¸ç¨³å®š
- éœ€è¦å¿«é€Ÿå¤±è´¥
- é˜²æ­¢çº§è”æ•…éšœ
- ä¿æŠ¤ç³»ç»Ÿèµ„æº

**è¿è¡Œ**:

```bash
cd circuit-breaker
go run main.go
```

**æ ¸å¿ƒæ¦‚å¿µ**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç†”æ–­å™¨çŠ¶æ€æœº                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  [Closed] â”€â”€å¤±è´¥è¶…é˜ˆå€¼â”€â”€> [Open]      â”‚
â”‚     â†‘                        â”‚       â”‚
â”‚     â”‚                        â”‚       â”‚
â”‚     â””â”€â”€æˆåŠŸâ”€â”€[Half-Open]<â”€â”€â”€â”€â”˜       â”‚
â”‚              è¶…æ—¶åå°è¯•               â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. [retry](./retry/) - é‡è¯•æœºåˆ¶

**éš¾åº¦**: â­â­â­  
**ç”¨é€”**: ä¸´æ—¶æ•…éšœæ¢å¤

**åŠŸèƒ½**:

- æŒ‡æ•°é€€é¿é‡è¯•
- æœ€å¤§é‡è¯•æ¬¡æ•°
- Jitter (æŠ–åŠ¨)
- é”™è¯¯åˆ†ç±»

**é€‚ç”¨åœºæ™¯**:

- ç½‘ç»œæŠ–åŠ¨
- ä¸´æ—¶æ€§æ•…éšœ
- æœåŠ¡é‡å¯
- èµ„æºäº‰ç”¨

**è¿è¡Œ**:

```bash
cd retry
go run main.go
```

**é‡è¯•ç­–ç•¥**:

```text
å°è¯•æ¬¡æ•°    å»¶è¿Ÿæ—¶é—´      ç´¯è®¡æ—¶é—´
   1        0ms          0ms
   2        100ms        100ms
   3        200ms        300ms
   4        400ms        700ms
   5        800ms        1500ms
```

---

## ğŸ¯ å¼¹æ€§æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | ç”¨é€” | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **ç†”æ–­å™¨** | å¿«é€Ÿå¤±è´¥ | ä¿æŠ¤ç³»ç»Ÿ | å¯èƒ½è¿‡æ—©ç†”æ–­ | ä¾èµ–ä¸ç¨³å®š |
| **é‡è¯•** | æ•…éšœæ¢å¤ | è‡ªåŠ¨æ¢å¤ | å¢åŠ å»¶è¿Ÿ | ä¸´æ—¶æ•…éšœ |
| **è¶…æ—¶** | èµ„æºä¿æŠ¤ | é˜²æ­¢é˜»å¡ | å¯èƒ½ä¸­æ–­æ­£å¸¸è¯·æ±‚ | é•¿æ—¶é—´æ“ä½œ |
| **é™æµ** | æµé‡æ§åˆ¶ | é˜²æ­¢è¿‡è½½ | ä¸¢å¼ƒè¯·æ±‚ | é«˜å¹¶å‘ |
| **é™çº§** | ä¿è¯æ ¸å¿ƒ | éƒ¨åˆ†å¯ç”¨ | åŠŸèƒ½å—é™ | å®¹é‡ä¸è¶³ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰ç¤ºä¾‹

```bash
# ç†”æ–­å™¨æ¨¡å¼
cd circuit-breaker
go run main.go

# é‡è¯•æœºåˆ¶
cd ../retry
go run main.go
```

### æµ‹è¯•ä¸åŒåœºæ™¯

```bash
# æµ‹è¯•ç†”æ–­å™¨
cd circuit-breaker
go test -v

# æµ‹è¯•é‡è¯•æœºåˆ¶
cd ../retry
go test -v
```

---

## ğŸ“– å­¦ä¹ è·¯å¾„

### åˆå­¦è€…è·¯å¾„

1. ç†è§£å¼¹æ€§è®¾è®¡æ¦‚å¿µ
2. è¿è¡Œ [circuit-breaker](./circuit-breaker/)
3. è¿è¡Œ [retry](./retry/)
4. å¯¹æ¯”ä¸¤ç§æ¨¡å¼

### è¿›é˜¶è·¯å¾„

1. ç»“åˆ [error-handling](../error-handling/)
2. å­¦ä¹ é”™è¯¯åˆ†ç±»
3. å®ç°è‡ªå®šä¹‰ç­–ç•¥
4. ç”Ÿäº§ç¯å¢ƒåº”ç”¨

### é«˜çº§è·¯å¾„

1. å¤šæ¨¡å¼ç»„åˆ
2. åŠ¨æ€é…ç½®è°ƒæ•´
3. ç›‘æ§å’Œå‘Šè­¦
4. æ€§èƒ½ä¼˜åŒ–

---

## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ

### 1. ç†”æ–­å™¨ (Circuit Breaker)

**ä¸‰ç§çŠ¶æ€**:

**Closed (å…³é—­)**: æ­£å¸¸çŠ¶æ€

- è¯·æ±‚æ­£å¸¸é€šè¿‡
- è®°å½•å¤±è´¥æ¬¡æ•°
- å¤±è´¥è¶…é˜ˆå€¼ â†’ Open

**Open (æ‰“å¼€)**: ç†”æ–­çŠ¶æ€

- ç›´æ¥è¿”å›é”™è¯¯
- ä¸æ‰§è¡Œå®é™…è°ƒç”¨
- è¶…æ—¶å â†’ Half-Open

**Half-Open (åŠå¼€)**: è¯•æ¢çŠ¶æ€

- å…è®¸å°‘é‡è¯·æ±‚
- æˆåŠŸ â†’ Closed
- å¤±è´¥ â†’ Open

**ä»£ç ç¤ºä¾‹**:

```go
type CircuitBreaker struct {
    state         State
    failures      int
    threshold     int
    timeout       time.Duration
    lastFailTime  time.Time
}

func (cb *CircuitBreaker) Call(fn func() error) error {
    switch cb.state {
    case Closed:
        err := fn()
        if err != nil {
            cb.failures++
            if cb.failures >= cb.threshold {
                cb.state = Open
            }
        } else {
            cb.failures = 0
        }
        return err
        
    case Open:
        if time.Since(cb.lastFailTime) > cb.timeout {
            cb.state = HalfOpen
            return cb.Call(fn)
        }
        return ErrCircuitOpen
        
    case HalfOpen:
        err := fn()
        if err != nil {
            cb.state = Open
        } else {
            cb.state = Closed
            cb.failures = 0
        }
        return err
    }
}
```

### 2. é‡è¯•æœºåˆ¶ (Retry)

**æŒ‡æ•°é€€é¿**:

- ç¬¬1æ¬¡: 100ms
- ç¬¬2æ¬¡: 200ms
- ç¬¬3æ¬¡: 400ms
- ç¬¬4æ¬¡: 800ms

**Jitter (æŠ–åŠ¨)**:

- æ·»åŠ éšæœºå»¶è¿Ÿ
- é¿å…æƒŠç¾¤æ•ˆåº”
- åˆ†æ•£é‡è¯•æ—¶é—´

**ä»£ç ç¤ºä¾‹**:

```go
func RetryWithBackoff(fn func() error, maxRetries int) error {
    var err error
    for i := 0; i < maxRetries; i++ {
        err = fn()
        if err == nil {
            return nil
        }
        
        if !shouldRetry(err) {
            return err
        }
        
        backoff := time.Duration(1<<uint(i)) * 100 * time.Millisecond
        jitter := time.Duration(rand.Intn(100)) * time.Millisecond
        time.Sleep(backoff + jitter)
    }
    return err
}
```

---

## ğŸ”§ æœ€ä½³å®è·µ

### ç†”æ–­å™¨é…ç½®

```go
breaker := &CircuitBreaker{
    Threshold: 5,           // 5æ¬¡å¤±è´¥åç†”æ–­
    Timeout:   30 * time.Second,  // 30ç§’åå°è¯•æ¢å¤
    OnOpen:    logCircuitOpen,    // ç†”æ–­æ—¶è®°å½•æ—¥å¿—
}
```

### é‡è¯•é…ç½®

```go
retryConfig := &RetryConfig{
    MaxRetries:   3,              // æœ€å¤šé‡è¯•3æ¬¡
    InitialDelay: 100 * time.Millisecond,
    MaxDelay:     5 * time.Second,
    Multiplier:   2.0,            // æŒ‡æ•°å› å­
    Jitter:       true,           // å¯ç”¨æŠ–åŠ¨
}
```

### é”™è¯¯åˆ†ç±»

```go
func shouldRetry(err error) bool {
    // å¯é‡è¯•çš„é”™è¯¯
    switch err {
    case context.DeadlineExceeded:
        return true
    case io.EOF:
        return true
    }
    
    // ä¸å¯é‡è¯•çš„é”™è¯¯
    if errors.Is(err, ErrBadRequest) {
        return false
    }
    
    return false
}
```

---

## ğŸ“Š æ€§èƒ½å½±å“

### ç†”æ–­å™¨å¼€é”€

| æŒ‡æ ‡ | æ— ç†”æ–­å™¨ | æœ‰ç†”æ–­å™¨ | å¢åŠ  |
|------|---------|---------|------|
| **å»¶è¿Ÿ** | 10ms | 10.1ms | +1% |
| **å†…å­˜** | 5MB | 5.1MB | +2% |
| **CPU** | 2% | 2.1% | +5% |

### é‡è¯•å½±å“

| åœºæ™¯ | æˆåŠŸç‡ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ |
|------|--------|---------|---------|
| **æ— é‡è¯•** | 90% | 10ms | 15ms |
| **1æ¬¡é‡è¯•** | 99% | 20ms | 120ms |
| **3æ¬¡é‡è¯•** | 99.9% | 40ms | 1.5s |

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä½•æ—¶ä½¿ç”¨ç†”æ–­å™¨?

A: å½“ä¾èµ–æœåŠ¡:

- å“åº”æ—¶é—´ä¸ç¨³å®š
- ç»å¸¸å‡ºç°æ•…éšœ
- å¯èƒ½å¯¼è‡´çº§è”å¤±è´¥
- éœ€è¦å¿«é€Ÿå¤±è´¥

### Q2: ä½•æ—¶ä½¿ç”¨é‡è¯•?

A: å½“é”™è¯¯:

- æ˜¯ä¸´æ—¶æ€§çš„
- æœ‰è¾ƒé«˜æˆåŠŸç‡
- å¯ä»¥æ¥å—å»¶è¿Ÿå¢åŠ 
- ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### Q3: å¦‚ä½•é¿å…é‡è¯•é£æš´?

A: ç­–ç•¥:

1. ä½¿ç”¨æŒ‡æ•°é€€é¿
2. æ·»åŠ  Jitter
3. è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
4. åŒºåˆ†å¯é‡è¯•é”™è¯¯

### Q4: ç†”æ–­å™¨é˜ˆå€¼å¦‚ä½•è®¾ç½®?

A: è€ƒè™‘å› ç´ :

1. æœåŠ¡ SLA
2. é”™è¯¯ç‡
3. æ¢å¤æ—¶é—´
4. ä¸šåŠ¡å½±å“

**æ¨èå€¼**:

- é˜ˆå€¼: 5-10 æ¬¡å¤±è´¥
- è¶…æ—¶: 30-60 ç§’
- åŠå¼€æµ‹è¯•: 1-3 æ¬¡

---

## ğŸ”— ç›¸å…³èµ„æº

### æ–‡æ¡£

- [13_Goé”™è¯¯å¤„ç†ä¸OTLPé›†æˆ.md](../../æ ‡å‡†æ·±åº¦æ¢³ç†_2025_10/00_Goå®Œæ•´é›†æˆæŒ‡å—/13_Goé”™è¯¯å¤„ç†ä¸OTLPé›†æˆ.md)
- [06_å®æˆ˜æ¡ˆä¾‹/04_ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ.md](../../æ ‡å‡†æ·±åº¦æ¢³ç†_2025_10/06_å®æˆ˜æ¡ˆä¾‹/04_ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ.md)

### ç¤ºä¾‹

- [error-handling](../error-handling/) - é”™è¯¯å¤„ç†åŸºç¡€
- [microservices](../microservices/) - å¾®æœåŠ¡é›†æˆ
- [distributed-tracing](../distributed-tracing/) - åˆ†å¸ƒå¼è¿½è¸ª

### ç¬¬ä¸‰æ–¹åº“

- [go-resilience/breaker](https://github.com/eapache/go-resiliency) - ç†”æ–­å™¨å®ç°
- [cenkalti/backoff](https://github.com/cenkalti/backoff) - é€€é¿ç®—æ³•
- [sony/gobreaker](https://github.com/sony/gobreaker) - ç†”æ–­å™¨åº“

---

## ğŸ“ è®¾è®¡å»ºè®®

### âœ… æ¨èåšæ³•

1. **ç»„åˆä½¿ç”¨**: ç†”æ–­å™¨ + é‡è¯•
2. **ç›‘æ§**: è®°å½•æ‰€æœ‰çŠ¶æ€å˜åŒ–
3. **å‘Šè­¦**: ç†”æ–­æ—¶å‘é€å‘Šè­¦
4. **é…ç½®**: æ”¯æŒåŠ¨æ€è°ƒæ•´
5. **æµ‹è¯•**: æ¨¡æ‹Ÿå„ç§æ•…éšœåœºæ™¯

### âŒ é¿å…åšæ³•

1. **ç›²ç›®é‡è¯•**: æ‰€æœ‰é”™è¯¯éƒ½é‡è¯•
2. **å¿½ç•¥è¶…æ—¶**: æ²¡æœ‰è¶…æ—¶æ§åˆ¶
3. **å…¨å±€ç†”æ–­**: ä¸åŒºåˆ†ä¸åŒä¾èµ–
4. **å›ºå®šå»¶è¿Ÿ**: ä½¿ç”¨å›ºå®šé‡è¯•é—´éš”
5. **ç¼ºå°‘ç›‘æ§**: ä¸è®°å½•çŠ¶æ€

---

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### ç›‘æ§æŒ‡æ ‡

```go
// ç†”æ–­å™¨æŒ‡æ ‡
metrics.RecordCircuitBreakerState(state)
metrics.RecordCircuitBreakerTrips(count)

// é‡è¯•æŒ‡æ ‡
metrics.RecordRetryAttempts(count)
metrics.RecordRetrySuccess(bool)
```

### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  - name: CircuitBreakerOpen
    condition: circuit_breaker_state == "open"
    duration: 5m
    severity: warning
    
  - name: HighRetryRate
    condition: retry_rate > 0.3
    duration: 5m
    severity: warning
```

### é…ç½®ç®¡ç†

```yaml
circuit_breaker:
  threshold: 5
  timeout: 30s
  metrics_enabled: true
  
retry:
  max_retries: 3
  initial_delay: 100ms
  max_delay: 5s
  jitter: true
```

---

## ğŸ“ è¿›é˜¶å­¦ä¹ 

### ä¸‹ä¸€æ­¥

1. å®ç°è¶…æ—¶æ§åˆ¶
2. æ·»åŠ é™æµå™¨
3. å®ç°é™çº§ç­–ç•¥
4. é›†æˆç›‘æ§ç³»ç»Ÿ

### æ¨èé˜…è¯»

1. "Release It!" - Michael Nygard
2. "Site Reliability Engineering" - Google
3. "Building Microservices" - Sam Newman

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-08  
**æ›´æ–°é¢‘ç‡**: éšé¡¹ç›®æ›´æ–°  
**ç»´æŠ¤çŠ¶æ€**: âœ… æ´»è·ƒç»´æŠ¤

---

**æ„å»ºå¼¹æ€§ç³»ç»Ÿ!** ğŸ’ª
